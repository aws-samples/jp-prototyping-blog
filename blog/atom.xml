<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://prototyping-blog.com/blog</id>
    <title>Prototyping Blog Blog</title>
    <updated>2022-12-21T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://prototyping-blog.com/blog"/>
    <subtitle>Prototyping Blog Blog</subtitle>
    <icon>https://prototyping-blog.com/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[Ruby on Rails を API Gateway + Lambda でサーバーレス運用する方法]]></title>
        <id>rails-lambda</id>
        <link href="https://prototyping-blog.com/blog/rails-lambda"/>
        <updated>2022-12-21T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Ruby on Rails で開発された Web アプリケーションを AWS で稼働させる際、EC2 の仮想サーバーや ECS のコンテナ環境で実行して ALB 等のロードバランサーで公開するのが一般的です。この方法は稼働時間に比例した料金となりますが、もう1つの選択肢として、時間ではなくリクエスト回数に応じた料金となる API Gateway と Lambda を使う方法があります。今回は、Ruby on Rails を AWS Lambda で動かす方法を解説します。]]></summary>
        <content type="html"><![CDATA[<p>Ruby on Rails で開発された Web アプリケーションを AWS で稼働させる際、<a href="https://aws.amazon.com/ec2/" target="_blank" rel="noopener noreferrer">EC2</a> の仮想サーバーや <a href="https://aws.amazon.com/ecs/" target="_blank" rel="noopener noreferrer">ECS</a> のコンテナ環境で実行して <a href="https://aws.amazon.com/elasticloadbalancing/application-load-balancer/" target="_blank" rel="noopener noreferrer">ALB</a> 等のロードバランサーで公開するのが一般的です。この方法は稼働時間に比例した料金となりますが、もう1つの選択肢として、時間ではなくリクエスト回数に応じた料金となる <a href="https://aws.amazon.com/api-gateway/" target="_blank" rel="noopener noreferrer">API Gateway</a> と <a href="https://aws.amazon.com/jp/lambda/" target="_blank" rel="noopener noreferrer">Lambda</a> を使う方法があります。今回は、Ruby on Rails を AWS Lambda で動かす方法を解説します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ruby-on-rails-とは">Ruby on Rails とは<a class="hash-link" href="#ruby-on-rails-とは" title="見出しへの直接リンク">​</a></h2><p>Ruby on Rails は、Ruby 言語で Web アプリケーションを開発するためのフレームワークの1つです。「設定より規約 (Convention over Configuration, CoC)」というパラダイムの先駆者として有名で、他のフレームワークにも大きな影響を及ぼしました。</p><p>rails コマンドによるコードの自動生成機能が充実しており、プロジェクトの作成だけでなく、モデルやコントローラーの生成や認証機能の追加といった事まで行う事ができます。特に Active Record によるモデルとテーブル定義の自動生成は便利で、Web アプリ開発で必須となるデータベースアクセスを簡単に実装できます。</p><p>今回は、先日 aws-samples として公開された <a href="https://github.com/aws-samples/rails-lambda-handler" target="_blank" rel="noopener noreferrer">AWS Lambda handler sample for Ruby on Rails</a> を元に、Ruby on Rails で実装された Web アプリを AWS Lambda で実行し、Amazon API Gateway で公開する方法とその仕組みについて解説します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ruby-on-rails-による-rest-api-の実装">Ruby on Rails による REST API の実装<a class="hash-link" href="#ruby-on-rails-による-rest-api-の実装" title="見出しへの直接リンク">​</a></h2><p><a href="https://github.com/aws-samples/rails-lambda-handler" target="_blank" rel="noopener noreferrer">AWS Lambda handler sample for Ruby on Rails</a> では、Ruby on Rails で実装した Web アプリのサンプルを提供しています。この Web アプリは、Ruby on Rails の <a href="https://railsguides.jp/api_app.html" target="_blank" rel="noopener noreferrer">API モード</a> を利用して実装したシンプルな Web API で、「Hello, World!」という固定データのみを持つ SQLite データベースに対してクエリーを行う事ができます。</p><p>まずは、このサンプルアプリについて簡単に解説します。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="サンプル-web-アプリのモデル定義">サンプル Web アプリのモデル定義<a class="hash-link" href="#サンプル-web-アプリのモデル定義" title="見出しへの直接リンク">​</a></h3><p>モデルは以下のコマンドで生成し、テーブルを自動生成しています。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">rails generate model Message text:string</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>これによって生成されたテーブル「<code>messages</code>」の定義は以下の通りです。</p><table><thead><tr><th>カラム名</th><th>型</th><th>意味</th></tr></thead><tbody><tr><td><code>id</code></td><td>integer</td><td>メッセージ ID</td></tr><tr><td><code>text</code></td><td>varchar</td><td>メッセージ</td></tr><tr><td><code>created_at</code></td><td>datetime</td><td>作成日時</td></tr><tr><td><code>updated_at</code></td><td>datetime</td><td>更新日時</td></tr></tbody></table><p>固定の SQLite データベースファイルには、以下のようなデータを格納しています。</p><table><thead><tr><th>id</th><th>text</th><th>created_at</th><th>updated_at</th></tr></thead><tbody><tr><td>1</td><td>Hello, World!</td><td>2022-12-15 01:31:59.291570</td><td>2022-12-15 01:31:59.291570</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="サンプル-web-アプリのコントローラー定義">サンプル Web アプリのコントローラー定義<a class="hash-link" href="#サンプル-web-アプリのコントローラー定義" title="見出しへの直接リンク">​</a></h3><p>コントローラーは以下のコマンドで生成しています。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">rails generate controller Messages</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>生成されたコントローラー「<a href="https://github.com/aws-samples/rails-lambda-handler/blob/main/rails/app/controllers/messages_controller.rb" target="_blank" rel="noopener noreferrer"><code>MessagesController</code></a>」には、以下のアクションを実装しています。</p><table><thead><tr><th>名前</th><th>ルート</th><th>動作</th></tr></thead><tbody><tr><td><code>index</code></td><td><code>GET</code> /messages</td><td>メッセージ一覧を返す</td></tr><tr><td><code>show</code></td><td><code>GET</code> /messages/<code>{id}</code></td><td>指定された ID のメッセージを返す</td></tr></tbody></table><p>メッセージは以下のような JSON データとして返しています。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    "id": 1,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    "text": "Hello, World!",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    "created_at" :"2022-12-15T01:31:59.291Z",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    "updated_at": "2022-12-15T01:31:59.291Z",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    "url": "メッセージの URL"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="サンプル-web-アプリの動作確認">サンプル Web アプリの動作確認<a class="hash-link" href="#サンプル-web-アプリの動作確認" title="見出しへの直接リンク">​</a></h3><p><a href="https://github.com/aws-samples/rails-lambda-handler" target="_blank" rel="noopener noreferrer">AWS Lambda handler sample for Ruby on Rails</a> をローカルに clone し、<code>rails</code> ディレクトリで以下のコマンドを実行する事により、ローカル環境で動作確認できます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">rails server</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>cURL 等のツールで <code>http://localhost:3000/messages</code> に GET リクエストを行うと、以下のようなレスポンスが返されます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">curl http://localhost:3000/messages</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[{"id":1,"text":"Hello, World!","created_at":"2022-12-15T01:31:59.291Z","updated_at":"2022-12-15T01:31:59.291Z","url":"http://localhost:3000/messages/1"}]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ruby-on-rails-と-web-サーバーの関係">Ruby on Rails と Web サーバーの関係<a class="hash-link" href="#ruby-on-rails-と-web-サーバーの関係" title="見出しへの直接リンク">​</a></h2><p>Ruby on Rails において、Web サーバーへのリクエストが Web アプリで処理され、結果がレスポンスとして返されるまでの流れを簡単に解説します。</p><p><img loading="lazy" alt="Ruby on Rails と Web サーバーの関係" src="/assets/images/rails_puma-5ccb39d4d56bc628cee4ec8b58d1853f.png" width="1280" height="720" class="img_ev3q"></p><p>Ruby 言語では、Web アプリとアプリケーションサーバーとの間のインターフェイス仕様として <a href="https://rack.github.io/" target="_blank" rel="noopener noreferrer">rack</a> が広く採用されています。Ruby on Rails はこの rack に準拠しており、標準アプリケーションサーバーとして <a href="https://puma.io/" target="_blank" rel="noopener noreferrer">puma</a> が採用されています。puma は、Web サーバーが受け取った HTTP リクエストを rack 仕様に基づいて Web アプリに伝え、Web アプリが rack 仕様に基づいて生成したレスポンスを HTTP レスポンスとして Web サーバーに返します。</p><p>puma は、単体でも Web サーバーとして動作させる事が可能ではありますが、Web サーバー機能が使われるのはテスト用途が多く、本番環境ではよりパフォーマンスやスケーラビリティに優れた <a href="https://nginx.org/" target="_blank" rel="noopener noreferrer">nginx</a> 等を利用するのが一般的となっています。(前節で <code>rails server</code> を実行した際は、puma を Web サーバーとしても利用した形となります)</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aws-で-ruby-on-rails-を動かす方法">AWS で Ruby on Rails を動かす方法<a class="hash-link" href="#aws-で-ruby-on-rails-を動かす方法" title="見出しへの直接リンク">​</a></h2><p>Ruby on Rails で実装された Web アプリを AWS で稼働させる方法はいくつかありますが、今回は代表的な2パターンを紹介します。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="alb--ec2--ecs">ALB + EC2 / ECS<a class="hash-link" href="#alb--ec2--ecs" title="見出しへの直接リンク">​</a></h3><p>最も一般的なのは、nginx や Ruby on Rails アプリを Amazon EC2 仮想マシンにインストールしたり、Amazon ECS で Docker コンテナ化として実行し、Application Load Balancer 等のロードバランサーで公開する方法です。</p><p><img loading="lazy" alt="ALB + ECS のアーキテクチャ例" src="/assets/images/alb_architecture-8a888db1c6360af59b6423819e7eb53b.png" width="1280" height="720" class="img_ev3q"></p><p>この方法は、Ruby on Rails の標準的な構成をほぼそのままクラウドに移行できるメリットがあります。料金は稼働時間に比例するため、常に一定以上の稼働率があるサービスに向いた方法になります。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="api-gateway--lambda">API Gateway + Lambda<a class="hash-link" href="#api-gateway--lambda" title="見出しへの直接リンク">​</a></h3><p>そしてもう1つの方法が、AWS Lambda で Ruby on Rails アプリを実行し、Amazon API Gateway の Lambda プロキシ統合で公開する方法です。料金はリクエスト数に比例するため、稼働が特定の時間帯に集中するようなサービスに向いた方法になります。</p><p><img loading="lazy" alt="API Gateway + Lambda のアーキテクチャ例" src="/assets/images/apigw_architecture-39a008e8a527577f918e0c9f3e7038e6.png" width="1280" height="720" class="img_ev3q"></p><p>AWS Lambda で Ruby on Rails を実行するには、Lambda 関数の実行環境の制約に合わせていくつかの設定変更が必要となります。また、API Gateway からは HTTP リクエストが Lambda 関数のパラメーターとして渡され、Lambda 関数の戻り値から HTTP レスポンスが生成されるため、それらを Ruby on Rails が理解できる rack 仕様に変換する処理も必要となります。</p><p><img loading="lazy" alt="Ruby on Rails と API Gateway / Lambda の関係" src="/assets/images/rails_lambda-5e0576527459d58d855b0873aaf4f7e6.png" width="1280" height="720" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ruby-on-rails-を-lambda-関数化する">Ruby on Rails を Lambda 関数化する<a class="hash-link" href="#ruby-on-rails-を-lambda-関数化する" title="見出しへの直接リンク">​</a></h2><p>Ruby on Rails アプリを Lambda 関数化する方法には以下の2種類が存在します。</p><ul><li><a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-ruby.html" target="_blank" rel="noopener noreferrer">AWS Lambda の Ruby ランタイムを利用する</a></li><li><a href="https://docs.aws.amazon.com/lambda/latest/dg/ruby-image.html" target="_blank" rel="noopener noreferrer">コンテナイメージを作成する</a></li></ul><p>2022年12月現在、AWS Lambda の Ruby ランタイムが対応している Ruby 言語のバージョンは 2.7 のみのため、Ruby 3.0 以降を利用したい場合は独自のコンテナイメージを作成する必要があります。</p><p>本記事ではそれぞれの方法の詳細は割愛しますが、<a href="https://github.com/aws-samples/rails-lambda-handler/blob/main/rails/Dockerfile" target="_blank" rel="noopener noreferrer">Dockerfile のサンプル</a>を提供していますので、独自のコンテナイメージを作成する際は参考にしてみて下さい。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="環境変数の設定">環境変数の設定<a class="hash-link" href="#環境変数の設定" title="見出しへの直接リンク">​</a></h3><p>Lambda 関数を作成したら、環境変数を設定します。Ruby on Rails の一般的な環境変数に加えて、Lambda 関数の実行環境では <code>/tmp</code> 以外のディレクトリに書き込む事ができないという制限に対応するための以下の設定が必要となります。</p><table><thead><tr><th>環境変数</th><th>設定例</th><th>目的</th></tr></thead><tbody><tr><td><code>BOOTSNAP_CACHE_DIR</code></td><td><code>/tmp/cache</code></td><td>Rails アプリの起動高速化のためのキャッシュディレクトリを <code>/tmp</code> 以下に変更する</td></tr><tr><td><code>RAILS_LOG_TO_STDOUT</code></td><td><code>1</code></td><td>ログをファイルではなく標準出力に出力し、CloudWatch Logs で閲覧可能にする</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ハンドラー関数の実装">ハンドラー関数の実装<a class="hash-link" href="#ハンドラー関数の実装" title="見出しへの直接リンク">​</a></h3><p>Lambda 関数のエントリーポイントとなるのがハンドラー関数です。API Gateway からのリクエストとレスポンスを rack 仕様に変換して Ruby on Rails アプリを実行する処理は、ハンドラー関数で行う必要があります。</p><p>Amazon API Gateway には REST API と HTTP API があり、それぞれリクエストとレスポンスを Lambda 関数とやり取りするための入出力フォーマットが異なっています。それぞれの仕様へのリンクを以下に示します。</p><ul><li>REST API<ul><li><a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html#api-gateway-simple-proxy-for-lambda-input-format" target="_blank" rel="noopener noreferrer">入力フォーマット</a></li><li><a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html#api-gateway-simple-proxy-for-lambda-output-format" target="_blank" rel="noopener noreferrer">出力フォーマット</a></li></ul></li><li>HTTP API<ul><li><a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-develop-integrations-lambda.html#http-api-develop-integrations-lambda.proxy-format" target="_blank" rel="noopener noreferrer">入力フォーマット (2.0)</a></li><li><a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-develop-integrations-lambda.html#http-api-develop-integrations-lambda.v2" target="_blank" rel="noopener noreferrer">出力フォーマット (2.0)</a></li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="rack-の入出力仕様との相互変換">rack の入出力仕様との相互変換<a class="hash-link" href="#rack-の入出力仕様との相互変換" title="見出しへの直接リンク">​</a></h4><p><a href="https://github.com/aws-samples/rails-lambda-handler" target="_blank" rel="noopener noreferrer">AWS Lambda handler sample for Ruby on Rails</a> では、API Gateway の種類に応じて <a href="https://github.com/rack/rack/blob/main/SPEC.rdoc" target="_blank" rel="noopener noreferrer">rack の仕様</a>に基づいた変換処理を行うハンドラー関数のサンプルを提供しています。</p><ul><li><a href="https://github.com/aws-samples/rails-lambda-handler/blob/main/rails/lambda_rest.rb" target="_blank" rel="noopener noreferrer">REST API 向けハンドラー関数 (lambda_rest.handler)</a></li><li><a href="https://github.com/aws-samples/rails-lambda-handler/blob/main/rails/lambda_http.rb" target="_blank" rel="noopener noreferrer">HTTP API 向けハンドラー関数 (lambda_http.handler)</a></li></ul><p>上記のコードを Ruby on Rails アプリのルートディレクトリにコピーし、Lambda 関数のハンドラー関数として設定すれば、Ruby on Rails アプリを Lambda 関数として実行する事ができます。</p><p>ハンドラー関数が行っている変換処理の概要は以下の通りです。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="リクエスト対応表">リクエスト対応表<a class="hash-link" href="#リクエスト対応表" title="見出しへの直接リンク">​</a></h4><p>REST API と HTTP API の入力パラメーターは、rack の env 変数に変換されます。</p><table><thead><tr><th>rack の env 変数名</th><th>意味</th><th>REST API</th><th>HTTP API</th></tr></thead><tbody><tr><td><code>REQUEST_METHOD</code></td><td>HTTP メソッド</td><td><code>httpMethod</code></td><td><code>requestContext.http.method</code></td></tr><tr><td><code>SCRIPT_NAME</code></td><td>パスのルート</td><td>環境変数 <code>RAILS_RELATIVE_URL_ROOT</code> の値</td><td>環境変数 <code>RAILS_RELATIVE_URL_ROOT</code> の値</td></tr><tr><td><code>PATH_INFO</code></td><td>パス</td><td><code>path</code></td><td><code>requestContext.http.path</code></td></tr><tr><td><code>QUERY_STRING</code></td><td>クエリ文字列</td><td><code>multiValueQueryStringParameters</code> から再構築</td><td><code>rawQueryString</code></td></tr><tr><td><code>SERVER_NAME</code></td><td>ドメイン名</td><td><code>headers.X-Forwarded-Host</code><br>or <code>headers.Host</code></td><td><code>headers.x-forwarded-host</code><br>or <code>headers.host</code></td></tr><tr><td><code>SERVER_PORT</code></td><td>ポート</td><td><code>headers.X-Forwarded-Port</code></td><td><code>headers.x-forwarded-port</code></td></tr><tr><td><code>SERVER_PROTOCOL</code></td><td>HTTP バージョン</td><td><code>requestContext.protocol</code></td><td><code>requestContext.http.protocol</code></td></tr><tr><td><code>rack.url_scheme</code></td><td>URL スキーム</td><td><code>headers.CloudFront-Forwarded-Proto</code><br>or <code>headers.X-Forwarded-Proto</code></td><td><code>headers.cloudfront-forwarded-proto</code><br>or <code>headers.x-forwarded-proto</code></td></tr><tr><td><code>rack.input</code></td><td>HTTP ボディ</td><td><code>body</code></td><td><code>body</code></td></tr><tr><td><code>CONTENT_LENGTH</code></td><td>ボディのサイズ</td><td><code>body</code> のサイズから計算</td><td><code>body</code> のサイズから計算</td></tr><tr><td><code>HTTP_COOKIE</code></td><td>Cookie データ</td><td><code>multiValueHeaders.Cookie</code></td><td><code>cookies</code> から再構築</td></tr><tr><td><code>HTTP_*</code></td><td>その他のヘッダー</td><td><code>multiValueHeaders</code></td><td><code>headers</code></td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_LWe7" id="レスポンス対応表">レスポンス対応表<a class="hash-link" href="#レスポンス対応表" title="見出しへの直接リンク">​</a></h4><p>rack のレスポンスは、REST API と HTTP API の出力パラメーターに変換されます。</p><table><thead><tr><th>レスポンスの要素</th><th>REST API</th><th>HTTP API</th></tr></thead><tbody><tr><td>ステータスコード</td><td><code>statusCode</code></td><td><code>statusCode</code></td></tr><tr><td>ボディ</td><td><code>body</code></td><td><code>body</code></td></tr><tr><td>Cookie データ</td><td><code>multiValueHeaders.Set-Cookie</code></td><td><code>cookies</code></td></tr><tr><td>その他のヘッダー</td><td><code>headers</code><br>or <code>multiValueHeaders</code></td><td><code>headers</code></td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="サンプルを-aws-で動かしてみる">サンプルを AWS で動かしてみる<a class="hash-link" href="#サンプルを-aws-で動かしてみる" title="見出しへの直接リンク">​</a></h3><p><a href="https://github.com/aws-samples/rails-lambda-handler" target="_blank" rel="noopener noreferrer">AWS Lambda handler sample for Ruby on Rails</a> では、冒頭で解説したサンプルアプリを API Gateway + Lambda 構成でデプロイする <a href="https://aws.amazon.com/jp/getting-started/guides/setup-cdk/" target="_blank" rel="noopener noreferrer">AWS CDK</a> のサンプルも提供しています。</p><p><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB-web-%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D">サンプル Web アプリの動作確認</a>を行った後、<a href="https://aws.amazon.com/jp/getting-started/guides/setup-cdk/module-two/" target="_blank" rel="noopener noreferrer">AWS CDK のインストールと設定</a>を行った上で、<code>cdk</code> ディレクトリで以下のコマンドを実行するとデプロイが開始されます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">npm ci</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">npx cdk deploy -c railsMasterKey=d1c2ae419e40d2c43006aacdf98cf7f0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>デプロイが終わると、以下のような出力が表示されます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">RailsLambdaStack.HttpHttpApiUrlE6BB121E = https://xxxx.execute-api.ap-northeast-1.amazonaws.com/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RailsLambdaStack.RestRestApiUrl2AB183B3 = https://yyyy.execute-api.ap-northeast-1.amazonaws.com/default/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>後は、ローカルで起動した時と同じように動作確認して下さい。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">curl https://xxxx.execute-api.ap-northeast-1.amazonaws.com/messages</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[{"id":1,"text":"Hello, World!","created_at":"2022-12-15T01:31:59.291Z","updated_at":"2022-12-15T01:31:59.291Z","url":"https://xxxx.execute-api.ap-northeast-1.amazonaws.com/messages/1"}]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">curl https://yyyy.execute-api.ap-northeast-1.amazonaws.com/default/messages</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[{"id":1,"text":"Hello, World!","created_at":"2022-12-15T01:31:59.291Z","updated_at":"2022-12-15T01:31:59.291Z","url":"https://yyyy.execute-api.ap-northeast-1.amazonaws.com/default/messages/1"}]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a class="hash-link" href="#まとめ" title="見出しへの直接リンク">​</a></h2><p>今回は、<a href="https://github.com/aws-samples/rails-lambda-handler" target="_blank" rel="noopener noreferrer">AWS Lambda handler sample for Ruby on Rails</a> のサンプルを中心に、Amazon API Gateway + AWS Lambda 環境で Ruby on Rails の Web アプリを稼働させるのに必要な技術的要素を解説しました。ユースケース次第では選択肢になり得ると思いますので、このような事が可能である事を覚えておいて頂ければと思います。</p>]]></content>
        <author>
            <name>Yukinobu Mine</name>
            <uri>https://github.com/Yukinobu-Mine</uri>
        </author>
        <category label="lambda" term="lambda"/>
        <category label="api gateway" term="api gateway"/>
        <category label="ruby on rails" term="ruby on rails"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[新規 AWS アカウントで CodeBuild を利用する際の注意点]]></title>
        <id>codebuild-concurrency</id>
        <link href="https://prototyping-blog.com/blog/codebuild-concurrency"/>
        <updated>2022-12-05T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[AWS のサービスには、新規作成したばかりのアカウントにはデフォルトよりも低い上限を設けているものがあります。今回は、AWS CodeBuild に適用される事がある制限をご紹介します。]]></summary>
        <content type="html"><![CDATA[<p>AWS のサービスには、新規作成したばかりのアカウントにはデフォルトよりも低い上限を設けているものがあります。今回は、AWS CodeBuild に適用される事がある制限をご紹介します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aws-codebuild-とは">AWS CodeBuild とは<a class="hash-link" href="#aws-codebuild-とは" title="見出しへの直接リンク">​</a></h2><p><a href="https://aws.amazon.com/codebuild/" target="_blank" rel="noopener noreferrer">AWS CodeBuild</a> は、フルマネージドなソフトウェア開発環境を提供する Code シリーズのサービスの1つで、ソフトウェアのビルドやテストのフェーズを担当しています。CodeBuild を使う事で、ビルドやテストを実行するためのサーバーの構築や運用から解放され、必要な時に必要なだけのリソースを持つインフラで自動的に実行できるようになります。CodeBuild の詳しい使い方について知りたい方は、<a href="https://youtu.be/Zzv1_ztf-B0" target="_blank" rel="noopener noreferrer">Black Belt Online Seminar</a> の動画を見て頂ければと思います。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aws-codebuild-のビルド同時実行数">AWS CodeBuild のビルド同時実行数<a class="hash-link" href="#aws-codebuild-のビルド同時実行数" title="見出しへの直接リンク">​</a></h2><p>AWS CodeBuild では、複数のビルドを並列で実行する事ができます。例えば、依存関係のないビルドを並列で実行する事でビルドにかかる時間を大きく短縮する事ができますが、同時実行できるビルドの数にはアカウント毎に上限が設けられています。</p><p><a href="https://docs.aws.amazon.com/codebuild/latest/userguide/limits.html" target="_blank" rel="noopener noreferrer">AWS CodeBuild のクォータ</a>のページを見ると、「ビルドの同時実行」のデフォルトの上限は「60」となっていますが、下の方に以下のような注釈が書かれています。(2022年12月現在)</p><blockquote><p>同時実行ビルドの最大数のクォータは、コンピューティングタイプによって異なります。
一部のプラットフォームとコンピューティングタイプでは、デフォルトは 20 です。
新しいアカウントの場合、クォータは最低 5 になります。</p></blockquote><p>コンピューティングタイプについては、<a href="https://docs.aws.amazon.com/codebuild/latest/userguide/build-env-ref-compute-types.html" target="_blank" rel="noopener noreferrer">ビルド環境のコンピューティングタイプ</a>のページをご確認ください。詳細は非公表となっていますが、一部のコンピューティングタイプには異なる上限が設けられています。現在の上限がいくつであるかは、実際に実行してみて「<code>Cannot have more than X builds in queue for the account</code>」といったエラーが出る事でしか確認できません。</p><p>そして、今回の本題である「新規 AWS アカウントに適用される制限」についても記載されており、「新しいアカウントの場合、クォータは最低 5 になります」とありますが、本当に新規作成したばかりのアカウントの場合、制限が 5 ではなく 1 になっている場合があります。そのため、その状態では並列ビルドの機能を使う事ができず、逐次実行させる必要があるという事になります。</p><p>無料枠の範囲内でも構いませんので、AWS サービスの利用実態をある程度積む事でこの制限は解除されるようですが、新規作成した AWS アカウントで CodeBuild の並列実行を行いたい場合はご注意ください。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a class="hash-link" href="#まとめ" title="見出しへの直接リンク">​</a></h2><ul><li>AWS CodeBuild のビルド同時実行数の上限は一律ではなく、条件によって異なる</li><li>新規作成したばかりの AWS アカウントでは、同時実行数の上限が 1 で並列ビルドができない場合がある</li></ul>]]></content>
        <author>
            <name>Yukinobu Mine</name>
            <uri>https://github.com/Yukinobu-Mine</uri>
        </author>
        <category label="codebuild" term="codebuild"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[JenkinsのEC2プラグインは2つある]]></title>
        <id>jenkins-ec2</id>
        <link href="https://prototyping-blog.com/blog/jenkins-ec2"/>
        <updated>2022-12-05T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Jenkins、便利ですよね！ワンストップなCI/CDツールで、オンプレ時代からの愛好家も多いのではないかと思います。]]></summary>
        <content type="html"><![CDATA[<p>Jenkins、便利ですよね！ワンストップなCI/CDツールで、オンプレ時代からの愛好家も多いのではないかと思います。
AWSはJenkinsととても相性が良く、最近も<a href="https://aws.amazon.com/blogs/devops/jenkins-high-availability-and-disaster-recovery-on-aws/" target="_blank" rel="noopener noreferrer">JenkinsのHA構成を実現するブログ</a>が書かれていたり、<a href="https://plugins.jenkins.io/ui/search?query=aws" target="_blank" rel="noopener noreferrer">AWS関連のプラグインも多数公開</a>されていたりします。</p><p>今日はその中でも特に、JenkinsのエージェントノードとしてEC2インスタンスを利用するためのプラグインを紹介します。実はほぼ同じ用途のものが2つあるので、比べてみましょう。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-amazon-ec2-プラグイン">1. <a href="https://plugins.jenkins.io/ec2/" target="_blank" rel="noopener noreferrer">Amazon EC2 プラグイン</a><a class="hash-link" href="#1-amazon-ec2-プラグイン" title="見出しへの直接リンク">​</a></h2><p><a href="https://plugins.jenkins.io/ec2/" target="_blank" rel="noopener noreferrer">Documentation</a> / <a href="https://github.com/jenkinsci/ec2-plugin" target="_blank" rel="noopener noreferrer">GitHub</a></p><p>JenkinsのMasterノードからEC2 APIを叩き、必要に応じてエージェントノードのEC2インスタンスを起動･維持･終了するプラグインです。
Jenkinsエージェントのセットアップ自体はSSH経由で自動的に行われるので、事前のAMI構築が楽になって良いですね。</p><p>より昔からあるプラグインのためユーザー数は多く、また今もしっかりとメンテナンスされているようです。こちらしか知らなかったという方もいるんではないでしょうか。</p><p>内部実装としては、ec2:RunInstance APIを直接叩いてインスタンスを起動するなど、プラグインが自身でインスタンスの管理を行う形になります。
このため、EC2の起動に必要な情報をすべてJenkinsに登録する必要があります。このために、設定項目が多めでやや煩雑な印象も受けました。</p><p>とはいえ枯れていてユーザー数も多いという点で無難な選択肢ではないかと思います。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-ec2-fleet-プラグイン">2. <a href="https://plugins.jenkins.io/ec2-fleet/" target="_blank" rel="noopener noreferrer">EC2 Fleet プラグイン</a><a class="hash-link" href="#2-ec2-fleet-プラグイン" title="見出しへの直接リンク">​</a></h2><p><a href="https://plugins.jenkins.io/ec2-fleet/" target="_blank" rel="noopener noreferrer">Documentation</a> / <a href="https://github.com/jenkinsci/ec2-fleet-plugin" target="_blank" rel="noopener noreferrer">GitHub</a></p><p>機能的には1と大きな違いはありません。EC2インスタンスの起動･終了やSSHによる自動設定も同様に利用可能です。</p><p>大きな違いは、ノードを管理する仕組みとしてAWSマネージドのAuto Scaling Groupを利用していることです。
これにより、プラグイン自体の実装は単純になり、またASGに慣れている人にはより理解しやすい挙動を得られるでしょう。
Allocation strategyなどASGの豊富な機能をそのまま使えるのも魅力です。
<a href="https://plugins.jenkins.io/ec2-fleet/#plugin-content-comparison-to-ec2-plugin" target="_blank" rel="noopener noreferrer">EC2プラグインとのより詳細な比較はこちらにある</a>ので、ぜひご確認ください。</p><p>元々は <code>github.com/awslabs</code> 配下の <a href="https://github.com/awslabs/ec2-spot-jenkins-plugin" target="_blank" rel="noopener noreferrer">ec2-spot-jenkins-plugin</a> というプロジェクトだったようで、AWS公式に提供されていたようです。
コミットログを見る限り、今もAWSやAmazonの開発者が関わっている様子が窺えます。</p><p>また、個人的にはEC2の起動設定 (どのAMIやインスタンスタイプを使うかなど) を、ASGやLaunch templateの設定としてAWS側で持つことができるのも良いと思いました。
これにより、AWS CDKやTerraformなど慣れたIaCツールでそれらの設定を記述することができます。
一方すべてJenkins側で管理したい方もいると思うので、ここは好みの問題かもしれません。</p><p>注意点として、まだ枯れていないせいか、ドキュメントが一部そのまま動かない点がありました。例えばGroovyスクリプトはそのままではエラーになります。
この辺りをカバーするために後ほど動作するサンプルを公開する予定ですので、そちらもぜひ合わせてご確認ください。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="私見">私見<a class="hash-link" href="#私見" title="見出しへの直接リンク">​</a></h2><p>2つの大きな違いは、ノードの管理にAWSマネージドなAuto Scaling Groupを使うか、プラグイン自身が管理するかという点です。</p><p>個人的には、そのような低レベルな処理はできるだけAWSに寄せたほうがプラグイン自体の開発･メンテナンスは楽になるのではと思います。
楽なものは維持されやすいので、サステイナビリティの面ではEC2 Fleetの方が良いかもしれません。(とはいえユーザー数の差は大きいので今は判断が難しいですが)</p><p>一方で、ノードの起動時間などパフォーマンスの面ではEC2プラグインが優れているかもしれません。自前で実装している分、最適化の余地がより大きいためです。
ノード起動時間にシビアな要求がある場合は、こちらに軍配が上がるかもしれません。</p><p>この比較をしていて、似たような話を思い出しました。Amazon EKSのノードのスケーリングの仕組みとして、Cluster Autoscaler(CAS) と Karpenter の2つがあるという話です。
前者はASGを利用し、後者は自前実装でEC2インスタンスを管理します。Karpenterの方が性能が良いなどの理由で、最近は<a href="https://aws.github.io/aws-eks-best-practices/karpenter/" target="_blank" rel="noopener noreferrer">CASより推奨される</a>こともあるようです。
EKSのような汎用基盤ではパフォーマンスが最重要視されるため、ノードをいち早く起動できる後者の選択肢が生まれたのでしょう。</p><p>Jenkinsプラグインの場合はCI/CD用のノードを管理することに特化しているため、ノードの起動時間は最優先ではないとも考えられます。
コミュニティが主導するOSSである都合上、プラグイン自体のメンテナンス性や開発容易性にも優先度が置かれることもあるでしょう。
このため、EC2 Fleetプラグインが後発で登場したのではないでしょうか。</p><p>JenkinsとEKSのノード管理、似たような話でありながら逆の方向に進化しているのが面白いですね。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a class="hash-link" href="#まとめ" title="見出しへの直接リンク">​</a></h2><p>JenkinsのEC2プラグインを2つ紹介しました。
特にまだEC2 Fleetプラグインの知名度はやや低いようなので、ぜひこの機会にお試しください！</p>]]></content>
        <author>
            <name>Masashi Tomooka</name>
            <uri>https://github.com/tmokmss</uri>
        </author>
        <category label="jenkins" term="jenkins"/>
        <category label="ec2" term="ec2"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[React 環境で 3Dmol.js を使う]]></title>
        <id>react-3dmol</id>
        <link href="https://prototyping-blog.com/blog/react-3dmol"/>
        <updated>2022-12-02T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[3dmol.js は分子を立体表示する JavaScript ライブラリです。React 環境で動作させる場合、少しコツが必要でしたので紹介します。]]></summary>
        <content type="html"><![CDATA[<p>3dmol.js は分子を立体表示する JavaScript ライブラリです。React 環境で動作させる場合、少しコツが必要でしたので紹介します。
<a href="https://3dmol.csb.pitt.edu/doc/index.html" target="_blank" rel="noopener noreferrer">https://3dmol.csb.pitt.edu/doc/index.html</a></p><p><img loading="lazy" alt="3dmol.png" src="/assets/images/3dmol-e70bc053c47dc9eafd7bf2b164956572.png" width="1152" height="842" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="react-環境で-3dmoljs-を読み込み分子データを可視化する手順">React 環境で 3Dmol.js を読み込み分子データを可視化する手順<a class="hash-link" href="#react-環境で-3dmoljs-を読み込み分子データを可視化する手順" title="見出しへの直接リンク">​</a></h2><p>jQuery への依存を解決するために <code>3Dmol-min.js</code> を読み込みます。jQuery を読み込んだりバンドル時に解決する方法でも構いません。</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- index.html --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">script</span><span class="token tag" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag" style="color:rgb(255, 121, 198)">  </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">src</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">https://cdnjs.cloudflare.com/ajax/libs/3Dmol/1.4.0/3Dmol-min.js</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag" style="color:rgb(255, 121, 198)">  </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">integrity</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">sha384-G/ktMxNGQtSajNFY+7He9WGWTfkmMrPlEbZbCjtjWLYXpsgvuAkS8Aj8IBjs13yc</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag" style="color:rgb(255, 121, 198)">  </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">crossorigin</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">anonymous</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag" style="color:rgb(255, 121, 198)"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token script"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">script</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>構造データ (pdb) のリンクを state にして、リンク取得時にレンダリングする hook を作成します。3Dmol viewer は構造データをテキストで渡すこともできますが、URL からダウンロードして表示する機能も備わっていますので、そちらを利用しています。</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// npm install 3dmol@^1.8.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// @ts-ignore</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token imports operator">*</span><span class="token imports"> </span><span class="token imports keyword module" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token imports"> $3Dmol</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'3dmol/build/3Dmol-nojquery.js'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">export</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Page</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> pdbViewer </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">useRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">pdbUrl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> setPdbUrl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">useState</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">''</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">useEffect</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">render</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> viewer </span><span class="token operator">=</span><span class="token plain"> $3Dmol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">createViewer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">pdbViewer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">current</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> $3Dmol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">download</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token template-string template-punctuation string" style="color:rgb(255, 121, 198)">`</span><span class="token template-string string" style="color:rgb(255, 121, 198)">url:</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token template-string interpolation">pdbUrl</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token template-string template-punctuation string" style="color:rgb(255, 121, 198)">`</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> viewer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      viewer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">setStyle</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> cartoon</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> color</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'spectrum'</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      viewer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">render</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">pdbUrl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">render</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">pdbUrl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">div</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">ref</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 121, 198)">pdbViewer</span><span class="token tag script language-javascript punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">style</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token tag script language-javascript punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 121, 198)"> height</span><span class="token tag script language-javascript operator" style="color:rgb(255, 121, 198)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 121, 198)"> </span><span class="token tag script language-javascript number" style="color:rgb(255, 121, 198)">500</span><span class="token tag script language-javascript punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token tag script language-javascript" style="color:rgb(255, 121, 198)"> width</span><span class="token tag script language-javascript operator" style="color:rgb(255, 121, 198)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 121, 198)"> </span><span class="token tag script language-javascript number" style="color:rgb(255, 121, 198)">500</span><span class="token tag script language-javascript punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token tag script language-javascript" style="color:rgb(255, 121, 198)"> position</span><span class="token tag script language-javascript operator" style="color:rgb(255, 121, 198)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 121, 198)"> </span><span class="token tag script language-javascript string" style="color:rgb(255, 121, 198)">'relative'</span><span class="token tag script language-javascript" style="color:rgb(255, 121, 198)"> </span><span class="token tag script language-javascript punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token tag script language-javascript punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">div</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="vite-rollup-を利用している場合">Vite (Rollup) を利用している場合<a class="hash-link" href="#vite-rollup-を利用している場合" title="見出しへの直接リンク">​</a></h2><p>3Dmol.js の内部で require を上書きしている箇所があり、その部分が <code>Illegal reassignment to import 'commonjsRequire'</code> と怒られてビルドに失敗します。利用していない箇所のため、下記のように rollup replace plugin でコードを書き換えてビルドすると回避できます。</p><div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> defineConfig </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'vite'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> react </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'@vitejs/plugin-react'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// npm install @rollup/plugin-replace@^5.0.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> replace </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'@rollup/plugin-replace'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">export</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">default</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">defineConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  plugins</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">replace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      preventAssignment</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      include</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'node_modules/3dmol/build/3Dmol-nojquery.js'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      values</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string-property property">'require = _3dmol_saved_require'</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">''</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">react</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Daiki Kuriyama</name>
            <uri>https://github.com/kuridaik</uri>
        </author>
        <category label="react" term="react"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[CDK の NOTICES についてざっと調べてみた]]></title>
        <id>cdk-notices</id>
        <link href="https://prototyping-blog.com/blog/cdk-notices"/>
        <updated>2022-10-20T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[CDK NOTICES とは?]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cdk-notices-とは">CDK NOTICES とは?<a class="hash-link" href="#cdk-notices-とは" title="見出しへの直接リンク">​</a></h2><p><a href="https://github.com/aws/aws-cdk/tree/main/packages/aws-cdk#notices" target="_blank" rel="noopener noreferrer">ここ</a> に説明がありました。</p><blockquote><p>CDK Notices are important messages regarding security vulnerabilities, regressions, and usage of unsupported versions. Relevant notices appear on every command by default.</p></blockquote><p><code>cdk deploy</code> などのコマンドを実行すると、このようなメッセージがでます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">NOTICES</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">21902   apigateway: Unable to serialize value as aws-cdk-lib.aws_apigateway.IModel</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Overview: Users of CDK in any language other than TS/JS cannot use</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                  values that return an instance of a deprecated class.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Affected versions: framework: &gt;=2.41.0 &lt;=2.43.0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        More information at: https://github.com/aws/aws-cdk/issues/21902</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">If you don’t want to see a notice anymore, use "cdk acknowledge &lt;id&gt;". For example, "cdk acknowledge 21902".</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cdk-の-notices-はいつから出るようになった">CDK の NOTICES はいつから出るようになった？<a class="hash-link" href="#cdk-の-notices-はいつから出るようになった" title="見出しへの直接リンク">​</a></h2><p><a href="https://github.com/aws/aws-cdk/releases/tag/v2.14.0" target="_blank" rel="noopener noreferrer">v2.14.0</a> に入っている<a href="https://github.com/aws/aws-cdk/pull/18936" target="_blank" rel="noopener noreferrer">こちらの対応</a> で導入されたようです。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cdk-の-notices-を消すには">CDK の NOTICES を消すには？<a class="hash-link" href="#cdk-の-notices-を消すには" title="見出しへの直接リンク">​</a></h2><ul><li>Affected versions に書かれている通り、CDK のバージョンをアップデートするのが正攻法です。</li><li>CDK のバージョンを都合によってアップデートできない場合、<code>cdk acknowledge &lt;id&gt;</code> で消すこともできます。</li><li>CI で実行していて不要な場合などは <code>--no-notices</code> で非表示にすることも可能です。</li><li>プロジェクト単位で NOTICES 対応が不要な場合は、cdk.json に <code>notices: false</code> を追加することで消すこともできます。</li></ul><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>ちなみに NOTICES を明示的に表示する <code>cdk notices</code> というコマンドがあるのですが、<code>cdk notices --no-notices</code> を実行したところ、NOTICES は表示されませんでした。</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一度消した-notices-をもう一度出すためには">一度消した NOTICES をもう一度出すためには？<a class="hash-link" href="#一度消した-notices-をもう一度出すためには" title="見出しへの直接リンク">​</a></h2><p>CDK の NOTICES は <code>$HOME/.cdk/cache/notices.json</code> に状態が保存されているようです。
よって、これまで acknowledge した NOTICES は全てこちらで管理されています。
該当する項目を消すことで、筆者の手元で NOTICES がもう一度表示されることが確認できました。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="複数のプロジェクトを運用している場合は注意が必要">複数のプロジェクトを運用している場合は注意が必要<a class="hash-link" href="#複数のプロジェクトを運用している場合は注意が必要" title="見出しへの直接リンク">​</a></h2><p>CDK の NOTICES がユーザー単位で注目されていることに注意が必要です。</p><p>例えば、とあるプロジェクトには不要で、とあるプロジェクトには必要な NOTICES があった場合、不用意に <code>cdk acknowledge</code> をしてしまうと、必要なプロジェクトでも見えなくなります。
そのようなケースでは、根本原因である CDK のバージョンアップ、<code>--no-notices</code> フラグ、cdk.json の <code>notices: false</code> で対応するのが良いでしょう。</p><p>また、CDK のバージョンアップを行うと NOTICES が見えなくなりますが、実態としては自動的に <code>cdk acknowledge</code> されているようです。
つまり複数のプロジェクトに NOTICES がでていても、1 つのプロジェクトで対応すると見えなくなり、対応していないプロジェクトが放置される原因になります。
よって、CDK をアップデートする際は、同時に行うのが良いでしょう。</p>]]></content>
        <author>
            <name>Taichiro Suzuki</name>
            <uri>https://github.com/tbrand</uri>
        </author>
        <category label="cdk" term="cdk"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[閉域網でサーバレスなアプリケーションを開発する]]></title>
        <id>closed-serverless-app</id>
        <link href="https://prototyping-blog.com/blog/closed-serverless-app"/>
        <updated>2022-10-03T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[はじめに]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="はじめに">はじめに<a class="hash-link" href="#はじめに" title="見出しへの直接リンク">​</a></h2><p>昨今、DX (Digital Transformation)に代表されるように、あらゆる業界・企業において IT 技術を駆使した業務変革のニーズが高まっています。その中で社内の変化を促すにあたり、既存の社内システムと連携が必要になるケースがあるかと思います。しかしこのような変革を担う部署では、PoC を実施し素早い成果創出を求められることが多い一方で、予算確保や保守・運用に関する社内調整が煩雑になり、スピード感を持って進めることが難しいと感じたご経験を持つ方もいらっしゃると思います。本記事は上記のような悩みを持っている方の助けになることを目指して執筆致しました。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="背景">背景<a class="hash-link" href="#背景" title="見出しへの直接リンク">​</a></h2><p>ゼロトラストによるセキュリティ対策が登場し久しいですが、多くのエンタープライズ企業ではまだ境界型セキュリティが主流であり、社内ネットワークと外部ネットワーク（例えばインターネットなど）の境界に、ファイアウォール等を設置しネットワークレイヤーでアクセス制限をかけているケースが多いと思います。特にプロキシを経由した社内ネットワークからインターネットへ出る outbound の通信は許可されている一方で、インターネットから社内イントラへの inboud は厳禁など、クライアントからインターネット経由でのサーバへのアクセスは許可されていないこともあるかと思います。このような制約があるため、既存の社内システム（ERP、Active Directory などの何らかの管理システム）と連携が必要なシステムを AWS 上に構築する場合、<a href="https://aws.amazon.com/jp/directconnect/" target="_blank" rel="noopener noreferrer">AWS Direct Connect</a>による閉域環境を構成した上で、EC2 や RDS などを使い開発していくケースが多いかと思います。</p><p><img loading="lazy" alt="background" src="/assets/images/background-63acea9a7e5f60fa74068f5e3dcd56dd.png" width="471" height="671" class="img_ev3q"></p><p>一方 EC2 や RDS を使った PoC では、下記のような課題が発生することがあります。</p><ul><li>料金：基本的に使用時間に基づいた課金のため、社内システムのようにアクセス量の比較的少ないシステムの場合、リクエスト数と実行時間で課金される<a href="https://aws.amazon.com/jp/lambda/" target="_blank" rel="noopener noreferrer">AWS Lambda</a>などと比較し高くつくことがあります。PoC 予算は限られている傾向にあるため、これは PJ を進める上で障害となる可能性があります。</li><li>運用・保守：EC2 は各社社内ルールの規定上、従来の物理サーバやプライベートクラウドと同様の保守・運用プロセスが求められることがあります（参考：<a href="https://aws.amazon.com/jp/compliance/shared-responsibility-model/" target="_blank" rel="noopener noreferrer">責任共有モデル</a>）。これは運用・保守人材確保のための社内調整や、人件費予算が必要となることを意味します。</li></ul><p>上記のような課題は、サーバレス構成を採用することで解決が見込める一方、閉域網でのサーバレス構成に関する情報は散逸的であり、いざ開発に取り掛かると時間がかかったり、苦労することもあるかと思います。このため、参考となるようなサンプル：<a href="https://github.com/aws-samples/serverless-application-on-closed-network" target="_blank" rel="noopener noreferrer">serverless-application-on-closed-network</a>を公開しました。下記にそのアーキテクチャを示します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="アーキテクチャ">アーキテクチャ<a class="hash-link" href="#アーキテクチャ" title="見出しへの直接リンク">​</a></h2><p><img loading="lazy" alt="arch" src="/assets/images/arch-427a357caa9bd41f4f4d97ae281690e1.png" width="968" height="491" class="img_ev3q"></p><p>フロントエンド・バックエンド・RDB からなる典型的な３層構成を想定したアーキテクチャであり、フロントエンド (html/css/js)は S3 から配信、バックエンドは API Gateway + AWS Lambda の組み合わせを想定しています。フロントエンドは静的ファイルであり、SPA (e.g. React、Vue)を想定しています。 S3 および API Gateway は VPC Endpoint によりインターネットを経由せずにアクセスが可能です。なおバックエンドを Fargate 上で稼働するサンプルも併せて公開しているため、既存のアプリケーションがコンテナで稼働している場合はそのままお使いいただけます（※Fargate は稼働時間による課金である点はご留意ください）。なお簡便のため RDB は今回のサンプルの中に含めていません。</p><p>図中左側の VPC は Transit Gateway や VPC Peering によって接続された他 VPC のほか、Direct Connect によって接続された社内のイントラネットを想定した検証用環境です。アプリケーション稼働確認用の Windows Server を立ち上げるためだけに存在していますので、他環境にて確認できる場合は不要となります。デプロイおよび確認の詳細な手順については <a href="https://github.com/aws-samples/serverless-application-on-closed-network" target="_blank" rel="noopener noreferrer">Github のリポジトリ</a>をご参照ください。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="おわりに">おわりに<a class="hash-link" href="#おわりに" title="見出しへの直接リンク">​</a></h2><p>サーバレスコンピューティングは、従来かかっていた運用負荷を下げるための良い解法の一つです。人的資源の限られる中で変革を遂げるにあたり、ぜひ閉域ネットワーク内においても AWS のサーバレスな仕組みを積極的にご活用いただければ幸いです。</p>]]></content>
        <author>
            <name>Takehiro Suzuki</name>
            <uri>https://github.com/statefb</uri>
        </author>
        <category label="dx" term="dx"/>
        <category label="closed" term="closed"/>
        <category label="serverless" term="serverless"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Amazon CloudWatch RUM で月次アクセス数を集計してみた]]></title>
        <id>cloudwatch-rum-stats</id>
        <link href="https://prototyping-blog.com/blog/cloudwatch-rum-stats"/>
        <updated>2022-09-16T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[概要]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a class="hash-link" href="#概要" title="見出しへの直接リンク">​</a></h2><p>本記事では、<a href="https://console.aws.amazon.com/cloudwatch/home#rum:dashboard?tab=overview" target="_blank" rel="noopener noreferrer">Amazon CloudWatch RUM</a> を利用した月次アクセス数の集計方法を実際のコードと合わせて紹介します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="amazon-cloudwatch-rum-とは">Amazon CloudWatch RUM とは<a class="hash-link" href="#amazon-cloudwatch-rum-とは" title="見出しへの直接リンク">​</a></h2><p><img loading="lazy" alt="overview" src="/assets/images/overview-df77b9364aace37c8d598cedeb14f07e.png" width="1532" height="498" class="img_ev3q"></p><p>Amazon CloudWatch RUM は、Web アプリケーションのモニタリングサービスです。簡単な JavaScript のスニペットをサイトに追加するだけで、ユーザーが使っているブラウザ、アクセス元の地域、パフォーマンスなどを取得し、可視化してくれます。利用方法は極めて簡単で、<a href="https://console.aws.amazon.com/cloudwatch/home#rum:dashboard?tab=overview" target="_blank" rel="noopener noreferrer">Amazon CloudWatch RUM</a> のページを開き、右上の「Add app monitor」をクリックしてサイト名とドメイン名を入力すれば基本的な設定は完了です。<strong>後述する集計を行う場合は「Data storage」を有効にしてログを出力するようにしてください。</strong>テスト用のローカル環境であれば、ドメインは localhost で構いません。</p><p>作成するとスニペットが出力されるので、それをサイトに追加しましょう。追加された状態でサイトにアクセスし、Amazon CloudWatch RUM の Overview をご覧ください。「Page loads」などでアクセスが確認できれば正常に設定できています。</p><p>Jekyll で構成されたサイトの場合、次のように設定すれば本番環境と開発環境でスニペットを分けることができます。</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {% if jekyll.environment == "development" %}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">script</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token script language-javascript">      </span><span class="token script language-javascript comment" style="color:rgb(98, 114, 164)">// 開発環境のスニペット</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token script language-javascript">      </span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token script language-javascript keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token script language-javascript parameter">n</span><span class="token script language-javascript parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token script language-javascript parameter">i</span><span class="token script language-javascript parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token script language-javascript parameter">v</span><span class="token script language-javascript parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token script language-javascript parameter">r</span><span class="token script language-javascript parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token script language-javascript parameter">s</span><span class="token script language-javascript parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token script language-javascript parameter">c</span><span class="token script language-javascript parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token script language-javascript parameter">x</span><span class="token script language-javascript parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token script language-javascript parameter">z</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token script language-javascript">      </span><span class="token script language-javascript comment" style="color:rgb(98, 114, 164)">// ...省略...</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token script language-javascript">          </span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token script language-javascript">      </span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token script language-javascript">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">script</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {% else %}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">script</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token script language-javascript">      </span><span class="token script language-javascript comment" style="color:rgb(98, 114, 164)">// 本番環境のスニペット</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token script language-javascript">      </span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token script language-javascript keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token script language-javascript parameter">n</span><span class="token script language-javascript parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token script language-javascript parameter">i</span><span class="token script language-javascript parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token script language-javascript parameter">v</span><span class="token script language-javascript parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token script language-javascript parameter">r</span><span class="token script language-javascript parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token script language-javascript parameter">s</span><span class="token script language-javascript parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token script language-javascript parameter">c</span><span class="token script language-javascript parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token script language-javascript parameter">x</span><span class="token script language-javascript parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token script language-javascript parameter">z</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token script language-javascript">      </span><span class="token script language-javascript comment" style="color:rgb(98, 114, 164)">// ...省略...</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token script language-javascript">          </span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token script language-javascript">      </span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token script language-javascript">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">script</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {% endif %}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="マネージメントコンソールでの集計テスト">マネージメントコンソールでの集計テスト<a class="hash-link" href="#マネージメントコンソールでの集計テスト" title="見出しへの直接リンク">​</a></h2><p>Amazon CloudWatch RUM にはさまざまな機能があるのですが、ここではログの集計にフォーカスします。月次にそれぞれのページにどれくらいアクセスがあったか投稿する Bot を作成しましょう。まずは <a href="https://console.aws.amazon.com/cloudwatch/home#logsV2:log-groups" target="_blank" rel="noopener noreferrer">Amazon CloudWatch Logs</a> を開いて、該当の Log group を探します。Log group は <code>/aws/vendedlogs/RUMService_&lt;サイト名&gt;&lt;ランダム文字列&gt;</code> の形式になっていますので、検索ボックスから探してみてください。さまざまな Event が記録されていると思います。以下に一例を示します。(一部の項目は無効な値に置き換えています。)</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"event_timestamp"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1663290527000</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"event_type"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"com.amazon.rum.page_view_event"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"event_id"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"event_version"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"1.0.0"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"log_stream"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"2022-09-15T18"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"application_id"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"application_version"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"1.0.0"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"metadata"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"version"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"1.0.0"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"browserLanguage"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"en"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"browserName"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Chrome"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"browserVersion"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"0.0.0.0"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"osName"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Mac OS"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"osVersion"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"0.0.0"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"deviceType"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"desktop"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"platformType"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"web"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"domain"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"aws-samples.github.io"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"title"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Home | AWS Prototyping ブログ"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"pageId"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"/jp-prototyping-blog/"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"countryCode"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"JP"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"subdivisionCode"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"13"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"user_details"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"sessionId"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"00000000-0000-0000-0000-000000000000"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"userId"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"00000000-0000-0000-0000-000000000000"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"event_details"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"version"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"1.0.0"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"pageId"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"/jp-prototyping-blog/"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>大事な項目をピックアップします。まず、event_timestamp にはイベントを受信した Unixtime が記録されています。次に、event_type が com.amazon.rum.page_view_event なので、ページを開いたというイベントであることがわかります。集計する際には event_type が com.amazon.rum.page_view_event のものをページごとに集計すれば良いことがわかります。metadata 以下にはユーザーのさまざまな情報が記録されています。</p><p>では、<a href="https://console.aws.amazon.com/cloudwatch/home#logsV2:logs-insights" target="_blank" rel="noopener noreferrer">Amazon CloudWatch の Logs Insights</a> で集計してみようと思います。Log group に該当のものを選択し、Query を以下のように入力します。右上の集計期間内にログが存在しないと結果が正しく表示されない可能性があるため、注意してください。(不明な場合は、とりあえず最大の 4 weeks を選択してみてください。)</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">filter event_type = "com.amazon.rum.page_view_event"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| stats count(*) as pageCount by metadata.title as pageTitle</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| sort pageCount desc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以下のような結果が出力されましたでしょうか。Home や About、404 などの結果も入ってしまっていますが、ここでは一旦アプリケーションレベルでフィルタリングすることにします。</p><p><img loading="lazy" alt="insights" src="/assets/images/insights-3ad177989e76e2f63e3401c1db78a352.png" width="1508" height="374" class="img_ev3q"></p><p>では、この実行の流れをコードに落とし込みたいと思います。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="python-による集計">Python による集計<a class="hash-link" href="#python-による集計" title="見出しへの直接リンク">​</a></h2><p>boto3 を利用して Query を実行します。まず、クエリ探索範囲の指定に Unixtime が必要です。ここでは約 1 ヶ月ということにします。</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> datetime</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">today </span><span class="token operator">=</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">date</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">today</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">month </span><span class="token operator">=</span><span class="token plain"> today </span><span class="token operator">-</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">timedelta</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">30</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>これで今日と 1 ヶ月前の datetime が取得できました。あとは <code>strftime("%s")</code> によって Unixtime に変換できます。では boto3 の logs クライアントを初期化して、<code>start_query</code> を実行してみます。<code>&lt;Log group名&gt;</code> となっているところは置き換えが必要です。</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> boto3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">client </span><span class="token operator">=</span><span class="token plain"> boto3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">client</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'logs'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">query </span><span class="token operator">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">start_query</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    logGroupName</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">'&lt;Log group名: 例 /aws/vendedlogs/RUMService_...&gt;'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    startTime</span><span class="token operator">=</span><span class="token builtin" style="color:rgb(189, 147, 249)">int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">month</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">strftime</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"%s"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    endTime</span><span class="token operator">=</span><span class="token builtin" style="color:rgb(189, 147, 249)">int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">today</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">strftime</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"%s"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    queryString</span><span class="token operator">=</span><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">"""filter event_type = "com.amazon.rum.page_view_event"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">    | stats count(*) as pageCount by metadata.title as pageTitle</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">    | sort pageCount desc"""</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">print</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">query</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>正常に実行完了すると以下のように出力されます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{'queryId': 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', 'ResponseMetadata': ... 省略 ...}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>クエリの実行は非同期ですので、この queryId をポーリングすることにより実行結果を得ます。</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> time</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">while</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    res </span><span class="token operator">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">get_query_results</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">queryId</span><span class="token operator">=</span><span class="token plain">query</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'queryId'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> res</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'status'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Running'</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">and</span><span class="token plain"> res</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'status'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Scheduled'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">sleep</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> res</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'status'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Complete'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">print</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'status for the query was not Complete'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> res</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    exit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">print</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">res</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>結果は以下のようになっていると思います。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{'results': [[{'field': 'pageTitle', 'value': 'ページタイトル'}, {'field': 'pageCount', 'value': '104'}],... 省略 ...]], 'statistics': {'recordsMatched': 193.0, 'recordsScanned': 2034.0, 'bytesScanned': 2139385.0}, 'status': 'Complete', 'ResponseMetadata': ... 省略 ...}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>一つ一つの項目が <code>[{'field': 'field名', 'value': '値'}]</code> となっているのが少し扱いづらいので、これを <code>{ 'field名': '値' }</code> となるように変換します。</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">formatFields</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">fields</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    pageTitle </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">next</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">filter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">lambda</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'field'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'pageTitle'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> fields</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    pageCount </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">next</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">filter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">lambda</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'field'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'pageCount'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> fields</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'title'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> pageTitle</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'value'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'count'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> pageCount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'value'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">print</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">list</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">map</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">formatFields</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> res</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'results'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>これで出力が <code>[{ 'title': 'ページタイトル', 'count': '閲覧数' }...]</code> のようになりました。また、Home や About などのページを対象外にします。ここでは Python レベルでフィルタリングしていますが、Amazon CloudWatch RUM の設定でページを排除することも可能ですし、Amazon CloudWatch Logs Insigts のクエリで排除することもできます。</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># ページタイトルが Home, About, Archive, 404 で始まる物を対象外とする</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">filterPosts</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">post</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> post</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'title'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">startswith</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'Home | '</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">and</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> post</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'title'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">startswith</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'About | '</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">and</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> post</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'title'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">startswith</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'Archive | '</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">and</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> post</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'title'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">startswith</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'404: '</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">print</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">list</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">filter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">filterPosts</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">map</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">formatFields</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> res</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'results'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上で各ページの 1 ヶ月の閲覧数が取得できました！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="おわりに">おわりに<a class="hash-link" href="#おわりに" title="見出しへの直接リンク">​</a></h2><p>あとはこれを Lambda 関数にして Slack に定期的に投稿するなどすれば、立派な集計 Bot の完成です！Lambda 化する場合は、十分な実行時間を確保できるタイムアウトに設定するのと、権限に注意してください。Lambda 関数から対象の CloudWatch Log Group に <code>logs:StartQuery</code> と <code>logs:GetQueryResults</code> が許可されている必要があります。</p>]]></content>
        <author>
            <name>Taichiro Suzuki</name>
            <uri>https://github.com/tbrand</uri>
        </author>
        <category label="cloudwatch" term="cloudwatch"/>
        <category label="rum" term="rum"/>
        <category label="stats" term="stats"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[AWS Samples の Simple NFT Marketplace を触ってみた]]></title>
        <id>simple-nft-marketplace</id>
        <link href="https://prototyping-blog.com/blog/simple-nft-marketplace"/>
        <updated>2022-08-10T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[概要]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a class="hash-link" href="#概要" title="見出しへの直接リンク">​</a></h2><p>本記事では、<a href="https://github.com/aws-samples/simple-nft-marketplace" target="_blank" rel="noopener noreferrer">github.com/aws-samples/simple-nft-marketplace</a> というサンプルプロジェクトの動作をざっと確認してみたいと思います。Simple NFT Marketplace はその名の通り、シンプルな NFT のマーケットプレイスです。ただし、<a href="https://opensea.io/" target="_blank" rel="noopener noreferrer">OpenSea</a> のように <a href="https://metamask.io/" target="_blank" rel="noopener noreferrer">MataMask</a> と連携させた完全な非中央集権的なマーケットプレイスではなく、アカウント登録が必要で、かつ、ウォレットをシステム側で管理するマーケットプレイスです。ただ、ERC-721 の規格に則っていますので、Simple NFT Marketplace で作成した NFT を OpenSea に陳列するといったことも可能です。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="simple-nft-marketplace-の環境構築について">Simple NFT Marketplace の環境構築について<a class="hash-link" href="#simple-nft-marketplace-の環境構築について" title="見出しへの直接リンク">​</a></h2><p>構築方法については <a href="https://github.com/aws-samples/simple-nft-marketplace/tree/main/docs/ja" target="_blank" rel="noopener noreferrer">ドキュメント</a> をご参照ください。方法は 2 通り存在していて、1 つは deploy.js というスクリプトを利用した簡単な手順、もう一つは Step-by-Step で構築する手順です。<strong>いずれの場合も Ethereum Ropsten の Ethereum が必要です。インターネット上のサービスを活用して、事前にトークンを取得しておいてください。「Ropsten Ethereum Faucet」などで検索すると見つかります。</strong> (Ethereum Ropsten は Ethereum のテストネットです。Simple NFT Marketplace の Contract はデフォルトで Ropsten にデプロイされます。)</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="動作確認">動作確認<a class="hash-link" href="#動作確認" title="見出しへの直接リンク">​</a></h2><p>では構築が完了した Simple NFT Marketplace にアクセスしてみます。まず、最初にサインイン/アカウント登録画面が表示されます。</p><p><img loading="lazy" alt="web01" src="/assets/images/web01-7c681820c1597c0a5fa0e5856cd8cb5f.png" width="481" height="497" class="img_ev3q"></p><p>初回なので、アカウントを作成しましょう。</p><p><img loading="lazy" alt="web02" src="/assets/images/web02-60477f2421653ef445307dd0dd867cca.png" width="1917" height="944" class="img_ev3q"></p><p>アカウント登録が完了 or サインインが完了すると、トップページに遷移します。とてもシンプルな UI ですが、大きく 2 つの機能があることがわかります。1 つは NFT を作成する機能、もう 1 つは NFT を表示する機能です。後者の画面で NFT の売買も可能です。また、右上の Account ページでアカウント情報を確認できます。</p><p><img loading="lazy" alt="web03" src="/assets/images/web03-9cb7da35acadc14aa17aace518b99d2a.png" width="732" height="312" class="img_ev3q"></p><p>こちらがアカウントページで表示されている情報です。ユーザー名 (taichirs)、ウォレットの Public Address、Balance (残高) が表示されています。Private Key は下部の Retrieve ボタンを押下すると表示されます。この Private Key は MetaMask などの外部ウォレットに Export することも可能です。また、サインアウトもここから行います。Private Key をユーザーに渡さない用に実装を変更すれば、サービス側で完全にウォレットを管理するということになります。</p><p><img loading="lazy" alt="web04" src="/assets/images/web04-723b2beb271fdd6a31f60fe2a322b1db.png" width="1294" height="572" class="img_ev3q"></p><p>では Create NFT から最初の NFT を作成してみようと思います。Simple NFT Marketplace では、画像を NFT として登録する機能を提供しています。適当な画像をアップロードし、タイトルと説明を記入します。Royalty Percentage は、NFT の発行者に支払われるロイヤリティの設定です。例えばデフォルトの 5 %を設定した場合、NFT が売買されるたびに売買代金の 5 %が発行者に支払われます。ここで言う発行者は、売買する度に変わるオーナーとは別で、最初に NFT を作成したアカウントになります。発行者は NFT 作成後に変更できない仕様です。(変更できるように実装することも可能です。) 一通り入力したら CREATE ボタンを押下してください。暫く待つと、NFT の詳細ページに遷移します。</p><p><img loading="lazy" alt="web05" src="/assets/images/web05-4a055918880d98e89465c6fe75ca20d4.png" width="1221" height="760" class="img_ev3q"></p><p>こちらが NFT の詳細ページです。Metadata として Token ID が払い出されています。Token ID は 1 から始まり、NFT が発行されるたびにインクリメントされる仕様です。Owner は今ログイン中のアカウントの Public Address になります。続いて Marketplace の情報です。Listing が false なので、現在この NFT は陳列されてません。(= 売買することができません。) Publisher (発行者) は Owner と同じアカウントで、Royalty は 5 %で設定されています。</p><p><img loading="lazy" alt="web06" src="/assets/images/web06-787725a6e63022db7119fdb0f8e5072c.png" width="1287" height="540" class="img_ev3q"></p><p>下部にスクロールすると、Marketplace と Transfer の機能が使えます。前者は、値段を設定した上で Marketplace に NFT を陳列する機能です。後者は、売買とは別に、NFT を転送する (= Owner を変更する) 機能です。では、Marketplace の機能で、発行した NFT を陳列してみます。適当な Price を入力し、Set price ボタンを押下してください。</p><p><img loading="lazy" alt="web07" src="/assets/images/web07-cc45b1d56463325b14cdd6b8983f3d78.png" width="408" height="233" class="img_ev3q"></p><p>陳列が完了すると、Listing が true になり、Price が設定されていることが確認できます。この状態であれば、売買が可能です。</p><p><img loading="lazy" alt="web08" src="/assets/images/web08-611200421a78f5d72ca73f6fda1d906a.png" width="357" height="136" class="img_ev3q"></p><p>この状態で下部にスクロールすると、先程は値段を設定する UI だったところが、今度は陳列を取り下げる機能に変わっています。Remove を押下すると陳列を取り下げます。</p><p><img loading="lazy" alt="web09" src="data:image/png;base64,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" width="165" height="147" class="img_ev3q"></p><p>では、NFT を購入してみます。別のアカウントでログインし、先程発行した NFT の詳細ページを開きます。下部にスクロールすると、Purchase という機能が表示されていると思います。Price を確認して、Purchase ボタンを押下してください。購入が完了すると、自動でページがリロードされます。なお、購入するアカウントの Balance が NFT の値段よりも多いことを事前に確認してください。</p><p><img loading="lazy" alt="web10" src="/assets/images/web10-03e9eb81aabb839ce23cd25881a02e59.png" width="412" height="494" class="img_ev3q"></p><p>こちらが購入後の NFT の詳細ページの情報です。ご覧の通り、Owner のアドレスが変更されました。購入直後は陳列から外されるため、Marketplace の Listing は false になります。また前述したとおり、Publisher は変わっていないことを確認してください。</p><p>以上で売買を含む Simple NFT Marketplace の機能の紹介は終了です！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="おわりに">おわりに<a class="hash-link" href="#おわりに" title="見出しへの直接リンク">​</a></h2><p>Simple NFT Marketplace では秘密鍵を DynamoDB で管理しています。AWS KMS を利用すると、システムの運用者ですら秘密鍵を取り出すことができなくなり、よりセキュアです。方法は以下をご参照ください。</p><ul><li><a href="https://aws.amazon.com/jp/blogs/database/how-to-sign-ethereum-eip-1559-transactions-using-aws-kms/" target="_blank" rel="noopener noreferrer">How to sign Ethereum EIP-1559 transactions using AWS KMS</a></li></ul>]]></content>
        <author>
            <name>Taichiro Suzuki</name>
            <uri>https://github.com/tbrand</uri>
        </author>
        <category label="nft" term="nft"/>
        <category label="blockchain" term="blockchain"/>
        <category label="ethereum" term="ethereum"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[AWS CDK で静的サイトをデプロイする (CloudFront + S3 + CF2)]]></title>
        <id>cdk-static-website</id>
        <link href="https://prototyping-blog.com/blog/cdk-static-website"/>
        <updated>2022-08-04T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[はじめに]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="はじめに">はじめに<a class="hash-link" href="#はじめに" title="見出しへの直接リンク">​</a></h2><p>静的 Web サイトを AWS CDK を使い、CloudFront + S3 の構成でデプロイ方法について説明します。この組み合わせは定番なのでいろいろな所で紹介されていますが、
情報が古くなってしまっているものもあるため2022年8月の時点で良さそうだと思った作り方を紹介します。</p><p>CDK アプリのソースコード全体は <a href="https://github.com/kudtomoy/aws-cdk-samples/tree/main/static-website" target="_blank" rel="noopener noreferrer">GitHub</a> で公開しています。この記事では、今回の CDK アプリの書き方のポイントや理由について説明していきます。</p><p>使用した Node.js と CDK のバージョンは以下になります:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">node</span><span class="token plain"> --version</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">v16.14.0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ cdk --version</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">2.28</span><span class="token plain">.1 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">build d035432</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ホストゾーンと証明書の情報を-parameter-store-から取得する">ホストゾーンと証明書の情報を Parameter Store から取得する<a class="hash-link" href="#ホストゾーンと証明書の情報を-parameter-store-から取得する" title="見出しへの直接リンク">​</a></h2><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> recordName </span><span class="token operator">=</span><span class="token plain"> ssm</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">StringParameter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">valueFromLookup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string" style="color:rgb(255, 121, 198)">'/static-website/record-name'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> domainName </span><span class="token operator">=</span><span class="token plain"> ssm</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">StringParameter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">valueFromLookup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string" style="color:rgb(255, 121, 198)">'/static-website/domain-name'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> certificateArn </span><span class="token operator">=</span><span class="token plain"> ssm</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">StringParameter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">valueFromLookup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string" style="color:rgb(255, 121, 198)">'/static-website/certificate-arn'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>AWS マネジメントコンソール上で Amazon Route53 のホストゾーンと AWS Certificate Manager (ACM) の証明書をあらかじめ作成しておき、それらの情報を AWS Systems Manager の Parameter Store に保存して、テンプレート生成時に読み込んでいます。</p><p>今回 CDK でホストゾーンや証明書を管理しなかった理由は以下です:</p><ul><li>ドメインの取得や移管には手作業が発生するし、何度も繰り返す作業ではない</li><li>Amazon CloudFront で ACM の証明書を使用するには証明書が <code>us-east-1</code> リージョンで発行されている必要があり、クロススタック参照になって手間が増える</li></ul><p>ACM も CDK で管理したい場合は <a href="https://dev.classmethod.jp/articles/cdk-remote-stack-for-acm-and-cloudfront/" target="_blank" rel="noopener noreferrer">AWS CDK（cdk-remote-stack）でACMとCloudFrontのクロスリージョン参照を実装する</a> の記事が参考になると思います。</p><p>また ARN 等をソースコードに書きたくなかったので Parameter Store を利用しましたが、ここはお好みでベタ書きしたり、CDK の Context を利用するなどしても良いと思います。Parameter Store を利用する場合は AWS CLI で以下のように値を保存します。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">aws ssm put-parameter --type </span><span class="token string" style="color:rgb(255, 121, 198)">'String'</span><span class="token plain"> --name </span><span class="token string" style="color:rgb(255, 121, 198)">'/static-website/record-name'</span><span class="token plain"> --value </span><span class="token string" style="color:rgb(255, 121, 198)">'sample.com'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">aws ssm put-parameter --type </span><span class="token string" style="color:rgb(255, 121, 198)">'String'</span><span class="token plain"> --name </span><span class="token string" style="color:rgb(255, 121, 198)">'/static-website/domain-name'</span><span class="token plain"> --value </span><span class="token string" style="color:rgb(255, 121, 198)">'sample.com'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">aws ssm put-parameter --type </span><span class="token string" style="color:rgb(255, 121, 198)">'String'</span><span class="token plain"> --name </span><span class="token string" style="color:rgb(255, 121, 198)">'/static-website/certificate-arn'</span><span class="token plain"> --value </span><span class="token string" style="color:rgb(255, 121, 198)">'arn:aws:acm:us-east-1:xxxx:certificate/xxxx'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="s3-origin--origin-access-identity-を使用する">S3 Origin + Origin Access Identity を使用する<a class="hash-link" href="#s3-origin--origin-access-identity-を使用する" title="見出しへの直接リンク">​</a></h2><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> bucket </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">s3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Bucket</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Bucket'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      autoDeleteObjects</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      removalPolicy</span><span class="token operator">:</span><span class="token plain"> RemovalPolicy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token constant" style="color:rgb(189, 147, 249)">DESTROY</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> originAccessIdentity </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">cloudfront</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">OriginAccessIdentity</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string" style="color:rgb(255, 121, 198)">'OriginAccessIdentity'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> bucketPolicyStatement </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">iam</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">PolicyStatement</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      actions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'s3:GetObject'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      effect</span><span class="token operator">:</span><span class="token plain"> iam</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Effect</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token constant" style="color:rgb(189, 147, 249)">ALLOW</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      principals</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">iam</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">CanonicalUserPrincipal</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          originAccessIdentity</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">cloudFrontOriginAccessIdentityS3CanonicalUserId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      resources</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token template-string template-punctuation string" style="color:rgb(255, 121, 198)">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token template-string interpolation">bucket</span><span class="token template-string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token template-string interpolation">bucketArn</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token template-string string" style="color:rgb(255, 121, 198)">/*</span><span class="token template-string template-punctuation string" style="color:rgb(255, 121, 198)">`</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    bucket</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">addToResourcePolicy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">bucketPolicyStatement</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>CloudFront 経由 で Amazon S3 のデータを配信する方法は2種類あります:</p><ol><li>CloudFront のオリジンに S3 バケットそのものを指定する</li><li>CloudFront のオリジンに S3 バケットの Static website hosting のエンドポイントを指定する</li></ol><p>今回は S3 に直接アクセスされたくなかったので Static website hosting を有効にせず、Origin Access Identity(OAI) を作成して CloudFront からのみアクセスできる1の構成にしました。</p><p>この場合、デフォルトルートオブジェクトのファイル名 (<code>index.html</code>) をディストリビューションで指定しているオリジンのルートにしか設定できません。たとえば <code>https://sample.com/posts/</code> にアクセスすると <code>https://sample.com/posts/index.html</code> は表示されずに403エラーになります。この問題は次の CloudFront Functions で解決します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cloudfront-functions-でファイル名を含まない-url-に対応する">CloudFront Functions でファイル名を含まない URL に対応する<a class="hash-link" href="#cloudfront-functions-でファイル名を含まない-url-に対応する" title="見出しへの直接リンク">​</a></h2><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> rewriteUrlFunction </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">cloudfront</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Function</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string" style="color:rgb(255, 121, 198)">'RewriteUrlFunction'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        functionName</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'rewrite-url'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        code</span><span class="token operator">:</span><span class="token plain"> cloudfront</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">FunctionCode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">fromFile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          filePath</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'functions/rewrite-url/index.js'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>functions/rewrite-url/index.js</code> は <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/example-function-add-index.html" target="_blank" rel="noopener noreferrer">公式ドキュメント</a> のコードをそのまま使用しています:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">handler</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> request </span><span class="token operator">=</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> uri </span><span class="token operator">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">uri</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Check whether the URI is missing a file name.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">uri</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">endsWith</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'/'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">uri</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'index.html'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Check whether the URI is missing a file extension.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token plain">uri</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">includes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'.'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">uri</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'/index.html'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ファイル名を含まない URL でアクセスされた時に <code>index.html</code> を返せるように CloudFront Functions (CF2) を設定します。CF2 は GA が比較的最近 (2021年5月) だったこともあり、同じことを Lambda@Edge でやっている例がよく紹介されています。 1回あたりの呼び出しは CF2 の方が安くレイテンシも小さいですが、Lambda@Edge は CloudFront のキャッシュにヒットしなかった場合のみ実行できるという利点があり、このあたりの選択はお好みだと思います。</p><p>Lambda@Edge を利用する場合は Lambda を <code>us-east-1</code> にデプロイする必要があり、CDK でやろうとするとクロススタック参照をする必要があります。この場合は Experimental ではありますが <a href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_cloudfront.experimental.EdgeFunction.html" target="_blank" rel="noopener noreferrer">EdgeFunction</a> を使うとかんたんに書くことができます。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cloudfrontwebdistribution-ではなく-distribution-api-を使用する">CloudFrontWebDistribution ではなく Distribution API を使用する<a class="hash-link" href="#cloudfrontwebdistribution-ではなく-distribution-api-を使用する" title="見出しへの直接リンク">​</a></h2><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> distribution </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">cloudfront</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Distribution</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Distribution'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      defaultRootObject</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'index.html'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      defaultBehavior</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        allowedMethods</span><span class="token operator">:</span><span class="token plain"> cloudfront</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">AllowedMethods</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token constant" style="color:rgb(189, 147, 249)">ALLOW_GET_HEAD</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cachedMethods</span><span class="token operator">:</span><span class="token plain"> cloudfront</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">CachedMethods</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token constant" style="color:rgb(189, 147, 249)">CACHE_GET_HEAD</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cachePolicy</span><span class="token operator">:</span><span class="token plain"> cloudfront</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">CachePolicy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token constant" style="color:rgb(189, 147, 249)">CACHING_OPTIMIZED</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        viewerProtocolPolicy</span><span class="token operator">:</span><span class="token plain"> cloudfront</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ViewerProtocolPolicy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token constant" style="color:rgb(189, 147, 249)">REDIRECT_TO_HTTPS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        origin</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">cloudfrontOrigins</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">S3Origin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">bucket</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          originAccessIdentity</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        functionAssociations</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            eventType</span><span class="token operator">:</span><span class="token plain"> cloudfront</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">FunctionEventType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token constant" style="color:rgb(189, 147, 249)">VIEWER_REQUEST</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token operator">:</span><span class="token plain"> rewriteUrlFunction</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      priceClass</span><span class="token operator">:</span><span class="token plain"> cloudfront</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">PriceClass</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token constant" style="color:rgb(189, 147, 249)">PRICE_CLASS_200</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      certificate</span><span class="token operator">:</span><span class="token plain"> acm</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Certificate</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">fromCertificateArn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'Certificate'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Lazy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">produce</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> certificateArn </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      domainNames</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">recordName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      minimumProtocolVersion</span><span class="token operator">:</span><span class="token plain"> cloudfront</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">SecurityPolicyProtocol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token constant" style="color:rgb(189, 147, 249)">TLS_V1_2_2021</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>CDK で CloudFront の Distribution を作成する高レベル Constructs は <code>CloudFrontWebDistribution</code> と <code>Distribution</code> の2つが用意されていますが、<code>Distribution</code> の方が新しく、<a href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_cloudfront-readme.html" target="_blank" rel="noopener noreferrer">ドキュメント</a>でもこちらの使用が推奨されています。</p><blockquote><p>The CloudFrontWebDistribution construct is the original construct written for working with CloudFront distributions. Users are encouraged to use the newer Distribution instead, as it has a simpler interface and receives new features faster.</p></blockquote><p>他に、<code>priceClass</code> は日本のエッジロケーションを使用したいので <code>PRICE_CLASS_200</code> としています。また <code>certificateArn</code> を渡すのに <code>Lazy</code> を使用しているのは <a href="https://github.com/aws/aws-cdk/issues/8699" target="_blank" rel="noopener noreferrer">Issue#8699</a> に対応するためです。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="bucketdeployment-を使ってファイルを-s3-にアップロードする">BucketDeployment を使ってファイルを S3 にアップロードする<a class="hash-link" href="#bucketdeployment-を使ってファイルを-s3-にアップロードする" title="見出しへの直接リンク">​</a></h2><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">s3Deployment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">BucketDeployment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'BucketDeployment'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      sources</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        s3Deployment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Source</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">asset</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">__dirname</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'../web/public'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      destinationBucket</span><span class="token operator">:</span><span class="token plain"> bucket</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      distribution</span><span class="token operator">:</span><span class="token plain"> distribution</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      distributionPaths</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'/*'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_s3_deployment.BucketDeployment.html" target="_blank" rel="noopener noreferrer">BucketDeployment</a> はローカルのファイルをS3バケットにデプロイします。また、先ほど作成した <code>Distribution</code> がこのバケットを Origin とするように設定しています。<code>../web/public</code> はデプロイしたいファイルがある場所に合わせて修正して下さい。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ipv4-と-ipv6-両方に対応する">IPv4 と IPv6 両方に対応する<a class="hash-link" href="#ipv4-と-ipv6-両方に対応する" title="見出しへの直接リンク">​</a></h2><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> hostedZone </span><span class="token operator">=</span><span class="token plain"> route53</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">HostedZone</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">fromLookup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'HostedZone'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      domainName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> propsForRoute53Records </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      zone</span><span class="token operator">:</span><span class="token plain"> hostedZone</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      recordName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      target</span><span class="token operator">:</span><span class="token plain"> route53</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">RecordTarget</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">fromAlias</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">route53Targets</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">CloudFrontTarget</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">destribution</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">route53</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">ARecord</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'ARecord'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> propsForRoute53Records</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">route53</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">AaaaRecord</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'AaaaRecord'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> propsForRoute53Records</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A と AAAA の2つのレコードを追加することで、IPv4 と IPv6 両方に対応しています。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="おわりに">おわりに<a class="hash-link" href="#おわりに" title="見出しへの直接リンク">​</a></h2><p>本記事では CDK で 静的ウェブサイトをデプロイする方法についてご紹介しました。CloudFront + S3 の組み合わせでファイル名を含まない URL に対応するためには少し工夫が必要になりますが、CDK であれば管理も簡単なのでおすすめです。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="あわせて読みたい">あわせて読みたい<a class="hash-link" href="#あわせて読みたい" title="見出しへの直接リンク">​</a></h2><ul><li><a href="https://aws.amazon.com/jp/premiumsupport/knowledge-center/cloudfront-serve-static-website/" target="_blank" rel="noopener noreferrer">CloudFront を使用して、Amazon S3 でホストされた静的ウェブサイトを公開するにはどうすればよいですか?</a></li><li><a href="https://dev.classmethod.jp/articles/sometimes-cf2-price-is-higher-than-lae/" target="_blank" rel="noopener noreferrer">CloudFront FunctionsはLambda@Edgeより安い。それ本当？！</a></li></ul>]]></content>
        <author>
            <name>Tomoya Kudo</name>
            <uri>https://github.com/kudtomoy</uri>
        </author>
        <category label="cdk" term="cdk"/>
        <category label="cloudfront" term="cloudfront"/>
        <category label="s3" term="s3"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Amazon CloudWatch RUM で Jekyll の静的サイトのアクセス解析を行う]]></title>
        <id>jekyll-cloudwatch-rum</id>
        <link href="https://prototyping-blog.com/blog/jekyll-cloudwatch-rum"/>
        <updated>2022-08-03T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[本記事では、GitHub Pages で広く利用されている静的サイト作成ツール Jekyll と AWS の Web アプリケーションモニタリングツールである Amazon CloudWatch RUM を組み合わせたアクセス解析可能な静的サイトの構築方法をご紹介いたします。なお、ホスティング方法については触れません。]]></summary>
        <content type="html"><![CDATA[<p>本記事では、GitHub Pages で広く利用されている静的サイト作成ツール Jekyll と AWS の Web アプリケーションモニタリングツールである Amazon CloudWatch RUM を組み合わせたアクセス解析可能な静的サイトの構築方法をご紹介いたします。なお、ホスティング方法については触れません。</p><h1>Jekyll の準備</h1><p>基本的には <a href="http://jekyllrb-ja.github.io/" target="_blank" rel="noopener noreferrer">Jekyll</a> の公式サイトの手順をなぞる形になります。Jekyll のコマンドラインツールは gem (Ruby のライブラリ形式) で公開されていますので、手元の環境に Ruby が必要だということに注意してください。以下のコマンドを実行して、<code>jekyll</code> コマンドをインストールし、<code>hello-rum</code> というサイトを作成します。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">gem </span><span class="token function" style="color:rgb(80, 250, 123)">install</span><span class="token plain"> bundler jekyll</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">jekyll new hello-rum</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">cd</span><span class="token plain"> hello-rum</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>公式の手順では次に <code>bundle exec jekyll serve</code> を実行していますが、筆者の手元の環境では <code>webrick</code> という gem が必要だというエラーが出ました。同様のエラーに遭遇した場合、Gemfile に以下の一文を追加してください。</p><div class="language-ruby codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ruby codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">source "https://rubygems.org"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">...省略...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 末尾にこれを追加</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">gem "webrick"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最後に、以下のコマンドを実行して serve を開始します。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">bundle </span><span class="token function" style="color:rgb(80, 250, 123)">install</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">bundle </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">exec</span><span class="token plain"> jekyll serve</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="http://localhost:4000" target="_blank" rel="noopener noreferrer">http://localhost:4000</a> にアクセスし、正常に表示されていることを確認してください。</p><h1>Amazon CloudWatch RUM による App monitor の作成</h1><p><a href="https://console.aws.amazon.com/cloudwatch/home#rum:dashboard?tab=overview" target="_blank" rel="noopener noreferrer">Amazon CloudWatch RUM</a> にアクセスし、右上の「Add app monitor」をクリックして App monitor の作成を開始します。</p><p>App monitor 名は「hello-rum」にします。Application domain は検証目的のため「localhost」にします。</p><p><img loading="lazy" alt="App monitor 01" src="/assets/images/app-monitor-01-82f54281235ed3c3c3d244a64ac07510.png" width="875" height="361" class="img_ev3q"></p><p>集めるデータには全てチェックを入れます。不必要なものがある場合はチェックを外しても問題ありません。</p><p><img loading="lazy" alt="App monitor 02" src="/assets/images/app-monitor-02-cbc46e29bf198b949f50ab60221fbdbf.png" width="876" height="387" class="img_ev3q"></p><p>「Allow cookies」のチェックは外しました。チェックを入れた場合は、cookie を設定してユーザーの動向を追跡できます。「Session samples」は 100% にします。「Data Storage」は有効にしました。これにより、CloudWatch Logs でデータを集計できるようになります。</p><p><img loading="lazy" alt="App monitor 03" src="/assets/images/app-monitor-03-908ad9a3e639ac9c2066b8996516cf32.png" width="873" height="567" class="img_ev3q"></p><p>作成が完了すると、組み込み用の Snippet が表示されます。TypeScript、JavaScript、HTML が選択できますが、Jekyll 用に「HTML」を選択します。右上から Snippet をコピーしてください。</p><p><img loading="lazy" alt="App monitor 04" src="/assets/images/app-monitor-04-1ff096fdb5edaae90d38e482ed40006f.png" width="874" height="681" class="img_ev3q"></p><h1>Jekyll に App monitor を組み込む</h1><p>jekyll (バージョン 4.2.2) ではデフォルトで <a href="https://github.com/jekyll/minima" target="_blank" rel="noopener noreferrer">minima</a> というテーマが適応されています。Snippet を組み込む <code>&lt;head&gt;</code> タグを上書きするため、<code>hello-rum</code> ディレクトリに <code>_includes</code> ディレクトリを作成し、その中に <code>head.html</code> を作成します。<code>head.html</code> の内容は以下にします。<code>&lt;!-- ここに App monitor のスニペットを貼り付ける --&gt;</code> は Snippet に置き換えてください。</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">head</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">meta</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">charset</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">utf-8</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">meta</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">http-equiv</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">X-UA-Compatible</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">content</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">IE=edge</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">meta</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">viewport</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">content</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">width=device-width, initial-scale=1</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  {%- seo -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;link rel="stylesheet" href="{{ "/assets/main.css" | relative_url }}"&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  {%- feed_meta -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- ここに App monitor のスニペットを貼り付ける --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">head</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上のコードはほとんど <a href="https://github.com/jekyll/minima/blob/master/_includes/head.html" target="_blank" rel="noopener noreferrer">minima の <code>_includes/head.html</code></a> の内容ですが、下部に App monitor のスニペットを組み込みます。また、minima のバージョンによっては <a href="https://github.com/jekyll/minima/blob/master/_includes/custom-head.html" target="_blank" rel="noopener noreferrer"><code>_includes/custom-head.html</code></a> も利用可能なようなので、そちらにスニペットを貼り付けても良いかもしれません。</p><p><a href="http://localhost:4000" target="_blank" rel="noopener noreferrer">http://localhost:4000</a> を何度かリロードしたり記事を閲覧したりして App monitor のダッシュボードにデータが表示されることを確認してください。成功していると以下のようにデータが表示されます。</p><p><img loading="lazy" alt="App monitor 05" src="/assets/images/app-monitor-05-db4ef50bfc68c45136f55f5f37b4251a.png" width="1509" height="850" class="img_ev3q"></p><h1>Production 環境への組み込み</h1><p>前述した App monitor は localhost に設定した開発用のものでした。本番用の App monitor も組み込んでみます。前述した手順と同様に App monitor を作成してください。App monitor 名は「hello-rum-prod」にして、Application domain は本番環境で使うドメインに設定します。GitHub Pages の場合「<code>&lt;org名&gt;.github.io</code>」になります。他の設定は同じで問題ありません。Snippet はコピーしておいてください。</p><p>続いて、<code>head.html</code> を以下のように編集します。本番環境か否かを <code>{% if jekyll.environment == "development" %}</code> で判断しています。</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">head</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">meta</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">charset</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">utf-8</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">meta</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">http-equiv</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">X-UA-Compatible</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">content</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">IE=edge</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">meta</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">viewport</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">content</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">width=device-width, initial-scale=1</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  {%- seo -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;link rel="stylesheet" href="{{ "/assets/main.css" | relative_url }}"&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  {%- feed_meta -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  {% if jekyll.environment == "development" %}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- ここに開発用 (localhost) の App monitor のスニペットを貼り付ける --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  {% else %}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- ここに本番用の App monitor のスニペットを貼り付ける --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  {% endif %}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">head</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>本番環境にデプロイしたあと、正常にデータが受信できることを確認してください。以上で全ての設定が完了です！</p><h1>おわりに</h1><p>本記事では Jekyll で作成した静的サイトに Amazon CloudWatch RUM を組み込む手順を紹介しました。Amazon CloudWatch RUM ではページごとのアクセス状況やデバイス種別などのデータが解析可能ですし、CloudWatch Logs と連携させることにより、柔軟な集計を行うことも可能です。また、今回は Jekyll への組み込みを行いましたが、React や Vue.js などの SPA にも組み込むことは可能ですので、ぜひ一度お試しください。</p>]]></content>
        <author>
            <name>Taichiro Suzuki</name>
            <uri>https://github.com/tbrand</uri>
        </author>
        <category label="cloudwatch" term="cloudwatch"/>
        <category label="rum" term="rum"/>
        <category label="jekyll" term="jekyll"/>
    </entry>
</feed>