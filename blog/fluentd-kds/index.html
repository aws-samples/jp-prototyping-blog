<!doctype html>
<html lang="ja" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Fluentd から Kinesis Data Streams へサイズが大きいデータを転送する | Prototyping Blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://prototyping-blog.com/blog/fluentd-kds"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="google-site-verification" content="QDt4NR8d-V1T7KHp94YVrifTFOIE9dm2b3cRz2rXMrU"><meta data-rh="true" property="og:title" content="Fluentd から Kinesis Data Streams へサイズが大きいデータを転送する | Prototyping Blog"><meta data-rh="true" name="description" content="Kinesis Data Streams には、1 レコードのサイズは 1MB 以下でなければならない制約があり、サイズの大きいデータを転送するには工夫が必要となります。また利用料金はストリームに読み書きされるデータ量に基づいて決定されるため、サイズが大きいと課金額も増えてしまいます。本記事では Publisher が Fluentd の場合において、上記課題を解決する方法についてご紹介します。メッセージをメタデータと本体に分割し、本体は S3 経由で Consumer に渡し、メタデータのみを Kinesis Data Streams へ送ることで実現します。"><meta data-rh="true" property="og:description" content="Kinesis Data Streams には、1 レコードのサイズは 1MB 以下でなければならない制約があり、サイズの大きいデータを転送するには工夫が必要となります。また利用料金はストリームに読み書きされるデータ量に基づいて決定されるため、サイズが大きいと課金額も増えてしまいます。本記事では Publisher が Fluentd の場合において、上記課題を解決する方法についてご紹介します。メッセージをメタデータと本体に分割し、本体は S3 経由で Consumer に渡し、メタデータのみを Kinesis Data Streams へ送ることで実現します。"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-01-05T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/statefb"><meta data-rh="true" property="article:tag" content="fluentd,kinesis data streams,kinesis"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://prototyping-blog.com/blog/fluentd-kds"><link data-rh="true" rel="alternate" href="https://prototyping-blog.com/blog/fluentd-kds" hreflang="ja"><link data-rh="true" rel="alternate" href="https://prototyping-blog.com/blog/fluentd-kds" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Prototyping Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Prototyping Blog Atom Feed">





<script src="/js/rum-prod.js"></script><link rel="stylesheet" href="/assets/css/styles.11c42881.css">
<link rel="preload" href="/assets/js/runtime~main.28972341.js" as="script">
<link rel="preload" href="/assets/js/main.78401a02.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="メインコンテンツまでスキップ"><a href="#" class="skipToContent_fXgn">メインコンテンツまでスキップ</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Prototyping Blog Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Prototyping Blog Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Prototyping Blog</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/about-team">Team</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/aws-samples/jp-prototyping-blog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_Pkmr"><kbd class="searchHint_iIMx">ctrl</kbd><kbd class="searchHint_iIMx">K</kbd></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/clean-cdk-resources">cdk destroy しても残ってしまうリソースへの対処法</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/eks-gpu-time-slicing">Amazon EKS の 複数 Pod 間で GPU を共有する (Time-Slicing 編)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/openai-discord-bot">OpenAI API を使って Discord Bot を作る</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/lambda-web-adapter-with-prisma">Lambda Web Adapter と Prisma を利用する際の注意点</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/primary-eni-with-cdk">AWS CDK で MAC アドレスと IP アドレスを固定した EC2 インスタンスを作成する</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">Fluentd から Kinesis Data Streams へサイズが大きいデータを転送する</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-01-05T00:00:00.000Z" itemprop="datePublished">2023年1月5日</time> · <!-- -->約13分</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/statefb" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/statefb.png" alt="Takehiro Suzuki"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/statefb" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Takehiro Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Prototyping Engineer</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p><a href="https://aws.amazon.com/jp/kinesis/data-streams/" target="_blank" rel="noopener noreferrer">Kinesis Data Streams</a> には、1 レコードのサイズは 1MB 以下でなければならない制約があり、サイズの大きいデータを転送するには工夫が必要となります。また利用料金はストリームに読み書きされるデータ量に基づいて決定されるため、サイズが大きいと課金額も増えてしまいます。本記事では Publisher が Fluentd の場合において、上記課題を解決する方法についてご紹介します。メッセージをメタデータと本体に分割し、本体は S3 経由で Consumer に渡し、メタデータのみを Kinesis Data Streams へ送ることで実現します。</p><p><img loading="lazy" src="/assets/images/arch-65816c847eb129ab558e9547a43a095d.png" width="511" height="250" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kinesis-data-streams-について">Kinesis Data Streams について<a class="hash-link" href="#kinesis-data-streams-について" title="見出しへの直接リンク">​</a></h2><p>Kinesis Data Streams (以降 KDS と呼称) は、フルマネージドのサーバレスストリーミングサービスです。シンプルな従量制課金を採用しており、シャードの稼働時間に応じて料金は計算されます。シャードは基本的なスループットの単位であり、スループット要件に応じて必要なシャード数を決定します。なおオンデマンドモードを利用した場合、読み書きのデータ量に応じて自動的にシャード数のスケールが行われます。詳細は<a href="https://aws.amazon.com/jp/kinesis/data-streams/pricing/" target="_blank" rel="noopener noreferrer">Amazon Kinesis Data Streams の料金</a>をご覧ください。<br>
<!-- -->また KDS では 1 レコードのサイズが 1MB 以下である必要があります。詳細は<a href="https://docs.aws.amazon.com/streams/latest/dev/service-sizes-and-limits.html" target="_blank" rel="noopener noreferrer">Quotas and Limits</a>をご確認ください。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="方針">方針<a class="hash-link" href="#方針" title="見出しへの直接リンク">​</a></h2><p>各レコードにユニークな ID を割り当て、KDS では ID のみを、S3 バケットへはレコードの本体をそれぞれ送信します。バケットのオブジェクトキーに ID を含ませておけば、Consumer 側で ID を元にバケットから本体のデータを取得し処理することができます。これにより KDS で取り扱うレコードのサイズを削減することが可能です。本記事では、Fluentd を用いた場合について具体的に解説します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="想定するレコード例">想定するレコード例<a class="hash-link" href="#想定するレコード例" title="見出しへの直接リンク">​</a></h2><p>サイズの大きなレコードの例を示します。</p><div class="language-record.json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-record.json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">[</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;metrics_name&quot;: &quot;metrics1&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;metrics_value&quot;: 24.1,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;metrics_name&quot;: &quot;metrics2&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;metrics_value&quot;: 312.56,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ...以降続く</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上記の配列を「1 レコード」として取り扱うことを想定しています。この例の場合、各<code>metrics</code>を別々のレコードとして取り扱えばサイズを 1MB に抑えることも可能でしょう。しかし Fluentd の入力側の都合や (技術的な課題や組織的な事情)、個々の<code>metrics</code>間に依存関係があるため Consumer 側ではまとめて処理した方が見通しが良い等の事情により、分割することが困難または妥当でないケースがあります。また上記の配列単位で順序性が担保されれば良い場合、KDS にすべて送信すると前述のコスト体系により予算面で厳しいケースも考えれます。このような課題を前述の方針により解決を図ります。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="fluentd-のバッファリング">Fluentd のバッファリング<a class="hash-link" href="#fluentd-のバッファリング" title="見出しへの直接リンク">​</a></h2><p>Fluentd ではレコードをバッファリングし、まとめて送信する機能があります。これによりログの欠損防止や流量の制御が可能です。本記事ではバッファリングの利用を前提とします。</p><p>Fluentd のバッファの仕組みを下記に示します。
<img loading="lazy" src="/assets/images/buf-9fe916e307db9ecb9ce0b96cc6924171.png" width="1212" height="563" class="img_ev3q">
<a href="https://docs.fluentd.org/buffer" target="_blank" rel="noopener noreferrer">引用先</a></p><p>バッファリングには stage と queue の 2 ステップが存在します。stage の段階でイベントの塊であるチャンク (chunk) を作成し、時間経過とともにエンキューされ、Output Plugin の指定する宛先へ送信されます。なおイベントはレコード (送信したいデータ本体)、タグ、タイムスタンプの 3 つの要素から構成されます。タグは Fluentd の備える主要な要素であり、Fluentd の内部でのルーティングに利用されます。Fluentd へデータを投入する Input Plugin はレコードにタグをつけ、Fluentd はそのタグにマッチする<code>match</code>ディレクティブを検索し、対応する Output Plugin へルーティングします。<br>
<!-- -->たとえば下記のような 2 つのダミーのデータソースがあるとします。それぞれタグは<code>example.hello</code>, <code>example.hoge</code>です。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;source&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @type dummy</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  dummy {&quot;hello&quot;: &quot;world&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  tag example.hello</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;/source&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;source&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @type dummy</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  dummy {&quot;hoge&quot;: &quot;hoge&quot;}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  tag example.hoge</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;/source&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上記両方ともに<code>example_bucket</code>という名前の S3 バケットへ転送したい場合、対応する match ディレクティブは下記のようになります。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;match example.**&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @type s3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  s3_bucket example_bucket</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;/match&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>それぞれ別のバケット (<code>hello_bucket</code>, <code>hoge_bucket</code>)へ転送したい場合は下記のように記述します。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;match example.hello&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @type s3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  s3_bucket hello_bucket</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;/match&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;match example.hoge&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @type s3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  s3_bucket hoge_bucket</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;/match&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>詳細は<a href="https://docs.fluentd.org/configuration/config-file" target="_blank" rel="noopener noreferrer">Config File Syntax</a>をご覧ください。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="チャンク">チャンク<a class="hash-link" href="#チャンク" title="見出しへの直接リンク">​</a></h3><p>チャンクを作成するとき、<a href="https://docs.fluentd.org/configuration/buffer-section#chunk-keys" target="_blank" rel="noopener noreferrer">Chunk key</a>と呼ばれるキーを指定しグルーピングすることができます。キーにはタグの他、タイムキーなどを含めることができます。<br>
<!-- -->例えば下記のように記述した場合、イベントは 60 秒ごと、かつタグごとにグルーピングされチャンクが作られます。</p><div class="language-fluent.conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-fluent.conf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;buffer time, tag&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  timekey 60</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;/buffer&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>チャンクを S3 へ転送する際、上記のチャンクに付与されたユニークな ID を KDS へ転送すれば Consumer 側で S3 のオブジェクトを取得できます。ユニークな ID は Output Plugin の<a href="https://docs.fluentd.org/plugin-development/api-plugin-output#chunk.unique_id" target="_blank" rel="noopener noreferrer">chunk.unique_id</a>、Chunk key で利用したタグやタイムキーは<a href="https://docs.fluentd.org/plugin-development/api-plugin-output#chunk.metadata" target="_blank" rel="noopener noreferrer">chunk.metadata</a>から取得することが可能です。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="fluentd-自身のログをキャプチャする">Fluentd 自身のログをキャプチャする<a class="hash-link" href="#fluentd-自身のログをキャプチャする" title="見出しへの直接リンク">​</a></h2><p>チャンクのユニークな ID を KDS へ転送するには、Fluentd への入力として<code>chunk.unique_id</code>および<code>chunk.metadata</code>を与える必要があります。ここでは <a href="https://docs.fluentd.org/deployment/logging#capture-fluentd-logs" target="_blank" rel="noopener noreferrer">Fluentd 自身のログをキャプチャする</a>方法を利用します。
Fluentd は Fluentd 自身のログを<code>fluent</code>タグをつけて管理しています。このログは<code>&lt;label @FLUENT_LOG&gt;</code>内で<code>match</code>ディレクティブを記載することで処理できます。たとえば下記のように記載すると、すべてのログレベルのログを KDS へ転送します。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;label @FLUENT_LOG&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;match fluent.*&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @type kinesis_streams</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;/match&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;/label&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Fluentd の S3 Output プラグインでは S3 転送時に<code>chunk.unique_id</code>および<code>chunk.metadata</code>を含んだログを<a href="https://github.com/fluent/fluent-plugin-s3/blob/2109abcaf6279fb92d0e877359d281aacba6b9ff/lib/fluent/plugin/out_s3.rb#L354" target="_blank" rel="noopener noreferrer">debug レベルで出力</a>します。下記ログをキャプチャし KDS へ転送すれば、Consumer 側で S3 のオブジェクトキーを特定できます。</p><div class="language-out_s3.rb codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-out_s3.rb codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">log.debug &quot;out_s3: write chunk #{dump_unique_id_hex(chunk.unique_id)} with metadata #{chunk.metadata} to s3://#{@s3_bucket}/#{s3path}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="fluentd-のコンフィギュレーション">Fluentd のコンフィギュレーション<a class="hash-link" href="#fluentd-のコンフィギュレーション" title="見出しへの直接リンク">​</a></h2><p>以上の内容を踏まえ、S3 へ本体を転送し、 KDS へメタデータを送るコンフィギュレーション例を作成してみます。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ログレベルの設定">ログレベルの設定<a class="hash-link" href="#ログレベルの設定" title="見出しへの直接リンク">​</a></h3><p>S3 Output プラグインは 前述のチャンク情報を含むログを <code>debug</code> レベルで出力するため、<code>system</code>セクションに下記のように設定します。<a href="https://docs.fluentd.org/deployment/logging#by-config-file" target="_blank" rel="noopener noreferrer">参考</a></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;system&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  log_level debug</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;log&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    format json</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    time_format %Y-%m-%d</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;/log&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;/system&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="s3">S3<a class="hash-link" href="#s3" title="見出しへの直接リンク">​</a></h3><p>ここでは後に<a href="https://aws.amazon.com/jp/athena/" target="_blank" rel="noopener noreferrer">Amazon Athena</a>を用い効率的にクエリできるよう、Hive 形式 (s3://year=yyyy/month=mm/day=dd) かつ gzip に圧縮し出力するものとします。<br>
<!-- -->下記のように設定すると、S3 バケットへは<code>s3://example_bucket/log/year=2023/month=01/day=05/{チャンクID}.gzip</code>のような形式で保存されます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;match example.log&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @type s3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    s3_bucket example_bucket</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    s3_object_key_format ${tag[1]}/%{time_slice}/${chunk_id}.%{file_extension}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    store_as gzip</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    time_slice_format year=%Y/month=%m/day=%d</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;format&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      @type json</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;/format&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;buffer time,tag&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        timekey 10s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;/buffer&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;/match&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>S3 に保存されるデータ例を下記に示します。上記の設定の場合 10 秒の間に到達した<a href="#%E6%83%B3%E5%AE%9A%E3%81%99%E3%82%8B%E3%83%AC%E3%82%B3%E3%83%BC%E3%83%89%E4%BE%8B">想定するレコード</a>を json フォーマットで並べたものになります。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;metrics_name&quot;: &quot;metrics1&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;metrics_value&quot;: 24.1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;metrics_name&quot;: &quot;metrics2&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;metrics_value&quot;: 312.56</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;metrics_name&quot;: &quot;metrics1&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;metrics_value&quot;: 28.1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;metrics_name&quot;: &quot;metrics2&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;metrics_value&quot;: 356.13</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fluentd-自身のログのフィルタリング">Fluentd 自身のログのフィルタリング<a class="hash-link" href="#fluentd-自身のログのフィルタリング" title="見出しへの直接リンク">​</a></h3><p>Fluentd の<a href="https://docs.fluentd.org/filter" target="_blank" rel="noopener noreferrer">Filter Plugins</a>を使うと、送信したい内容を抽出・加工することができます。<br>
<!-- -->まず前述した S3 Output プラグインが S3 転送した時のログを下記の設定により抽出します。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;filter fluent.debug&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @type grep</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;regexp&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      key message</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      pattern /out_s3: write chunk/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;/regexp&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;/filter&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>これにより例えば下記のようなログのみが抽出できます。</p><div class="language-.json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-.json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;time&quot;: &quot;2023-01-06&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;level&quot;: &quot;debug&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;message&quot;: &quot;out_s3: write chunk 5f18e855a51912add1e8b26328a62d3d with metadata #&lt;struct Fluent::Plugin::Buffer::Metadata timekey=1672969300, tag=\&quot;example.log\&quot;, variables=nil&gt; to s3://example_bucket/log/year=2023/month=01/day=06/5f18e855a51912add1e8b26328a62d3d.gz&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>続いて上記の抽出したログに対し、元のタグ (ここでは <code>example.log</code>) を含む部分を正規表現により取得し、後述する KDS のパーティションキーとして利用するため追加します。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;filter fluent.debug&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @type record_transformer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    enable_ruby</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;record&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      # 元のタグを正規表現で抽出しkinesisのpartition keyに利用</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      partition_key ${record[&quot;message&quot;].match(/tag=.+,/)[0].slice(0..-2)}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;/record&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;/filter&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下記のように<code>parition_key</code>が新たに追加されます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;time&quot;: &quot;2023-01-06&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;level&quot;: &quot;debug&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;message&quot;: ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;partition_key&quot;: &quot;tag=\&quot;example.log\&quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>fluent.debug</code>タグのレコードを KDS へ送信しないようにするため下記により除外します。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;filter fluent.debug&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @type grep</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;exclude&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      key partition_key</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      pattern /fluent.debug/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;/exclude&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;/filter&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="kds">KDS<a class="hash-link" href="#kds" title="見出しへの直接リンク">​</a></h3><p>先ほど抽出した元のタグをパーティションキーに設定し KDS へ送信します。これにより同じタグのレコードは毎回同じシャードに送信され順序性が担保されます (KDS はシャード内でのみ順序を保証します)。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;match fluent.debug&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @type kinesis_streams</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    stream_name example_stream</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    partition_key partition_key</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;/match&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>なお最終的に KDS へ送信されるデータは下記となります。この例の場合<code>tag=&quot;example.log&quot;</code>が送信先のシャード決定に利用されます。Consumer 側では<code>message</code>に含まれるオブジェクトキーを用いて本体データを取得できます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;time&quot;: &quot;2023-01-06&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;level&quot;: &quot;debug&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;message&quot;: &quot;out_s3: write chunk 5f18e855a51912add1e8b26328a62d3d with metadata #&lt;struct Fluent::Plugin::Buffer::Metadata timekey=1672969300, tag=\&quot;example.log\&quot;, variables=nil&gt; to s3://example_bucket/log/year=2023/month=01/day=06/5f18e855a51912add1e8b26328a62d3d.gz&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;partition_key&quot;: &quot;tag=\&quot;example.log\&quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上の内容を一つにまとめたものが下記となります。</p><div class="language-fluent.conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-fluent.conf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;system&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  log_level debug</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;log&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    format json</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    time_format %Y-%m-%d</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;/log&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;/system&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;match example.log&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @type s3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    s3_bucket example_bucket</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    s3_object_key_format ${tag[1]}/%{time_slice}/${chunk_id}.%{file_extension}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    store_as gzip</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    time_slice_format year=%Y/month=%m/day=%d</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;format&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      @type json</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;/format&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;buffer time,tag&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        timekey 10s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;/buffer&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;/match&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;label @FLUENT_LOG&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;filter fluent.debug&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @type grep</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;regexp&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      key message</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      pattern /out_s3: write chunk/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;/regexp&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;/filter&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;filter fluent.debug&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @type record_transformer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    enable_ruby</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;record&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      partition_key ${record[&quot;message&quot;].match(/tag=.+,/)[0]}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;/record&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;/filter&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;filter fluent.debug&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @type grep</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;exclude&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      key partition_key</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      pattern /fluent.debug/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;/exclude&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;/filter&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;match fluent.debug&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @type kinesis_streams</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    stream_name example_stream</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    partition_key partition_key</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;buffer time&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      timekey 10s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &lt;/buffer&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &lt;/match&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;/label&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a class="hash-link" href="#まとめ" title="見出しへの直接リンク">​</a></h2><p>本記事では Fluentd から Kinesis Data Streams へ大きなサイズのレコードを取り扱う具体的な方法例についてご紹介しました。ご参考にいただければ幸いです。</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>タグ:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/fluentd">fluentd</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/kinesis-data-streams">kinesis data streams</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/kinesis">kinesis</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/aws-samples/jp-prototyping-blog/edit/main/blog/2023-01-05-fluentd-kds/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>このページを編集</a></div></footer><div style="margin-top:.8em"></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="ブログ記事のナビゲーション"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/identity-pool-unauth"><div class="pagination-nav__sublabel">新しい記事</div><div class="pagination-nav__label">Cognito Identity Pools の Unauthenticated Role で Amazon Kendra にアクセスしたら AccessDeniedException だった話</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/rails-lambda"><div class="pagination-nav__sublabel">過去の記事</div><div class="pagination-nav__label">Ruby on Rails を API Gateway + Lambda でサーバーレス運用する方法</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#kinesis-data-streams-について" class="table-of-contents__link toc-highlight">Kinesis Data Streams について</a></li><li><a href="#方針" class="table-of-contents__link toc-highlight">方針</a></li><li><a href="#想定するレコード例" class="table-of-contents__link toc-highlight">想定するレコード例</a></li><li><a href="#fluentd-のバッファリング" class="table-of-contents__link toc-highlight">Fluentd のバッファリング</a><ul><li><a href="#チャンク" class="table-of-contents__link toc-highlight">チャンク</a></li></ul></li><li><a href="#fluentd-自身のログをキャプチャする" class="table-of-contents__link toc-highlight">Fluentd 自身のログをキャプチャする</a></li><li><a href="#fluentd-のコンフィギュレーション" class="table-of-contents__link toc-highlight">Fluentd のコンフィギュレーション</a><ul><li><a href="#ログレベルの設定" class="table-of-contents__link toc-highlight">ログレベルの設定</a></li><li><a href="#s3" class="table-of-contents__link toc-highlight">S3</a></li><li><a href="#fluentd-自身のログのフィルタリング" class="table-of-contents__link toc-highlight">Fluentd 自身のログのフィルタリング</a></li><li><a href="#kds" class="table-of-contents__link toc-highlight">KDS</a></li></ul></li><li><a href="#まとめ" class="table-of-contents__link toc-highlight">まとめ</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Contents</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/about-team">About Team</a></li></ul></div><div class="col footer__col"><div class="footer__title">Links</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023, Amazon Web Services, Inc. or its affiliates. All rights reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.28972341.js"></script>
<script src="/assets/js/main.78401a02.js"></script>
</body>
</html>