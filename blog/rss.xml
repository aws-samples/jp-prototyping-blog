<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Prototyping Blog Blog</title>
        <link>https://prototyping-blog.com/blog</link>
        <description>Prototyping Blog Blog</description>
        <lastBuildDate>Wed, 15 Nov 2023 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>ja</language>
        <item>
            <title><![CDATA[ClaudeでJSON出力を安定させるコツを一つ紹介します]]></title>
            <link>https://prototyping-blog.com/blog/claude-prompt-engineering-put-on-her-mouth</link>
            <guid>https://prototyping-blog.com/blog/claude-prompt-engineering-put-on-her-mouth</guid>
            <pubDate>Wed, 15 Nov 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Amazon Bedrock上のClaudeをサービスに組み込む場合、安定してJSONを出力させたいと思うことは多いですよね。今日はそのためのコツを一つ紹介します。]]></description>
            <content:encoded><![CDATA[<p>Amazon Bedrock上のClaudeをサービスに組み込む場合、安定してJSONを出力させたいと思うことは多いですよね。今日はそのためのコツを一つ紹介します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="コツ">コツ<a href="#コツ" class="hash-link" aria-label="コツ への直接リンク" title="コツ への直接リンク">​</a></h2><p>プロンプトの最後に <code>Assistant: {</code> を渡しましょう。末尾の <code>{</code> がポイントです。これにより回答が必ず <code>{</code> から始まるようになり、JSON出力が比較的安定化します。</p><p>プロンプトの例:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Human: 挨拶の文章を考えてください。回答は以下のJSONで返してください。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;example&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{ "greeting": "こんにちは" }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/example&gt;`;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Assistant: {</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Assistant側の回答もプロンプトに含められる、Claudeならではの手法ですね。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="効果の検証">効果の検証<a href="#効果の検証" class="hash-link" aria-label="効果の検証 への直接リンク" title="効果の検証 への直接リンク">​</a></h2><p>これだけだとホンマか？と思う人もいるでしょうから、簡単な検証を行ってみます。末尾に <code>{</code> をつけた場合とつけない場合とで正しいJSONを返せた割合を比較しました。</p><p>結果を下表に示します。大きな差があることが見て取れますね。</p><table><thead><tr><th></th><th>{ をつけた</th><th>{ なし</th></tr></thead><tbody><tr><td>正しいJSONの割合</td><td>100 %</td><td>78 %</td></tr></tbody></table><p>なお、検証の諸条件は以下のとおりです:</p><ul><li>呼び出し回数: 100回</li><li>temperature: 0.6</li><li>元のプロンプト:</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">挨拶の文章を考えてください。回答は以下のJSONで返してください。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;example&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{ "greeting": "こんにちは" }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/example&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>再現のための全コードは<a href="https://gist.github.com/tmokmss/4b1bbf04f864372a7d6b78561ff09953" target="_blank" rel="noopener noreferrer">こちらから</a>確認できます。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h2><p>ClaudeでJSON出力を安定化させる一つのコツを紹介しました。この小技を使って、Claudeの能力を最大限に引き出しましょう!</p>]]></content:encoded>
            <category>bedrock</category>
            <category>prompt engineering</category>
            <category>claude</category>
        </item>
        <item>
            <title><![CDATA[AWS HealthOmics で AlphaFold を実行し、タンパク質の立体構造を可視化する]]></title>
            <link>https://prototyping-blog.com/blog/aws-healthomics-analysis-app-alphafold</link>
            <guid>https://prototyping-blog.com/blog/aws-healthomics-analysis-app-alphafold</guid>
            <pubDate>Wed, 25 Oct 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[AWS HealthOmics では、設定不要で手軽に利用できる Ready2Run ワークフローとして、タンパク質の立体構造を予測するオープンソースソフトウェアである AlphaFold が提供されています。今回は、以前の記事で紹介した「AWS HealthOmics Analysis App」で AlphaFold を実行し、予測されたタンパク質の立体構造を可視化する方法について解説します。]]></description>
            <content:encoded><![CDATA[<p>AWS HealthOmics では、設定不要で手軽に利用できる Ready2Run ワークフローとして、タンパク質の立体構造を予測するオープンソースソフトウェアである AlphaFold が提供されています。今回は、<a href="https://prototyping-blog.com/blog/aws-healthomics-analysis-app" target="_blank" rel="noopener noreferrer">以前の記事</a>で紹介した「AWS HealthOmics Analysis App」で AlphaFold を実行し、予測されたタンパク質の立体構造を可視化する方法について解説します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前回のおさらい">前回のおさらい<a href="#前回のおさらい" class="hash-link" aria-label="前回のおさらい への直接リンク" title="前回のおさらい への直接リンク">​</a></h2><p><a href="https://prototyping-blog.com/blog/aws-healthomics-analysis-app" target="_blank" rel="noopener noreferrer">前回の記事</a>では、AWS HealthOmics を使った Web アプリケーションのサンプル実装である <a href="https://github.com/aws-samples/amazon-omics-analysis-app" target="_blank" rel="noopener noreferrer">AWS HealthOmics Analysis App</a> のアーキテクチャや利用方法について解説しました。また、オミクスデータ分析ワークフローの例として、Ready2Run ワークフローとして提供されている AlphaFold を実行し、実行結果をダウンロードするまでの手順を解説しました。</p><p>今回は、AlphaFold の実行結果からタンパク質の立体構造データを取得し、Web アプリ上で 3D 表示する方法を解説します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="アーキテクチャ">アーキテクチャ<a href="#アーキテクチャ" class="hash-link" aria-label="アーキテクチャ への直接リンク" title="アーキテクチャ への直接リンク">​</a></h2><p>AWS HealthOmics Analysis App の概要とアーキテクチャについては、<a href="https://prototyping-blog.com/blog/aws-healthomics-analysis-app/#aws-healthomics-analysis-app-%E3%81%AE%E6%A6%82%E8%A6%81" target="_blank" rel="noopener noreferrer">前回の記事</a>をご参照ください。今回は、AlphaFold の実行結果の可視化に関する部分を解説します。</p><p>AWS HealthOmics Analysis App では、AWS HealthOmics ワークフローの実行後に二次解析 (可視化) を実行することができます。ワークフローで実行可能な可視化の種類は、以下の定義を持つ DynamoDB テーブル <code>OmicsWorkflowVisualizers</code> で管理されます。</p><table><thead><tr><th>カラム名</th><th>型</th><th>内容</th></tr></thead><tbody><tr><td>workflowId</td><td>String</td><td>ワークフロー ID</td></tr><tr><td>visualizerId</td><td>String</td><td>可視化 ID</td></tr><tr><td>name</td><td>String</td><td>可視化の名前</td></tr><tr><td>stateMachineArn</td><td>String</td><td>可視化を実行する Step Functions ステートマシンの ARN</td></tr></tbody></table><p>また、二次解析の処理において、Web アプリ上での可視化の対象となるものがあれば、以下の定義を持つ DynamoDB テーブル <code>OmicsRunVisualizations</code> に登録します。</p><table><thead><tr><th>カラム名</th><th>型</th><th>内容</th><th>値</th></tr></thead><tbody><tr><td>runId</td><td>String</td><td>ワークフローの実行 ID</td><td></td></tr><tr><td>visualizationId</td><td>String</td><td>可視化 ID</td><td></td></tr><tr><td>type</td><td>String</td><td>可視化の種類</td><td><code>QuickSightDashboard</code>: QuickSight ダッシュボード<br><code>3Dmol</code>: 3Dmol による立体構造の 3D 表示</td></tr><tr><td>dashboardId</td><td>String</td><td>QuickSight ダッシュボード ID</td><td>(<code>type</code> が <code>QuickSightDashboard</code> の場合)<br>Web アプリ上に埋め込む QuickSight ダッシュボードの ID<br></td></tr><tr><td>pdbPath</td><td>String</td><td>立体構造ファイルのパス</td><td>(<code>type</code> が <code>3Dmol</code> の場合)<br>Web アプリ上で 3Dmol を使って表示する PDB 形式の立体構造ファイルのパス<br>(ワークフローの出力先 S3 URL からの相対パス)</td></tr></tbody></table><p>今回解説する AlphaFold の可視化では、<code>AlphaFold3DmolVisualizer</code> という Step Functions ステートマシンを利用します。このステートマシンでは、AlphaFold の出力に含まれる立体構造予測データを展開する AWS Glue Python Shell ジョブを実行します。</p><p><img loading="lazy" alt="AlphaFold3DmolVisualizer の定義" src="/assets/images/stepfunctions-3d1661b8cf1282e86c9792fd3dc2f8d3.png" width="800" height="450" class="img_ev3q"></p><table><thead><tr><th>タスク名</th><th>タスク種別</th><th>処理内容</th></tr></thead><tbody><tr><td>ExtractResultsTask</td><td>Glue Job</td><td>AlphaFold の予測結果を展開する Glue Python Shell ジョブ <code>AlphaFoldExtractResultsJob</code> を実行</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="alphafold-実行結果の展開">AlphaFold 実行結果の展開<a href="#alphafold-実行結果の展開" class="hash-link" aria-label="AlphaFold 実行結果の展開 への直接リンク" title="AlphaFold 実行結果の展開 への直接リンク">​</a></h2><p>AWS HealthOmics の Ready2Run ワークフローに含まれる AlphaFold では、タンパク質の立体構造の予測結果を <code>out/prediction/results.tar.gz</code> というアーカイブファイルとして出力します。このアーカイブには、以下のファイルが含まれています。</p><table><thead><tr><th>ファイル名</th><th>種別</th><th>内容</th></tr></thead><tbody><tr><td>ranked_<!-- -->[<!-- -->0-4<!-- -->]<!-- -->.pdb</td><td><a href="https://pdbj.org/help/data-format?lang=ja" target="_blank" rel="noopener noreferrer">PDB</a></td><td>Amber relaxation 適用後に pLDDT でランク付けされた立体構造データ</td></tr><tr><td>unrelaxed<em>model</em>[<!-- -->1-5<!-- -->]<!-- -->_ptm_pred_0.pdb</td><td>PDB</td><td>各モデルから予測された立体構造データ</td></tr><tr><td>model_<!-- -->[<!-- -->1-5<!-- -->]<!-- -->_ptm_pred_0_pae.png</td><td><a href="https://ja.wikipedia.org/wiki/Portable_Network_Graphics" target="_blank" rel="noopener noreferrer">PNG</a></td><td>各モデルの Predicted Aligned Error の画像</td></tr><tr><td>result<em>model</em>[<!-- -->1-5<!-- -->]<!-- -->_ptm_pred_0.pkl</td><td><a href="https://docs.python.org/ja/3/library/pickle.html" target="_blank" rel="noopener noreferrer">PKL</a></td><td>各モデルから AlphaFold が生成した全データのシリアライズ</td></tr><tr><td>ranking_debug.json</td><td><a href="https://ja.wikipedia.org/wiki/JavaScript_Object_Notation" target="_blank" rel="noopener noreferrer">JSON</a></td><td>各モデルの pLDDT 情報</td></tr><tr><td>timings.json</td><td>JSON</td><td>AlphaFold のパイプラインの各セクションにかかった実行時間</td></tr></tbody></table><p><code>AlphaFoldExtractResultsJob</code> では、これらのファイルを <code>out/prediction/</code> ディレクトリに展開すると共に、PDB ファイルのパスを <a href="https://github.com/3dmol/3Dmol.js" target="_blank" rel="noopener noreferrer">3Dmol</a> による 3D 表示の対象として DynamoDB の <code>OmicsRunVisualizations</code> に登録します。実装の詳細については<a href="https://github.com/aws-samples/amazon-omics-analysis-app/blob/main/visualizer/glue/AlphaFoldExtractResultsJob/index.py" target="_blank" rel="noopener noreferrer">ソースコード</a>をご参照ください。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="デプロイ方法">デプロイ方法<a href="#デプロイ方法" class="hash-link" aria-label="デプロイ方法 への直接リンク" title="デプロイ方法 への直接リンク">​</a></h2><p><code>AlphaFold3DmolVisualizer</code> は、AWS HealthOmics Analysis App と同じく AWS CDK を使ってデプロイします。AWS HealthOmics Analysis App 本体のデプロイについては<a href="https://prototyping-blog.com/blog/aws-healthomics-analysis-app/#aws-healthomics-analysis-app-%E3%81%AE%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4" target="_blank" rel="noopener noreferrer">前回の記事</a>で解説しましたので、今回はそれに続く手順を解説します。</p><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_S0QG"><p>今回の記事の公開にあたり、AWS HealthOmics Analysis App の CDK スタックの構成が大きく変化しています。2023年10月25日以前に AWS HealthOmics Analysis App をデプロイされている場合、お手数ですが AWS CloudFormation コンソール等で一旦削除してから、リポジトリの内容を更新して再度デプロイして頂く必要があります。</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="alphafold3dmolvisualizerstack-のデプロイ">AlphaFold3DmolVisualizerStack のデプロイ<a href="#alphafold3dmolvisualizerstack-のデプロイ" class="hash-link" aria-label="AlphaFold3DmolVisualizerStack のデプロイ への直接リンク" title="AlphaFold3DmolVisualizerStack のデプロイ への直接リンク">​</a></h3><p><code>/cdk</code> ディレクトリで以下のコマンドを実行してください。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">npx cdk deploy AlphaFold3DmolVisualizerStack --require-approval never</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>これにより、AlphaFold の実行後に Web アプリ上で PDB ファイルが 3D 表示されるようになります。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="alphafold-の実行手順">AlphaFold の実行手順<a href="#alphafold-の実行手順" class="hash-link" aria-label="AlphaFold の実行手順 への直接リンク" title="AlphaFold の実行手順 への直接リンク">​</a></h2><p>基本的な実行手順は<a href="https://prototyping-blog.com/blog/aws-healthomics-analysis-app/#%E5%AE%9F%E8%A1%8C%E6%89%8B%E9%A0%86" target="_blank" rel="noopener noreferrer">前回の記事</a>と同じですが、今回は「Visualizer」として「3Dmol visualization」を選択します。</p><ol><li>AWS HealthOmics Analysis App にサインインしたら「New Analysis」をクリックします。</li><li>次の画面で「Workflow」をクリックすると Ready2Run ワークフローの一覧が表示されるので、「AlphaFold for up to 600 residues」を選択します。</li><li>「Visualizer」をクリックし、「3Dmol visualization」を選択します。</li><li>「Analysis Name」に任意の名前を入力して「CONTINUE」をクリックします。</li></ol><p><img loading="lazy" alt="New Analysis" src="/assets/images/new_analysis_settings-d4ba8d9565ed9c08687971d0735ddd9a.png" width="2145" height="818" class="img_ev3q"></p><ol start="5"><li>次の画面で「fasta_path」に以下の S3 URL を入力し、「CONTINUE」をクリックします。</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">s3://omics-us-east-1/sample-inputs/4885129/3d06.fasta</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="Parameters" src="/assets/images/new_analysis_parameters-1bfa9b1360e3f12ae517285c01e62cc9.png" width="2083" height="763" class="img_ev3q"></p><ol start="6"><li>次の画面に表示された内容を確認し、「RUN」をクリックします。</li></ol><p><img loading="lazy" alt="Confirmation" src="/assets/images/new_analysis_confirmation-10f0270be92683adfb46713897676858.png" width="2145" height="1455" class="img_ev3q"></p><ol start="7"><li>確認ダイアログが表示されるので、「OK」をクリックします。</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="立体構造予測結果の-3d-表示">立体構造予測結果の 3D 表示<a href="#立体構造予測結果の-3d-表示" class="hash-link" aria-label="立体構造予測結果の 3D 表示 への直接リンク" title="立体構造予測結果の 3D 表示 への直接リンク">​</a></h2><p>ワークフローの実行が完了したら、立体構造の予測結果を確認しましょう。「Analysis List」で該当のワークフローをクリックするか、または完了通知メールが届いた場合はメール内のリンクをクリックすると分析の詳細情報が表示され、3Dmol による立体構造の 3D 表示を見ることができます。</p><p><img loading="lazy" alt="3Dmol" src="/assets/images/analysis_3dmol-45ee59c76ea5246bcecb95bd61878ee4.png" width="2724" height="1571" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h2><p>今回は、AWS HealthOmics Analysis App で AlphaFold の実行結果を可視化する方法を解説しました。同様の仕組みを使う事で、AWS HealthOmics で実行したワークフローに対して、様々な二次解析や可視化を行うシステムを構築する事ができます。</p>]]></content:encoded>
            <category>aws</category>
            <category>healthomics</category>
            <category>omics</category>
            <category>alphafold</category>
        </item>
        <item>
            <title><![CDATA[AWS HealthOmics と Step Functions でオミクスデータ分析ワークフローを構築する]]></title>
            <link>https://prototyping-blog.com/blog/aws-healthomics-analysis-app</link>
            <guid>https://prototyping-blog.com/blog/aws-healthomics-analysis-app</guid>
            <pubDate>Wed, 20 Sep 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[ヘルスケア・ライフサイエンス分野において、大規模なオミクスデータを分析するためのコンピューティングのニーズは日々増大しています。今回は、AWS が提供するオミクスデータ分析のためのマネージドサービス「AWS HealthOmics」を使ったオミクスデータ分析ワークフローの構築方法について解説します。]]></description>
            <content:encoded><![CDATA[<p>ヘルスケア・ライフサイエンス分野において、大規模なオミクスデータを分析するためのコンピューティングのニーズは日々増大しています。今回は、AWS が提供するオミクスデータ分析のためのマネージドサービス「AWS HealthOmics」を使ったオミクスデータ分析ワークフローの構築方法について解説します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aws-healthomics-とは">AWS HealthOmics とは<a href="#aws-healthomics-とは" class="hash-link" aria-label="AWS HealthOmics とは への直接リンク" title="AWS HealthOmics とは への直接リンク">​</a></h2><p><a href="https://aws.amazon.com/jp/healthomics/" target="_blank" rel="noopener noreferrer">AWS HealthOmics</a> は、オミクス (ゲノム (Genomics) や転写産物 (Transcriptomics) など、生物学分野で -omics という名前を持つ大規模データの総称) データを扱うためのマネージドサービスです。オミクスデータを保存する Storage、クエリや分析を行う Analytics、分析ワークフローを実行する Workflows の 3 つの機能を提供しています。各機能の詳細については<a href="https://aws.amazon.com/jp/healthomics/features/" target="_blank" rel="noopener noreferrer">公式ページ</a>や <a href="https://aws.amazon.com/jp/blogs/news/introducing-amazon-omics-a-purpose-built-service-to-store-query-and-analyze-genomic-and-biological-data-at-scale/" target="_blank" rel="noopener noreferrer">AWS Blog の記事</a>、<a href="https://catalog.workshops.aws/amazon-omics-end-to-end/ja-JP" target="_blank" rel="noopener noreferrer">公式ハンズオン</a>などをご参照ください。</p><p>AWS では、AWS HealthOmics による分析ワークフローの実行と分析結果の閲覧ができる Web アプリケーション「<a href="https://github.com/aws-samples/amazon-omics-analysis-app" target="_blank" rel="noopener noreferrer">AWS HealthOmics Analysis App</a>」をサンプルとして公開しています。今回はこのアプリケーションを題材に、AWS HealthOmics を使ったオミクスデータ分析ワークフローについて解説します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aws-healthomics-analysis-app-の概要">AWS HealthOmics Analysis App の概要<a href="#aws-healthomics-analysis-app-の概要" class="hash-link" aria-label="AWS HealthOmics Analysis App の概要 への直接リンク" title="AWS HealthOmics Analysis App の概要 への直接リンク">​</a></h2><p><a href="https://github.com/aws-samples/amazon-omics-analysis-app" target="_blank" rel="noopener noreferrer">AWS HealthOmics Analysis App</a> は、AWS HealthOmics を使ってオミクスデータの分析ワークフローを実行し、分析結果を閲覧する Web アプリケーションのサンプル実装です。このアプリでは、以下のような機能を実装しています。</p><ul><li><a href="https://aws.amazon.com/jp/healthomics/" target="_blank" rel="noopener noreferrer">AWS HealthOmics</a> によるバイオインフォマティックスのワークフローの実行</li><li><a href="https://aws.amazon.com/jp/step-functions/" target="_blank" rel="noopener noreferrer">AWS Step Functions</a> によるワークフローの二次解析 (可視化) や完了通知の実行</li><li><a href="https://aws.amazon.com/jp/ses/" target="_blank" rel="noopener noreferrer">Amazon Simple Email Service (SES)</a> によるワークフロー完了通知メールの送信</li><li>ワークフロー実行結果のブラウズ</li><li>ワークフローで実行されたタスクの詳細情報の表示</li></ul><p>アプリケーションの全体アーキテクチャと、各サービスの役割は以下の通りです。</p><p><img loading="lazy" alt="全体アーキテクチャ" src="/assets/images/architecture-d84ed1f1f84c3f82af79a2313bf3036e.png" width="1280" height="720" class="img_ev3q"></p><table><thead><tr><th align="left">サービス</th><th align="left">役割</th></tr></thead><tbody><tr><td align="left">Amazon CloudFront</td><td align="left">Vue.js で実装されたフロントエンドのアセットを配信</td></tr><tr><td align="left">Amazon S3</td><td align="left">Vue.js で実装されたフロントエンドのアセットを格納</td></tr><tr><td align="left">Amazon Cognito</td><td align="left">ユーザー認証を行うためのユーザープールを提供<br>ユーザープールをフロントエンドやバックエンドから利用するためのユーザープールクライアントを提供</td></tr><tr><td align="left">Amazon API Gateway</td><td align="left">フロントエンドに対してバックエンドの REST API を提供</td></tr><tr><td align="left">AWS Step Functions</td><td align="left">AWS HealthOmics ワークフローの実行や二次解析 (可視化) 等のタスクを実行するステートマシンを提供</td></tr><tr><td align="left">AWS Lambda</td><td align="left">バックエンド API を実装した Lambda 関数を実行<br>Step Functions ステートマシンのタスクを実装した Lambda 関数を実行</td></tr><tr><td align="left">Amazon DynamoDB</td><td align="left">Step Functions で実行される二次解析 (可視化) の実行結果を管理</td></tr><tr><td align="left">Amazon QuickSight</td><td align="left">ワークフローの出力を可視化するためのダッシュボードを表示</td></tr><tr><td align="left">AWS WAF</td><td align="left">フロントエンドやバックエンド API にアクセスできる IP アドレスを制限</td></tr></tbody></table><p><a href="https://github.com/aws-samples/amazon-omics-analysis-app/blob/main/README.ja.md" target="_blank" rel="noopener noreferrer">GitHub の README</a> に書かれたデプロイ手順に従って、利用方法を解説します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aws-healthomics-analysis-app-のデプロイ">AWS HealthOmics Analysis App のデプロイ<a href="#aws-healthomics-analysis-app-のデプロイ" class="hash-link" aria-label="AWS HealthOmics Analysis App のデプロイ への直接リンク" title="AWS HealthOmics Analysis App のデプロイ への直接リンク">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="前提条件">前提条件<a href="#前提条件" class="hash-link" aria-label="前提条件 への直接リンク" title="前提条件 への直接リンク">​</a></h3><p>AWS HealthOmics Analysis App は <a href="https://aws.amazon.com/jp/cdk/" target="_blank" rel="noopener noreferrer">AWS Cloud Development Kit (CDK)</a> を使って AWS サービスの設定を行います。AWS CDK を使うには、前提条件として以下のソフトウェアがインストールされている必要があります。詳細は<a href="https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/getting_started.html#getting_started_prerequisites" target="_blank" rel="noopener noreferrer">こちらのドキュメント</a>をご参照ください。</p><ul><li><a href="https://aws.amazon.com/jp/cli/" target="_blank" rel="noopener noreferrer">AWS Command Line Interface (AWS CLI)</a></li><li><a href="https://nodejs.org/ja" target="_blank" rel="noopener noreferrer">Node.js</a></li><li><a href="https://www.docker.com/" target="_blank" rel="noopener noreferrer">Docker</a></li></ul><p>上記の条件を満たす環境として、<a href="https://aws.amazon.com/jp/cloud9/" target="_blank" rel="noopener noreferrer">AWS Cloud9</a> を使う事もできます。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="デプロイ">デプロイ<a href="#デプロイ" class="hash-link" aria-label="デプロイ への直接リンク" title="デプロイ への直接リンク">​</a></h3><p><a href="https://github.com/aws-samples/amazon-omics-analysis-app" target="_blank" rel="noopener noreferrer">AWS HealthOmics Analysis App の GitHub リポジトリ</a>を clone し、<a href="https://github.com/aws-samples/amazon-omics-analysis-app/blob/main/README.ja.md#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E6%96%B9%E6%B3%95" target="_blank" rel="noopener noreferrer">デプロイ手順のドキュメント</a>に従ってデプロイを実施してください。</p><p>なお、AWS HealthOmics が利用できるリージョンは現時点 (2023/9/20) で以下のようになっており、AWS HealthOmics Analysis App は us-east-1 リージョンにデプロイされる事を前提としています。</p><ul><li>us-east-1 (米国東部: バージニア北部)</li><li>us-west-2 (米国西部: オレゴン)</li><li>ap-southeast-1 (アジアパシフィック: シンガポール)</li><li>eu-central-1 (欧州: フランクフルト)</li><li>eu-west-1 (欧州: アイルランド)</li><li>eu-west-2 (欧州: ロンドン)</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ready2run-ワークフローを実行する">Ready2Run ワークフローを実行する<a href="#ready2run-ワークフローを実行する" class="hash-link" aria-label="Ready2Run ワークフローを実行する への直接リンク" title="Ready2Run ワークフローを実行する への直接リンク">​</a></h2><p>デプロイが完了したら、早速ワークフローを実行してみましょう。AWS HealthOmics では、以下の2種類のワークフローを実行することができます。</p><ul><li>初期設定不要ですぐに使える <a href="https://docs.aws.amazon.com/omics/latest/dev/service-workflows.html" target="_blank" rel="noopener noreferrer">Ready2Run ワークフロー</a></li><li>ユーザーがコードと初期設定を任意にカスタマイズできる<a href="https://docs.aws.amazon.com/omics/latest/dev/workflows.html" target="_blank" rel="noopener noreferrer">プライベートワークフロー</a></li></ul><p>今回は、Ready2Run ワークフローの中から、タンパク質の立体構造を予測する <a href="https://github.com/google-deepmind/alphafold" target="_blank" rel="noopener noreferrer">AlphaFold</a> を実行しようと思います。Ready2Run ワークフローの使い方は AWS HealthOmics コンソールの <a href="https://console.aws.amazon.com/omics/home#/ready2run" target="_blank" rel="noopener noreferrer">Ready2Run ワークフローのページ</a>で確認する事ができ、簡単に実行を試せるサンプルデータも提供されているので、今回はそれを利用して AlphaFold を実行します。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="実行手順">実行手順<a href="#実行手順" class="hash-link" aria-label="実行手順 への直接リンク" title="実行手順 への直接リンク">​</a></h3><ol><li>AWS HealthOmics Analysis App にサインインしたら「New Analysis」をクリックします。</li><li>次の画面で「Workflow」をクリックすると Ready2Run ワークフローの一覧が表示されるので、「AlphaFold for up to 600 residues」を選択します。</li><li>「Analysis Name」に任意の名前を入力して「CONTINUE」をクリックします。(「Visualizer」は今回は指定しません)</li></ol><p><img loading="lazy" alt="New Analysis" src="/assets/images/new_analysis_settings-2c08e9e161ed765c19f78be2f3c2a1e8.png" width="2670" height="1187" class="img_ev3q"></p><ol start="4"><li>次の画面で「fasta_path」に以下の S3 URL を入力し、「CONTINUE」をクリックします。</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">s3://omics-us-east-1/sample-inputs/4885129/3d06.fasta</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="Parameters" src="/assets/images/new_analysis_parameters-1bfa9b1360e3f12ae517285c01e62cc9.png" width="2083" height="763" class="img_ev3q"></p><ol start="5"><li>次の画面に表示された内容を確認し、「RUN」をクリックします。</li></ol><p><img loading="lazy" alt="Confirmation" src="/assets/images/new_analysis_confirmation-5851d0b5e04907534e0fc6349e0eacc6.png" width="2084" height="1459" class="img_ev3q"></p><ol start="6"><li>確認ダイアログが表示されるので、「OK」をクリックします。</li></ol><p>入力内容に問題がなければ、ワークフローを実行するための Step Functions ステートマシンが開始されます。「Analysis List」の更新ボタンを押すと、開始された AWS HealthOmics ワークフローが一覧に表示されます。</p><p>AlphaFold のサンプルの実行には6〜7時間ほどかかりますが、完了するとアカウントのメールアドレスに完了通知メールが送信されます。<br>
(メールを受信するには、事前にそのメールアドレスを Amazon SES の「検証済みID」として登録しておく必要があります。詳細は Amazon SES デベロッパーガイドの「<a href="https://docs.aws.amazon.com/ja_jp/ses/latest/dg/creating-identities.html#verify-email-addresses-procedure" target="_blank" rel="noopener noreferrer">Eメールアドレス ID の作成</a>」をご参照ください。)</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-functions-によるワークフローの実行">Step Functions によるワークフローの実行<a href="#step-functions-によるワークフローの実行" class="hash-link" aria-label="Step Functions によるワークフローの実行 への直接リンク" title="Step Functions によるワークフローの実行 への直接リンク">​</a></h2><p>Step Functions ステートマシンでは、以下のようなステップでタスクが実行されます。</p><ol><li>AWS HealthOmics ワークフローを実行する。</li><li>(指定されていれば) 二次解析 (可視化) を実行する。</li><li>完了通知を実行する。</li><li>ステートマシンの終了処理。</li></ol><p><img loading="lazy" alt="Step Functions ステートマシンの定義" src="/assets/images/stepfunctions-0b6d23d60bcd2d7d0a74a349b695eb0f.png" width="685" height="974" class="img_ev3q"></p><p>各ステップで実行されるタスクを解説します。タスクの詳細については<a href="https://docs.aws.amazon.com/ja_jp/step-functions/latest/dg/concepts-states.html" target="_blank" rel="noopener noreferrer">公式ドキュメント</a>をご参照ください。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="aws-healthomics-ワークフローの実行">AWS HealthOmics ワークフローの実行<a href="#aws-healthomics-ワークフローの実行" class="hash-link" aria-label="AWS HealthOmics ワークフローの実行 への直接リンク" title="AWS HealthOmics ワークフローの実行 への直接リンク">​</a></h3><table><thead><tr><th>タスク名</th><th>タスク種別</th><th>処理内容</th></tr></thead><tbody><tr><td>CheckOmicsStartRunTask</td><td>Choice</td><td>ステートマシンの入力に <code>OmicsStartRun</code> が含まれているかを確認</td></tr><tr><td>OmicsStartRunTask</td><td>Lambda</td><td>AWS HealthOmics のワークフローを実行</td></tr><tr><td>WaitAfterOmicsStartRunTask</td><td>Wait</td><td>AWS HealthOmics のワークフロー完了を数分間待機</td></tr><tr><td>OmicsGetRunStatusTask</td><td>Lambda</td><td>AWS HealthOmics のワークフロー実行状態を取得し、<code>OmicsRun</code> として出力</td></tr><tr><td>CheckOmicsRunFinishedTask</td><td>Choice</td><td>AWS HealthOmics ワークフローが完了したかを確認</td></tr><tr><td>CheckOmicsRunFailedTask</td><td>Choice</td><td>AWS HealthOmics ワークフローが失敗したかを確認</td></tr></tbody></table><p>ステートマシンの入力に <code>OmicsStartRun</code> が含まれていなかった場合、ワークフローの新規実行は行わずに以下のタスクに分岐します。</p><table><thead><tr><th>タスク名</th><th>タスク種別</th><th>処理内容</th></tr></thead><tbody><tr><td>CheckOmicsRunTask</td><td>Choice</td><td>ステートマシンの入力に <code>OmicsRun</code> が含まれているかを確認</td></tr><tr><td>OmicsGetRunTask</td><td>Lambda</td><td>AWS HealthOmics のワークフロー実行状態を取得する</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="二次解析-可視化-の実行">二次解析 (可視化) の実行<a href="#二次解析-可視化-の実行" class="hash-link" aria-label="二次解析 (可視化) の実行 への直接リンク" title="二次解析 (可視化) の実行 への直接リンク">​</a></h3><table><thead><tr><th>タスク名</th><th>タスク種別</th><th>処理内容</th></tr></thead><tbody><tr><td>CheckVisualizationTask</td><td>Choice</td><td>ステートマシンの入力に <code>Visualization</code> が含まれているかを確認</td></tr><tr><td>VisualizationTask</td><td>Step Functions</td><td>ワークフロー実行結果の二次解析 (可視化) を実行するため、別の Step Functions ステートマシンを起動</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="完了通知の実行">完了通知の実行<a href="#完了通知の実行" class="hash-link" aria-label="完了通知の実行 への直接リンク" title="完了通知の実行 への直接リンク">​</a></h3><table><thead><tr><th>タスク名</th><th>タスク種別</th><th>処理内容</th></tr></thead><tbody><tr><td>CheckNotificationTask</td><td>Choice</td><td>ステートマシンの入力に <code>Notification</code> が含まれているかを確認</td></tr><tr><td>NotificationTask</td><td>Lambda</td><td>Amazon SES で完了通知メールを送信</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ステートマシンの終了処理">ステートマシンの終了処理<a href="#ステートマシンの終了処理" class="hash-link" aria-label="ステートマシンの終了処理 への直接リンク" title="ステートマシンの終了処理 への直接リンク">​</a></h3><table><thead><tr><th>タスク名</th><th>タスク種別</th><th>処理内容</th></tr></thead><tbody><tr><td>CheckWorkflowRunnerFailedTask</td><td>Choice</td><td>AWS HealthOmics ワークフローが失敗したかを確認</td></tr><tr><td>WorkflowRunnerSucceedTask</td><td>Succeed</td><td>ステートマシンの状態を正常終了とする</td></tr><tr><td>OmicsRunFailedTask</td><td>Fail</td><td>ステートマシンの状態を失敗とする</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="分析結果のブラウズ">分析結果のブラウズ<a href="#分析結果のブラウズ" class="hash-link" aria-label="分析結果のブラウズ への直接リンク" title="分析結果のブラウズ への直接リンク">​</a></h2><p>ワークフローの実行が完了したら、分析結果をブラウズする事ができるようになります。「Analysis List」で該当のワークフローをクリックするか、または完了通知メールが届いた場合はメール内のリンクをクリックすると分析の詳細情報が表示され、「Outputs」でワークフローの出力ファイルをブラウズすることができます。</p><p><img loading="lazy" alt="Outputs" src="/assets/images/analysis_outputs-ac49613e8370041c52fc159ffef5b7e9.png" width="2030" height="847" class="img_ev3q"></p><p>ファイル名をクリックすると、ブラウザで表示可能な形式 (PDF や画像など) のファイルであれば別のタブで表示されます。「DOWNLOAD」をクリックすると、ファイルをダウンロードすることができます。</p><p>ブラウザで表示できない形式の出力ファイルについては、AWS HealthOmics Analysis App に二次解析によるデータ変換や可視化手法の登録を行うことで表示が可能となります。詳細については別の記事で解説予定です。</p><p>「Tasks」では、ワークフローで実行されたタスクの詳細情報を確認することができます。</p><p><img loading="lazy" alt="Tasks" src="/assets/images/analysis_tasks-09aee76b220d6cb709c19130fc6c067a.png" width="2216" height="1430" class="img_ev3q"></p><p>タスクの名前と実行時間、使用した vCPU やメモリ量などが表形式で表示され、その下では実行の時系列をグラフで確認できます。「VIEW LOGS」ボタンを押すと、タスクが実行中に CloudWatch Logs に出力したログを確認することができます。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h2><p>今回は、AWS HealthOmics のご紹介と、このサービスを AWS Step Functions と組み合わせたサンプルアプリである AWS HealthOmics Analysis App の解説を行いました。これらのサービスを活用することで、スケーラブルなオミクスデータ分析ワークフローを AWS 上に手軽に構築する事が可能となります。</p><p>次の記事: <a href="https://prototyping-blog.com/blog/aws-healthomics-analysis-app-alphafold/" target="_blank" rel="noopener noreferrer">AWS HealthOmics で AlphaFold を実行し、タンパク質の立体構造を可視化する</a></p>]]></content:encoded>
            <category>aws</category>
            <category>healthomics</category>
            <category>omics</category>
            <category>genomics</category>
        </item>
        <item>
            <title><![CDATA[CDK で instanceProps を使った RDS (Aurora) を writer と readers を使った書き方に移行する]]></title>
            <link>https://prototyping-blog.com/blog/cdk-aurora-migration</link>
            <guid>https://prototyping-blog.com/blog/cdk-aurora-migration</guid>
            <pubDate>Thu, 17 Aug 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[AWS CDK の v2.82.0 にて、Aurora Serverless V2 に対応したと同時に、RDS (Aurora) の記述方法が変わりました。]]></description>
            <content:encoded><![CDATA[<p>AWS CDK の <a href="https://github.com/aws/aws-cdk/releases/tag/v2.82.0" target="_blank" rel="noopener noreferrer">v2.82.0</a> にて、Aurora Serverless V2 に対応したと同時に、RDS (Aurora) の記述方法が変わりました。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="v2810-以前の書き方">v2.81.0 以前の書き方<a href="#v2810-以前の書き方" class="hash-link" aria-label="v2.81.0 以前の書き方 への直接リンク" title="v2.81.0 以前の書き方 への直接リンク">​</a></h2><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">const cluster = new rds.DatabaseCluster(this, 'Database', {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  engine: rds.DatabaseClusterEngine.auroraMysql({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    version: rds.AuroraMysqlEngineVersion.VER_3_03_0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  instances: 2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  instanceProps: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instanceType: ec2.InstanceType.of(ec2.InstanceClass.BURSTABLE3, ec2.InstanceSize.SMALL),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vpcSubnets: { subnetType: ec2.SubnetType.PUBLIC },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vpc,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>v2.18.0 以前はインスタンスの設定に <code>instances</code> や <code>instanceProps</code> を使っていました。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="v2820-以降の書き方">v2.82.0 以降の書き方<a href="#v2820-以降の書き方" class="hash-link" aria-label="v2.82.0 以降の書き方 への直接リンク" title="v2.82.0 以降の書き方 への直接リンク">​</a></h2><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">const cluster = new rds.DatabaseCluster(this, 'Database', {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    engine: rds.DatabaseClusterEngine.auroraMysql({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    version: rds.AuroraMysqlEngineVersion.VER_3_03_0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vpcSubnets: { subnetType: ec2.SubnetType.PUBLIC },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vpc,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    writer: rds.ClusterInstance.provisioned('Writer', {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instanceType: ec2.InstanceType.of(ec2.InstanceClass.BURSTABLE3, ec2.InstanceSize.SMALL),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    readers: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rds.ClusterInstance.provisioned('Reader1', {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        instanceType: ec2.InstanceType.of(ec2.InstanceClass.BURSTABLE3, ec2.InstanceSize.SMALL),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>v2.82.0 以降は <code>instances</code> と <code>instanceProps</code> が Deprecated になり、代わりに <code>writer</code> と <code>readers</code> を利用することが推奨されています。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="既存の-rds-aurora-を移行する手順">既存の RDS (Aurora) を移行する手順<a href="#既存の-rds-aurora-を移行する手順" class="hash-link" aria-label="既存の RDS (Aurora) を移行する手順 への直接リンク" title="既存の RDS (Aurora) を移行する手順 への直接リンク">​</a></h2><p><code>instances</code> と <code>instanceProps</code> を使っていたインスタンスを <code>writer</code> と <code>readers</code> を使った書き方に移行するため、<code>isFromLegacyInstanceProps</code> というオプションが用意されています。
また Coustruct ID も以前のものに合わせる (今回は Instance1-2) 必要があります。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">const cluster = new rds.DatabaseCluster(this, 'Database', {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    engine: rds.DatabaseClusterEngine.auroraMysql({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    version: rds.AuroraMysqlEngineVersion.VER_3_03_0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vpcSubnets: { subnetType: ec2.SubnetType.PUBLIC },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vpc,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    writer: rds.ClusterInstance.provisioned('Instance1', {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instanceType: ec2.InstanceType.of(ec2.InstanceClass.BURSTABLE3, ec2.InstanceSize.LARGE),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    isFromLegacyInstanceProps: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    readers: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rds.ClusterInstance.provisioned('Instance2', {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        instanceType: ec2.InstanceType.of(ec2.InstanceClass.BURSTABLE3, ec2.InstanceSize.LARGE),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        isFromLegacyInstanceProps: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>デプロイ前には <code>cdk diff</code> を使って差分がないことを確認しましょう。
差分がある場合には以下のように表示され、一度インスタンスが削除されてしまうことが分かります。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">% cdk diff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Stack SampleStack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Resources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[-] AWS::RDS::DBInstance Database/Instance1 DatabaseInstance1844F58FD destroy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[-] AWS::RDS::DBInstance Database/Instance2 DatabaseInstance2AA380DEE destroy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] AWS::RDS::DBInstance Database/Instance1 DatabaseInstance14A23AADF </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] AWS::RDS::DBInstance Database/Instance2 DatabaseInstance20B30A4F7 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>差分がない場合には以下のように表示されます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">% cdk diff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Stack SampleStack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">There were no differences</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>isFromLegacyInstanceProps</code> は CDK v2.89.0 以降で使用できます。</p>]]></content:encoded>
            <category>cdk</category>
            <category>rds</category>
            <category>aurora</category>
        </item>
        <item>
            <title><![CDATA[Lambda SnapStart を Java 以外で有効化する方法]]></title>
            <link>https://prototyping-blog.com/blog/snapstart-any-langs</link>
            <guid>https://prototyping-blog.com/blog/snapstart-any-langs</guid>
            <pubDate>Thu, 13 Jul 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Lambda SnapStat を Java 以外で有効化する方法をご紹介いたします。]]></description>
            <content:encoded><![CDATA[<p>Lambda SnapStat を Java 以外で有効化する方法をご紹介いたします。</p><ul><li><strong>こちらの記事で紹介している方法は、AWS 公式で案内している方法ではありません</strong></li><li><strong>実施する場合は、あくまで検証のために行い、本番環境では絶対に利用しないでください</strong></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景 への直接リンク" title="背景 への直接リンク">​</a></h2><p>Lambda SnapStart はコールドスタートのボトルネックを改善する機能です。初回起動時の実行環境のメモリとディスクの状態の Firecracker MicroVM スナップショットを作成し、キャッシュします。次回以降のコールドスタートは、スナップショットをロードすることで高速化を図ります。</p><p>現時点 (2023/07/13) では、Lambda SnapStart は Java 11 マネージドランタイムのみをサポートしています。Node.js や Python などはサポートされていません。そこで、この記事では Lambda SnapStart を Java 11 以外の言語で書かれた Lambda 関数でも有効化する方法を紹介します。<strong>ただし、あくまでハックな方法であり、AWS 公式が案内する手順ではありません。検証にとどめ、本番環境では絶対に利用しないでください。</strong>また、具体的なコードや設定ファイルなどを紹介することは控えさせていただきますので、ご了承ください。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="有効化手順">有効化手順<a href="#有効化手順" class="hash-link" aria-label="有効化手順 への直接リンク" title="有効化手順 への直接リンク">​</a></h2><p>Java 11 以外のランタイムを選択すると、そもそも SnapStart を有効化できないため、Java 11 のランタイムを選択した状態で、いかに他の言語の Lambda 関数を動かすかというのが議題です。具体的に申し上げますと、以下の 2 ステップを考慮する必要があります。</p><ol><li>Java 11 ランタイムで、<strong>どのようにして他の言語を実行可能にするか</strong></li><li>どのようにして <strong>Lambda 関数として実行可能にするか</strong></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="java-11-ランタイムでどのようにして他の言語を実行可能にするか">Java 11 ランタイムで、どのようにして他の言語を実行可能にするか<a href="#java-11-ランタイムでどのようにして他の言語を実行可能にするか" class="hash-link" aria-label="Java 11 ランタイムで、どのようにして他の言語を実行可能にするか への直接リンク" title="Java 11 ランタイムで、どのようにして他の言語を実行可能にするか への直接リンク">​</a></h3><p>とどのつまり、Java 11 ラインタイムを無視して、他の言語が実行できれば問題ないわけです。
これに関しては、現状わかっているだけでも以下の手段があります。</p><ol><li>コンパイル言語であるなら、バイナリをインストールすれば良い</li><li>スクリプト言語なら、ランタイムをインストールすれば良い (Lambda Layer に置いてパスを通す)</li><li>スクリプト言語でもコンパイル可能であればそれを利用する</li><li>JVM で実行可能な形式に変換できるなら、それも可 (JRuby など)</li></ol><p>(1) に関してはほとんど説明不要で、例えば Go や Rust などはこれに当たります。生成されたバイナリを Lambda 関数にアップロードすれば良いです。(2) に関しては、例えば <code>node</code> や <code>python</code> などを Lambda Layer に置けば、その言語が利用できるようになります。ただし、250 MB の制限があるため、収まるか検証が必要です。(3) に関しては、例えば JavaScript のオルタナティブランタイムである Deno がこれに当たります。Deno であれば <code>deno compile</code> コマンドで実行可能ファイルを作成可能です。また、Node.js に関しても v19.7 ~ に試験的に導入された postject という機能で実行可能バイナリを生成することができます。ただし、こちらは手元で検証した結果 glibc のバージョンが合わずに実行できませんでした。(4) に関してはあまり検証できていませんが、理論的には JRuby などは実行可能だと思います。また、2.x 系しかサポートされていませんが Jython (implementation of Python in Java) もこれに当たります。</p><p>以上のように、限定的ではあるものの、ハックすれば Java 11 ランタイムを選択した場合でも、他の言語が実行可能であることはわかりました。しかし、Lambda 関数としてどのようなコードになるでしょうか。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="どのようにして-lambda-関数として実行可能にするか">どのようにして Lambda 関数として実行可能にするか<a href="#どのようにして-lambda-関数として実行可能にするか" class="hash-link" aria-label="どのようにして Lambda 関数として実行可能にするか への直接リンク" title="どのようにして Lambda 関数として実行可能にするか への直接リンク">​</a></h3><p>これは現状わかっている範囲で、1 択です。<a href="https://github.com/awslabs/aws-lambda-web-adapter" target="_blank" rel="noopener noreferrer">Lambda Web Adapter</a> を利用します。Lambda Web Adapter を利用すれば、Lambda 関数の invoke を、通常の HTTP リクエストとして受けることができます。つまり、慣れ親しんだ Web フレームワークが利用できます。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="サンプル">サンプル<a href="#サンプル" class="hash-link" aria-label="サンプル への直接リンク" title="サンプル への直接リンク">​</a></h3><ul><li>Lambda Web Adapter のリポジトリの examples に、<code>deno compile</code> を利用して SnapStart を有効化しているサンプルがあります。(<a href="https://github.com/awslabs/aws-lambda-web-adapter/tree/main/examples/deno-zip" target="_blank" rel="noopener noreferrer">こちら</a>)</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h2><p>この記事では Lambda SnapStart を Java 11 以外の言語で有効化する手順について説明しました。3 度目になりますが、<strong>AWS 公式で案内している手順ではありません。これらの手順に関して、AWS からはいかなるサポートも受けることができません。また、本番環境での利用は絶対にしないでください。</strong></p>]]></content:encoded>
            <category>lambda</category>
        </item>
        <item>
            <title><![CDATA[5分でEC2 + Remote SSH開発環境を構築する]]></title>
            <link>https://prototyping-blog.com/blog/ec2-proto-env</link>
            <guid>https://prototyping-blog.com/blog/ec2-proto-env</guid>
            <pubDate>Mon, 10 Jul 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[開発環境の構築は慣れている人にとっては手間ではないものの、開発に不慣れな人にとっては躓きがちなポイントの一つとなります。このような場合選択肢の一つとしてCloud9 を使った方法が挙げられますが、チームの方針や好みなどでVisual Studio Code (以降 vscode と呼称) を利用したいケースもあるでしょう。ここではRemote SSH 用に、プロトタイピング用途でよく利用されるソフトウェアをプリインストールした EC2 インスタンスを手軽に構築する方法について紹介します。]]></description>
            <content:encoded><![CDATA[<p>開発環境の構築は慣れている人にとっては手間ではないものの、開発に不慣れな人にとっては躓きがちなポイントの一つとなります。このような場合選択肢の一つとして<a href="https://prototyping-blog.com/blog/cdk-deploy-cloudshell-cloud9" target="_blank" rel="noopener noreferrer">Cloud9 を使った方法</a>が挙げられますが、チームの方針や好みなどで<a href="https://code.visualstudio.com/" target="_blank" rel="noopener noreferrer">Visual Studio Code</a> (以降 vscode と呼称) を利用したいケースもあるでしょう。ここでは<a href="https://code.visualstudio.com/docs/remote/ssh" target="_blank" rel="noopener noreferrer">Remote SSH</a> 用に、プロトタイピング用途でよく利用されるソフトウェアをプリインストールした EC2 インスタンスを手軽に構築する方法について紹介します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景 への直接リンク" title="背景 への直接リンク">​</a></h2><p><a href="https://aws.amazon.com/jp/cloud9/" target="_blank" rel="noopener noreferrer">AWS Cloud9</a>はプロトタイピング用途で頻繁に登場するソフトウェア (AWS CLI v2, Python, Node.js, Docker 等) がプリインストール済みのため、プロトタイプ開発用途に向いていると言えます。一方で何らかの事情により vscode を利用したいケースもあるでしょう。たとえばチーム開発でリンター・フォーマッターを導入しており、チーム共通の vscode プラグインや設定を使いたい場合などのケースが相当します。この場合ローカルに開発環境を作成する選択肢が考えられますが、主に Docker の環境構築に困難を伴うことがあるでしょう。例えば予算など組織的な事情により<a href="https://www.docker.com/products/docker-desktop/" target="_blank" rel="noopener noreferrer">Docker Desktop</a>が利用できない場合、Windows の場合は WSL2、Mac OS の場合は<a href="https://github.com/lima-vm/lima" target="_blank" rel="noopener noreferrer">lima</a>や<a href="https://github.com/runfinch/finch" target="_blank" rel="noopener noreferrer">finch</a>がその代替となり得ますが、開発に不慣れな場合、自力でトラブルシューティングすることが難しい場合があります。このような場合、EC2 (Amazon Linux 2) 上に環境構築し、Remote SSH で開発する選択肢が有効と考えられます。なお Docker は ECS/EKS 以外にも、CDK 開発で頻出のコンストラクタ (<a href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-lambda-python-alpha-readme.html" target="_blank" rel="noopener noreferrer">aws-lambda-python-alpha module</a>など) においても利用されるため、導入しておくと便利です。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="構築手順">構築手順<a href="#構築手順" class="hash-link" aria-label="構築手順 への直接リンク" title="構築手順 への直接リンク">​</a></h2><ol><li>AWS アカウントを用意します</li><li><a href="https://console.aws.amazon.com/cloudshell/home" target="_blank" rel="noopener noreferrer">CloudShell</a>を開きます</li><li>CloudShell のプロンプトで下記コマンドを実行します。なお<code>XX.XX.XX.XX</code>は接続元の IP アドレスで置換してください</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/aws-samples/ec2-setup-for-prototyping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd ec2-setup-for-prototyping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./bin.sh XX.XX.XX.XX/32 ProtoEnvStack</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="4"><li>CloudFormation のスタック作成が完了するまで 5 分ほど待機します。完了後、下記の内容が出力されるため適当なエディタなどに控えておきます</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Copy ssh key from here: ===============================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----BEGIN RSA PRIVATE KEY-----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----END RSA PRIVATE KEY-----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">End of ssh key ===============================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HostPublicIP: YY.YY.YY.YY</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="5"><li><p><code>prototype.pem</code>などの名前で ssh key ファイルを作成します。作成後、控えた RSA PRIVATE KEY の内容を貼り付けます</p></li><li><p>作成したファイルのパーミッションを変更します</p></li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">chmod 400 prototype.pem</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="7"><li>ssh コマンドでログインできることを確認します。なお<code>YY.YY.YY.YY</code>は 4.で控えた<code>HostPublicIP</code>です</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ssh -i prototype.pem ec2-user@YY.YY.YY.YY</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="8"><li>(optional) インストールされている各ソフトウェアのバージョンを下記コマンドで確認します。</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker -v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 -V</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node -v</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="9"><li><a href="https://code.visualstudio.com/docs/remote/ssh" target="_blank" rel="noopener noreferrer">Remote Development using SSH</a>の手順に従って、vscode をセットアップしたら完成です。</li></ol><p>実装の詳細は<a href="https://github.com/aws-samples/ec2-setup-for-prototyping" target="_blank" rel="noopener noreferrer">GitHub</a>を参照ください。</p><hr><p>本記事では小規模のプロトタイプ用途を想定し EC2 インスタンスを SSH 接続先として構築しましたが、<a href="https://docs.aws.amazon.com/toolkit-for-vscode/latest/userguide/codecatalyst-service.html" target="_blank" rel="noopener noreferrer">CodeCatalyst for VS Code</a>をお使いいただくことでも同等のことが実現できます。より大規模でマネージドなプロジェクトを取り扱う場合は CodeCatalyst も検討してみてください。</p>]]></content:encoded>
            <category>ec2</category>
            <category>cloudshell</category>
        </item>
        <item>
            <title><![CDATA[API Loader を使ってプレビューリリースバージョンの AWS Service を SDK から利用する]]></title>
            <link>https://prototyping-blog.com/blog/preview-service-apiloader</link>
            <guid>https://prototyping-blog.com/blog/preview-service-apiloader</guid>
            <pubDate>Wed, 21 Jun 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[プレビューリリース段階の AWS Service では、それを利用するための API が AWS SDK に用意されていないことがあります。このような場合、プレビューリリースバージョンの Service API を、API Loader を使い AWS SDK に登録して利用するケースがありますので、その例を紹介します。]]></description>
            <content:encoded><![CDATA[<p>プレビューリリース段階の AWS Service では、それを利用するための API が AWS SDK に用意されていないことがあります。このような場合、プレビューリリースバージョンの Service API を、API Loader を使い AWS SDK に登録して利用するケースがありますので、その例を紹介します。</p><p><strong>Note:</strong> 本記事で利用する SDK は AWS SDK for JavaScript v2 です。v3 では利用できないためご注意ください</p><ol><li><p>プレビューサービス API のモデルファイルを入手します</p><p>モデルファイルは <a href="https://github.com/aws-samples/healthlake-imaging-to-dicom-python-module/blob/dc781e327c24fedff9b2794c8e25beecc760386e/example/service-2.json" target="_blank" rel="noopener noreferrer">こちら</a> のような形式の JSON データです。決まった入手方法があるわけではないため詳細は記載できませんが、プレビューサービスを利用する場合はまず必要になるデータです。</p></li></ol><div class="language-jsonc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsonc codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "version":"2.0",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "metadata":{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "apiVersion":"2023-06-21",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "endpointPrefix":"preview-service",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "jsonVersion":"1.1",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "protocol":"rest-json",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "serviceFullName":"Amazon Preview Service",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "serviceId":"Preview Service",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "signatureVersion":"v4",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "signingName":"preview-service",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "uid":"preview-service-2023-06-21"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "operations":{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "CreateDatastore":{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "name":"CreateDatastore",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "http":{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "method":"POST",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "requestUri":"/datastore",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "responseCode":200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>API Loader を使ってモデルデータを読み込み、サービスを定義します</li></ol><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// lib/preview_service.js</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AWS</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'aws-sdk/lib/core'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token maybe-class-name">Service</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AWS</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">Service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> apiLoader </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AWS</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apiLoader</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiLoader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">services</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'preview-service'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">AWS</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">PreviewService</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">Service</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">defineService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'preview-service'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'2023-06-21'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token known-class-name class-name">Object</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">defineProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">apiLoader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">services</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'preview-service'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'2023-06-21'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">get</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'./preview-service.json'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">paginators</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">waiters</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">enumerable</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">configurable</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AWS</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">PreviewService</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Note:</strong> サービスによっては <code>paginators.json</code> や <code>waiters.json</code> なども提供されています。必要に応じてそれぞれ <code>model.paginators</code> や <code>model.waiters</code> に指定します</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">paginators</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'./paginators.json'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">pagination</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>あとは定義したサービスを利用するだけです</li></ol><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token maybe-class-name">PreviewService</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'./lib/preview_service'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> ps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">PreviewService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'2023-06-21'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">region</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'us-east-1'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 必要に応じてプレビューサービス用のエンドポイントを指定</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">endpoint</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AWS</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Endpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'preview.service.endpoint.amazonaws.example.com'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">main</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> ps</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">promise</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Note:</strong> 定義したサービスにどのような API があるかはプレビューサービスのドキュメントなどから学習できますが、モデルファイルの JSON にも各 API の定義とドキュメントが含まれています。こちらを参照して学習することも可能です</p>]]></content:encoded>
            <category>sdk</category>
        </item>
        <item>
            <title><![CDATA[Amazon Linux 2023 の EC2 インスタンスから CloudWatch Logs にアプリケーションログを転送する]]></title>
            <link>https://prototyping-blog.com/blog/ec2-cloudwatchlogs-al2023</link>
            <guid>https://prototyping-blog.com/blog/ec2-cloudwatchlogs-al2023</guid>
            <pubDate>Tue, 20 Jun 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Amazon Linux 2023 は systemd のバージョンが 252 にアップデートされています。このバージョンでは StandardOutput などの出力オプションで append プレフィックスが利用できるため、EC2 インスタンス内で動作するアプリケーションのログを手軽にファイル出力して CloudWatch Logs に転送できます。]]></description>
            <content:encoded><![CDATA[<p>Amazon Linux 2023 は systemd のバージョンが 252 にアップデートされています。このバージョンでは <code>StandardOutput</code> などの出力オプションで <code>append</code> プレフィックスが利用できるため、EC2 インスタンス内で動作するアプリケーションのログを手軽にファイル出力して CloudWatch Logs に転送できます。</p><ol><li><p>ログの転送設定ファイルを作成します</p><p>作成先に指定はありませんが後ほど参照するため、ここでは <code>/home/ec2-user/logtransfer.json</code> とします。下記例では ログファイル <code>/var/log/sampleapp.log</code> を CloudWatch Logs の <code>/ec2/sampleapp/{instance_id}</code> に書き出します。</p></li></ol><div class="language-jsonc codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsonc codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "agent": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "logfile": "/opt/aws/amazon-cloudwatch-agent/logs/amazon-cloudwatch-agent.log"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "logs": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "log_stream_name": "{instance_id}",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "force_flush_interval": 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "logs_collected": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "files": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "collect_list": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "file_path": "/var/log/sampleapp.log",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "log_group_name": "/ec2/sampleapp",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "log_stream_name": "{instance_id}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li><code>amazon-cloudwatch-agent</code> をインストールして設定ファイルを読み込みます</li></ol><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo dnf install amazon-cloudwatch-agent -y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c file:/home/ec2-user/logtransfer.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>Systemd Unit 定義ファイルを作成して有効化します</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description=Sample Application</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Requires=cloud-final.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">After=cloud-final.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type=simple</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WorkingDirectory=/var/app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStart=/usr/bin/bash /var/app/sampleapp.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Restart=always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RestartSec=1s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LimitNOFILE=65535</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TimeoutStopSec=20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StandardOutput=append:/var/log/sampleapp.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StandardError=append:/var/log/sampleapp.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Install]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WantedBy=cloud-init.target</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo cp sampleapp.service /usr/lib/systemd/system/sampleapp.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo systemctl enable sampleapp.service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="注意事項">注意事項<a href="#注意事項" class="hash-link" aria-label="注意事項 への直接リンク" title="注意事項 への直接リンク">​</a></h3><p>この仕組みは EC2 インスタンスのログを必ず全て CloudWatch Logs に転送するというものではありません。例えば何らかの要因で強制的なシャットダウンが発生した場合などでは、<code>force_flush_interval</code> の間隔を下回るログをロストする可能性があります。また仮にログローテートを設定した場合は、<code>copytruncate</code> によるログのロストも考えられます。本記事に記載のログを転送する方法は「ロバストな方法」ではなく「簡単に設定できる方法」とお考えください。</p>]]></content:encoded>
            <category>ec2</category>
            <category>cloudwatch</category>
        </item>
        <item>
            <title><![CDATA[React と Amazon Transcribe でストリーミング文字起こしを行う方法]]></title>
            <link>https://prototyping-blog.com/blog/transcribe-in-react</link>
            <guid>https://prototyping-blog.com/blog/transcribe-in-react</guid>
            <pubDate>Thu, 01 Jun 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Amazon Transcribe (以降、Transcribe) は、音声をテキストに変換するサービスです。]]></description>
            <content:encoded><![CDATA[<p><a href="https://aws.amazon.com/jp/transcribe/" target="_blank" rel="noopener noreferrer">Amazon Transcribe</a> (以降、Transcribe) は、音声をテキストに変換するサービスです。<br>
<!-- -->SDK を利用したストリーミング文字起こしを行うことで、リアルタイムに文字起こしを行うことができます。<br>
<!-- -->本記事では、React で実装された Web アプリで Transcribe のストリーミング文字起こし機能を使う際に、Polyfill の設定が必要になるためそれを中心に解説します。  </p><p>本記事のベースとなっているコードは、<a href="https://github.com/wadabee/react-transcribe" target="_blank" rel="noopener noreferrer">こちらの GitHub リポジトリ</a>で公開していますので、併せてご確認ください。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ストリーミング文字起こしについて">ストリーミング文字起こしについて<a href="#ストリーミング文字起こしについて" class="hash-link" aria-label="ストリーミング文字起こしについて への直接リンク" title="ストリーミング文字起こしについて への直接リンク">​</a></h2><p>Transcribe のストリーミング文字起こしは、<a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/clients/client-transcribe-streaming/" target="_blank" rel="noopener noreferrer">@aws-sdk/client-transcribe-streaming</a> と <a href="https://github.com/microphone-stream/microphone-stream#readme" target="_blank" rel="noopener noreferrer">microphone-stream</a> を利用することで簡単に実装するできます。<br>
<a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/clients/client-transcribe-streaming/" target="_blank" rel="noopener noreferrer">@aws-sdk/client-transcribe-streaming</a> のドキュメントで紹介されているサンプルコードを、ほぼそのまま流用することが可能ですが、Polyfill の設定をしないとエラーが発生し実行することができません。<br>
<!-- -->この記事では、<a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/clients/client-transcribe-streaming/" target="_blank" rel="noopener noreferrer">@aws-sdk/client-transcribe-streaming</a> で紹介されているサンプルコードを実装する際のエラー解消方法を解説します。  </p><p>また、<code>webpack</code> と <code>Vite</code> で対応方法が異なるため、それぞれで適切対応を取る必要があります。<br>
<code>webpack</code> と <code>Vite</code> それぞれの、Polyfill の設定方法をご紹介します。  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="polyfill-とは">Polyfill とは<a href="#polyfill-とは" class="hash-link" aria-label="Polyfill とは への直接リンク" title="Polyfill とは への直接リンク">​</a></h3><p>プログラムの解説に入る前に、簡単に Polyfill について解説します。<br>
<!-- -->Polyfill とは、JavaScript の実行環境の差異を吸収するためのコードのことです。  </p><p>JavaScript の実行環境（ブラウザや Node.js など）は多岐にわたるため、実行環境によってはある文法やある機能をサポートしていない場合があります。<br>
<!-- -->Polyfill はそのサポートしていない文法や機能を実現するためのコードになります（サポートしている古い文法・機能を使って、サポートしていない新しい文法・機能を再現します）。  </p><p>利用するライブラリやアプリを動かす実行環境によっては、Polyfill の設定が必要になることがあります。  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="webpack-の対応方法">webpack の対応方法<a href="#webpack-の対応方法" class="hash-link" aria-label="webpack の対応方法 への直接リンク" title="webpack の対応方法 への直接リンク">​</a></h3><p>サンプルコードを Polyfill の設定を行わずに実行すると、以下のようなビルドエラーが発生します。  </p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">BREAKING CHANGE: webpack </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> used to include polyfills </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> node.js core modules by default.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This is no longer the case. Verify </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> you need this module and configure a polyfill </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> it.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>こちらは、webpack 5 から Node.js の Polyfill のコードが含まれなくなっているため、上記のエラーが発生しています。<br>
<!-- -->必要な Polyfill のコードを手動でインストールする必要があります。<br>
<!-- -->今回は、<code>buffer</code> と <code>process</code> が必要なので、それぞれインストールします。  </p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">npm</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> buffer process</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>これでビルドエラーは解消できますが、Transcribe　を実行すると以下のようなエラーが発生します。  </p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">index.js:35 Uncaught ReferenceError: Buffer is not defined</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at fromArrayBuffer </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index.js:35:1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at Object.bufferFrom </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">as default</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index.js:60:1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at ScriptProcessorNode.recorderProcess </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">microphone-stream.js:108:1</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>このエラーは、<code>index.tsx</code> などに、以下の Polyfill 用のコードを追加することで解消できます。</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#393A34">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">Buffer</span><span class="token imports"> </span><span class="token imports punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"buffer"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports operator" style="color:#393A34">*</span><span class="token imports"> </span><span class="token imports keyword module" style="color:#00009f">as</span><span class="token imports"> process</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">process</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> process</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">Buffer</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">Buffer</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>これで、正常に Transcribe の実行ができるようになります。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="vite-の対応方法">Vite の対応方法<a href="#vite-の対応方法" class="hash-link" aria-label="Vite の対応方法 への直接リンク" title="Vite の対応方法 への直接リンク">​</a></h3><p><code>Vite</code> も <code>webpack</code> と同様で、 Polyfill の設定を行わずにサンプルコードを実行すると、エラーが発生します。  </p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">index.js:37 Uncaught ReferenceError: Buffer is not defined</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at fromArrayBuffer </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index.js:37:11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at Object.bufferFrom </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">as default</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index.js:60:12</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at ScriptProcessorNode.recorderProcess </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">microphone-stream.js:110:37</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>webpack</code> と同様に、必要な Polyfill のコードをインストールした後に、<code>main.tsx</code> などに以下のコードを追記してください。<br>
<!-- -->ただ、<code>Vite</code> では <code>process</code> は利用しませんので、こちらは不要です。  </p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">npm</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> buffer</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#393A34">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">Buffer</span><span class="token imports"> </span><span class="token imports punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"buffer"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// eslint-disable-next-line @typescript-eslint/no-explicit-any</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token dom variable" style="color:#36acaa">window</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">Buffer</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">Buffer</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>Vite</code> の場合は、上記の対応だけでは不十分で、Transcribe を実行すると以下のエラーが発生します。  </p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Uncaught </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in promise</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> TypeError: Cannot </span><span class="token builtin class-name">read</span><span class="token plain"> properties of undefined </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reading </span><span class="token string" style="color:#e3116c">'call'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at MicrophoneStream2.Readable </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_stream_readable.js:178:10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at new MicrophoneStream2 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">microphone-stream.js:46:28</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at startTranscription </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">useTranscribe.ts:120:17</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at HTMLUnknownElement.callCallback2 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">react-dom.development.js:4164:14</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at Object.invokeGuardedCallbackDev </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">react-dom.development.js:4213:16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at invokeGuardedCallback </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">react-dom.development.js:4277:31</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at invokeGuardedCallbackAndCatchFirstError </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">react-dom.development.js:4291:25</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at executeDispatch </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">react-dom.development.js:9041:3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at processDispatchQueueItemsInOrder </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">react-dom.development.js:9073:7</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at processDispatchQueue </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">react-dom.development.js:9086:5</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>こちらのエラーは、Node.js の Core Module の Polyfill を行う Vite プラグインを導入することで解消できます。<br>
<!-- -->プラグインは、<a href="https://github.com/davidmyersdev/vite-plugin-node-polyfills" target="_blank" rel="noopener noreferrer">vite-plugin-node-polyfills</a> を利用します。<br>
<!-- -->プラグインをインストールしてから、<code>vite/vite.config.ts</code> を以下のように修正してください。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">npm</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -D vite-plugin-node-polyfills</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> defineConfig </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"vite"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> react </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"@vitejs/plugin-react"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> nodePolyfills </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"vite-plugin-node-polyfills"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// https://vitejs.dev/config/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">defineConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  plugins</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">react</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">nodePolyfills</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Whether to polyfill `node:` protocol imports.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      protocolImports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>これで、<code>Vite</code> でも正常に Transcribe の実行ができるようになります。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="さいごに">さいごに<a href="#さいごに" class="hash-link" aria-label="さいごに への直接リンク" title="さいごに への直接リンク">​</a></h2><p>以上が、React で Transcribe を使ったストリーミング文字起こしを実装する方法でした。<br>
<a href="https://github.com/wadabee/react-transcribe" target="_blank" rel="noopener noreferrer">こちらの GitHub リポジトリ</a>でコードを公開していますので、詳細な実装はこちらでご確認ください。</p>]]></content:encoded>
            <category>react</category>
            <category>typescript</category>
            <category>transcribe</category>
        </item>
        <item>
            <title><![CDATA[Kendra で S3 ドキュメントのアクセスコントロールを行う方法]]></title>
            <link>https://prototyping-blog.com/blog/kendra-s3-access-control</link>
            <guid>https://prototyping-blog.com/blog/kendra-s3-access-control</guid>
            <pubDate>Tue, 16 May 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Amazon Kendra (以降、Kendra) は、機械学習 (ML) を利用したインテリジェント検索サービスです。]]></description>
            <content:encoded><![CDATA[<p><a href="https://aws.amazon.com/jp/kendra/" target="_blank" rel="noopener noreferrer">Amazon Kendra</a> (以降、Kendra) は、機械学習 (ML) を利用したインテリジェント検索サービスです。<br>
<!-- -->この記事では、ユーザの権限によって検索ドキュメントのアクセスコントロールを行う方法をご紹介します。<br>
<strong>[2023/07/12]<!-- -->：記事の内容をアップデートしました。</strong></p><p>本記事で紹介するアクセスコントロールのサンプルコードは、<a href="https://github.com/aws-samples/simple-lex-kendra-jp/" target="_blank" rel="noopener noreferrer">simple-lex-kendra-jp</a> という GitHub リポジトリで公開しておりますので、合わせてご確認ください。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kendra-のアクセスコントロールについて">Kendra のアクセスコントロールについて<a href="#kendra-のアクセスコントロールについて" class="hash-link" aria-label="Kendra のアクセスコントロールについて への直接リンク" title="Kendra のアクセスコントロールについて への直接リンク">​</a></h2><p>Kendra では、<code>AccessControlList</code> を利用してアクセスコントロールを行うことが可能です。<code>AccessControlList</code> は <code>ACL</code> と省略して表現されることもあります。</p><p>本記事では、 Amazon S3 (以降、S3) の Data source connection のアクセスコントロールについて解説します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="アクセスコントロールの種類">アクセスコントロールの種類<a href="#アクセスコントロールの種類" class="hash-link" aria-label="アクセスコントロールの種類 への直接リンク" title="アクセスコントロールの種類 への直接リンク">​</a></h2><p>Amazon S3 ドキュメントのアクセスコントロールは、「メタデータ使う方法」と「設定ファイルを使う方法」の 2 つがあります。</p><ul><li>メタデータを使う方法<ul><li>Amazon S3 ドキュメントにはメタデータを設定できますが、そのメタデータのひとつとして <code>AccessControlList</code> があります。</li><li><code>AccessControlList</code> にアクセス条件を設定することで、ファイルごとにアクセスコントロールを行うことができます。</li><li>本題とはそれますが、FAQ にもアクセスコントロール用のメタデータが用意されているため、そちらを利用することで S3 ドキュメントと同様のアクセスコントロールが可能です（<a href="https://docs.aws.amazon.com/ja_jp/kendra/latest/dg/in-creating-faq.html" target="_blank" rel="noopener noreferrer">参考</a>）。</li></ul></li><li>設定ファイルを使う方法<ul><li>アクセスコントロール設定用の JSON ファイルを定義することで、一元的にアクセスコントロールを設定することが可能です。</li><li>フォルダ単位または、ファイル単位で、アクセスコントロールを行うことができます。</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="メタデータによるアクセスコントロール">メタデータによるアクセスコントロール<a href="#メタデータによるアクセスコントロール" class="hash-link" aria-label="メタデータによるアクセスコントロール への直接リンク" title="メタデータによるアクセスコントロール への直接リンク">​</a></h2><p>メタデータファイルを使用して、S3 ドキュメントに対してメタデータを設定できます。<br>
<!-- -->メタデータはアクセスコントロール以外の用途でも利用することが可能で、各属性を設定することにより属性を考慮したドキュメント検索（絞り込みやキーワード検索）を行うことが可能になります。<br>
<!-- -->詳細については、<a href="https://docs.aws.amazon.com/kendra/latest/dg/s3-metadata.html" target="_blank" rel="noopener noreferrer">こちらのドキュメント (Amazon S3 document metadata)</a> をご確認ください。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="アクセスコントロールの定義">アクセスコントロールの定義<a href="#アクセスコントロールの定義" class="hash-link" aria-label="アクセスコントロールの定義 への直接リンク" title="アクセスコントロールの定義 への直接リンク">​</a></h3><p>メタデータファイルに <code>AccessControlList</code> を設定することで、ファイルごとにアクセスコントロールを行うことができます。<br>
<code>AccessControlList</code> は以下の通り設定することが可能です。</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token property" style="color:#36acaa">"AccessControlList"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"Name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"group name | user name"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"Type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"GROUP | USER"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"Access"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ALLOW | DENY"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>Name: アクセスコントロール対象の「グループ名 or ユーザ名」を設定</li><li>Type: グループ単位で制御するか、ユーザ単位で制御するかを設定</li><li>Access: 当該ユーザを「許可」するか「拒否」するかを設定</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="アクセスコントロールの定義内容と挙動">アクセスコントロールの定義内容と挙動<a href="#アクセスコントロールの定義内容と挙動" class="hash-link" aria-label="アクセスコントロールの定義内容と挙動 への直接リンク" title="アクセスコントロールの定義内容と挙動 への直接リンク">​</a></h3><p><code>AccessControlList</code> が未設定の場合は、すべてのユーザが「アクセス許可」となります。<br>
<code>AccessControlList</code> に 1 つでも定義がある場合は、「アクセス許可」として定義されたユーザを除き、全員が「アクセス拒否」となります。<br>
<!-- -->そのため、<strong>あるグループ以外のすべてのグループを「アクセス許可」という設定はできません。</strong></p><p>以下のように、<code>AdminGroup</code> のみ <code>ALLOW</code> を設定すると <code>AdminGroup</code> に所属しているユーザのみ、ドキュメントを参照することが可能になります。</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token property" style="color:#36acaa">"AccessControlList"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"Name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"AdminGroup"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"Type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"GROUP"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"Access"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ALLOW"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以下のように、<code>AdminGroup</code> のみに <code>DENY</code> が設定されているため <code>AdminGroup</code> に所属していないユーザーはこのファイルを参照できそうに思えますが、実際はそうではありません。<br>
<code>ALLOW</code> の設定がないため、このファイルには誰もアクセスすることができません。</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token property" style="color:#36acaa">"AccessControlList"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"Name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"AdminGroup"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"Type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"GROUP"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"Access"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"DENY"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>DENY</code> のユースケースとしては、あるグループが内包しているサブグループのみアクセスを拒否したり、特定のユーザのみアクセスを拒否するといったものが考えられます。</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token property" style="color:#36acaa">"AccessControlList"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"Name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"AnyGroup"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"Type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"GROUP"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"Access"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ALLOW"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// AnyGroup が内包している特定のサブグループのみ拒否</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"Name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"AnySubGroup"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"Type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"GROUP"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"Access"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"DENY"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// AnyGroup に所属している特定のユーザのみ拒否</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"Name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"AnyUser"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"Type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"USER"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"Access"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"DENY"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="設定ファイルによるアクセスコントロール">設定ファイルによるアクセスコントロール<a href="#設定ファイルによるアクセスコントロール" class="hash-link" aria-label="設定ファイルによるアクセスコントロール への直接リンク" title="設定ファイルによるアクセスコントロール への直接リンク">​</a></h2><p>アクセスコントロール用の設定ファイル (JSON 形式) を使って、一元的にアクセスコントロールを設定することが可能です。<br>
<!-- -->S3 のデータソースに対して、1 つの設定ファイルを定義できます。<br>
<!-- -->詳細については、<a href="https://docs.aws.amazon.com/kendra/latest/dg/s3-acl.html" target="_blank" rel="noopener noreferrer">こちらのドキュメント (Access control for Amazon S3 data sources)</a> をご確認ください。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="アクセスコントロールの定義-1">アクセスコントロールの定義<a href="#アクセスコントロールの定義-1" class="hash-link" aria-label="アクセスコントロールの定義 への直接リンク" title="アクセスコントロールの定義 への直接リンク">​</a></h3><p><a href="https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/using-prefixes.html" target="_blank" rel="noopener noreferrer">S3 のプレフィックス</a>を利用して、アクセスコントロール対象を指定します。<br>
<!-- -->ディレクトリ単位または、オブジェクト単位で、アクセスコントロールの設定を行うことができます。</p><blockquote><p>プレフィックスの指定は、<code>s3://</code> から始まるフルパスで指定する必要があるので、ご注意ください。</p></blockquote><p><code>aclEntries</code> は、「メタデータによるアクセスコントロール」の <code>AccessControlList</code> と同じ定義となります。</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"keyPrefix"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"s3://prefix1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"aclEntries"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"Name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"user name"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"Type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"GROUP | USER"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"Access"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ALLOW | DENY"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="アクセスコントロールの定義内容と挙動-1">アクセスコントロールの定義内容と挙動<a href="#アクセスコントロールの定義内容と挙動-1" class="hash-link" aria-label="アクセスコントロールの定義内容と挙動 への直接リンク" title="アクセスコントロールの定義内容と挙動 への直接リンク">​</a></h3><p>「メタデータによるアクセスコントロール」と同じ挙動になります。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="メタデータと設定ファイルの使い分けについて">メタデータと設定ファイルの使い分けについて<a href="#メタデータと設定ファイルの使い分けについて" class="hash-link" aria-label="メタデータと設定ファイルの使い分けについて への直接リンク" title="メタデータと設定ファイルの使い分けについて への直接リンク">​</a></h2><p>ここまで、メタデータと設定ファイルでアクセスコントロールを実現できることを紹介しました。<br>
<!-- -->メタデータと設定ファイルでは設定方法が異なるだけで、実現できるアクセスコントロールの内容は同じです。<br>
<!-- -->それでは、それぞれの使い分けについての一例をご紹介します。</p><ul><li>メタデータのユースケース<ul><li>メータデータファイルを自動で生成できる仕組みがある場合（大量のファイルに対して手動でファイル作成するのは現実的ではないため）<ul><li>ファイル単位できめ細やかなアクセスコントロールを行いたい場合</li><li>アクセスコントロール以外の属性も設定して、検索に活かしたい場合</li></ul></li></ul></li><li>設定ファイルのユースケース<ul><li>フォルダ単位でアクセスコントロールを行いたい場合<ul><li>権限を考慮したフォルダ体系であれば、簡単にアクセスコントロールを実装できます</li></ul></li><li>一元的にアクセスコントロールのルールを管理したい場合</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ユーザコンテキストについて">ユーザコンテキストについて<a href="#ユーザコンテキストについて" class="hash-link" aria-label="ユーザコンテキストについて への直接リンク" title="ユーザコンテキストについて への直接リンク">​</a></h2><p><code>AccessControlList</code> で、ユーザごと・グループごとのアクセスコントロールの定義を行いましたが、Kendra の Query を実行する際に、ユーザの情報を設定しなければアクセスコントロールは実施されません。<br>
<!-- -->ユーザの情報を設定していない場合は、<code>AccessControlList</code> の設定有無に関係なく、すべてのドキュメントが検索されるので、ご注意ください。</p><p>ユーザの情報を設定してアクセスコントロールを行う方法は、大きく 2 つあります。</p><ul><li>ユーザコンテキスト<ul><li><a href="https://docs.aws.amazon.com/ja_jp/kendra/latest/dg/API_Query.html" target="_blank" rel="noopener noreferrer">Query</a> の <code>UserContext</code> に、以下の方法でユーザ情報を設定することが可能です。<ul><li>JWT トークン<ul><li>JWT トークンのペイロードを元にアクセスコントロールを行います。</li><li>認証基盤に設定されている権限情報をそのまま利用して、アクセスコントロールを行いたい場合に便利です。</li></ul></li><li>ユーザ ID とグループ名<ul><li>ユーザ ID とグループ名を直接 Query に設定して、アクセスコントロールを行います。</li><li>JWT トークンを利用できない場合、認証基盤とは異なる情報でアクセスコントロールを行いたい場合に便利です。</li></ul></li><li>DataSourceGroup<ul><li><a href="https://docs.aws.amazon.com/ja_jp/kendra/latest/APIReference/API_PutPrincipalMapping.html" target="_blank" rel="noopener noreferrer">PutPrincipalMapping</a> の機能を使って、Kendra 用に所属グループの設定を行うことが可能です。<ul><li>組織構造が複雑な場合や、アクセスコントロールの要件が複雑な場合に便利です。</li><li>設定ファイルを用いた管理も可能です。</li></ul></li></ul></li></ul></li></ul></li><li>ユーザ属性フィルタリング<ul><li><a href="https://docs.aws.amazon.com/ja_jp/kendra/latest/dg/API_Query.html" target="_blank" rel="noopener noreferrer">Query</a> の <code>AttributeFilter</code> を設定することで、メタデータによるフィルタリングを行うことが可能です。<ul><li><code>AccessControlList</code> で「許可」しているユーザは <code>_user_id</code>、「許可」しているグループは <code>_group_ids</code> という属性でマッピングされています。</li><li><code>_user_id</code> と <code>_group_ids</code> をフィルタリングの条件として利用することで、「許可」されたドキュメントのみ検索対象に含めることが可能になります。</li><li><strong>条件式によっては、<code>AccessControlList</code> が未設定のドキュメントが検索できないのでご注意ください。</strong></li></ul></li></ul></li></ul><p>参考：<a href="https://docs.aws.amazon.com/ja_jp/kendra/latest/dg/user-context-filter.html" target="_blank" rel="noopener noreferrer">ユーザーコンテキストでのフィルタリング</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="認証認可について">認証・認可について<a href="#認証認可について" class="hash-link" aria-label="認証・認可について への直接リンク" title="認証・認可について への直接リンク">​</a></h2><p>前項で説明した通り、各種認証サービスの発行した JWT トークンを利用してアクセスコントロールを実現することが可能です。この機能は、Kendra 自体のアクセス制限を行うのではなく、ドキュメントの検索可否を制御するだけなのでご注意ください。</p><p>今回は <a href="https://aws.amazon.com/jp/cognito/" target="_blank" rel="noopener noreferrer">Amazon Cognito</a> (以降、Cognito) を利用した認証について解説を行います。<br>
<a href="https://github.com/aws-samples/simple-lex-kendra-jp/" target="_blank" rel="noopener noreferrer">simple-lex-kendra-jp</a> リポジトリの <code>SimpleKendraAuth</code> のスタックはここで紹介する Cognito を利用する方法で実装をしています。<br>
<!-- -->Kendra のトークンを使ったアクセスコントロールについては、<a href="https://docs.aws.amazon.com/kendra/latest/dg/create-index-access-control.html" target="_blank" rel="noopener noreferrer">こちらのドキュメント (Controlling access to documents in an index)</a> をご覧ください。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="kendra-の-jwt-トークン設定の要否">Kendra の JWT トークン設定の要否<a href="#kendra-の-jwt-トークン設定の要否" class="hash-link" aria-label="Kendra の JWT トークン設定の要否 への直接リンク" title="Kendra の JWT トークン設定の要否 への直接リンク">​</a></h3><p>前項でも説明した通り、JWT トークンを利用しても Kendra 自体のアクセス制限を行うことはできません。すべてのファイルに <code>AccessControlList</code> を設定していれば、未認証ユーザが検索してもドキュメントは 1 件もヒットしませんが、Kendra への Query 発行はできます。</p><p>未認証ユーザの Kendra へのアクセス自体を制限したい場合は、<a href="https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/apigateway-integrate-with-cognito.html" target="_blank" rel="noopener noreferrer">API Gateway の Cognito オーソライザー</a>等を利用して Query を発行する前に、アクセスをブロックする仕組みにする必要があります。<a href="https://github.com/aws-samples/simple-lex-kendra-jp/" target="_blank" rel="noopener noreferrer">simple-lex-kendra-jp</a> の「Amazon Kendra Auth プロジェクト」に、こちらの実装サンプルがあるので合わせてご確認ください。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="パターン別の対応方法">パターン別の対応方法<a href="#パターン別の対応方法" class="hash-link" aria-label="パターン別の対応方法 への直接リンク" title="パターン別の対応方法 への直接リンク">​</a></h4><p>構築するシステムの要件によって、さまざまな Kendra の設定パターンがありますので、よくあるパターン別に対応方法をご紹介します。<br>
<strong>こちらは、IAM や <a href="https://docs.aws.amazon.com/ja_jp/kendra/latest/dg/vpc-interface-endpoints.html" target="_blank" rel="noopener noreferrer">VPC</a> の設定が正しくできており、 Kendra へ直接 Query が発行できない状態になっていることを前提としています。</strong><br>
<strong>注意：Kendra のアクセスコントロールでは、 S3 バケット自体のアクセス制限はできません。S3 バケットの権限設定は適切に行ってください。</strong></p><ul><li>認証ユーザのみ Kendra のアクセスを許可したい<ul><li>共通<ul><li>API Gateway 等で未認証ユーザをブロックしてください。</li></ul></li><li>JWT トークンの情報でドキュメントのアクセスコントロールを実施したい<ul><li>Index に JWT トークンの設定し、Query 発行時に JWT トークンをセットしてください。</li></ul></li><li>Kendra 独自のユーザ・グループの定義でドキュメントのアクセスコントロールを実施したい<ul><li>Index に JWT トークンの設定は不要です。</li><li>Query 発行時に、ユーザ ID・グループ ID または、DataSourceGroup をセットしてください。<ul><li>JWT トークンのペイロードの情報を元に、ユーザ ID・グループ ID または、DataSourceGroup をセットする方法も考えられます。</li><li>APIGateway + Lambda の構成だと、認証に利用した JWT トークンのペイロードを簡単に取得できます (<code>event.requestContext.authorizer</code> でペイロードが取得できます <a href="https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/http-api-jwt-authorizer.html" target="_blank" rel="noopener noreferrer">[参考]</a>)。</li></ul></li></ul></li><li>ドキュメントのアクセスコントロールを実施しない<ul><li>Index に JWT トークンの設定は不要です。</li><li>ドキュメントに <code>AccessControlList</code> を設定しないでください。</li><li>Query 発行時にユーザコンテキストとユーザ属性フィルタリングの設定をしないでください。</li></ul></li></ul></li><li>未認証ユーザも Kendra のアクセスを許可したい<ul><li>ドキュメントのアクセスコントロールを実施したい<ul><li>未認証ユーザに公開したくないドキュメント<strong>すべて</strong>に <code>AccessControlList</code> を設定してください。</li><li>非公開ドキュメントを参照できるユーザは認証を必須としてください。<ul><li>対応方法は「認証ユーザのみ Kendra のアクセスを許可したい」と同様です。</li></ul></li><li><code>AccessControlList</code> が設定されていないドキュメントは、未認証ユーザでもアクセス可能となります。<ul><li>未認証ユーザの場合は、Query 発行時にユーザコンテキストとユーザ属性フィルタリングの設定をしないでください。</li></ul></li></ul></li><li>ドキュメントのアクセスコントロールを実施しない<ul><li>Index に JWT トークンの設定は不要です。</li><li>ドキュメントに <code>AccessControlList</code> を設定しないでください。</li><li>Query 発行時にユーザコンテキストとユーザ属性フィルタリングの設定をしないでください。</li></ul></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="kendra-の-jwt-トークンの設定方法">Kendra の JWT トークンの設定方法<a href="#kendra-の-jwt-トークンの設定方法" class="hash-link" aria-label="Kendra の JWT トークンの設定方法 への直接リンク" title="Kendra の JWT トークンの設定方法 への直接リンク">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="index-の設定">Index の設定<a href="#index-の設定" class="hash-link" aria-label="Index の設定 への直接リンク" title="Index の設定 への直接リンク">​</a></h4><p>JWT トークンを利用したアクセス制限を行う際は、Kendra の Index に対して設定を行う必要があります。</p><p>Index 設定画面の「Configure user access control (ユーザアクセスコントロールの設定)」の中に「Token configuration（トークン設定）」という項目があり、そこで設定を行うことができます。<br>
<!-- -->Coginito を利用する場合は、「Token Type」で「OpenID」を選択してください。<br>
<!-- -->JWT トークンの正当性を検証するための「Signing key URL」を設定する必要がありますが、Cognito を利用する場合は以下を設定してください。(<a href="https://docs.aws.amazon.com/ja_jp/cognito/latest/developerguide/amazon-cognito-user-pools-using-tokens-verifying-a-jwt.html" target="_blank" rel="noopener noreferrer">参考</a>)</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">https://cognito-idp.&lt;Region&gt;.amazonaws.com/&lt;userPoolId&gt;/.well-known/jwks.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="ユーザ名とグループ名について">ユーザ名とグループ名について<a href="#ユーザ名とグループ名について" class="hash-link" aria-label="ユーザ名とグループ名について への直接リンク" title="ユーザ名とグループ名について への直接リンク">​</a></h4><p>Kendra では、ユーザ名とグループ名でアクセスコントロールを行うことができますが、JWT トークンのペイロードの中のどの項目でアクセスコントロールを行うかを設定できます。<br>
<!-- -->たとえば、「Username」に <code>email</code> を設定すればメールアドレスでアクセスコントロールが可能ですし、それ以外のカスタム属性を指定することも可能です。<br>
<!-- -->「Groups」に <code>cognito:groups</code> を設定することで、Cognito ユーザグループでアクセスコントロールを行うことが可能です。<br>
<!-- -->参考：<a href="https://docs.aws.amazon.com/ja_jp/cognito/latest/developerguide/user-pool-settings-attributes.html" target="_blank" rel="noopener noreferrer">ユーザプール属性</a><br>
<!-- -->参考：<a href="https://docs.aws.amazon.com/ja_jp/cognito/latest/developerguide/cognito-user-pools-user-groups.html" target="_blank" rel="noopener noreferrer">ユーザプルにグループを追加する</a><br>
<!-- -->参考：<a href="https://docs.aws.amazon.com/ja_jp/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html" target="_blank" rel="noopener noreferrer">ID トークンのペイロード</a></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="kendra-の-query-実行">Kendra の Query 実行<a href="#kendra-の-query-実行" class="hash-link" aria-label="Kendra の Query 実行 への直接リンク" title="Kendra の Query 実行 への直接リンク">​</a></h4><p>Query のオプションである <code>--user-context</code> に <code>Token</code> という項目があるので、そちらに Cognito から発行された JWT トークンを設定してください。JWT トークンの検証および、ドキュメントのアクセスコントロールが実施されます。<br>
<!-- -->参考：<a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/kendra/query.html" target="_blank" rel="noopener noreferrer">AWS CLI Referense kendra qurey</a></p><p>Cognito には、アクセストークンと ID トークンの 2 種類の JWT トークンがあります。<br>
<!-- -->Kendra の Query では、どちらのトークンも利用することが可能ですが、認証されたユーザの属性（アイデンティティ）を利用することが主な目的ですので、ID トークンを利用する方が適切です。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="さいごに">さいごに<a href="#さいごに" class="hash-link" aria-label="さいごに への直接リンク" title="さいごに への直接リンク">​</a></h2><p>以上が、Kendra のアクセスコントロールを行う方法でした。<br>
<!-- -->適切にアクセスコントロールを行うことで、より安全に、より便利に Kendra を利用できるようになります。<br>
<!-- -->気になる方は、<a href="https://github.com/aws-samples/simple-lex-kendra-jp/" target="_blank" rel="noopener noreferrer">simple-lex-kendra-jp</a> のリポジトリで気軽にお試し可能ですので、ぜひお試しください。<br>
<!-- -->バグや要望がございましたら、気軽に Issue を起票していただければ幸いです！</p>]]></content:encoded>
            <category>kendra</category>
        </item>
        <item>
            <title><![CDATA[Vue3 + TypeScript を利用した型安全な開発の実現]]></title>
            <link>https://prototyping-blog.com/blog/vue3-typescript</link>
            <guid>https://prototyping-blog.com/blog/vue3-typescript</guid>
            <pubDate>Thu, 27 Apr 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[現在のフロントエンド開発では、TypeScript を利用した型安全な開発が一般的になってきました。]]></description>
            <content:encoded><![CDATA[<p>現在のフロントエンド開発では、TypeScript を利用した型安全な開発が一般的になってきました。<br>
<!-- -->Vue2 時代（特に Composition API 登場以前）は TypeScript との相性があまり良くなく、保守性の高い開発が困難な状況でした。<br>
<!-- -->しかし、Vue3 の登場により、TypeScript との相性が劇的に改善され、これについてまとめたいと思います。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="この記事を書いたモチベーション">この記事を書いたモチベーション<a href="#この記事を書いたモチベーション" class="hash-link" aria-label="この記事を書いたモチベーション への直接リンク" title="この記事を書いたモチベーション への直接リンク">​</a></h2><p>筆者が初めて利用したフロントエンドフレームワークは Vue2 でした。<br>
<!-- -->Vue2 時代（特に Composition API 登場以前）は、TypeScript との相性が悪く、ソフトウェアが大きくなるにつれて保守性が悪くなることに苦労し、そのため React に乗り換えていました。<br>
<!-- -->最近の開発案件で Vue3 を利用したところ、React にも引けを取らないぐらい TypeScript との相性が改善され、型安全なプログラミングを行いやすくなっていたため、それについてまとめたいと思います。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="vue3-と-compositionapi-について">Vue3 と CompositionAPI について<a href="#vue3-と-compositionapi-について" class="hash-link" aria-label="Vue3 と CompositionAPI について への直接リンク" title="Vue3 と CompositionAPI について への直接リンク">​</a></h2><p>Vue3 は、フロントエンドフレームワークである Vue.js の Version.3 系のものを指します。<br>
<!-- -->TypeScript との親和性が高くなり、型安全な開発を行いやすくなりました。<br>
<!-- -->また、Composition API が導入（正確には Vue2.7 から導入）されており、これを利用すると保守性の高いプログラミングを行うことができます。<br>
<!-- -->詳しくは、<a href="https://ja.vuejs.org/guide/extras/composition-api-faq.html" target="_blank" rel="noopener noreferrer">Vue.js 公式ドキュメント</a>をご覧ください。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="本記事で紹介するコード">本記事で紹介するコード<a href="#本記事で紹介するコード" class="hash-link" aria-label="本記事で紹介するコード への直接リンク" title="本記事で紹介するコード への直接リンク">​</a></h2><p>本記事で紹介しているコードは、以下のリポジトリで公開しています。必要に応じでご覧ください。<br>
<!-- -->GitHubリポジトリ：<a href="https://github.com/wadabee/vue3-prototype-blog" target="_blank" rel="noopener noreferrer">vue3-prototype-blog</a>  </p><p><img loading="lazy" alt="picture 1" src="/assets/images/application-adfb8f63775bca5db171ed3477cf9c7a.png" width="757" height="299" class="img_ev3q"><br>
<!-- -->本記事では、上記のようなシンプルなアプリケーションを作成しました（フロントエンドのみの構成）。<br>
<!-- -->New Todo の Title と Content を入力して、Register ボタンを押下すると、下部の Todo List に入力した Todo が表示されます。<br>
<!-- -->また、Delete ボタンを押下することで、当該 Todo を削除することができます。<br>
<!-- -->この機能を、Composition API、Composition API( Emitを利用しないパターン )、Options API でそれぞれ実装しています。  </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="型安全なコードの書き方">型安全なコードの書き方<a href="#型安全なコードの書き方" class="hash-link" aria-label="型安全なコードの書き方 への直接リンク" title="型安全なコードの書き方 への直接リンク">​</a></h2><p>今回は最も基本的な、リアクティブなデータ定義、Props、Emitに絞って紹介します。  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="composition-api">Composition API<a href="#composition-api" class="hash-link" aria-label="Composition API への直接リンク" title="Composition API への直接リンク">​</a></h3><p>Composition API では、以下のようなコードで実装しました。    </p><p><code>src/components/CompositionApi.vue</code> (import と style は省略)</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">script setup lang</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"ts"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">defineComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'CompositionApi'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> todoList </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">ref</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">TodoType</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">[</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">]</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">registerTodo</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">todo</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TodoType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  todoList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">todo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">deleteTodo</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  todoList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">splice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">script</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">style</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"{ display: 'flex', flexDirection: 'column' }"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">h2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">Composition </span><span class="token constant" style="color:#36acaa">API</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">h2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">CATodoInput </span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">register</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"registerTodo"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">CATodoList </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">todo</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">list</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"todoList"</span><span class="token plain"> @</span><span class="token keyword" style="color:#00009f">delete</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"deleteTodo"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>src/components/CATodoInput.vue</code> (import と style は省略)</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">script setup lang</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"ts"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">defineComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'CATodoInput'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> title </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">ref</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">''</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> content </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">ref</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">''</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> emits </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">defineEmits</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name">  </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">(</span><span class="token generic-function generic class-name">e</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name string" style="color:#e3116c">'register'</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">,</span><span class="token generic-function generic class-name"> newTodo</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> TodoType</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">)</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name keyword" style="color:#00009f">void</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name"></span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">onClickRegister</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">emits</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'register'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    title</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> title</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">script</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">h3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">New ToDo</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">h3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div </span><span class="token keyword" style="color:#00009f">class</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"input-field"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">label </span><span class="token keyword" style="color:#00009f">for</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"title"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">Title</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">label</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"text"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"title"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">value</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"title"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">input</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">:</span><span class="token builtin">any</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          title </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div </span><span class="token keyword" style="color:#00009f">class</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"input-field"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">label </span><span class="token keyword" style="color:#00009f">for</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"content"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">Content</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">label</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"text"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"content"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">value</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"content"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">input</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">:</span><span class="token builtin">any</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          content </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">button </span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">click</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"onClickRegister"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">Register</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">button</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>src/components/CASTodoList.vue</code> (import と style は省略)</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">script setup lang</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"ts"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">defineComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'CASTodoList'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token generic-function function" style="color:#d73a49">defineProps</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name">  todoList</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> TodoType</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">[</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">]</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name"></span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> emits </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">defineEmits</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name">  </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">(</span><span class="token generic-function generic class-name">e</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name string" style="color:#e3116c">'delete'</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">,</span><span class="token generic-function generic class-name"> index</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">number</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">)</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name keyword" style="color:#00009f">void</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name"></span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">onClickDelete</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">emits</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'delete'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">script</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">h3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">Todo List</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">h3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div v</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">for</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"(todo, idx) in todoList"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">key</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"idx"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div </span><span class="token keyword" style="color:#00009f">class</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"todo"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">h4</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> todo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">title </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">h4</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div </span><span class="token keyword" style="color:#00009f">class</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"content"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> todo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">content </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">button </span><span class="token keyword" style="color:#00009f">class</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"delete-button"</span><span class="token plain"> </span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">click</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"() =&gt; onClickDelete(idx)"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">Delete</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">button</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="型安全にする-point">型安全にする Point<a href="#型安全にする-point" class="hash-link" aria-label="型安全にする Point への直接リンク" title="型安全にする Point への直接リンク">​</a></h4><p>最も基本的なことですが、しっかりと変数、関数（引数、戻り値）に対して型定義を行うことが非常に重要です。<br>
<!-- -->対応コストが非常に低く、Template 部でも入力補完と型チェックが効くようになるため、非常に効果が高いです。<br>
<!-- -->必ず型を指定するようにしましょう。  </p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> todoList </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">ref</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">TodoType</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">[</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">]</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">registerTodo</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">todo</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TodoType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  todoList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">todo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>続いて、Props に対する型定義となります。<br>
<!-- -->下記のように <code>defineProps</code> を利用することで、Props に対して型定義を行うことができます。<br>
<!-- -->親コンポーネントの Template 部から当該コンポーネントを参照する際に、この定義に沿って入力補完と型チェックが効くようになります。<br>
<!-- -->コンポーネント数が増えてくると、Props の型不一致によるバグが起こりやすくなるので、こちらも必ず設定するようにしましょう。  </p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token generic-function function" style="color:#d73a49">defineProps</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name">  todoList</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> TodoType</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">[</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">]</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name"></span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>型定義によって、必須・任意の切り替えも可能です。<br>
<!-- -->TypeScript の <code>type</code> の定義と文法が同じなので、直感的です。<br>
<!-- -->また、<code>script</code> 部で Props を利用することも可能です（もちろん、入力補完と型チェックが効きます）。    </p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> props </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">defineProps</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name">  requiredProp</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name">  optionalProp</span><span class="token generic-function generic class-name operator" style="color:#393A34">?</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name"></span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// script 部でも props を利用可能</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> hoge </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> props</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">requiredProp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> fuga </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> props</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">optionalProp </span><span class="token operator" style="color:#393A34">??</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">''</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最後に、Emit に対する型定義となります。<br>
<!-- -->下記のように <code>defineEmits</code> を利用することで、Emit に対して型定義を行うことができます。<br>
<!-- -->イベント名と、その引数と戻り値を定義することが可能です。  </p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> emits </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">defineEmits</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name">  </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">(</span><span class="token generic-function generic class-name">e</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name string" style="color:#e3116c">'delete'</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">,</span><span class="token generic-function generic class-name"> index</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">number</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">)</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name keyword" style="color:#00009f">void</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name"></span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">onClickDelete</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">emits</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'delete'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>親コンポーネントから当該コンポーネントを呼び出す際は、以下のように記述します。<br>
<code>@delete</code> で削除イベントのハンドリングを行いますが、このハンドリングを行う際も入力補完や型チェックが効きます。<br>
<!-- -->複雑なコンポーネントは、イベントハンドリングも複雑になりがちです（個人的にはイベントハンドリングが一番複雑化しやすい部分だと思っています）。<br>
<!-- -->こちらも、型定義をしっかり行うようにしましょう。<br>
<!-- -->ただし、Emit を利用した場合、型定義をしっかり行ったとしても、存在しないイベントを指定したり、イベントハンドリングを行っていないことをエラーとして検出することはできない点には注意が必要です。</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 良いパターン</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">CATodoList </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">todo</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">list</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"todoList"</span><span class="token plain"> @</span><span class="token keyword" style="color:#00009f">delete</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"deleteTodo"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 存在しない event を指定してもエラーにならない</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">CATodoList </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">todo</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">list</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"todoList"</span><span class="token plain"> </span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">nothing</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">event</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"deleteTodo"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ハンドリングを行わなくてもエラーにならない</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">CATodoList </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">todo</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">list</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"todoList"</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="composition-apiemit-を利用しないパターン">Composition API　（Emit を利用しないパターン）<a href="#composition-apiemit-を利用しないパターン" class="hash-link" aria-label="Composition API　（Emit を利用しないパターン） への直接リンク" title="Composition API　（Emit を利用しないパターン） への直接リンク">​</a></h3><p>上記でご説明した通り、Emit を使ったイベントハンドリングでは、型安全とは言い難い状況です。<br>
<!-- -->そこで、React では一般的な実装となっている「親コンポーネントからイベントハンドラーを渡して、子コンポーネントで実行する」というコードをご紹介します。  </p><p><code>src/components/CompositionApiWithoutEmits.vue</code> (import と style は省略)</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">script setup lang</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"ts"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">defineComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'CompositionApiWithoutEmits'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> todoList </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">ref</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">TodoType</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">[</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">]</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 通常通りイベントハンドラーを定義する</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">registerTodo</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">todo</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TodoType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  todoList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">todo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">deleteTodo</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  todoList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">splice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">script</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">style</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"{ display: 'flex', flexDirection: 'column' }"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">h2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">Composition </span><span class="token constant" style="color:#36acaa">API</span><span class="token plain"> w</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">o Emits</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">h2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"> v</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">onディレクティブを使わずにハンドラーをPropsとして渡す </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">CAWithoutEmitsTodoInput </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">on</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">register</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"registerTodo"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">CAWithoutEmitsTodoList </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">todo</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">list</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"todoList"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">on</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">delete</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"deleteTodo"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>src/components/CAWithoutEmitsTodoInput.vue</code> (import と style は省略)</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">script setup lang</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"ts"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">defineComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'CAWithoutEmitsTodoInput'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> props </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> defineProps</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Propsとしてハンドラーを受け取る</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">onRegister</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newTodo</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TodoType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> title </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">ref</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">''</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> content </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">ref</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">''</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">onClickRegister</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Emitせずに、Propsとして受け取ったハンドラーを実行する</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  props</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">onRegister</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    title</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> title</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">script</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">h3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">New ToDo</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">h3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div </span><span class="token keyword" style="color:#00009f">class</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"input-field"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">label </span><span class="token keyword" style="color:#00009f">for</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"title"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">Title</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">label</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"text"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"title"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">value</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"title"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">input</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">:</span><span class="token builtin">any</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          title </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div </span><span class="token keyword" style="color:#00009f">class</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"input-field"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">label </span><span class="token keyword" style="color:#00009f">for</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"content"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">Content</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">label</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"text"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"content"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">value</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"content"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">input</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">:</span><span class="token builtin">any</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          content </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">button </span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">click</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"onClickRegister"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">Register</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">button</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>src/components/CAWithoutEmitsTodoList.vue</code> (import と style は省略)</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">script setup lang</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"ts"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">defineComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'CAWithoutEmitsTodoList'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> props </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> defineProps</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  todoList</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TodoType</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Propsとしてハンドラーを受け取る</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">onDelete</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">onClickDelete</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Emitせずに、Propsとして受け取ったハンドラーを実行する</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  props</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">onDelete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">script</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">h3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">Todo List</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">h3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div v</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">for</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"(todo, idx) in todoList"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">key</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"idx"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div </span><span class="token keyword" style="color:#00009f">class</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"todo"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">h4</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> todo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">title </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">h4</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div </span><span class="token keyword" style="color:#00009f">class</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"content"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> todo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">content </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">button </span><span class="token keyword" style="color:#00009f">class</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"delete-button"</span><span class="token plain"> </span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">click</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"() =&gt; onClickDelete(idx)"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">Delete</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">button</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="型安全にする-point-1">型安全にする Point<a href="#型安全にする-point-1" class="hash-link" aria-label="型安全にする Point への直接リンク" title="型安全にする Point への直接リンク">​</a></h4><p>Emit を使うパターンでは、「子コンポーネントで発火したイベントを親コンポーネントで検知して、親コンポーネント側でハンドラーを実行する」という流れでした。<br>
<!-- -->それに対して、Emit を使わないパターンでは、「子コンポーネントでイベントが発火したら、親コンポーネントから渡されたハンドラーを子コンポーネント側で実行する」という流れになります。  </p><p>この実装のメリットは、より型安全にコーディングできることにあります。<br>
<!-- -->アプリケーションの大規模化やコンポーネントの複雑化が進んだ際に、より保守性を高めやすくなります。<br>
<!-- -->例を見てみましょう。</p><p>子コンポーネントのPropsが、以下の様に定義されていたとします。<br>
<!-- -->こちらは登録処理( onRegister )は必須、削除処理( onDelete )は任意となります。  </p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> props </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> defineProps</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">onRegister</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SomethingType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  onDelete</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>親コンポーネントを実装する際は、以下の様になります。<br>
<!-- -->登録処理は必須であるため、Props として設定していない場合は型エラーが発生するので、コーディングミスに気づくことができます。<br>
<!-- -->削除処理は任意であるため、削除処理が必要ない場合は設定する必要はありません。<br>
<!-- -->型定義を行なっているため、このハンドラーの関数を設定する際も引数、戻り値の型で、入力補完、型チェックが効きます。  </p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"> 登録処理のみ実行したい場合 </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ChildComponent </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">onRegister</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">registerFunc</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"> 登録と削除処理を両方実行したい場合 </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ChildComponent </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">onRegister</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">registerFunc</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">onDelete</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">deleteFunc</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"> 必須である登録処理が未設定であるためエラー </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ChildComponent </span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Vue の仕様として、Props として定義されていない属性を指定しても型エラーにはなりません。<br>
<!-- -->こちらは、<a href="https://ja.vuejs.org/guide/components/attrs.html" target="_blank" rel="noopener noreferrer">フォールスルー属性</a>の仕様と思われます。<br>
<!-- -->ちなみに、<code>inheritAttrs: false</code> を設定しても、型チェックは行われず型安全にすることはできないので、ご注意ください（属性が継承されないようになるだけです）。<br>
<!-- -->Props 定義を修正した場合は、親コンポーネントの修正を忘れない様に注意してください。  </p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"> 未定義のPropsに対してハンドラーを設定してもエラーにならない </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ChildComponent2 </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">on</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nothing</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">event</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">registerFnc</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="options-api">Options API<a href="#options-api" class="hash-link" aria-label="Options API への直接リンク" title="Options API への直接リンク">​</a></h3><p>最後に Options API の実装例も見てみましょう。  </p><p><code>src/components/OptionsApi.vue</code> (import と style は省略)</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">script lang</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"ts"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'OptionsApi'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  components</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OATodoInput</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OATodoList</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      todoList</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> TodoType</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  methods</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">registerTodo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">todo</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TodoType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">todoList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">todo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">deleteTodo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">todoList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">splice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">script</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">style</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"{ display: 'flex', flexDirection: 'column' }"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">h2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">OptionsAPI</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">h2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">OATodoInput </span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">register</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"registerTodo"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">OATodoList </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">todo</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">list</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"todoList"</span><span class="token plain"> @</span><span class="token keyword" style="color:#00009f">delete</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"deleteTodo"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>src/components/OATodoInput.vue</code> (import と style は省略)</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">script lang</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"ts"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">defineComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'OATodoInput'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      title</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">''</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      content</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  emits</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// eslint-disable-next-line @typescript-eslint/no-unused-vars</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function-variable function" style="color:#d73a49">register</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_todo</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TodoType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  methods</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">onClickRegister</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">$emit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'register'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        title</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">title</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        content</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">script</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">h3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">New ToDo</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">h3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div </span><span class="token keyword" style="color:#00009f">class</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"input-field"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">label </span><span class="token keyword" style="color:#00009f">for</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"title"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">Title</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">label</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"text"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"title"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">value</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"title"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">input</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">:</span><span class="token builtin">any</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          title </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div </span><span class="token keyword" style="color:#00009f">class</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"input-field"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">label </span><span class="token keyword" style="color:#00009f">for</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"content"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">Content</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">label</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"text"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"content"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">value</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"content"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">input</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">:</span><span class="token builtin">any</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          content </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">button </span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">click</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"onClickRegister"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">Register</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">button</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>src/components/OATodoList.vue</code> (import と style は省略)</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">script lang</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"ts"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">defineComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'OATodoList'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  props</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    todoList</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Object </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> PropType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">TodoType</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      required</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  emits</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// eslint-disable-next-line @typescript-eslint/no-unused-vars</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function-variable function" style="color:#d73a49">delete</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  methods</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">onClickDelete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">$emit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'delete'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">script</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">h3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">Todo List</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">h3</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div v</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">for</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"(todo, idx) in todoList"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">key</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"idx"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div </span><span class="token keyword" style="color:#00009f">class</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"todo"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">h4</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> todo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">title </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">h4</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div </span><span class="token keyword" style="color:#00009f">class</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"content"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> todo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">content </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">button </span><span class="token keyword" style="color:#00009f">class</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"delete-button"</span><span class="token plain"> </span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">click</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"() =&gt; onClickDelete(idx)"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">Delete</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">button</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">div</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="型安全にする-point-2">型安全にする Point<a href="#型安全にする-point-2" class="hash-link" aria-label="型安全にする Point への直接リンク" title="型安全にする Point への直接リンク">​</a></h4><p>Options API でも、Composition API とほぼ同等な型安全性を実現することができます。<br>
<!-- -->しかし、型定義の際に、TypeScript の標準的な書き方ではなく、Vue の Options API 独特の書き方が必要になります。  </p><p>変数は、<code>data</code> を定義する際に、<code>as</code> を利用して型定義を行う必要があります。  </p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      todoList</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> TodoType</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Props は <code>as</code> を利用して、<code>PropType</code> を設定することで、型定義が可能になります。<br>
<code>PropType</code> の Generic 型として引き渡しているものが、Props のデータ型となります。<br>
<!-- -->Props のデータ型を関数にしてイベントハンドラーを引き渡すことで、上記で説明した「<strong>Composition API　（Emit を利用しないパターン）</strong>」と同等の実装を行うことができます。  </p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  props</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    todoList</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Object </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> PropType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">TodoType</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      required</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>関数は、通常の TypeScript の関数と同じ要領で型定義が可能です。<br>
<!-- -->methods の中ではアロー関数が使えないため、注意が必要です（ <code>this</code> のスコープがおかしくなリます）</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  methods</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">someFunction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// 省略</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Emit は、Validation の機能を利用することで、型定義が可能です。<br>
<!-- -->本来は、Emit の Validation を行うための機能（ false を return すると validation エラーが発生する）ですが、型定義に利用するだけですので、固定で true を return しています。<br>
<!-- -->Validation の詳細については、<a href="https://ja.vuejs.org/guide/typescript/options-api.html#typing-component-emits" target="_blank" rel="noopener noreferrer">こちら</a>を参照してください。  </p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  emits</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// null だと型定義されない</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    onSomeEvent1</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// この書き方で、引数の型定義が可能</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function-variable function" style="color:#d73a49">onSomeEvent2</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="composition-api-と-options-api-どちらが型安全なのか">Composition API と Options API どちらが型安全なのか？<a href="#composition-api-と-options-api-どちらが型安全なのか" class="hash-link" aria-label="Composition API と Options API どちらが型安全なのか？ への直接リンク" title="Composition API と Options API どちらが型安全なのか？ への直接リンク">​</a></h2><p>基本的な使い方であれば、どちらも同等な型安全性でした。<br>
<!-- -->（高度な使い方をすれば、また感想は変わってくるかもしれません）  </p><blockquote><p>Options API は、コンポーネントコードを書くときに「考えることを減らす」ことを可能にし、それが多くのユーザーに支持されている理由です。しかし、精神的なオーバーヘッドを減らす一方で、逃げ場のない規定のコード構成パターンに縛られてしまい、大規模なプロジェクトではリファクタリングやコード品質の向上が困難になる可能性があります。この点、Composition API は、長期的なスケーラビリティに優れています。  </p></blockquote><blockquote><p>Composition API の利点の多くは大規模プロジェクトでこそ現れるものであり、多くの低~中程度の複雑性のシナリオにおいては Options API が堅実な選択肢であり続けることも理解しています。</p></blockquote><p>引用：<a href="https://ja.vuejs.org/guide/extras/composition-api-faq.html#trade-offs" target="_blank" rel="noopener noreferrer">公式ドキュメント</a>より  </p><p>コードの保守性という観点で見れば、上記の記載の通りComposition API に軍配が上がりそうです。<br>
<!-- -->どちらを選択するかどうかは、開発するチームの属性で決めれば良いのかなと思います。<br>
<!-- -->私個人の意見としては、標準的な TypeScript のコードに近い書き方ができる Composition API がおすすめです。  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h3><p>以上が、Vue3 で型安全な開発を実現する方法でした。<br>
<!-- -->Vue3 には、さまざまな書き方があるため、情報収集に苦労しました（目的の記事がピンポイントでヒットせず...）。<br>
<!-- -->情報収集を行う際は、Composition API、Options API をキーワードに含めることをお勧めします。</p>]]></content:encoded>
            <category>vue</category>
            <category>typescript</category>
        </item>
        <item>
            <title><![CDATA[リソース外ソースコードの変更に応じてLambda-backedカスタムリソースの更新をトリガーする]]></title>
            <link>https://prototyping-blog.com/blog/lambda-cr-trigger-update</link>
            <guid>https://prototyping-blog.com/blog/lambda-cr-trigger-update</guid>
            <pubDate>Tue, 18 Apr 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[AWS CloudFormation がサポートしていないリソースやアクションをカスタマイズするために便利なLambda-backed カスタムリソースですが、スタックが直接参照しないコードに変更があり更新をかける場合は一工夫必要となります。本記事ではその方法について CDK の具体的なコード例を交えながら紹介します。]]></description>
            <content:encoded><![CDATA[<p>AWS CloudFormation がサポートしていないリソースやアクションをカスタマイズするために便利な<a href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/template-custom-resources-lambda.html" target="_blank" rel="noopener noreferrer">Lambda-backed カスタムリソース</a>ですが、スタックが直接参照しないコードに変更があり更新をかける場合は一工夫必要となります。本記事ではその方法について CDK の具体的なコード例を交えながら紹介します。</p><p>ここでは具体的に下記のようなケースを想定します。</p><ul><li>カスタムリソースを含む独自の<a href="https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/constructs.html" target="_blank" rel="noopener noreferrer">コンストラクト</a>: <code>MyConstruct</code> を作成している</li><li><code>MyConstruct</code>では指定されたフォルダの内容を S3 へアップロードし、リソースのライフサイクルイベント (<code>Create</code>・<code>Update</code>・<code>Delete</code>) をハンドリングする Lambda から上記 S3 オブジェクトを取得し何らかの処理を実行する</li></ul><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 利用側</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> myConstruct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MyConstruct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"MyConstruct"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/path/to/dir"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// MyConstruct本体の定義</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">MyConstructProps</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">MyConstruct</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">Construct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scope</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Construct</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> props</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> MyConstructProps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scope</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// path内のファイルをS3へデプロイ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">declare</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> bucket</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> s3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Bucket</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">s3deploy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">BucketDeployment</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"S3Deploy"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sources</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">s3deploy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">asset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">props</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      destinationBucket</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> bucket</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Lambda-backedプロバイダー</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">declare</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> handler</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> lambda</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">Function</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> provider </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">cr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Provider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Provider"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      onEventHandler</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> handler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// カスタムリソースの定義</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> customResource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">CustomResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">CustomResource</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serviceToken</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> provider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serviceToken</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Lambda</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ...略...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">onUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// S3バケットの中身を取得し何らかの処理を行う</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exports</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">handler</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">RequestType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Create"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      response </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">onCreate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Update"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      response </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">onUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Delete"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      response </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">onDelete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...略...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上記のコードをデプロイした場合、スタックの作成時と削除時には<code>onCreate</code>および<code>onDelete</code>がコールされますが、指定されたフォルダ（ここでは<code>/path/to/dir</code>）内のコードに変更を加えても<code>onUpdate</code>は実行されません。<a href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/crpg-ref-requesttypes-update.html" target="_blank" rel="noopener noreferrer">ドキュメント</a>ではカスタムリソースのプロパティに変更があった場合更新がされると記載があるので、ここでは該当フォルダ内のハッシュ値を計算しプロパティに付与する方法で更新をトリガーします。具体的にはたとえば下記のように実装します。</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">MyConstruct</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">Construct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scope</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Construct</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> props</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> MyConstructProps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...略...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ディレクトリのハッシュを計算</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> hash </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">calculateDirHash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">props</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> customResource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">CustomResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">CustomResource</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serviceToken</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> provider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serviceToken</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      properties</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// カスタムリソースはプロパティの値が変更されると更新がトリガーされる</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hash</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">calculateDirHashRecursive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dirPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hash</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> crypto</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Hash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> entries </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readdirSync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dirPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> withFileTypes</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> entry </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> entries</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> fullPath </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> path</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dirPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> stats </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">statSync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fullPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// ファイルのパス・更新時刻・サイズに基づいてハッシュ値を更新</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hash</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fullPath </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> stats</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> stats</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mtimeMs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isDirectory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">calculateDirHashRecursive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fullPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">calculateDirHash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dirPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> hash </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> crypto</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createHash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"sha256"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">calculateDirHashRecursive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dirPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">digest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"hex"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="おわりに">おわりに<a href="#おわりに" class="hash-link" aria-label="おわりに への直接リンク" title="おわりに への直接リンク">​</a></h2><p>本記事では、AWS CDK を使用して、リソース外のソースコードの変更に応じて Lambda-backed カスタムリソースの更新をトリガーする方法を紹介しました。ディレクトリ内のファイルのハッシュを計算し、カスタムリソースのプロパティとして設定することで、ファイルの変更があった際に自動的にカスタムリソースの更新がトリガーされるようになります。</p><p>この方法を利用することで、AWS CloudFormation スタックが直接参照していないコードにも対応した柔軟なインフラ管理が可能になります。今後も AWS CDK や Lambda-backed カスタムリソースを使用して、効率的なインフラ管理を実現していきましょう。</p>]]></content:encoded>
            <category>cdk</category>
        </item>
        <item>
            <title><![CDATA[Glue Sparkを使ってRedshiftのデータをDynamoDBへ書き出す]]></title>
            <link>https://prototyping-blog.com/blog/redshift-to-dynamo-glue</link>
            <guid>https://prototyping-blog.com/blog/redshift-to-dynamo-glue</guid>
            <pubDate>Tue, 28 Mar 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[AWS 上でデータ分析用の基盤を構築する際、データウェアハウスとして Redshift、データマートとして DynamoDB を利用したいことがあると思います。たとえば Redshift 上のデータを集計した結果に頻繁にアクセスする場合において、オフロード先として DynamoDB を採用する等のケースを想定しています。本記事では Glue Spark を用いて Redshift から DynamoDB へデータを ETL する方法を具体例を交えて紹介します。]]></description>
            <content:encoded><![CDATA[<p>AWS 上でデータ分析用の基盤を構築する際、データウェアハウスとして Redshift、データマートとして DynamoDB を利用したいことがあると思います。たとえば Redshift 上のデータを集計した結果に頻繁にアクセスする場合において、オフロード先として DynamoDB を採用する等のケースを想定しています。本記事では Glue Spark を用いて Redshift から DynamoDB へデータを ETL する方法を具体例を交えて紹介します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="問題設定">問題設定<a href="#問題設定" class="hash-link" aria-label="問題設定 への直接リンク" title="問題設定 への直接リンク">​</a></h2><p>ここでは下記のような購買履歴データを取り扱うものとします。</p><table><thead><tr><th>user_id</th><th>item_id</th></tr></thead><tbody><tr><td>user001</td><td>item001</td></tr><tr><td>user001</td><td>item002</td></tr><tr><td>user001</td><td>item003</td></tr><tr><td>user002</td><td>item010</td></tr><tr><td>user003</td><td>item002</td></tr><tr><td>user003</td><td>item010</td></tr><tr><td>...</td><td>...</td></tr></tbody></table><p>上記データが Redshift の<code>transaction</code>テーブルに存在するとします。これを下記のように<code>user_id</code> ごとに整理し、DynamoDB へ書き込む状況を考えます。</p><table><thead><tr><th>user_id</th><th>items</th></tr></thead><tbody><tr><td>user001</td><td>[item001,item002,item003]</td></tr><tr><td>user002</td><td>[item010]</td></tr><tr><td>user003</td><td>[item002,item010]</td></tr><tr><td>...</td><td>...</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="redshift-からデータを読み込む-extract">Redshift からデータを読み込む (Extract)<a href="#redshift-からデータを読み込む-extract" class="hash-link" aria-label="Redshift からデータを読み込む (Extract) への直接リンク" title="Redshift からデータを読み込む (Extract) への直接リンク">​</a></h2><p>Spark では JDBC を使って Redshift にアクセスすることができます。たとえば Glue PySpark では下記のように記述することでデータを読み込むことができます。</p><div class="language-glue.py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-glue.py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from awsglue.context import GlueContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from pyspark.context import SparkContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sc = SparkContext()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">glueContext = GlueContext(sc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df = (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    glueContext.read.format("jdbc")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option("url", "jdbc:redshift://host.amazonaws.com:5439/default_db")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option("user", "user")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option("password", "password")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option("dbtable","transaction")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .load()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上記コードは単一の Executor によって処理されるため、データサイズが小さい場合は動作しますが、大量のデータを読み込む場合メモリ不足等の原因により ETL ジョブは失敗に終わります。複数の Executor により並行に処理するには適切なパーティショニングを実施する必要があります。
パーティショニングするためには下記 3 つのオプションを指定します。</p><ul><li><code>partitionColumn</code><ul><li>パーティションのキーとなるカラム。数値・日付・タイムスタンプのどれかの型を持つカラムを指定できる</li></ul></li><li><code>numPartitions</code><ul><li>パーティションの数</li></ul></li><li><code>lowerBound</code>, <code>upperBound</code><ul><li>パーティションのレンジを定義するために利用されるパラメータ</li></ul></li></ul><p>たとえばパーティションとなるカラム: <code>example_col</code>が 1 から 1000 の範囲の整数をとる場合において<code>numPartitions</code>を 10、 <code>lowerBound</code>を 1、<code>upperBound</code>を 1000 とした場合、それぞれのパーティションにおいて個別に下記のようなクエリが発行されます。</p><div class="language-example.sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-example.sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT * FROM table WHERE example_col &lt; 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SELECT * FROM table WHERE example_col &gt;= 100 and example_col &lt; 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SELECT * FROM table WHERE example_col &gt;= 200 and example_col &lt; 300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SELECT * FROM table WHERE example_col &gt;= 900</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>したがって、各パーティションでは<code>example_col</code>の値が 1~99, 100~199, 200~299, ..., 900~1000 であるレコードを取り扱うことになります。
詳細は<a href="http://mogile.web.fc2.com/spark/sql-data-sources-jdbc.html" target="_blank" rel="noopener noreferrer">Spark のドキュメント</a>を参照ください。なお Redshift ではクエリ履歴は下記のようなクエリで確認できます。</p><div class="language-history.sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-history.sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT query_text, execution_time, start_time FROM sys_query_history</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>今回のケースでは<code>user_id</code>を<code>partitionColumn</code>に指定するアイデアが考えられますが、<code>user_id</code>は文字列型であるため直接指定することができません。また数値型であったとしても分布が均等でないケースが存在することも容易に想像できます（ヘビーユーザーとライトユーザーでは履歴の数が異なるなど）。均等でない場合データの偏りが発生し、その結果メモリ不足に関連した問題が発生する可能性があります。これを解決するため、ここではハッシュの剰余を利用します。<code>user_id</code>のハッシュ値をパーティション数で割った余りを<code>partitionColumn</code>に指定することで、上述の問題を回避することができます。ここではハッシュ値の計算に Redshift の<a href="https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_CHECKSUM.html" target="_blank" rel="noopener noreferrer">CHECKSUM 関数</a>を利用します。</p><div class="language-glue.py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-glue.py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">NUM_PARTITIONS = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOWER_BOUND = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UPPER_BOUND = NUM_PARTITIONS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sql = """</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SELECT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    user_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    item_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CHECKSUM(user_id) % {} as partition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    recommend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">""".format(NUM_PARTITIONS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jdbc_properties = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "url": "jdbc:redshift://host.amazonaws.com:5439/default_db",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "user": "user",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "password": "password",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df = (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    glueContext.read.format("jdbc")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option("url", "jdbc:redshift://host.amazonaws.com:5439/default_db")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option("user", "user")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option("password", "password")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "dbtable",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        f"({sql}) as tmp",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option("partitionColumn", "partition")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option("lowerBound", str(LOWER_BOUND))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option("upperBound", str(UPPER_BOUND))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option("numPartitions", str(NUM_PARTITIONS))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .load()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="http://mogile.web.fc2.com/spark/sql-data-sources-jdbc.html" target="_blank" rel="noopener noreferrer">Spark のドキュメント</a>にあるように、ここでは<code>dbtable</code>プロパティに直接クエリ文を指定している点に留意ください。</p><blockquote><p>read パスでそれを使う場合は、SQL クエリの FROM 句で有効なものを全て使用できることに注意してください。例えば、完全なテーブルの代わりに、丸括弧内のサブクエリも使うことができます。</p></blockquote><p>なおパーティション数: <code>NUM_PARTITIONS</code>には 30 を指定していますが、パーティション数を増やすと Redshift へのリクエスト数も増加する点に留意ください。リクエストはクエリキューに積まれ順次実行されます。詳細は<a href="https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/cm-c-defining-query-queues.html" target="_blank" rel="noopener noreferrer">ドキュメント</a>をご確認ください。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="データの変換-transform">データの変換 (Transform)<a href="#データの変換-transform" class="hash-link" aria-label="データの変換 (Transform) への直接リンク" title="データの変換 (Transform) への直接リンク">​</a></h2><p>Spark の <a href="https://spark.apache.org/docs/3.1.1/api/python/reference/api/pyspark.sql.DataFrame.html" target="_blank" rel="noopener noreferrer">DataFrame API</a> を利用し下記のように変換します。</p><div class="language-glue.py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-glue.py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from pyspark.sql.functions import collect_list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df_transformed = (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df.groupBy("user_id")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .agg(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        collect_list("item_id").alias("items"),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dynamodb-へ書き込み-load">DynamoDB へ書き込み (Load)<a href="#dynamodb-へ書き込み-load" class="hash-link" aria-label="DynamoDB へ書き込み (Load) への直接リンク" title="DynamoDB へ書き込み (Load) への直接リンク">​</a></h2><p>Spark DataFrame を Dynamic Frame へ変換後、<a href="https://docs.aws.amazon.com/ja_jp/glue/latest/dg/aws-glue-api-crawler-pyspark-extensions-dynamic-frame-writer.html#aws-glue-api-crawler-pyspark-extensions-dynamic-frame-writer-from_options" target="_blank" rel="noopener noreferrer">write_dynamic_frame_from_options</a>を利用し DynamoDB へ書き込みます。<code>connectionType</code>に<a href="https://docs.aws.amazon.com/ja_jp/glue/latest/dg/aws-glue-programming-etl-connect.html#aws-glue-programming-etl-connect-dynamodb" target="_blank" rel="noopener noreferrer"><code>dynamodb</code></a>を指定します。書き込みの量に対して十分な WCU が確保されている必要がありますのでご留意ください。</p><div class="language-glue.py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-glue.py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dyf = DynamicFrame.fromDF(df_transformed, glueContext)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">glueContext.write_dynamic_frame_from_options(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    frame=dyf,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connection_type="dynamodb",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connection_options={</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "dynamodb.output.tableName": "output_table",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "dynamodb.throughput.write.percent": "1.0",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">job.commit()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h2><p>以上、Redshift から DynamoDB へ Glue Spark を利用した ETL について紹介しました。Redshift 以外の JDBC データソースにも応用できますので、ご参考にしていただけたら幸いです。</p>]]></content:encoded>
            <category>dynamodb</category>
            <category>redshift</category>
            <category>glue</category>
            <category>spark</category>
        </item>
        <item>
            <title><![CDATA[最新の nvidia-driver 対応の Amazon Linux 2 ベースの EKS AMI の作り方]]></title>
            <link>https://prototyping-blog.com/blog/amazon-eks-gpu-ami</link>
            <guid>https://prototyping-blog.com/blog/amazon-eks-gpu-ami</guid>
            <pubDate>Fri, 24 Mar 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[最新の nvidia-driver (2023年3月時点)をインストールした Amazon Linux 2 ベースの EKS AMI の作り方を紹介します。]]></description>
            <content:encoded><![CDATA[<p>最新の nvidia-driver (2023年3月時点)をインストールした Amazon Linux 2 ベースの EKS AMI の作り方を紹介します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="gpu-ワークロード用-eks-ami-を自作する">GPU ワークロード用 EKS AMI を自作する<a href="#gpu-ワークロード用-eks-ami-を自作する" class="hash-link" aria-label="GPU ワークロード用 EKS AMI を自作する への直接リンク" title="GPU ワークロード用 EKS AMI を自作する への直接リンク">​</a></h2><p>GPU ワークロードに対応した <a href="https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/eks-optimized-ami.html" target="_blank" rel="noopener noreferrer">Amazon EKS optimized accelerated Amazon Linux AMI</a> に含まれる <code>nvidia-driver</code> の version は2023年3月現在 <code>470.161.03</code> であり、ワークロードによってはより新しいドライバが必要になることがあります。</p><p>通常の AMI はビルドに必要なスクリプトが <a href="https://github.com/awslabs/amazon-eks-ami" target="_blank" rel="noopener noreferrer">GitHub</a> に公開されていますが、GPU ワークロード用のものは公開されていません。通常の AMI をベースに最新の <code>nvidia-driver</code> をインストールした AMI を作るサンプルを <a href="https://github.com/kudtomoy/amazon-eks-gpu-ami" target="_blank" rel="noopener noreferrer">GitHub</a> に公開しました。EKS version <code>1.24</code> と <code>1.25</code> で動作確認を行なっています。<code>nvidia-driver</code> は <code>scripts/setup_gpu.sh</code> 内で <code>cuda_12.0.1_525.85.12</code> をインストールしていますが、必要なバージョンに書き換えてご利用ください。</p><p>ビルドの手順としては Linux インスタンスへの <a href="https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/install-nvidia-driver.html" target="_blank" rel="noopener noreferrer">NVIDIA ドライバーのインストール</a> を参考に <code>nvidia-driver</code> など必要なソフトウェアのインストールと設定を行なっています。Amazon Linux 2 の場合は通常の <code>gcc</code> ではなく <code>/usr/bin/gcc10-cc</code> を使うなど細かいポイントがあるため、一度目を通すことをおすすめします。</p>]]></content:encoded>
            <category>eks</category>
            <category>packer</category>
        </item>
        <item>
            <title><![CDATA[cdk destroy しても残ってしまうリソースへの対処法]]></title>
            <link>https://prototyping-blog.com/blog/clean-cdk-resources</link>
            <guid>https://prototyping-blog.com/blog/clean-cdk-resources</guid>
            <pubDate>Thu, 23 Mar 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[CDK で deploy や destroy を繰り返していると、不要なリソースが削除されずに残ってしまうことがあります。この記事ではそれらの cdk destroy しても残ってしまうリソースへの対処法を説明します。]]></description>
            <content:encoded><![CDATA[<p>CDK で deploy や destroy を繰り返していると、不要なリソースが削除されずに残ってしまうことがあります。この記事ではそれらの <code>cdk destroy</code> しても残ってしまうリソースへの対処法を説明します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="全てのリソースの-removalpolicy-を-destroy-に設定する">全てのリソースの RemovalPolicy を DESTROY に設定する<a href="#全てのリソースの-removalpolicy-を-destroy-に設定する" class="hash-link" aria-label="全てのリソースの RemovalPolicy を DESTROY に設定する への直接リンク" title="全てのリソースの RemovalPolicy を DESTROY に設定する への直接リンク">​</a></h2><p>リソースの <code>RemovalPolicy</code> が <code>RETAIN</code> になっていると、<code>cdk destroy</code> してもそのリソースは残ります。
開発環境などで全てのリソースに <code>RemovalPolicy.DESTROY</code> を付けたい場合は <a href="https://docs.aws.amazon.com/cdk/v2/guide/aspects.html" target="_blank" rel="noopener noreferrer">Aspects</a> を使うと簡単です。
以下のように使います。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class DeletionPolicySetter implements cdk.IAspect {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    constructor(private readonly policy: cdk.RemovalPolicy) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    visit(node: IConstruct): void {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (node instanceof cdk.CfnResource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            node.applyRemovalPolicy(this.policy)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cdk.Aspects.of(myStack).add(new DeletionPolicySetter(cdk.RemovalPolicy.DESTROY))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="中身があると消せないリソースは中身も消すように設定する">中身があると消せないリソースは、中身も消すように設定する<a href="#中身があると消せないリソースは中身も消すように設定する" class="hash-link" aria-label="中身があると消せないリソースは、中身も消すように設定する への直接リンク" title="中身があると消せないリソースは、中身も消すように設定する への直接リンク">​</a></h2><p><code>RemovalPolicy</code> が <code>DESTROY</code> になっていても <code>cdk destroy</code> で消えない場合があります。
たとえば S3 Bucket に中身が入っている状態で <code>cdk destroy</code> をすると以下のようなエラーで失敗します。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">x:xx:xx | DELETE_FAILED        | AWS::S3::Bucket       | Bucketxxxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The bucket you tried to delete is not empty (Service: Amazon S3; Status Code: 409; Error Code: BucketNotEmpty; Request ID: ...)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>S3 Bucket の場合は <code>autoDeleteObjects</code> を設定することで <code>cdk destroy</code> 時にオブジェクトを含めて削除してくれます。
ECR の <code>autoDeleteImages</code> なども同様です。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="すでに-stack-が無いのに残っているリソースを削除する">すでに Stack が無いのに残っているリソースを削除する<a href="#すでに-stack-が無いのに残っているリソースを削除する" class="hash-link" aria-label="すでに Stack が無いのに残っているリソースを削除する への直接リンク" title="すでに Stack が無いのに残っているリソースを削除する への直接リンク">​</a></h2><p>"すでに Stack は削除済みなのに消し忘れたリソースがたくさんある" 状態に対処するために、<a href="https://github.com/kudtomoy/clean-orphaned-resources" target="_blank" rel="noopener noreferrer">Stack に紐づいていないリソースをリストアップ・削除するツール</a>を作りました。</p><p>インストール方法などは README に記載があります。</p><p><code>list</code> コマンドを使用すると CloudFormation Stack に紐づいていないリソースの一覧を出力します。
出力されたファイルの一覧を見て、消したくないリソースの行を削除しておきます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ clean-orphaned-resources list &gt; orphaned_resources.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>その後 <code>destroy</code> コマンドを使用することでファイルに書かれているリソースを削除できます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ clean-orphaned-resources destroy &lt; orphaned_resources.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>cdk</category>
        </item>
        <item>
            <title><![CDATA[Amazon EKS の 複数 Pod 間で GPU を共有する (Time-Slicing 編)]]></title>
            <link>https://prototyping-blog.com/blog/eks-gpu-time-slicing</link>
            <guid>https://prototyping-blog.com/blog/eks-gpu-time-slicing</guid>
            <pubDate>Wed, 22 Mar 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[NVIDIA device plugin の Time-Slicing 機能を使って、Amazon EKS の 複数 Pod 間で GPU を共有する方法について紹介します。]]></description>
            <content:encoded><![CDATA[<p>NVIDIA device plugin の Time-Slicing 機能を使って、Amazon EKS の 複数 Pod 間で GPU を共有する方法について紹介します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="はじめに">はじめに<a href="#はじめに" class="hash-link" aria-label="はじめに への直接リンク" title="はじめに への直接リンク">​</a></h2><p>Amazon EKS で GPU ベースのワークロードを有効化するには <a href="https://github.com/NVIDIA/k8s-device-plugin" target="_blank" rel="noopener noreferrer">NVIDIA device plugin for Kubernetes</a> をクラスターの DaemonSet として適用する必要があります。手順は <a href="https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/eks-optimized-ami.html" target="_blank" rel="noopener noreferrer">Amazon EKS 最適化 Amazon Linux AMI</a> に書かれています。</p><p>Pod をコンテナに割り当てる際は下記のようにマニフェストの <code>resources</code> で使用する GPU数を指定します。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: nvidia-smi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  restartPolicy: OnFailure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: nvidia-smi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: nvidia/cuda:9.2-devel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - "nvidia-smi"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      limits:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nvidia.com/gpu: 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ここで指定できる数は整数であるため1つの Pod が1つ以上の GPU を占有することになりますが、実際のワークロードでは1つの GPU に複数の Pod を割り当てたい場合があると思います。</p><p>NVIDIA の GPU を複数の Pod で共有する方法として Time-Slicing、Multi-Instance GPU (MIG)、および Multi-Process Service (MPS) 等がありますが、今回は Time-Slicing の設定方法を紹介します。Time-Slicing は MIG や MPS と比較するとオーバーヘッドは大きめですが、GPU を選ばす NVIDIA device plugin で簡単に利用できるメリットがあります。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="設定方法">設定方法<a href="#設定方法" class="hash-link" aria-label="設定方法 への直接リンク" title="設定方法 への直接リンク">​</a></h2><p>NVIDIA device plugin がインストールされていない状態の EKS Cluster を用意してください。次に、下記のような設定ファイルを <code>nvidia-device-plugin-config.yaml</code> として保存します。今回の例では1つの GPU を10つに分割しています。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">version: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sharing:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timeSlicing:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: nvidia.com/gpu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        replicas: 10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>その後、helm で 設定ファイルを指定して NVIDIA device plugin をインストールします。 Time-Slicing は <code>v0.12.0</code> 以降の機能なので、それ以降の version を指定します。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm repo add nvdp https://nvidia.github.io/k8s-device-plugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ helm upgrade -i nvdp nvdp/nvidia-device-plugin \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --namespace nvidia-device-plugin \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --create-namespace \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --version 0.13.0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --set-file config.map.config=./nvidia-device-plugin-config.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>しばらくして DaemonSet がデプロイされると <code>kubectl</code> から見える GPU が増えているはずです。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl describe node | grep nvidia.com/gpu:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nvidia.com/gpu:              10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nvidia.com/gpu:              10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>より詳しい設定例などは、NVIDIA device plugin の <a href="https://github.com/NVIDIA/k8s-device-plugin#shared-access-to-gpus-with-cuda-time-slicing" target="_blank" rel="noopener noreferrer">Shared Access to GPUs with CUDA Time-Slicing</a> を参照してください。</p>]]></content:encoded>
            <category>eks</category>
            <category>gpu</category>
            <category>machine-learning</category>
        </item>
        <item>
            <title><![CDATA[OpenAI API を使って Discord Bot を作る]]></title>
            <link>https://prototyping-blog.com/blog/openai-discord-bot</link>
            <guid>https://prototyping-blog.com/blog/openai-discord-bot</guid>
            <pubDate>Mon, 06 Mar 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[流行りの OpenAI API を使って AWS に Discord Bot をデプロイする手順について紹介します。]]></description>
            <content:encoded><![CDATA[<p>流行りの OpenAI API を使って AWS に Discord Bot をデプロイする手順について紹介します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="アーキテクチャ">アーキテクチャ<a href="#アーキテクチャ" class="hash-link" aria-label="アーキテクチャ への直接リンク" title="アーキテクチャ への直接リンク">​</a></h2><p><img loading="lazy" alt="アーキテクチャ" src="/assets/images/architecture-5c47dbbdce7fb9183a7e05387d21c322.png" width="1697" height="773" class="img_ev3q"></p><p>AWS Fargate で Docker コンテナを動かすシンプルな構成です。API Key 等の保存に Pamameter Store を使っています。
ソースコードは <a href="https://github.com/kudtomoy/cdk-openai-discord-bot" target="_blank" rel="noopener noreferrer">GitHub</a> にあります。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="必要な準備">必要な準備<a href="#必要な準備" class="hash-link" aria-label="必要な準備 への直接リンク" title="必要な準備 への直接リンク">​</a></h2><ul><li>Docker と Node.js (LTSを推奨) と AWS CLI がインストールされていること</li><li>デプロイに使用するための <code>Administrator</code> 相当の権限を持つ IAM User or Role があり、 AWS CLI から利用できるように設定されていること</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="discord-に-bot-application-を追加する">Discord に Bot Application を追加する<a href="#discord-に-bot-application-を追加する" class="hash-link" aria-label="Discord に Bot Application を追加する への直接リンク" title="Discord に Bot Application を追加する への直接リンク">​</a></h2><p><a href="https://qiita.com/1ntegrale9/items/cb285053f2fa5d0cccdf" target="_blank" rel="noopener noreferrer">Discord Botアカウント初期設定ガイド for Developer</a> を参考に、Discord Server に Bot Application を追加し、後ほどし使用するために TOKEN を控えておきます。</p><p>権限周りの設定は以下を変更しました。</p><ul><li>自分だけが使用するので Bot 設定の <code>PUBLIC BOT</code> のチェックを外す</li><li>Bot Permissions は <code>Send Messages</code> <code>Send Messages in Threads</code> <code>Read Message History</code> を選択</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="openai-api-の-api-key-を作成する">OpenAI API の API Key を作成する<a href="#openai-api-の-api-key-を作成する" class="hash-link" aria-label="OpenAI API の API Key を作成する への直接リンク" title="OpenAI API の API Key を作成する への直接リンク">​</a></h2><p>OpenAI の Webサイトにログインし、<a href="https://platform.openai.com/account/api-keys" target="_blank" rel="noopener noreferrer">API Keys</a> から Secret Key を作成して控えておきます。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="parameterstore-に-secret-を保存する">ParameterStore に Secret を保存する<a href="#parameterstore-に-secret-を保存する" class="hash-link" aria-label="ParameterStore に Secret を保存する への直接リンク" title="ParameterStore に Secret を保存する への直接リンク">​</a></h2><p>Parameter Store に Discord Bot の Token と、OpenAI API の Secret を SecureString として保存しておきます。
この Parameter は 後ほど ECS Task の中から取得して使います。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ aws ssm put-parameter --type 'SecureString' --name '/openai-discord-bot/discord-token' \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --value '&lt;Discord Bot の Token&gt;'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ aws ssm put-parameter --type 'SecureString' --name '/openai-discord-bot/openai-secret' \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --value '&lt;OpenAI API の Secret&gt;'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aws-に-bot-をデプロイする">AWS に Bot をデプロイする<a href="#aws-に-bot-をデプロイする" class="hash-link" aria-label="AWS に Bot をデプロイする への直接リンク" title="AWS に Bot をデプロイする への直接リンク">​</a></h2><p>Bot は AWS CDK でデプロイできるようになっています。ソースコードを clone して、必要なライブラリをインストールしておきます。 </p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ git clone git@github.com:kudtomoy/cdk-openai-discord-bot.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cd cdk-openai-discord-bot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ npm install</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>lib/openai-discord-bot-stack.ts</code> の 55行目付近、コンテナの環境変数 <code>BOT_AUTHOR</code> を編集します。
Discord から Bot アカウントを右クリックしてプロフィールを確認することができます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">      environment: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CHARACTER_SETTING: readFileSync('./lib/character_setting.txt', 'utf8'),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BOT_AUTHOR: 'sample-bot#1584',  // 環境に合わせて変更してください</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="BotのProfile" src="/assets/images/bot-profile-38571be3d65b4dcd811abe98a967ff35.png" width="235" height="199" class="img_ev3q"></p><p>以上で最小限の設定は完了です。下記のコマンドでデプロイします。<code>cdk bootstrap</code> は AWS アカウント・リージョンごとに最初に1回必要です。
コマンドを実行すると IAM 周りの変更が表示され <code>Do you wish to deploy these changes (y/n)?</code> と聞かれます。内容を確認し、<code>y</code> と入力してください。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ npx cdk bootstrap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ npx cdk deploy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>デプロイが完了したら AWS Console の <a href="https://ap-northeast-1.console.aws.amazon.com/ecs/v2/clusters" target="_blank" rel="noopener noreferrer">Amazon ECS のページ</a>で ECS Task などの状態を確認することができます。また <a href="https://ap-northeast-1.console.aws.amazon.com/cloudwatch/home" target="_blank" rel="noopener noreferrer">CloudWatch のページ</a>ではコンテナのログを確認することができます。</p><p><img loading="lazy" alt="CloudWatchのログ" src="/assets/images/cloudwatch-log-fe8521e5120bb39a4a39e545968c2005.png" width="658" height="255" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="bot-を使ってみる">Bot を使ってみる<a href="#bot-を使ってみる" class="hash-link" aria-label="Bot を使ってみる への直接リンク" title="Bot を使ってみる への直接リンク">​</a></h2><p><img loading="lazy" alt="Botのデモ" src="/assets/images/bot-demo-c46b57a5cdbebddb740685ed8b14a6e4.png" width="830" height="599" class="img_ev3q"></p><p>Discord で Bot に mention を送ることで AI と会話することができます。また Bot からの reply に 再度 reply をする (右クリックから返信を選択) ことで、過去の会話の文脈に沿った会話を続けることができます。新しい文脈で会話をしたい場合は reply ではなく mention から始めてください。</p><p>しばらく会話を続けていると以下のようなメッセージが返ってくることがありますが、過去の会話の履歴が長くなりすぎて OpenAI API からエラーが返ってきているのが原因のため、この場合も新しく mention から始めてください。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">This model's maximum context length is 4096 tokens. However, your messages resulted in 4238 tokens. Please reduce the length of the messages.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="bot-をカスタマイズする">Bot をカスタマイズする<a href="#bot-をカスタマイズする" class="hash-link" aria-label="Bot をカスタマイズする への直接リンク" title="Bot をカスタマイズする への直接リンク">​</a></h2><p><code>lib/character_setting.txt</code> には、AI のキャラクター設定が書かれています。性格や口調をカスタマイズして、あなただけの Bot を作りましょう！</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">あなたは以下のキャラクターになりきって会話してください：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 一人称は「僕」、文体は必ず敬語の「ですます調」で、返事は短く簡潔に</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ロボットやSFが好き。趣味はアニメ、漫画、プラモデルを組むなど。お酒は飲めないけど料理は得意</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 回転寿司のお湯がでる蛇口を手を洗うところだと思っている</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ファイルを編集したら再度デプロイすることで設定を反映できます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ npx cdk deploy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="bot-を削除する">Bot を削除する<a href="#bot-を削除する" class="hash-link" aria-label="Bot を削除する への直接リンク" title="Bot を削除する への直接リンク">​</a></h2><p>下記のコマンドで削除できます。CloudWatch Logs など一部のリソースは残るため、気になる場合は手動で削除してください。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cdk destroy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>openai</category>
            <category>discord</category>
            <category>cdk</category>
        </item>
        <item>
            <title><![CDATA[Lambda Web Adapter と Prisma を利用する際の注意点]]></title>
            <link>https://prototyping-blog.com/blog/lambda-web-adapter-with-prisma</link>
            <guid>https://prototyping-blog.com/blog/lambda-web-adapter-with-prisma</guid>
            <pubDate>Thu, 02 Mar 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Lambda Web Adapter を利用することで、 コンテナイメージとして実装した Web システムを簡単に Lambda で動かすことができるようになります。]]></description>
            <content:encoded><![CDATA[<p>Lambda Web Adapter を利用することで、 コンテナイメージとして実装した Web システムを簡単に Lambda で動かすことができるようになります。<br>
<!-- -->この Lambda Web Adapter を利用して、 TypeScript の ORM ツールである Prisma を使用する際に注意すべきポイントがありましたので、そちらをご紹介します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="lambda-web-adapter-について">Lambda Web Adapter について<a href="#lambda-web-adapter-について" class="hash-link" aria-label="Lambda Web Adapter について への直接リンク" title="Lambda Web Adapter について への直接リンク">​</a></h2><p><a href="https://github.com/awslabs/aws-lambda-web-adapter" target="_blank" rel="noopener noreferrer">Lambda Web Adapter</a> とは、開発者が使い慣れた Web フレームワークをほぼそのまま AWS Lambda 上で実行することができるツールです。<br>
<!-- -->このツールを使うことで、コンテナ用に実装した Web アプリに変更を加えることなく、Lambda 上で実行させることができます。</p><p>Lambda Web Adapter については、弊チームメンバーが記載した <a href="https://aws.amazon.com/jp/builders-flash/202301/lambda-web-adapter/" target="_blank" rel="noopener noreferrer">builders.flash の記事</a>にて具体的な使い方や性能面など詳しく紹介されていますので、こちらをご覧ください。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="prisma-について">Prisma について<a href="#prisma-について" class="hash-link" aria-label="Prisma について への直接リンク" title="Prisma について への直接リンク">​</a></h2><p><a href="https://www.prisma.io/" target="_blank" rel="noopener noreferrer">Prisma</a> とは、Node.js の ORM ツールです。<br>
<!-- -->TypeScript に対応しており、型安全なデータベース操作、自動補完機能による効率の良いコーディングなどを実現することができます。  </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="アーキテクチャ図">アーキテクチャ図<a href="#アーキテクチャ図" class="hash-link" aria-label="アーキテクチャ図 への直接リンク" title="アーキテクチャ図 への直接リンク">​</a></h2><p><img loading="lazy" alt="アーキテクチャ図" src="/assets/images/architecture-8e1db77ab8f2cf2a99492a731e37db66.png" width="411" height="111" class="img_ev3q"></p><p>Lambda には、コンテナイメージで実装した以下の Web アプリをデプロイしています。</p><ul><li>ベースイメージ：<a href="https://hub.docker.com/layers/library/node/18.14-bullseye-slim/images/sha256-1ce35098327311d9cb16504d10abf4d5644ecd181279655a5906bb7100c91606" target="_blank" rel="noopener noreferrer">node:18.14-bullseye-slim</a><ul><li>Prisma を動作させるために必要なので、Dockerfile 内で openssl をインストールしています。</li><li><code>RUN apt-get -y install openssl</code></li></ul></li><li>Web フレームワーク：<a href="https://expressjs.com/" target="_blank" rel="noopener noreferrer">Express</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="lambda-web-adapter-と-prisma-を利用する際の注意点">Lambda Web Adapter と Prisma を利用する際の注意点<a href="#lambda-web-adapter-と-prisma-を利用する際の注意点" class="hash-link" aria-label="Lambda Web Adapter と Prisma を利用する際の注意点 への直接リンク" title="Lambda Web Adapter と Prisma を利用する際の注意点 への直接リンク">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="lambda-関数のアーキテクチャ不一致による実行エラー">Lambda 関数のアーキテクチャ不一致による実行エラー<a href="#lambda-関数のアーキテクチャ不一致による実行エラー" class="hash-link" aria-label="Lambda 関数のアーキテクチャ不一致による実行エラー への直接リンク" title="Lambda 関数のアーキテクチャ不一致による実行エラー への直接リンク">​</a></h3><p>こちらは、Prisma とは直接関係のないものとなりますが、ハマりやすいポイントのためご紹介します。  </p><p>Lambda 関数には、<code>arm64</code> アーキテクチャと <code>x86_64</code> アーキテクチャの2種類が用意されています（<a href="https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/foundation-arch.html" target="_blank" rel="noopener noreferrer">参考</a>）。<br>
<!-- -->Lambda 関数で利用するアーキテクチャとコンテナイメージのアーキテクチャが一致していない場合は、<code>exec format error</code> というエラーが発生し実行できません。<br>
<!-- -->Docker を利用してコンテナイメージをビルドする際は、<code>--platform</code> オプションを利用してアーキテクチャを一致させるようにしてください（<a href="https://docs.docker.com/build/building/multi-platform/#building-multi-platform-images" target="_blank" rel="noopener noreferrer">参考</a>）。  </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="aws-codebuild-を利用してコンテナイメージをビルドする際の注意点">AWS CodeBuild を利用してコンテナイメージをビルドする際の注意点<a href="#aws-codebuild-を利用してコンテナイメージをビルドする際の注意点" class="hash-link" aria-label="AWS CodeBuild を利用してコンテナイメージをビルドする際の注意点 への直接リンク" title="AWS CodeBuild を利用してコンテナイメージをビルドする際の注意点 への直接リンク">​</a></h4><p>CodeBuild には<a href="https://docs.aws.amazon.com/ja_jp/codebuild/latest/userguide/build-env-ref-available.html" target="_blank" rel="noopener noreferrer">ビルド用環境のイメージが用意</a>されています。<br>
<!-- -->コンテナイメージをビルドする際は、以下のイメージを選択いただければそれぞれのプラットフォームでビルドすることができます。  </p><ul><li><code>arm64</code> の場合は、<code>aws/codebuild/amazonlinux2-aarch64-standard:2.0</code>  </li><li><code>x86_64</code>の場合は、<code>aws/codebuild/amazonlinux2-x86_64-standard:4.0</code> または、<code>aws/codebuild/standard:6.0</code></li></ul><p><code>arm64</code> でビルドを行いたい場合は、以下について注意が必要です。<br>
<code>aws/codebuild/amazonlinux2-aarch64-standard:2.0</code> にプリインストールされている Node.js のバージョンは <code>10.24.1</code> と非常に古いものになっています（<a href="https://github.com/aws/aws-codebuild-docker-images/blob/master/al2/aarch64/standard/2.0/Dockerfile#L233" target="_blank" rel="noopener noreferrer">参考</a>）。<br>
<!-- -->これでは、2023年03月 現在よく使われている v16, v18 を利用して開発を行なっていた場合に、CodeBuild 内で  <code>npm ci</code> コマンドの実行に失敗してしまいます（注意：<a href="https://github.com/nodejs/Release" target="_blank" rel="noopener noreferrer">v16 は 2023-09-11 EOL 予定</a>）。<br>
<!-- -->※ v15 以上の Node.js は lockfileVersion が 3 であるため、pakage-lock.json の互換性がなくなり、<code>npm ci</code> コマンドが失敗します（<a href="https://docs.npmjs.com/cli/v9/configuring-npm/package-lock-json#file-format" target="_blank" rel="noopener noreferrer">参考</a>）。<br>
<!-- -->そのため、Node.js をアップグレードしたカスタムイメージを利用するか、<a href="https://docs.aws.amazon.com/ja_jp/codebuild/latest/userguide/build-spec-ref.html" target="_blank" rel="noopener noreferrer">buildspec</a> にて Node.js のアップグレードを行う必要があります。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="prisma-と-openssl-の互換性エラー">Prisma と OpenSSL の互換性エラー<a href="#prisma-と-openssl-の互換性エラー" class="hash-link" aria-label="Prisma と OpenSSL の互換性エラー への直接リンク" title="Prisma と OpenSSL の互換性エラー への直接リンク">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="prisma-が-db-アクセスする仕組み">Prisma が DB アクセスする仕組み<a href="#prisma-が-db-アクセスする仕組み" class="hash-link" aria-label="Prisma が DB アクセスする仕組み への直接リンク" title="Prisma が DB アクセスする仕組み への直接リンク">​</a></h4><p>OpenSSL 互換性エラーの話に入る前に、Prisma が DB にアクセスする仕組みの一部を簡単にご説明します。<br>
<!-- -->Prisma は、<a href="https://www.prisma.io/docs/concepts/components/prisma-engines" target="_blank" rel="noopener noreferrer">Prismaエンジン</a> と呼ばれるバイナリを利用して DB にアクセスをします。<br>
<!-- -->この中には <a href="https://www.prisma.io/docs/concepts/components/prisma-engines/query-engine" target="_blank" rel="noopener noreferrer">Query エンジン</a>というものが含まれており、この Query エンジンは DB へのクエリを実行するために利用されます。</p><p>この Query エンジンは、デフォルトでは Node-API ライブラリとしてロードされ、Node.js 上で実行されます。<br>
<!-- -->Node-API ライブラリとしてロードした場合は、オーバヘッドを最小限にすることができます。<br>
<!-- -->もう1つのアプローチとして、バイナリをサイドカープロセスとして起動することで、Node.js に依存しない形で Query エンジンを利用することもできます。<br>
<!-- -->こちらの詳細については、<a href="https://www.prisma.io/docs/concepts/components/prisma-engines/query-engine#the-query-engine-at-runtime" target="_blank" rel="noopener noreferrer">Prisma の公式ドキュメント</a>と<a href="https://github.com/prisma/prisma-engines#query-engine" target="_blank" rel="noopener noreferrer">Prisma エンジンのGitHub</a> をご確認ください。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="prisma-で-openssl-の互換性エラーが発生するパターン">Prisma で OpenSSL の互換性エラーが発生するパターン<a href="#prisma-で-openssl-の互換性エラーが発生するパターン" class="hash-link" aria-label="Prisma で OpenSSL の互換性エラーが発生するパターン への直接リンク" title="Prisma で OpenSSL の互換性エラーが発生するパターン への直接リンク">​</a></h4><p><em>Node-APIライブラリとしてQueryエンジンを利用した場合</em>に、プラットフォームと Node.js の組み合わせによって、OpenSSL の互換性エラーが発生してしまいます。  </p><p>Node.js は OpenSSL 1.1.1 の脆弱性対応として、v17 から OpenSSL3 へ移行されました（<a href="https://nodejs.org/en/blog/announcements/nodejs16-eol/" target="_blank" rel="noopener noreferrer">参考</a>）。
Node.js v17 以降では、OpenSSL1 系で実装されたプログラムとの互換性問題が発生し、エラーが発生してしまう場合があります（<a href="https://nodejs.org/es/blog/release/v17.0.0/#openssl-3-0" target="_blank" rel="noopener noreferrer">参考</a>）。</p><p>Linux の Prisma エンジンのバイナリは OpenSSL に依存しているのですが、そこで Node.js と プラットフォーム側の OpenSSL のバージョンに違いがあると互換性エラーが発生してしまいます。<br>
<a href="https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#binarytargets-options" target="_blank" rel="noopener noreferrer">こちら</a>を見ていただきますとわかります通り、Prisma エンジンはごく一部の Linux ディストリビューションを除き、OpenSSL1 系に依存しています。<br>
<!-- -->上記の OpenSSL1 系に依存したプラットフォームをベースイメージにしたコンテナイメージで v17 以上の Node.js を実行すると、Prisma がエラーとなり実行することができません。<br>
<!-- -->そのため、ローカルマシン（Windows や Mac）の Docker 上で動作していたものが、Lambda 上では実行できないという状態になってしまいます。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="互換性エラーの解消方法">互換性エラーの解消方法<a href="#互換性エラーの解消方法" class="hash-link" aria-label="互換性エラーの解消方法 への直接リンク" title="互換性エラーの解消方法 への直接リンク">​</a></h4><p>上記で説明した通り、この互換性エラーは Node.js と Prisma エンジンのバイナリとで OpenSSL のバージョンが異なるために発生しています。<br>
<!-- -->そのため、Prisma エンジンを Node-API ライブラリとしてロードせずに、バイナリをサイドカープロセスとして Node.js と切り離して実行すれば、エラーを解消することができます。<br>
<a href="https://www.prisma.io/docs/concepts/components/prisma-engines/query-engine#defining-the-query-engine-type-for-prisma-client" target="_blank" rel="noopener noreferrer">こちらの設定</a>を行うことで、エンジンタイプを <code>binary</code> に変更することができます。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="prisma-では-rds-proxy-を利用するメリットがない">Prisma では RDS Proxy を利用するメリットがない<a href="#prisma-では-rds-proxy-を利用するメリットがない" class="hash-link" aria-label="Prisma では RDS Proxy を利用するメリットがない への直接リンク" title="Prisma では RDS Proxy を利用するメリットがない への直接リンク">​</a></h3><p>こちらの話題は、Lambda Web Adapter とは直接関係のない話題となりますが、
Lambda + RDS（Aurora）の構成の場合に、コネクションを効率的に管理するために RDS Proxy を利用するケースがあるかと思います。<br>
<!-- -->しかし、Prisma を利用している場合は、RDS Proxy がコネクションをピン留め（コネクションが固定化されて、他のクライアントから再利用できなくなる）してしまいます。<br>
<!-- -->そのため、Prisma を利用している場合は RDS Proxy を利用するメリットがないと Prisma の公式ドキュメントに記載がされています。  </p><blockquote><p>Prisma is compatible with AWS RDS Proxy. However, there is no benefit in using it for connection pooling with Prisma due to the way RDS Proxy pins connections:</p></blockquote><p>引用：<a href="https://www.prisma.io/docs/guides/deployment/deployment-guides/caveats-when-deploying-to-aws-platforms#aws-rds-proxy" target="_blank" rel="noopener noreferrer">https://www.prisma.io/docs/guides/deployment/deployment-guides/caveats-when-deploying-to-aws-platforms#aws-rds-proxy</a></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="prisma-を利用するとピン留めが発生する理由">Prisma を利用するとピン留めが発生する理由<a href="#prisma-を利用するとピン留めが発生する理由" class="hash-link" aria-label="Prisma を利用するとピン留めが発生する理由 への直接リンク" title="Prisma を利用するとピン留めが発生する理由 への直接リンク">​</a></h4><p>RDS Proxy を利用している場合、多重化によって予期せぬ動作が発生する可能性がある場合に、コネクションがピン留めされます。<br>
<!-- -->そして、このコネクションがピン留めされる原因の1つに、<code>Prepared statements を利用してSQLを発行する</code>というものがあります。</p><blockquote><p>The proxy pins the session to the current connection in the following situations where multiplexing might cause unexpected behavior:</p><ul><li>Any statement with a text size greater than 16 KB causes the proxy to pin the session.</li><li>Prepared statements cause the proxy to pin the session. This rule applies whether the prepared statement uses SQL text or the binary protocol.</li></ul></blockquote><p>引用：<a href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/rds-proxy-managing.html#rds-proxy-pinning" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/rds-proxy-managing.html#rds-proxy-pinning</a></p><p>Prisma は Prepared Statement を利用して SQL を発行する仕様であるため、RDS Proxy を利用すると必ずピン留めが発生します。  </p><blockquote><p>Because Prisma uses prepared statements for all queries, you won't see any benefit when using RDS Proxy with Prisma.</p></blockquote><p>引用：<a href="https://www.prisma.io/docs/guides/deployment/deployment-guides/caveats-when-deploying-to-aws-platforms#aws-rds-proxy" target="_blank" rel="noopener noreferrer">https://www.prisma.io/docs/guides/deployment/deployment-guides/caveats-when-deploying-to-aws-platforms#aws-rds-proxy</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h3><p>以上、Lambda Web Adapter と Prisma を利用する際の注意点でした。<br>
<!-- -->Lambda Web Adapter と Prisma はどちらも便利なツールです。<br>
<!-- -->皆さんもぜひ使ってみてください。</p>]]></content:encoded>
            <category>lambda</category>
            <category>prisma</category>
            <category>typescript</category>
        </item>
        <item>
            <title><![CDATA[AWS CDK で MAC アドレスと IP アドレスを固定した EC2 インスタンスを作成する]]></title>
            <link>https://prototyping-blog.com/blog/primary-eni-with-cdk</link>
            <guid>https://prototyping-blog.com/blog/primary-eni-with-cdk</guid>
            <pubDate>Mon, 20 Feb 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[本記事では AWS CDK を使い、指定したネットワークインターフェイス (ENI) をプライマリネットワークインターフェイス (primary ENI) としてアタッチし、MAC アドレスと IP アドレスを固定した EC2 インスタンスを作成する方法について紹介します。]]></description>
            <content:encoded><![CDATA[<p>本記事では AWS CDK を使い、指定したネットワークインターフェイス (ENI) をプライマリネットワークインターフェイス (primary ENI) としてアタッチし、MAC アドレスと IP アドレスを固定した EC2 インスタンスを作成する方法について紹介します。</p><p>MAC アドレスや IP アドレスを固定する必要がある場合などに本記事で紹介する方法をご活用ください。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ec2-インスタンスと-eni-について">EC2 インスタンスと ENI について<a href="#ec2-インスタンスと-eni-について" class="hash-link" aria-label="EC2 インスタンスと ENI について への直接リンク" title="EC2 インスタンスと ENI について への直接リンク">​</a></h2><p>primary ENI を指定して起動することで、IP アドレスや MAC アドレスを EC2 インスタンス間で引き継ぐことが可能になります。
EC2 インスタンスでは AWS CLI のコマンドを利用することで ENI を追加 (アタッチ)・削除 (デタッチ) できますが、primary ENI に限っては変更できないことが明記されています (<a href="https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/using-eni.html" target="_blank" rel="noopener noreferrer">参考</a>)。</p><p>マネジメントコンソール経由で ENI を指定して起動する方法については他のウェブサイト等でも紹介されていますが、AWS CDK でも実現可能であることを知っていただければと思います。</p><p>本記事の最後には Unity Build Server での応用例をサンプルコードとともにご紹介します。</p><p>今回使用した Node.js と CDK のバージョンは以下になります:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ node --version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">v18.13.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cdk --version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2.63.0 (build 7f4e35e)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="eni-を-aws-cdk-で作成する">ENI を AWS CDK で作成する<a href="#eni-を-aws-cdk-で作成する" class="hash-link" aria-label="ENI を AWS CDK で作成する への直接リンク" title="ENI を AWS CDK で作成する への直接リンク">​</a></h2><p>まず、EC2 インスタンスにアタッチする ENI を AWS CDK で作成します。
既に存在する ENI を利用したい場合、<a href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/resource-import-existing-stack.html" target="_blank" rel="noopener noreferrer">CloudFormation へのインポート</a> や <a href="https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/use_cfn_template.html" target="_blank" rel="noopener noreferrer">CloudFormation のインポート</a> を参考にし、リソースを CDK 管理下に移行してください。</p><p>本記事執筆時点では AWS CDK に ENI の L2 コンストラクトは存在しません。
そこで今回はより CloudFormation に近い L1 コンストラクトの <a href="https://docs.aws.amazon.com/cdk/api/v1/docs/@aws-cdk_aws-ec2.CfnNetworkInterface.html" target="_blank" rel="noopener noreferrer"><code>ec2.CfnNetworkInterface</code></a> を使って ENI を作成します。
ENI が誤って削除されてしまうことを防止したい場合、必要に応じて削除ポリシーに <code>Retain</code> を指定します。</p><p>CDK のコードはそれぞれ以下のようになります。(一部抜粋、以下同様)</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> cdk </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'aws-cdk-lib'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> ec2 </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'aws-cdk-lib/aws-ec2'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Construct </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'constructs'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> RemovalPolicy </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'aws-cdk-lib'</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> vpc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ec2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Vpc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Vpc'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> subnetId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> vpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">privateSubnets</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subnetId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> eni </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ec2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CfnNetworkInterface</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Eni'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  subnetId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> subnetId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eni</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">applyRemovalPolicy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RemovalPolicy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">RETAIN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="eni-を-ec2-インスタンスの-primary-eni-に指定する">ENI を EC2 インスタンスの primary ENI に指定する<a href="#eni-を-ec2-インスタンスの-primary-eni-に指定する" class="hash-link" aria-label="ENI を EC2 インスタンスの primary ENI に指定する への直接リンク" title="ENI を EC2 インスタンスの primary ENI に指定する への直接リンク">​</a></h2><p>起動テンプレート (<a href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_ec2.LaunchTemplate.html" target="_blank" rel="noopener noreferrer">LaunchTemplate</a>)を利用して EC2 インスタンスを起動するため、CDK で起動テンプレートを作成します。</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> launchTemplate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ec2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LaunchTemplate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'LaunchTemplate'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  instanceType</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ec2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InstanceType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'t3.small'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  machineImage</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ec2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AmazonLinuxImage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    generation</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ec2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AmazonLinuxGeneration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">AMAZON_LINUX_2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>起動時にアタッチする ENI を指定するには起動テンプレートの <a href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-launchtemplate-launchtemplatedata.html#cfn-ec2-launchtemplate-launchtemplatedata-networkinterfaces" target="_blank" rel="noopener noreferrer">NetworkInterfaces</a> を変更すればよいのですが、このプロパティは L2 コンストラクト <code>ec2.LaunchTemplate</code> ではサポートされていません。
そこで今回は AWS CDK の <a href="https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/cfn_layer.html" target="_blank" rel="noopener noreferrer">エスケープハッチ</a> や raw オーバーライドと呼ばれる機能を利用して設定します。</p><p>実際のコードは以下のようになります。</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> cfnLaunchTemplate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> launchTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findChild</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Resource'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> ec2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CfnLaunchTemplate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cfnLaunchTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addPropertyOverride</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'LaunchTemplateData.NetworkInterfaces'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DeviceIndex</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DeleteOnTermination</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NetworkInterfaceId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> eni</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ref</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>起動テンプレートの設定が完了したので、EC2 インスタンスの作成に移ります。
ただし、今回は L2 Construct の　<code>ec2.Instance</code> を利用するとプログラムが複雑になってしまいます。
これは <code>ec2.Instance</code> では自動的にデプロイするサブネットを設定してくれるのですが、ENI とサブネット ID を同時に指定することはできないという制約があるためです。(実際にデプロイしようとすると <code>Network interfaces and an instance-level subnet ID may not be specified on the same request (Service: AmazonEC2; Status Code: 400; Error Code: InvalidParameterCombination; ...</code> といったエラーが返されます)</p><p>そこで EC2 インスタンスの L1 Construct である <code>ec2.CfnInstance</code> を利用してインスタンスを作成します。コードは以下のようになります。</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ec2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CfnInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Instance'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  launchTemplate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> launchTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">versionNumber</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  launchTemplateId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> launchTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">launchTemplateId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上で指定したネットワークインターフェイスを primary ENI としてインスタンスを作成できました。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="unity-build-server-での応用例">Unity Build Server での応用例<a href="#unity-build-server-での応用例" class="hash-link" aria-label="Unity Build Server での応用例 への直接リンク" title="Unity Build Server での応用例 への直接リンク">​</a></h2><p>MAC アドレスの固定が求められる場面の例として、Unity Build Server を AWS 上に構築するケースが挙げられます。
aws-samples に<a href="https://github.com/aws-samples/unity-build-server-with-aws-cdk" target="_blank" rel="noopener noreferrer">サンプルコード</a> を公開していますので、ご利用のソフトウェアのライセンス条項等をご確認の上、ご活用ください。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="おわりに">おわりに<a href="#おわりに" class="hash-link" aria-label="おわりに への直接リンク" title="おわりに への直接リンク">​</a></h2><p>本記事では AWS CDK を使い、指定した ENI を primary ENI としてアタッチし、MAC アドレスと IP アドレスを固定した EC2 インスタンスを作成する方法について紹介しました。
これにより EC2 インスタンス間で MAC アドレスや IP アドレスを引き継いで起動できるようになります。
また、Unity Build Server を AWS に構築する場合のサンプルコードについても紹介しました。</p>]]></content:encoded>
            <category>cdk</category>
            <category>ec2</category>
            <category>unity</category>
        </item>
        <item>
            <title><![CDATA[Amazon Lex, Amazon Kendra のサンプルプロジェクト開発で集めた Tips]]></title>
            <link>https://prototyping-blog.com/blog/lex-kendra-dev</link>
            <guid>https://prototyping-blog.com/blog/lex-kendra-dev</guid>
            <pubDate>Wed, 08 Feb 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[弊社 Prototyping チームと ML Specialist 合同で作成した simple-lex-kendra-jp というサンプルプロジェクト開発中に集めた Tips を紹介いたします。包括的な内容ではなく、散文的な内容になることをご了承ください。また、Amazon Lex、Amazon Kendra に直接関係のない Tips もあります。]]></description>
            <content:encoded><![CDATA[<p>弊社 Prototyping チームと ML Specialist 合同で作成した <a href="https://github.com/aws-samples/simple-lex-kendra-jp" target="_blank" rel="noopener noreferrer">simple-lex-kendra-jp</a> というサンプルプロジェクト開発中に集めた Tips を紹介いたします。包括的な内容ではなく、散文的な内容になることをご了承ください。また、Amazon Lex、Amazon Kendra に直接関係のない Tips もあります。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="simple-lex-kendra-jp-について">simple-lex-kendra-jp について<a href="#simple-lex-kendra-jp-について" class="hash-link" aria-label="simple-lex-kendra-jp について への直接リンク" title="simple-lex-kendra-jp について への直接リンク">​</a></h2><p>AWS では "言語" に関する ML サービスをいくつか展開していますが、Amazon Lex と Amazon Kendra もそれに属します。Amazon Lex は会話型 AI を使用してチャットボットと音声ボットを構築するサービスで、Amazon Kendra はさまざまなデータソースに存在するドキュメントに対して機械学習を活用してインテリジェントな検索を提供するサービスです。また、Amazon Lex と Amazon Kendra を統合することで、チャットボットから検索が可能になります。</p><p><a href="https://github.com/aws-samples/simple-lex-kendra-jp" target="_blank" rel="noopener noreferrer">simple-lex-kendra-jp</a> は日本のユーザーに最適化した Amazon Lex と Amazon Kendra のサンプルプロジェクトです。ドキュメントが日本語であることはもちろんのこと、内容も日本のユーザーに向けて最適化されています。このサンプルプロジェクトでは、架空の会社の社内検索システムと社内サポートのチャットボット対応を構築します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tips">Tips<a href="#tips" class="hash-link" aria-label="Tips への直接リンク" title="Tips への直接リンク">​</a></h2><p>では、ここからは開発中に得た Tips をご紹介いたします。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cdk-で-frontend-をデプロイする際に環境変数を組み込む方法">CDK で Frontend をデプロイする際に環境変数を組み込む方法<a href="#cdk-で-frontend-をデプロイする際に環境変数を組み込む方法" class="hash-link" aria-label="CDK で Frontend をデプロイする際に環境変数を組み込む方法 への直接リンク" title="CDK で Frontend をデプロイする際に環境変数を組み込む方法 への直接リンク">​</a></h3><p>そもそも、なぜ CDK で環境変数が必要な Frontend をデプロイする際に考慮が必要なのかというと、ご存知の通り、Frontend はビルドする際に環境変数を組み込むため、ビルド時には必要な環境変数が解決されている必要があるためです。一方で、CDK で Backend と Frontend を同時にデプロイしたい場合 1) Frontend はビルド済みである必要がある (S3 などにアップロードするため) 2) Backend の情報は未解決である (API Endpoint など) の 2 点がコンフリクトしているため、困ってしまうという訳です。一番素直に解決する方法としては、Backend と Frontend の Stack を分けてしまうというものになります。1) Backend をデプロイする 2) 環境変数を設定して Frontend をビルドする 3) ビルドした Frontend をデプロイする、の手順を踏めばデプロイ可能です。ただし、特にサンプルプロジェクトでは手軽さを売りにしたいので、1 Stack でデプロイしたいところです。</p><p>simple-lex-kendra-jp では、弊チームメンバーが開発している <a href="https://github.com/tmokmss/deploy-time-build" target="_blank" rel="noopener noreferrer">deploy-time-build</a> を利用しています。こちらの Construct を使うと、Backend のリソースが未解決な状態でも Frontend の環境変数として設定できるため、1 Stack でデプロイできます。仕組みとしては、CDK の CustomResource を使い、Lambda 関数内で Frontend をビルドしています。こうすることで、1 Stack 内で前述した (1) ~ (3) の手順が再現されています。</p><p>他にも方法はあって、それぞれの Pros/Cons は <a href="https://github.com/tmokmss/deploy-time-build" target="_blank" rel="noopener noreferrer">deploy-time-build の README.md</a> に記載されているので、ぜひご覧ください。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="npm-workspace-使ってみた">npm workspace 使ってみた<a href="#npm-workspace-使ってみた" class="hash-link" aria-label="npm workspace 使ってみた への直接リンク" title="npm workspace 使ってみた への直接リンク">​</a></h3><p>本プロジェクトは CDK、Amazon Lex の Frontend、Amazon Kendra の Frontend と 3 つの TypeScript のプロジェクトを内包しているわけですが、このような場合、npm の workspace 機能が便利です。npm workspace は npm の 7.x.x から導入された機能で、複数の npm プロジェクトを内包しているモノリシックなプロジェクトのパッケージ管理を便利に行ってくれるものです。例えば、Backend と Frontend で共通で利用するモジュールを切り出すことで、特別な指定をすることなく、Backend と Frontend からその共通モジュールを import できます。今回はパッケージが相互に参照することはなかったため、そのような機能は使っていないのですが、ディレクトリを移動しながら npm コマンドを実行する必要がないため、それだけで十分便利でした。</p><p>npm workspace 機能を使う場合は、以下のように package.json に workspaces を定義します。(<code>cdk</code>、<code>web-kendra</code>、<code>web-lexv2</code> という 3 つの npm パッケージを内包したプロジェクトの例)</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...省略...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"workspaces"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"cdk"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"web-kendra"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"web-lexv2"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>続いて、具体的に使ったコマンドを書きます。</p><p>以下のコマンドで、全てのワークスペースの依存パッケージをインストールしました。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># --workspaces は -ws でも可</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">npm</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> --workspaces</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Workspace を指定しつつ、<code>npm exec</code> を実行しました。なお、<code>npm exec</code> が workspace 対応したのは <a href="https://github.com/npm/cli/releases/tag/v7.7.0" target="_blank" rel="noopener noreferrer">v7.7.0</a> からのようですので、使用バージョンにご留意ください。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># workspace=cdk を指定しつつ、cdk コマンドを実行している</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">npm</span><span class="token plain"> </span><span class="token builtin class-name">exec</span><span class="token plain"> -w cdk -- cdk deploy SimpleKendraStack</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Workspace を指定しつつ、<code>npm run</code> を実行しました。なお、<code>npm run</code> も workspace 対応したのは <a href="https://github.com/npm/cli/releases/tag/v7.7.0" target="_blank" rel="noopener noreferrer">v7.7.0</a> からのようですので、workspace 機能を使う場合は v7.7.0 以降の npm を利用するのがよさそうですね。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">npm</span><span class="token plain"> run start -w web-kendra</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="amazon-lex-の-bot-バージョンを-cdk-で自動インクリメントする">Amazon Lex の Bot バージョンを CDK で自動インクリメントする<a href="#amazon-lex-の-bot-バージョンを-cdk-で自動インクリメントする" class="hash-link" aria-label="Amazon Lex の Bot バージョンを CDK で自動インクリメントする への直接リンク" title="Amazon Lex の Bot バージョンを CDK で自動インクリメントする への直接リンク">​</a></h3><p>Amazon Lex では、複数の Bot のバージョンを作成し、Alias を特定のバージョンに向けることで Bot を利用します。そのため、Bot、Bot Version、Bot Alias の 3 つを作成する必要があります。開発中、あるいは、本番運用フェーズにおいても、常に最新の Bot を指す Bot Version が必要になるケースがほとんどだと思います。その際、ただ CDK で Bot Version を作成しただけでは、Bot の内容が変更されたとしても、Bot Version 自体には変更が入っていないため、最新に向いていると思っている Bot Version が古い Bot を示す場合があります。</p><p>simple-lex-kendra-jp では、このようなことが起こらないように、デプロイするたびに作成しなおす Bot Version を作成しています。(常に最新に向いています。) 具体的にはリソースの Logical ID に自動でインクリメントされる数字を含ませることで、毎回作成しなおすということを行っています。自動でインクリメントする方法としては、CloudFormation の Output として現在の Bot Version Number を出力し、次回デプロイ時にその数値 + 1 のバージョンを利用する、ということを行っています。ちなみに、このような用途であれば、単にランダムな Hex 値を Logical ID に入れるという実装でも良いと思います。今回は、特定の Bot Version Number を本番で利用するものとして Fix するという用途も見据えて数値をインクリメントする実装にしました。(そのような実装はサンプルコードには含まれていません。)</p><ul><li><a href="https://github.com/aws-samples/simple-lex-kendra-jp/blob/main/cdk/bin/simple-lex-kendra-jp.ts#L8-L24" target="_blank" rel="noopener noreferrer">前回デプロイ時の Bot Version Number を取得</a></li><li><a href="https://github.com/aws-samples/simple-lex-kendra-jp/blob/main/cdk/lib/simple-lexv2-stack.ts#L191" target="_blank" rel="noopener noreferrer">バージョンのインクリメント</a></li><li><a href="https://github.com/aws-samples/simple-lex-kendra-jp/blob/main/cdk/lib/simple-lexv2-stack.ts#L304-L306" target="_blank" rel="noopener noreferrer">現在の Bot Version Number を出力</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="amazon-lex-の-nluconfidencethreshold-は高めに設定した方が良い">Amazon Lex の nluConfidenceThreshold は高めに設定した方が良い<a href="#amazon-lex-の-nluconfidencethreshold-は高めに設定した方が良い" class="hash-link" aria-label="Amazon Lex の nluConfidenceThreshold は高めに設定した方が良い への直接リンク" title="Amazon Lex の nluConfidenceThreshold は高めに設定した方が良い への直接リンク">​</a></h3><p>Amazon Lex では、発話に対してどの Intent を起動するのかの閾値を 0.0 ~ 1.0 で設定します。CloudFormation 的には nluConfidenceThreshold というプロパティで、AWS Management Console 的には Confidence score threshold というプロパティになります。閾値を高くすると、あらかじめ設定した発話パターンに近くないと Intent が起動しないということになります。低くすると、ざっくりとしたものでも Intent で拾えるようになる一方、不正確な Intent がキックされる可能性も高くなります。</p><p>この値は運用中にチューニングしていくことにはなるのですが、基本的には高めに設定しておくことをお勧めします。理由としては、それぞれの Cons として以下の 2 点を書きましたが</p><ul><li>高い場合: あらかじめ設定した発話パターンに近くないと Intent が起動しない</li><li>低い場合: 不正確な Intent がキックされる可能性が高い</li></ul><p>このうち、高い場合の Cons については運用でカバーが可能なためです。具体的には、Amazon Lex の Analytics 機能から Utterances statistics を開き、Missed (対象の Intent がわからなかった発話) を収集して、Slot をチューニングしたり、新しく Intent を追加したりすることが可能なためです。一方、低い場合は、キックされた Intent が不正確だったかどうかを調査するのが、かなり面倒になります。よって、最初に高い数値を設定しおき、徐々に発話パターンを充填させていくという運用をお勧めします。</p><p>なお、発話に関しては <a href="https://docs.aws.amazon.com/lexv2/latest/APIReference/API_ListAggregatedUtterances.html" target="_blank" rel="noopener noreferrer">API でも取得できる</a> ため、定期的に運用チームにレポートするといった運用にしても良いかもしれませんね。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="amazon-kendra-の-custom-data-source-の-attribute-には-_source_uri-をつけると良い">Amazon Kendra の Custom Data Source の Attribute には <code>_source_uri</code> をつけると良い<a href="#amazon-kendra-の-custom-data-source-の-attribute-には-_source_uri-をつけると良い" class="hash-link" aria-label="amazon-kendra-の-custom-data-source-の-attribute-には-_source_uri-をつけると良い への直接リンク" title="amazon-kendra-の-custom-data-source-の-attribute-には-_source_uri-をつけると良い への直接リンク">​</a></h3><p>基本的には <a href="https://docs.aws.amazon.com/kendra/latest/dg/data-source-custom.html" target="_blank" rel="noopener noreferrer">こちら</a> の公式ドキュメントに書かれている通りなのですが、Custom Data Source には <code>_source_uri</code> の Attribute もつけた方が良いと考えます。(必須な Attributes は <code>_data_source_id</code> と <code>_data_source_sync_job_execution_id</code> のみです。) 理由としては、他のデータソース (S3 Bucket など) ではソースの URI が設定されていることがほとんどであるため、UI を実装する上で同様に扱えた方が良いと考えるためです。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h2><p>この記事では <a href="https://github.com/aws-samples/simple-lex-kendra-jp" target="_blank" rel="noopener noreferrer">simple-lex-kendra-jp</a> 開発中に得た Tips をまとめてみました。これら以外にもこちらのサンプルプロジェクトから得られた知見を以下にまとめています。</p><ul><li><a href="https://prototyping-blog.com/blog/identity-pool-unauth" target="_blank" rel="noopener noreferrer">Cognito Identity Pools の Unauthenticated Role で Amazon Kendra にアクセスしたら AccessDeniedException だった話</a></li><li><a href="https://github.com/aws-samples/simple-lex-kendra-jp/blob/main/docs/05_TECH_KNOWLEDGE.md" target="_blank" rel="noopener noreferrer">Tech Knowledge (Amazon Lex v2 と Amazon Kendra についての知見をまとめたもの)</a></li></ul>]]></content:encoded>
            <category>lex</category>
            <category>kendra</category>
            <category>cdk</category>
        </item>
        <item>
            <title><![CDATA[EC2 Macインスタンスを使う上で3つの注意点]]></title>
            <link>https://prototyping-blog.com/blog/ec2-mac-instances</link>
            <guid>https://prototyping-blog.com/blog/ec2-mac-instances</guid>
            <pubDate>Wed, 01 Feb 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[EC2 MacインスタンスがGAされて久しいですが、まだまだAWSの中では新しいサービスということもあり、使うと驚くこともいくつかあります。]]></description>
            <content:encoded><![CDATA[<p><a href="https://aws.amazon.com/jp/ec2/instance-types/mac/" target="_blank" rel="noopener noreferrer">EC2 Macインスタンス</a>がGAされて久しいですが、まだまだAWSの中では新しいサービスということもあり、使うと驚くこともいくつかあります。
この記事では、実際にプロトタイピング案件でEC2 Macを使ってみて気づいたことを何点か紹介します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="起動にはクォータ緩和が必要">起動にはクォータ緩和が必要<a href="#起動にはクォータ緩和が必要" class="hash-link" aria-label="起動にはクォータ緩和が必要 への直接リンク" title="起動にはクォータ緩和が必要 への直接リンク">​</a></h2><p>EC2 Macインスタンスはデフォルトでは起動できません。<a href="https://console.aws.amazon.com/servicequotas/home/services/ec2/quotas" target="_blank" rel="noopener noreferrer">コチラのページ</a>からクォータの値を上限緩和しましょう。mac1がIntel Mac、mac2がM1 Macを指します。</p><p><img loading="lazy" alt="クォータ" src="/assets/images/quota-f4b33c75f9154002c560cb819fe15015.png" width="1056" height="359" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dedicated-hostを使う必要がある">Dedicated hostを使う必要がある<a href="#dedicated-hostを使う必要がある" class="hash-link" aria-label="Dedicated hostを使う必要がある への直接リンク" title="Dedicated hostを使う必要がある への直接リンク">​</a></h2><p>よくあるユースケースのLinuxインスタンスではEC2インスタンスを直接起動できますが、Macインスタンスではそれができません。代わりに、Dedicated hostを割り当て、そのホスト上にインスタンスを起動する形になります。<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-mac-instances.html#mac-instance-launch" target="_blank" rel="noopener noreferrer">具体的な方法はこちら</a>。</p><p><img loading="lazy" alt="Dedicated host" src="/assets/images/dedicated-hosts-66ea43654368bbed7d1e36d37931cfb0.png" width="1156" height="365" class="img_ev3q"></p><p>また、課金についてもインスタンスを起動しているかどうかによらず、Dedicated host割当時間で決まります (<a href="https://aws.amazon.com/ec2/instance-types/mac/#Pricing" target="_blank" rel="noopener noreferrer">参考</a>)。使い終わったらインスタンスの終了だけでなくホストのリリースを忘れないようにしたいですね。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dedicated-hostのリリースに関する制約">Dedicated hostのリリースに関する制約<a href="#dedicated-hostのリリースに関する制約" class="hash-link" aria-label="Dedicated hostのリリースに関する制約 への直接リンク" title="Dedicated hostのリリースに関する制約 への直接リンク">​</a></h2><p>EC2 MacのDedicated hostは少しクセがあり、以下の制約があります:</p><ol><li>ホストを割り当ててから24時間はリリースできません。これは Apple macOS Software License Agreement に準拠するためということです (<a href="https://aws.amazon.com/ec2/instance-types/mac/#Pricing" target="_blank" rel="noopener noreferrer">参考</a>)。</li><li>ホスト上のインスタンスを停止/終了してから1〜3時間程度は、ホストのリリースやインスタンスの起動ができません (<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-mac-instances.html#mac-instance-stop" target="_blank" rel="noopener noreferrer">参考</a>)。内部SSDやNVRAMの消去、デバイスファームウェアのアップデートなどをするためとのことです。なお、この処理に要する時間はユーザーには課金されないようです。</li></ol><p>いつでも自由にホストをリリースできるわけではないことに注意しましょう。特にDedicated hostやインスタンスをCloudFormationで管理する場合は、リソースの削除時にホストとインスタンスの削除が同時に行われないように工夫が必要です (Removal PolicyをRetainにする、別のスタックでデプロイするなど)。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="リモートデスクトップ接続する方法">リモートデスクトップ接続する方法<a href="#リモートデスクトップ接続する方法" class="hash-link" aria-label="リモートデスクトップ接続する方法 への直接リンク" title="リモートデスクトップ接続する方法 への直接リンク">​</a></h2><p>Macインスタンスの操作は、やはりGUIが便利です。Apple Remote Desktopの機能を有効化すれば、お手元の端末からMacインスタンスへリモートデスクトップ接続が可能です。</p><p>具体的な方法はこちらに書かれています: <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-mac-instances.html#connect-to-mac-instance" target="_blank" rel="noopener noreferrer">Connect to your instance using Apple Remote Desktop</a>。Macインスタンス側の設定は、ユーザーにパスワードを設定し、ARDの機能を有効化するだけです。</p><p>ARDには5900番ポートでアクセスできます。<a href="https://aws.amazon.com/jp/blogs/news/use-port-forwarding-in-aws-systems-manager-session-manager-to-connect-to-remote-hosts-jp/" target="_blank" rel="noopener noreferrer">SSM Session manager</a>を使えば、セキュリティグループの許可は不要で、またプライベートサブネットにあるインスタンスでもポートフォワードが可能です。</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># targetにはMacインスタンスのインスタンスIDは入れる (マネジメントコンソールで確認)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws ssm start-session \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --target i-xxxxxxxxxxxxxx \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --document-name AWS-StartPortForwardingSession \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --parameters '{"portNumber":["5900"], "localPortNumber":["5900"]}'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>あとは手元の端末のVNCクライアント (MacならScreen sharingアプリがデフォルトで利用可能です) から、<code>localhost:5900</code> に接続すればOKです。</p><p><img loading="lazy" alt="ard" src="/assets/images/ard-31b55a1efd3d246522c5b826b08d0e35.jpg" width="1022" height="817" class="img_ev3q"></p><p>画面解像度を変更したい場合は、こちらに手順があります: <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-mac-instances.html#mac-screen-resolution" target="_blank" rel="noopener noreferrer">Modify macOS screen resolution on Mac instances</a>。コマンド4つくらいで済みます。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ebsサイズを変更する方法">EBSサイズを変更する方法<a href="#ebsサイズを変更する方法" class="hash-link" aria-label="EBSサイズを変更する方法 への直接リンク" title="EBSサイズを変更する方法 への直接リンク">​</a></h2><p>Macインスタンスでも、メインストレージとしてEBSが利用されます。一点Amazon Linuxインスタンスと異なるのは、EBSサイズを変更する際にMac側から明示的にストレージを拡張するコマンドを実行する必要がある点です。<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-mac-instances.html#mac-instance-increase-volume" target="_blank" rel="noopener noreferrer">こちらのドキュメント</a>に詳細が書かれています。</p><p>また、コマンド実行の際にはインスタンスの再起動が必要なのですが、この再起動に数十分程度かかる場合がありました。ベターな方法として、<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-add-user-data.html" target="_blank" rel="noopener noreferrer">EC2のユーザーデータ</a>でこのコマンドを実行すれば、再起動は不要になります。もし最初から必要なストレージサイズがわかっているのであれば、ユーザーデータ内で上記コマンドを実行することをおすすめいたします。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h2><p>以上、EC2 Macインスタンスを使ってみて気づいたことを紹介しました。</p><p>プロトタイピングチームでは、EC2 Macを使ってJenkinsのUnityビルドパイプラインを構築するCDKテンプレートを公開しています: <a href="https://github.com/aws-samples/jenkins-unity-build-on-aws" target="_blank" rel="noopener noreferrer">Unity Build Pipeline with Jenkins and EC2 Mac</a>。
EC2インスタンスをCDKで構築するコード例は<a href="https://github.com/aws-samples/jenkins-unity-build-on-aws/blob/main/lib/construct/jenkins/agent-mac.ts" target="_blank" rel="noopener noreferrer">こちら</a>です。
ご参考にしていただければ幸いです。</p>]]></content:encoded>
            <category>ec2</category>
            <category>mac</category>
        </item>
        <item>
            <title><![CDATA[CDK のデプロイ環境を CloudShell と Cloud9 を使い爆速で構築する]]></title>
            <link>https://prototyping-blog.com/blog/cdk-deploy-cloudshell-cloud9</link>
            <guid>https://prototyping-blog.com/blog/cdk-deploy-cloudshell-cloud9</guid>
            <pubDate>Mon, 23 Jan 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Prototyping チームでは実装したシステムをお客様にお渡ししますが、お客様の環境は様々です。]]></description>
            <content:encoded><![CDATA[<p>Prototyping チームでは実装したシステムをお客様にお渡ししますが、お客様の環境は様々です。
お渡しするシステムは CDK を使ったものがほとんどですが、nodejs のインストールや docker のインストールといった事前準備の手順は、お客様の環境によって変わります。</p><p>環境ごとの手順を用意するのは大変なので、その対策として、Prototyping チームでは CloudShell と Cloud9 を併用した手段をご提案する場合があります。今回はその手順をご紹介させていただきます。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="構築手順">構築手順<a href="#構築手順" class="hash-link" aria-label="構築手順 への直接リンク" title="構築手順 への直接リンク">​</a></h2><ol><li>AWS Console から AWS CloudShell を起動</li><li>CloudShell のプロンプトで下記コマンドを実行</li></ol><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/aws-samples/cloud9-setup-for-prototyping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd cloud9-setup-for-prototyping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./bin/bootstrap</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>AWS Console から AWS Cloud9 に移動して <code>cloud9-for-prototyping</code> を起動</li><li>AWS Cloud9 のメニューにある File から <code>Upload Local Files</code> を押下</li><li>CDK プロジェクトのソース zip ファイルを <code>Drag &amp; drop file here</code> に投下</li><li>AWS Cloud9 のターミナルで下記コマンドを実行</li></ol><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Admin:~/environment $ unzip prototype.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Admin:~/environment $ cd prototype/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="7"><li>プロジェクトのデプロイ方法に従いコマンドを実行</li></ol><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">## 実行例です。プロジェクトによって変化します</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Admin:~/environment $ npx cdk deploy --all</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Note:</strong> 4-6. の手順で Cloud9 にプロジェクトをアップロードしていますが、もしプロジェクトが GitHub などで公開されている場合はもちろん Cloud9 のターミナルから git コマンドで取得していただいても構いません。</p><p>この Cloud9 を利用中は EC2 の利用料金がかかりますが、使用していない場合は一定時間後に自動停止し、料金も発生しなくなります。AWS CLI v2 / Python / Node.js / Docker といった頻繁に利用する依存ソフトウェアも導入済みで、Cloud9 にありがちなメモリ不足も抑えられるように調整されています。</p><p>本記事では CDK のデプロイ用途として紹介しましたが、この用途に限らず、クリーンな UNIX 環境を素早く簡単に構築できる手段です。是非お試しください。</p>]]></content:encoded>
            <category>cdk</category>
            <category>cloudshell</category>
            <category>cloud9</category>
        </item>
        <item>
            <title><![CDATA[Cognito Identity Pools の Unauthenticated Role で Amazon Kendra にアクセスしたら AccessDeniedException だった話]]></title>
            <link>https://prototyping-blog.com/blog/identity-pool-unauth</link>
            <guid>https://prototyping-blog.com/blog/identity-pool-unauth</guid>
            <pubDate>Fri, 20 Jan 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[フロントエンドから直接 AWS サービスを実行する際に、Cognito の Identity Pools で取得した認証情報を利用することは多々あると思います。この記事では、知らないとハマってしまうかもしれない仕様について、ご紹介いたします。]]></description>
            <content:encoded><![CDATA[<p>フロントエンドから直接 AWS サービスを実行する際に、Cognito の Identity Pools で取得した認証情報を利用することは多々あると思います。この記事では、知らないとハマってしまうかもしれない仕様について、ご紹介いたします。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cognito-identity-pools">Cognito Identity Pools<a href="#cognito-identity-pools" class="hash-link" aria-label="Cognito Identity Pools への直接リンク" title="Cognito Identity Pools への直接リンク">​</a></h2><p>認証されたユーザー及びゲストユーザーに一時的な AWS 認証情報を提供するため、Cognito Identity Pools を利用することがあると思います。その認証情報を用いることで、フロントエンドから直接 AWS サービスを呼び出すことが可能です。</p><p>詳細な説明は省きますが、例えば、AWS SDK for JavaScript v3 なら以下のように記述することで認証付きのクライアントを作成できます。(<code>&lt;IDENTITY_POOL_ID&gt;</code> は適切な値に書き換えが必要)</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#393A34">{</span><span class="token imports"> fromCognitoIdentityPool </span><span class="token imports punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"@aws-sdk/credential-providers"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">FooClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">credentials</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fromCognitoIdentityPool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">identityPoolId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'&lt;IDENTITY_POOL_ID&gt;'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="unauthenticated-role">Unauthenticated Role<a href="#unauthenticated-role" class="hash-link" aria-label="Unauthenticated Role への直接リンク" title="Unauthenticated Role への直接リンク">​</a></h2><p>筆者が <a href="https://aws.amazon.com/jp/lex/" target="_blank" rel="noopener noreferrer">Amazon Lex</a> と <a href="https://aws.amazon.com/jp/kendra/" target="_blank" rel="noopener noreferrer">Amazon Kendra</a> を使ったサンプルコード <a href="https://github.com/aws-samples/simple-lex-kendra-jp" target="_blank" rel="noopener noreferrer">simple-lex-kendra-jp</a> を開発するにあたり、Cognito Identity Pools を使って、フロントエンドから直接それらの AWS サービスにアクセスしようと考えていました。ユーザーは全てゲストユーザーです。</p><p>Amazon Lex に関しては問題なくアクセスできたのですが、Amazon Kendra にアクセスを試みた際に、以下のような AccessDeniedException が発生してしまいました。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">An error occurred (AccessDeniedException) when calling the Query operation: User: &lt;省略&gt; is not authorized to perform: kendra:Query on resource: &lt;省略&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>エラー文からして権限が足りないのかと思い、取り急ぎ AdministratorAccess などを付与して実験したものの、解消しませんでした。
結論として、原因は <a href="https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies" target="_blank" rel="noopener noreferrer">Unauthenticated Role の認証情報でアクセスできる AWS サービスに制限がある</a> ためでした。
この表によると、Amazon Lex や Amazon Transcribe などは呼び出し可能ですが、確かに Amazon Kendra はリストにありません。
最終的に、Amazon Kendra を呼び出すことが可能な API Endpoint を作成することで、これを回避しました。</p><p>ちなみに、ゲストユーザーではなく、認証されたユーザーであれば呼び出し可能です。例えば Cognito で認証した場合、ID Token を取得して以下のように設定してください。(<code>&lt;IDENTITY_POOL_ID&gt;</code>、<code>&lt;REGION&gt;</code>、<code>&lt;COGNITO_USER_POOL_ID&gt;</code> と <code>&lt;ID Token&gt;</code> は適切な値に書き換えが必要) (<a href="https://docs.aws.amazon.com/ja_jp/sdk-for-javascript/v3/developer-guide/loading-browser-credentials-cognito.html" target="_blank" rel="noopener noreferrer">参考</a>)</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#393A34">{</span><span class="token imports"> fromCognitoIdentityPool </span><span class="token imports punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"@aws-sdk/credential-providers"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">FooClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">credentials</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fromCognitoIdentityPool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">identityPoolId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'&lt;IDENTITY_POOL_ID&gt;'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">logins</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'cognito-idp.&lt;REGION&gt;.amazonaws.com/&lt;COGNITO_USER_POOL_ID&gt;'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'&lt;ID Token&gt;'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h2><ul><li>Cognito Identity Pools の Unauthenticated Role の認証情報ではポリシーに関わらずアクセスできない AWS サービス (例: Amazon Kendra) がある</li><li>その際は API を作成してバックエンドから呼び出すか、要認証とする</li></ul>]]></content:encoded>
            <category>cognito</category>
            <category>kendra</category>
        </item>
        <item>
            <title><![CDATA[Fluentd から Kinesis Data Streams へサイズが大きいデータを転送する]]></title>
            <link>https://prototyping-blog.com/blog/fluentd-kds</link>
            <guid>https://prototyping-blog.com/blog/fluentd-kds</guid>
            <pubDate>Thu, 05 Jan 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Kinesis Data Streams には、1 レコードのサイズは 1MB 以下でなければならない制約があり、サイズの大きいデータを転送するには工夫が必要となります。また利用料金はストリームに読み書きされるデータ量に基づいて決定されるため、サイズが大きいと課金額も増えてしまいます。本記事では Publisher が Fluentd の場合において、上記課題を解決する方法についてご紹介します。メッセージをメタデータと本体に分割し、本体は S3 経由で Consumer に渡し、メタデータのみを Kinesis Data Streams へ送ることで実現します。]]></description>
            <content:encoded><![CDATA[<p><a href="https://aws.amazon.com/jp/kinesis/data-streams/" target="_blank" rel="noopener noreferrer">Kinesis Data Streams</a> には、1 レコードのサイズは 1MB 以下でなければならない制約があり、サイズの大きいデータを転送するには工夫が必要となります。また利用料金はストリームに読み書きされるデータ量に基づいて決定されるため、サイズが大きいと課金額も増えてしまいます。本記事では Publisher が Fluentd の場合において、上記課題を解決する方法についてご紹介します。メッセージをメタデータと本体に分割し、本体は S3 経由で Consumer に渡し、メタデータのみを Kinesis Data Streams へ送ることで実現します。</p><p><img loading="lazy" src="/assets/images/arch-65816c847eb129ab558e9547a43a095d.png" width="511" height="250" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kinesis-data-streams-について">Kinesis Data Streams について<a href="#kinesis-data-streams-について" class="hash-link" aria-label="Kinesis Data Streams について への直接リンク" title="Kinesis Data Streams について への直接リンク">​</a></h2><p>Kinesis Data Streams (以降 KDS と呼称) は、フルマネージドのサーバレスストリーミングサービスです。シンプルな従量制課金を採用しており、シャードの稼働時間に応じて料金は計算されます。シャードは基本的なスループットの単位であり、スループット要件に応じて必要なシャード数を決定します。なおオンデマンドモードを利用した場合、読み書きのデータ量に応じて自動的にシャード数のスケールが行われます。詳細は<a href="https://aws.amazon.com/jp/kinesis/data-streams/pricing/" target="_blank" rel="noopener noreferrer">Amazon Kinesis Data Streams の料金</a>をご覧ください。<br>
<!-- -->また KDS では 1 レコードのサイズが 1MB 以下である必要があります。詳細は<a href="https://docs.aws.amazon.com/streams/latest/dev/service-sizes-and-limits.html" target="_blank" rel="noopener noreferrer">Quotas and Limits</a>をご確認ください。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="方針">方針<a href="#方針" class="hash-link" aria-label="方針 への直接リンク" title="方針 への直接リンク">​</a></h2><p>各レコードにユニークな ID を割り当て、KDS では ID のみを、S3 バケットへはレコードの本体をそれぞれ送信します。バケットのオブジェクトキーに ID を含ませておけば、Consumer 側で ID を元にバケットから本体のデータを取得し処理することができます。これにより KDS で取り扱うレコードのサイズを削減することが可能です。本記事では、Fluentd を用いた場合について具体的に解説します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="想定するレコード例">想定するレコード例<a href="#想定するレコード例" class="hash-link" aria-label="想定するレコード例 への直接リンク" title="想定するレコード例 への直接リンク">​</a></h2><p>サイズの大きなレコードの例を示します。</p><div class="language-record.json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-record.json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "metrics_name": "metrics1",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "metrics_value": 24.1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "metrics_name": "metrics2",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "metrics_value": 312.56,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...以降続く</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上記の配列を「1 レコード」として取り扱うことを想定しています。この例の場合、各<code>metrics</code>を別々のレコードとして取り扱えばサイズを 1MB に抑えることも可能でしょう。しかし Fluentd の入力側の都合や (技術的な課題や組織的な事情)、個々の<code>metrics</code>間に依存関係があるため Consumer 側ではまとめて処理した方が見通しが良い等の事情により、分割することが困難または妥当でないケースがあります。また上記の配列単位で順序性が担保されれば良い場合、KDS にすべて送信すると前述のコスト体系により予算面で厳しいケースも考えれます。このような課題を前述の方針により解決を図ります。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="fluentd-のバッファリング">Fluentd のバッファリング<a href="#fluentd-のバッファリング" class="hash-link" aria-label="Fluentd のバッファリング への直接リンク" title="Fluentd のバッファリング への直接リンク">​</a></h2><p>Fluentd ではレコードをバッファリングし、まとめて送信する機能があります。これによりログの欠損防止や流量の制御が可能です。本記事ではバッファリングの利用を前提とします。</p><p>Fluentd のバッファの仕組みを下記に示します。
<img loading="lazy" src="/assets/images/buf-9fe916e307db9ecb9ce0b96cc6924171.png" width="1212" height="563" class="img_ev3q">
<a href="https://docs.fluentd.org/buffer" target="_blank" rel="noopener noreferrer">引用先</a></p><p>バッファリングには stage と queue の 2 ステップが存在します。stage の段階でイベントの塊であるチャンク (chunk) を作成し、時間経過とともにエンキューされ、Output Plugin の指定する宛先へ送信されます。なおイベントはレコード (送信したいデータ本体)、タグ、タイムスタンプの 3 つの要素から構成されます。タグは Fluentd の備える主要な要素であり、Fluentd の内部でのルーティングに利用されます。Fluentd へデータを投入する Input Plugin はレコードにタグをつけ、Fluentd はそのタグにマッチする<code>match</code>ディレクティブを検索し、対応する Output Plugin へルーティングします。<br>
<!-- -->たとえば下記のような 2 つのダミーのデータソースがあるとします。それぞれタグは<code>example.hello</code>, <code>example.hoge</code>です。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;source&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @type dummy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dummy {"hello": "world"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tag example.hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/source&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;source&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @type dummy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dummy {"hoge": "hoge"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tag example.hoge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/source&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上記両方ともに<code>example_bucket</code>という名前の S3 バケットへ転送したい場合、対応する match ディレクティブは下記のようになります。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;match example.**&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @type s3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  s3_bucket example_bucket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/match&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>それぞれ別のバケット (<code>hello_bucket</code>, <code>hoge_bucket</code>)へ転送したい場合は下記のように記述します。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;match example.hello&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @type s3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  s3_bucket hello_bucket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/match&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;match example.hoge&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @type s3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  s3_bucket hoge_bucket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/match&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>詳細は<a href="https://docs.fluentd.org/configuration/config-file" target="_blank" rel="noopener noreferrer">Config File Syntax</a>をご覧ください。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="チャンク">チャンク<a href="#チャンク" class="hash-link" aria-label="チャンク への直接リンク" title="チャンク への直接リンク">​</a></h3><p>チャンクを作成するとき、<a href="https://docs.fluentd.org/configuration/buffer-section#chunk-keys" target="_blank" rel="noopener noreferrer">Chunk key</a>と呼ばれるキーを指定しグルーピングすることができます。キーにはタグの他、タイムキーなどを含めることができます。<br>
<!-- -->例えば下記のように記述した場合、イベントは 60 秒ごと、かつタグごとにグルーピングされチャンクが作られます。</p><div class="language-fluent.conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-fluent.conf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;buffer time, tag&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timekey 60</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/buffer&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>チャンクを S3 へ転送する際、上記のチャンクに付与されたユニークな ID を KDS へ転送すれば Consumer 側で S3 のオブジェクトを取得できます。ユニークな ID は Output Plugin の<a href="https://docs.fluentd.org/plugin-development/api-plugin-output#chunk.unique_id" target="_blank" rel="noopener noreferrer">chunk.unique_id</a>、Chunk key で利用したタグやタイムキーは<a href="https://docs.fluentd.org/plugin-development/api-plugin-output#chunk.metadata" target="_blank" rel="noopener noreferrer">chunk.metadata</a>から取得することが可能です。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="fluentd-自身のログをキャプチャする">Fluentd 自身のログをキャプチャする<a href="#fluentd-自身のログをキャプチャする" class="hash-link" aria-label="Fluentd 自身のログをキャプチャする への直接リンク" title="Fluentd 自身のログをキャプチャする への直接リンク">​</a></h2><p>チャンクのユニークな ID を KDS へ転送するには、Fluentd への入力として<code>chunk.unique_id</code>および<code>chunk.metadata</code>を与える必要があります。ここでは <a href="https://docs.fluentd.org/deployment/logging#capture-fluentd-logs" target="_blank" rel="noopener noreferrer">Fluentd 自身のログをキャプチャする</a>方法を利用します。
Fluentd は Fluentd 自身のログを<code>fluent</code>タグをつけて管理しています。このログは<code>&lt;label @FLUENT_LOG&gt;</code>内で<code>match</code>ディレクティブを記載することで処理できます。たとえば下記のように記載すると、すべてのログレベルのログを KDS へ転送します。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;label @FLUENT_LOG&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;match fluent.*&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @type kinesis_streams</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/match&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/label&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Fluentd の S3 Output プラグインでは S3 転送時に<code>chunk.unique_id</code>および<code>chunk.metadata</code>を含んだログを<a href="https://github.com/fluent/fluent-plugin-s3/blob/2109abcaf6279fb92d0e877359d281aacba6b9ff/lib/fluent/plugin/out_s3.rb#L354" target="_blank" rel="noopener noreferrer">debug レベルで出力</a>します。下記ログをキャプチャし KDS へ転送すれば、Consumer 側で S3 のオブジェクトキーを特定できます。</p><div class="language-out_s3.rb codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-out_s3.rb codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">log.debug "out_s3: write chunk #{dump_unique_id_hex(chunk.unique_id)} with metadata #{chunk.metadata} to s3://#{@s3_bucket}/#{s3path}"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="fluentd-のコンフィギュレーション">Fluentd のコンフィギュレーション<a href="#fluentd-のコンフィギュレーション" class="hash-link" aria-label="Fluentd のコンフィギュレーション への直接リンク" title="Fluentd のコンフィギュレーション への直接リンク">​</a></h2><p>以上の内容を踏まえ、S3 へ本体を転送し、 KDS へメタデータを送るコンフィギュレーション例を作成してみます。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ログレベルの設定">ログレベルの設定<a href="#ログレベルの設定" class="hash-link" aria-label="ログレベルの設定 への直接リンク" title="ログレベルの設定 への直接リンク">​</a></h3><p>S3 Output プラグインは 前述のチャンク情報を含むログを <code>debug</code> レベルで出力するため、<code>system</code>セクションに下記のように設定します。<a href="https://docs.fluentd.org/deployment/logging#by-config-file" target="_blank" rel="noopener noreferrer">参考</a></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;system&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  log_level debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;log&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    format json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time_format %Y-%m-%d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/log&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/system&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="s3">S3<a href="#s3" class="hash-link" aria-label="S3 への直接リンク" title="S3 への直接リンク">​</a></h3><p>ここでは後に<a href="https://aws.amazon.com/jp/athena/" target="_blank" rel="noopener noreferrer">Amazon Athena</a>を用い効率的にクエリできるよう、Hive 形式 (s3://year=yyyy/month=mm/day=dd) かつ gzip に圧縮し出力するものとします。<br>
<!-- -->下記のように設定すると、S3 バケットへは<code>s3://example_bucket/log/year=2023/month=01/day=05/{チャンクID}.gzip</code>のような形式で保存されます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;match example.log&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @type s3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s3_bucket example_bucket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s3_object_key_format ${tag[1]}/%{time_slice}/${chunk_id}.%{file_extension}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    store_as gzip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time_slice_format year=%Y/month=%m/day=%d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;format&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      @type json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/format&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;buffer time,tag&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        timekey 10s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/buffer&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/match&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>S3 に保存されるデータ例を下記に示します。上記の設定の場合 10 秒の間に到達した<a href="#%E6%83%B3%E5%AE%9A%E3%81%99%E3%82%8B%E3%83%AC%E3%82%B3%E3%83%BC%E3%83%89%E4%BE%8B">想定するレコード</a>を json フォーマットで並べたものになります。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "metrics_name": "metrics1",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "metrics_value": 24.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "metrics_name": "metrics2",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "metrics_value": 312.56</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "metrics_name": "metrics1",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "metrics_value": 28.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "metrics_name": "metrics2",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "metrics_value": 356.13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fluentd-自身のログのフィルタリング">Fluentd 自身のログのフィルタリング<a href="#fluentd-自身のログのフィルタリング" class="hash-link" aria-label="Fluentd 自身のログのフィルタリング への直接リンク" title="Fluentd 自身のログのフィルタリング への直接リンク">​</a></h3><p>Fluentd の<a href="https://docs.fluentd.org/filter" target="_blank" rel="noopener noreferrer">Filter Plugins</a>を使うと、送信したい内容を抽出・加工することができます。<br>
<!-- -->まず前述した S3 Output プラグインが S3 転送した時のログを下記の設定により抽出します。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;filter fluent.debug&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @type grep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;regexp&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      key message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      pattern /out_s3: write chunk/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/regexp&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/filter&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>これにより例えば下記のようなログのみが抽出できます。</p><div class="language-.json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-.json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "time": "2023-01-06",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "level": "debug",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "message": "out_s3: write chunk 5f18e855a51912add1e8b26328a62d3d with metadata #&lt;struct Fluent::Plugin::Buffer::Metadata timekey=1672969300, tag=\"example.log\", variables=nil&gt; to s3://example_bucket/log/year=2023/month=01/day=06/5f18e855a51912add1e8b26328a62d3d.gz",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>続いて上記の抽出したログに対し、元のタグ (ここでは <code>example.log</code>) を含む部分を正規表現により取得し、後述する KDS のパーティションキーとして利用するため追加します。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;filter fluent.debug&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @type record_transformer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enable_ruby</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;record&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # 元のタグを正規表現で抽出しkinesisのpartition keyに利用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      partition_key ${record["message"].match(/tag=.+,/)[0].slice(0..-2)}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/record&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/filter&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下記のように<code>parition_key</code>が新たに追加されます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "time": "2023-01-06",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "level": "debug",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "message": ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "partition_key": "tag=\"example.log\""</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>fluent.debug</code>タグのレコードを KDS へ送信しないようにするため下記により除外します。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;filter fluent.debug&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @type grep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;exclude&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      key partition_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      pattern /fluent.debug/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/exclude&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/filter&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="kds">KDS<a href="#kds" class="hash-link" aria-label="KDS への直接リンク" title="KDS への直接リンク">​</a></h3><p>先ほど抽出した元のタグをパーティションキーに設定し KDS へ送信します。これにより同じタグのレコードは毎回同じシャードに送信され順序性が担保されます (KDS はシャード内でのみ順序を保証します)。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;match fluent.debug&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @type kinesis_streams</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stream_name example_stream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    partition_key partition_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/match&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>なお最終的に KDS へ送信されるデータは下記となります。この例の場合<code>tag="example.log"</code>が送信先のシャード決定に利用されます。Consumer 側では<code>message</code>に含まれるオブジェクトキーを用いて本体データを取得できます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "time": "2023-01-06",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "level": "debug",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "message": "out_s3: write chunk 5f18e855a51912add1e8b26328a62d3d with metadata #&lt;struct Fluent::Plugin::Buffer::Metadata timekey=1672969300, tag=\"example.log\", variables=nil&gt; to s3://example_bucket/log/year=2023/month=01/day=06/5f18e855a51912add1e8b26328a62d3d.gz",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "partition_key": "tag=\"example.log\""</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上の内容を一つにまとめたものが下記となります。</p><div class="language-fluent.conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-fluent.conf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;system&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  log_level debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;log&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    format json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time_format %Y-%m-%d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/log&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/system&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;match example.log&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @type s3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s3_bucket example_bucket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s3_object_key_format ${tag[1]}/%{time_slice}/${chunk_id}.%{file_extension}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    store_as gzip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time_slice_format year=%Y/month=%m/day=%d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;format&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      @type json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/format&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;buffer time,tag&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        timekey 10s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/buffer&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/match&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;label @FLUENT_LOG&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;filter fluent.debug&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @type grep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;regexp&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      key message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      pattern /out_s3: write chunk/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/regexp&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/filter&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;filter fluent.debug&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @type record_transformer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enable_ruby</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;record&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      partition_key ${record["message"].match(/tag=.+,/)[0]}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/record&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/filter&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;filter fluent.debug&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @type grep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;exclude&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      key partition_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      pattern /fluent.debug/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/exclude&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/filter&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;match fluent.debug&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @type kinesis_streams</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stream_name example_stream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    partition_key partition_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;buffer time&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      timekey 10s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/buffer&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/match&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/label&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h2><p>本記事では Fluentd から Kinesis Data Streams へ大きなサイズのレコードを取り扱う具体的な方法例についてご紹介しました。ご参考にいただければ幸いです。</p>]]></content:encoded>
            <category>fluentd</category>
            <category>kinesis data streams</category>
            <category>kinesis</category>
        </item>
        <item>
            <title><![CDATA[Ruby on Rails を API Gateway + Lambda でサーバーレス運用する方法]]></title>
            <link>https://prototyping-blog.com/blog/rails-lambda</link>
            <guid>https://prototyping-blog.com/blog/rails-lambda</guid>
            <pubDate>Wed, 21 Dec 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[Ruby on Rails で開発された Web アプリケーションを AWS で稼働させる際、EC2 の仮想サーバーや ECS のコンテナ環境で実行して ALB 等のロードバランサーで公開するのが一般的です。この方法は稼働時間に比例した料金となりますが、もう1つの選択肢として、時間ではなくリクエスト回数に応じた料金となる API Gateway と Lambda を使う方法があります。今回は、Ruby on Rails を AWS Lambda で動かす方法を解説します。]]></description>
            <content:encoded><![CDATA[<p>Ruby on Rails で開発された Web アプリケーションを AWS で稼働させる際、<a href="https://aws.amazon.com/ec2/" target="_blank" rel="noopener noreferrer">EC2</a> の仮想サーバーや <a href="https://aws.amazon.com/ecs/" target="_blank" rel="noopener noreferrer">ECS</a> のコンテナ環境で実行して <a href="https://aws.amazon.com/elasticloadbalancing/application-load-balancer/" target="_blank" rel="noopener noreferrer">ALB</a> 等のロードバランサーで公開するのが一般的です。この方法は稼働時間に比例した料金となりますが、もう1つの選択肢として、時間ではなくリクエスト回数に応じた料金となる <a href="https://aws.amazon.com/api-gateway/" target="_blank" rel="noopener noreferrer">API Gateway</a> と <a href="https://aws.amazon.com/jp/lambda/" target="_blank" rel="noopener noreferrer">Lambda</a> を使う方法があります。今回は、Ruby on Rails を AWS Lambda で動かす方法を解説します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ruby-on-rails-とは">Ruby on Rails とは<a href="#ruby-on-rails-とは" class="hash-link" aria-label="Ruby on Rails とは への直接リンク" title="Ruby on Rails とは への直接リンク">​</a></h2><p>Ruby on Rails は、Ruby 言語で Web アプリケーションを開発するためのフレームワークの1つです。「設定より規約 (Convention over Configuration, CoC)」というパラダイムの先駆者として有名で、他のフレームワークにも大きな影響を及ぼしました。</p><p>rails コマンドによるコードの自動生成機能が充実しており、プロジェクトの作成だけでなく、モデルやコントローラーの生成や認証機能の追加といった事まで行う事ができます。特に Active Record によるモデルとテーブル定義の自動生成は便利で、Web アプリ開発で必須となるデータベースアクセスを簡単に実装できます。</p><p>今回は、先日 aws-samples として公開された <a href="https://github.com/aws-samples/rails-lambda-handler" target="_blank" rel="noopener noreferrer">AWS Lambda handler sample for Ruby on Rails</a> を元に、Ruby on Rails で実装された Web アプリを AWS Lambda で実行し、Amazon API Gateway で公開する方法とその仕組みについて解説します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ruby-on-rails-による-rest-api-の実装">Ruby on Rails による REST API の実装<a href="#ruby-on-rails-による-rest-api-の実装" class="hash-link" aria-label="Ruby on Rails による REST API の実装 への直接リンク" title="Ruby on Rails による REST API の実装 への直接リンク">​</a></h2><p><a href="https://github.com/aws-samples/rails-lambda-handler" target="_blank" rel="noopener noreferrer">AWS Lambda handler sample for Ruby on Rails</a> では、Ruby on Rails で実装した Web アプリのサンプルを提供しています。この Web アプリは、Ruby on Rails の <a href="https://railsguides.jp/api_app.html" target="_blank" rel="noopener noreferrer">API モード</a> を利用して実装したシンプルな Web API で、「Hello, World!」という固定データのみを持つ SQLite データベースに対してクエリーを行う事ができます。</p><p>まずは、このサンプルアプリについて簡単に解説します。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="サンプル-web-アプリのモデル定義">サンプル Web アプリのモデル定義<a href="#サンプル-web-アプリのモデル定義" class="hash-link" aria-label="サンプル Web アプリのモデル定義 への直接リンク" title="サンプル Web アプリのモデル定義 への直接リンク">​</a></h3><p>モデルは以下のコマンドで生成し、テーブルを自動生成しています。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rails generate model Message text:string</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>これによって生成されたテーブル「<code>messages</code>」の定義は以下の通りです。</p><table><thead><tr><th>カラム名</th><th>型</th><th>意味</th></tr></thead><tbody><tr><td><code>id</code></td><td>integer</td><td>メッセージ ID</td></tr><tr><td><code>text</code></td><td>varchar</td><td>メッセージ</td></tr><tr><td><code>created_at</code></td><td>datetime</td><td>作成日時</td></tr><tr><td><code>updated_at</code></td><td>datetime</td><td>更新日時</td></tr></tbody></table><p>固定の SQLite データベースファイルには、以下のようなデータを格納しています。</p><table><thead><tr><th>id</th><th>text</th><th>created_at</th><th>updated_at</th></tr></thead><tbody><tr><td>1</td><td>Hello, World!</td><td>2022-12-15 01:31:59.291570</td><td>2022-12-15 01:31:59.291570</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="サンプル-web-アプリのコントローラー定義">サンプル Web アプリのコントローラー定義<a href="#サンプル-web-アプリのコントローラー定義" class="hash-link" aria-label="サンプル Web アプリのコントローラー定義 への直接リンク" title="サンプル Web アプリのコントローラー定義 への直接リンク">​</a></h3><p>コントローラーは以下のコマンドで生成しています。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rails generate controller Messages</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>生成されたコントローラー「<a href="https://github.com/aws-samples/rails-lambda-handler/blob/main/rails/app/controllers/messages_controller.rb" target="_blank" rel="noopener noreferrer"><code>MessagesController</code></a>」には、以下のアクションを実装しています。</p><table><thead><tr><th>名前</th><th>ルート</th><th>動作</th></tr></thead><tbody><tr><td><code>index</code></td><td><code>GET</code> /messages</td><td>メッセージ一覧を返す</td></tr><tr><td><code>show</code></td><td><code>GET</code> /messages/<code>{id}</code></td><td>指定された ID のメッセージを返す</td></tr></tbody></table><p>メッセージは以下のような JSON データとして返しています。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "id": 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "text": "Hello, World!",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "created_at" :"2022-12-15T01:31:59.291Z",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "updated_at": "2022-12-15T01:31:59.291Z",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "url": "メッセージの URL"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="サンプル-web-アプリの動作確認">サンプル Web アプリの動作確認<a href="#サンプル-web-アプリの動作確認" class="hash-link" aria-label="サンプル Web アプリの動作確認 への直接リンク" title="サンプル Web アプリの動作確認 への直接リンク">​</a></h3><p><a href="https://github.com/aws-samples/rails-lambda-handler" target="_blank" rel="noopener noreferrer">AWS Lambda handler sample for Ruby on Rails</a> をローカルに clone し、<code>rails</code> ディレクトリで以下のコマンドを実行する事により、ローカル環境で動作確認できます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rails server</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>cURL 等のツールで <code>http://localhost:3000/messages</code> に GET リクエストを行うと、以下のようなレスポンスが返されます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl http://localhost:3000/messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[{"id":1,"text":"Hello, World!","created_at":"2022-12-15T01:31:59.291Z","updated_at":"2022-12-15T01:31:59.291Z","url":"http://localhost:3000/messages/1"}]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ruby-on-rails-と-web-サーバーの関係">Ruby on Rails と Web サーバーの関係<a href="#ruby-on-rails-と-web-サーバーの関係" class="hash-link" aria-label="Ruby on Rails と Web サーバーの関係 への直接リンク" title="Ruby on Rails と Web サーバーの関係 への直接リンク">​</a></h2><p>Ruby on Rails において、Web サーバーへのリクエストが Web アプリで処理され、結果がレスポンスとして返されるまでの流れを簡単に解説します。</p><p><img loading="lazy" alt="Ruby on Rails と Web サーバーの関係" src="/assets/images/rails_puma-5ccb39d4d56bc628cee4ec8b58d1853f.png" width="1280" height="720" class="img_ev3q"></p><p>Ruby 言語では、Web アプリとアプリケーションサーバーとの間のインターフェイス仕様として <a href="https://rack.github.io/" target="_blank" rel="noopener noreferrer">rack</a> が広く採用されています。Ruby on Rails はこの rack に準拠しており、標準アプリケーションサーバーとして <a href="https://puma.io/" target="_blank" rel="noopener noreferrer">puma</a> が採用されています。puma は、Web サーバーが受け取った HTTP リクエストを rack 仕様に基づいて Web アプリに伝え、Web アプリが rack 仕様に基づいて生成したレスポンスを HTTP レスポンスとして Web サーバーに返します。</p><p>puma は、単体でも Web サーバーとして動作させる事が可能ではありますが、Web サーバー機能が使われるのはテスト用途が多く、本番環境ではよりパフォーマンスやスケーラビリティに優れた <a href="https://nginx.org/" target="_blank" rel="noopener noreferrer">nginx</a> 等を利用するのが一般的となっています。(前節で <code>rails server</code> を実行した際は、puma を Web サーバーとしても利用した形となります)</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aws-で-ruby-on-rails-を動かす方法">AWS で Ruby on Rails を動かす方法<a href="#aws-で-ruby-on-rails-を動かす方法" class="hash-link" aria-label="AWS で Ruby on Rails を動かす方法 への直接リンク" title="AWS で Ruby on Rails を動かす方法 への直接リンク">​</a></h2><p>Ruby on Rails で実装された Web アプリを AWS で稼働させる方法はいくつかありますが、今回は代表的な2パターンを紹介します。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="alb--ec2--ecs">ALB + EC2 / ECS<a href="#alb--ec2--ecs" class="hash-link" aria-label="ALB + EC2 / ECS への直接リンク" title="ALB + EC2 / ECS への直接リンク">​</a></h3><p>最も一般的なのは、nginx や Ruby on Rails アプリを Amazon EC2 仮想マシンにインストールしたり、Amazon ECS で Docker コンテナ化として実行し、Application Load Balancer 等のロードバランサーで公開する方法です。</p><p><img loading="lazy" alt="ALB + ECS のアーキテクチャ例" src="/assets/images/alb_architecture-8a888db1c6360af59b6423819e7eb53b.png" width="1280" height="720" class="img_ev3q"></p><p>この方法は、Ruby on Rails の標準的な構成をほぼそのままクラウドに移行できるメリットがあります。料金は稼働時間に比例するため、常に一定以上の稼働率があるサービスに向いた方法になります。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="api-gateway--lambda">API Gateway + Lambda<a href="#api-gateway--lambda" class="hash-link" aria-label="API Gateway + Lambda への直接リンク" title="API Gateway + Lambda への直接リンク">​</a></h3><p>そしてもう1つの方法が、AWS Lambda で Ruby on Rails アプリを実行し、Amazon API Gateway の Lambda プロキシ統合で公開する方法です。料金はリクエスト数に比例するため、稼働が特定の時間帯に集中するようなサービスに向いた方法になります。</p><p><img loading="lazy" alt="API Gateway + Lambda のアーキテクチャ例" src="/assets/images/apigw_architecture-39a008e8a527577f918e0c9f3e7038e6.png" width="1280" height="720" class="img_ev3q"></p><p>AWS Lambda で Ruby on Rails を実行するには、Lambda 関数の実行環境の制約に合わせていくつかの設定変更が必要となります。また、API Gateway からは HTTP リクエストが Lambda 関数のパラメーターとして渡され、Lambda 関数の戻り値から HTTP レスポンスが生成されるため、それらを Ruby on Rails が理解できる rack 仕様に変換する処理も必要となります。</p><p><img loading="lazy" alt="Ruby on Rails と API Gateway / Lambda の関係" src="/assets/images/rails_lambda-5e0576527459d58d855b0873aaf4f7e6.png" width="1280" height="720" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ruby-on-rails-を-lambda-関数化する">Ruby on Rails を Lambda 関数化する<a href="#ruby-on-rails-を-lambda-関数化する" class="hash-link" aria-label="Ruby on Rails を Lambda 関数化する への直接リンク" title="Ruby on Rails を Lambda 関数化する への直接リンク">​</a></h2><p>Ruby on Rails アプリを Lambda 関数化する方法には以下の2種類が存在します。</p><ul><li><a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-ruby.html" target="_blank" rel="noopener noreferrer">AWS Lambda の Ruby ランタイムを利用する</a></li><li><a href="https://docs.aws.amazon.com/lambda/latest/dg/ruby-image.html" target="_blank" rel="noopener noreferrer">コンテナイメージを作成する</a></li></ul><p>2022年12月現在、AWS Lambda の Ruby ランタイムが対応している Ruby 言語のバージョンは 2.7 のみのため、Ruby 3.0 以降を利用したい場合は独自のコンテナイメージを作成する必要があります。</p><p>本記事ではそれぞれの方法の詳細は割愛しますが、<a href="https://github.com/aws-samples/rails-lambda-handler/blob/main/rails/Dockerfile" target="_blank" rel="noopener noreferrer">Dockerfile のサンプル</a>を提供していますので、独自のコンテナイメージを作成する際は参考にしてみて下さい。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="環境変数の設定">環境変数の設定<a href="#環境変数の設定" class="hash-link" aria-label="環境変数の設定 への直接リンク" title="環境変数の設定 への直接リンク">​</a></h3><p>Lambda 関数を作成したら、環境変数を設定します。Ruby on Rails の一般的な環境変数に加えて、Lambda 関数の実行環境では <code>/tmp</code> 以外のディレクトリに書き込む事ができないという制限に対応するための以下の設定が必要となります。</p><table><thead><tr><th>環境変数</th><th>設定例</th><th>目的</th></tr></thead><tbody><tr><td><code>BOOTSNAP_CACHE_DIR</code></td><td><code>/tmp/cache</code></td><td>Rails アプリの起動高速化のためのキャッシュディレクトリを <code>/tmp</code> 以下に変更する</td></tr><tr><td><code>RAILS_LOG_TO_STDOUT</code></td><td><code>1</code></td><td>ログをファイルではなく標準出力に出力し、CloudWatch Logs で閲覧可能にする</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ハンドラー関数の実装">ハンドラー関数の実装<a href="#ハンドラー関数の実装" class="hash-link" aria-label="ハンドラー関数の実装 への直接リンク" title="ハンドラー関数の実装 への直接リンク">​</a></h3><p>Lambda 関数のエントリーポイントとなるのがハンドラー関数です。API Gateway からのリクエストとレスポンスを rack 仕様に変換して Ruby on Rails アプリを実行する処理は、ハンドラー関数で行う必要があります。</p><p>Amazon API Gateway には REST API と HTTP API があり、それぞれリクエストとレスポンスを Lambda 関数とやり取りするための入出力フォーマットが異なっています。それぞれの仕様へのリンクを以下に示します。</p><ul><li>REST API<ul><li><a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html#api-gateway-simple-proxy-for-lambda-input-format" target="_blank" rel="noopener noreferrer">入力フォーマット</a></li><li><a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html#api-gateway-simple-proxy-for-lambda-output-format" target="_blank" rel="noopener noreferrer">出力フォーマット</a></li></ul></li><li>HTTP API<ul><li><a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-develop-integrations-lambda.html#http-api-develop-integrations-lambda.proxy-format" target="_blank" rel="noopener noreferrer">入力フォーマット (2.0)</a></li><li><a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-develop-integrations-lambda.html#http-api-develop-integrations-lambda.v2" target="_blank" rel="noopener noreferrer">出力フォーマット (2.0)</a></li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="rack-の入出力仕様との相互変換">rack の入出力仕様との相互変換<a href="#rack-の入出力仕様との相互変換" class="hash-link" aria-label="rack の入出力仕様との相互変換 への直接リンク" title="rack の入出力仕様との相互変換 への直接リンク">​</a></h4><p><a href="https://github.com/aws-samples/rails-lambda-handler" target="_blank" rel="noopener noreferrer">AWS Lambda handler sample for Ruby on Rails</a> では、API Gateway の種類に応じて <a href="https://github.com/rack/rack/blob/main/SPEC.rdoc" target="_blank" rel="noopener noreferrer">rack の仕様</a>に基づいた変換処理を行うハンドラー関数のサンプルを提供しています。</p><ul><li><a href="https://github.com/aws-samples/rails-lambda-handler/blob/main/rails/lambda_rest.rb" target="_blank" rel="noopener noreferrer">REST API 向けハンドラー関数 (lambda_rest.handler)</a></li><li><a href="https://github.com/aws-samples/rails-lambda-handler/blob/main/rails/lambda_http.rb" target="_blank" rel="noopener noreferrer">HTTP API 向けハンドラー関数 (lambda_http.handler)</a></li></ul><p>上記のコードを Ruby on Rails アプリのルートディレクトリにコピーし、Lambda 関数のハンドラー関数として設定すれば、Ruby on Rails アプリを Lambda 関数として実行する事ができます。</p><p>ハンドラー関数が行っている変換処理の概要は以下の通りです。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="リクエスト対応表">リクエスト対応表<a href="#リクエスト対応表" class="hash-link" aria-label="リクエスト対応表 への直接リンク" title="リクエスト対応表 への直接リンク">​</a></h4><p>REST API と HTTP API の入力パラメーターは、rack の env 変数に変換されます。</p><table><thead><tr><th>rack の env 変数名</th><th>意味</th><th>REST API</th><th>HTTP API</th></tr></thead><tbody><tr><td><code>REQUEST_METHOD</code></td><td>HTTP メソッド</td><td><code>httpMethod</code></td><td><code>requestContext.http.method</code></td></tr><tr><td><code>SCRIPT_NAME</code></td><td>パスのルート</td><td>環境変数 <code>RAILS_RELATIVE_URL_ROOT</code> の値</td><td>環境変数 <code>RAILS_RELATIVE_URL_ROOT</code> の値</td></tr><tr><td><code>PATH_INFO</code></td><td>パス</td><td><code>path</code></td><td><code>requestContext.http.path</code></td></tr><tr><td><code>QUERY_STRING</code></td><td>クエリ文字列</td><td><code>multiValueQueryStringParameters</code> から再構築</td><td><code>rawQueryString</code></td></tr><tr><td><code>SERVER_NAME</code></td><td>ドメイン名</td><td><code>headers.X-Forwarded-Host</code><br>or <code>headers.Host</code></td><td><code>headers.x-forwarded-host</code><br>or <code>headers.host</code></td></tr><tr><td><code>SERVER_PORT</code></td><td>ポート</td><td><code>headers.X-Forwarded-Port</code></td><td><code>headers.x-forwarded-port</code></td></tr><tr><td><code>SERVER_PROTOCOL</code></td><td>HTTP バージョン</td><td><code>requestContext.protocol</code></td><td><code>requestContext.http.protocol</code></td></tr><tr><td><code>rack.url_scheme</code></td><td>URL スキーム</td><td><code>headers.CloudFront-Forwarded-Proto</code><br>or <code>headers.X-Forwarded-Proto</code></td><td><code>headers.cloudfront-forwarded-proto</code><br>or <code>headers.x-forwarded-proto</code></td></tr><tr><td><code>rack.input</code></td><td>HTTP ボディ</td><td><code>body</code></td><td><code>body</code></td></tr><tr><td><code>CONTENT_LENGTH</code></td><td>ボディのサイズ</td><td><code>body</code> のサイズから計算</td><td><code>body</code> のサイズから計算</td></tr><tr><td><code>HTTP_COOKIE</code></td><td>Cookie データ</td><td><code>multiValueHeaders.Cookie</code></td><td><code>cookies</code> から再構築</td></tr><tr><td><code>HTTP_*</code></td><td>その他のヘッダー</td><td><code>multiValueHeaders</code></td><td><code>headers</code></td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_LWe7" id="レスポンス対応表">レスポンス対応表<a href="#レスポンス対応表" class="hash-link" aria-label="レスポンス対応表 への直接リンク" title="レスポンス対応表 への直接リンク">​</a></h4><p>rack のレスポンスは、REST API と HTTP API の出力パラメーターに変換されます。</p><table><thead><tr><th>レスポンスの要素</th><th>REST API</th><th>HTTP API</th></tr></thead><tbody><tr><td>ステータスコード</td><td><code>statusCode</code></td><td><code>statusCode</code></td></tr><tr><td>ボディ</td><td><code>body</code></td><td><code>body</code></td></tr><tr><td>Cookie データ</td><td><code>multiValueHeaders.Set-Cookie</code></td><td><code>cookies</code></td></tr><tr><td>その他のヘッダー</td><td><code>headers</code><br>or <code>multiValueHeaders</code></td><td><code>headers</code></td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="サンプルを-aws-で動かしてみる">サンプルを AWS で動かしてみる<a href="#サンプルを-aws-で動かしてみる" class="hash-link" aria-label="サンプルを AWS で動かしてみる への直接リンク" title="サンプルを AWS で動かしてみる への直接リンク">​</a></h3><p><a href="https://github.com/aws-samples/rails-lambda-handler" target="_blank" rel="noopener noreferrer">AWS Lambda handler sample for Ruby on Rails</a> では、冒頭で解説したサンプルアプリを API Gateway + Lambda 構成でデプロイする <a href="https://aws.amazon.com/jp/getting-started/guides/setup-cdk/" target="_blank" rel="noopener noreferrer">AWS CDK</a> のサンプルも提供しています。</p><p><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB-web-%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D">サンプル Web アプリの動作確認</a>を行った後、<a href="https://aws.amazon.com/jp/getting-started/guides/setup-cdk/module-two/" target="_blank" rel="noopener noreferrer">AWS CDK のインストールと設定</a>を行った上で、<code>cdk</code> ディレクトリで以下のコマンドを実行するとデプロイが開始されます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">npm ci</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">npx cdk deploy -c railsMasterKey=d1c2ae419e40d2c43006aacdf98cf7f0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>デプロイが終わると、以下のような出力が表示されます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RailsLambdaStack.HttpHttpApiUrlE6BB121E = https://xxxx.execute-api.ap-northeast-1.amazonaws.com/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RailsLambdaStack.RestRestApiUrl2AB183B3 = https://yyyy.execute-api.ap-northeast-1.amazonaws.com/default/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>後は、ローカルで起動した時と同じように動作確認して下さい。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl https://xxxx.execute-api.ap-northeast-1.amazonaws.com/messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[{"id":1,"text":"Hello, World!","created_at":"2022-12-15T01:31:59.291Z","updated_at":"2022-12-15T01:31:59.291Z","url":"https://xxxx.execute-api.ap-northeast-1.amazonaws.com/messages/1"}]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl https://yyyy.execute-api.ap-northeast-1.amazonaws.com/default/messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[{"id":1,"text":"Hello, World!","created_at":"2022-12-15T01:31:59.291Z","updated_at":"2022-12-15T01:31:59.291Z","url":"https://yyyy.execute-api.ap-northeast-1.amazonaws.com/default/messages/1"}]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h2><p>今回は、<a href="https://github.com/aws-samples/rails-lambda-handler" target="_blank" rel="noopener noreferrer">AWS Lambda handler sample for Ruby on Rails</a> のサンプルを中心に、Amazon API Gateway + AWS Lambda 環境で Ruby on Rails の Web アプリを稼働させるのに必要な技術的要素を解説しました。ユースケース次第では選択肢になり得ると思いますので、このような事が可能である事を覚えておいて頂ければと思います。</p>]]></content:encoded>
            <category>lambda</category>
            <category>api gateway</category>
            <category>ruby on rails</category>
        </item>
        <item>
            <title><![CDATA[新規 AWS アカウントで CodeBuild を利用する際の注意点]]></title>
            <link>https://prototyping-blog.com/blog/codebuild-concurrency</link>
            <guid>https://prototyping-blog.com/blog/codebuild-concurrency</guid>
            <pubDate>Mon, 05 Dec 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[AWS のサービスには、新規作成したばかりのアカウントにはデフォルトよりも低い上限を設けているものがあります。今回は、AWS CodeBuild に適用される事がある制限をご紹介します。]]></description>
            <content:encoded><![CDATA[<p>AWS のサービスには、新規作成したばかりのアカウントにはデフォルトよりも低い上限を設けているものがあります。今回は、AWS CodeBuild に適用される事がある制限をご紹介します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aws-codebuild-とは">AWS CodeBuild とは<a href="#aws-codebuild-とは" class="hash-link" aria-label="AWS CodeBuild とは への直接リンク" title="AWS CodeBuild とは への直接リンク">​</a></h2><p><a href="https://aws.amazon.com/codebuild/" target="_blank" rel="noopener noreferrer">AWS CodeBuild</a> は、フルマネージドなソフトウェア開発環境を提供する Code シリーズのサービスの1つで、ソフトウェアのビルドやテストのフェーズを担当しています。CodeBuild を使う事で、ビルドやテストを実行するためのサーバーの構築や運用から解放され、必要な時に必要なだけのリソースを持つインフラで自動的に実行できるようになります。CodeBuild の詳しい使い方について知りたい方は、<a href="https://youtu.be/Zzv1_ztf-B0" target="_blank" rel="noopener noreferrer">Black Belt Online Seminar</a> の動画を見て頂ければと思います。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aws-codebuild-のビルド同時実行数">AWS CodeBuild のビルド同時実行数<a href="#aws-codebuild-のビルド同時実行数" class="hash-link" aria-label="AWS CodeBuild のビルド同時実行数 への直接リンク" title="AWS CodeBuild のビルド同時実行数 への直接リンク">​</a></h2><p>AWS CodeBuild では、複数のビルドを並列で実行する事ができます。例えば、依存関係のないビルドを並列で実行する事でビルドにかかる時間を大きく短縮する事ができますが、同時実行できるビルドの数にはアカウント毎に上限が設けられています。</p><p><a href="https://docs.aws.amazon.com/codebuild/latest/userguide/limits.html" target="_blank" rel="noopener noreferrer">AWS CodeBuild のクォータ</a>のページを見ると、「ビルドの同時実行」のデフォルトの上限は「60」となっていますが、下の方に以下のような注釈が書かれています。(2022年12月現在)</p><blockquote><p>同時実行ビルドの最大数のクォータは、コンピューティングタイプによって異なります。
一部のプラットフォームとコンピューティングタイプでは、デフォルトは 20 です。
新しいアカウントの場合、クォータは最低 5 になります。</p></blockquote><p>コンピューティングタイプについては、<a href="https://docs.aws.amazon.com/codebuild/latest/userguide/build-env-ref-compute-types.html" target="_blank" rel="noopener noreferrer">ビルド環境のコンピューティングタイプ</a>のページをご確認ください。詳細は非公表となっていますが、一部のコンピューティングタイプには異なる上限が設けられています。現在の上限がいくつであるかは、実際に実行してみて「<code>Cannot have more than X builds in queue for the account</code>」といったエラーが出る事でしか確認できません。</p><p>そして、今回の本題である「新規 AWS アカウントに適用される制限」についても記載されており、「新しいアカウントの場合、クォータは最低 5 になります」とありますが、本当に新規作成したばかりのアカウントの場合、制限が 5 ではなく 1 になっている場合があります。そのため、その状態では並列ビルドの機能を使う事ができず、逐次実行させる必要があるという事になります。</p><p>無料枠の範囲内でも構いませんので、AWS サービスの利用実態をある程度積む事でこの制限は解除されるようですが、新規作成した AWS アカウントで CodeBuild の並列実行を行いたい場合はご注意ください。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h2><ul><li>AWS CodeBuild のビルド同時実行数の上限は一律ではなく、条件によって異なる</li><li>新規作成したばかりの AWS アカウントでは、同時実行数の上限が 1 で並列ビルドができない場合がある</li></ul>]]></content:encoded>
            <category>codebuild</category>
        </item>
        <item>
            <title><![CDATA[JenkinsのEC2プラグインは2つある]]></title>
            <link>https://prototyping-blog.com/blog/jenkins-ec2</link>
            <guid>https://prototyping-blog.com/blog/jenkins-ec2</guid>
            <pubDate>Mon, 05 Dec 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[Jenkins、便利ですよね！ワンストップなCI/CDツールで、オンプレ時代からの愛好家も多いのではないかと思います。]]></description>
            <content:encoded><![CDATA[<p>Jenkins、便利ですよね！ワンストップなCI/CDツールで、オンプレ時代からの愛好家も多いのではないかと思います。
AWSはJenkinsととても相性が良く、最近も<a href="https://aws.amazon.com/blogs/devops/jenkins-high-availability-and-disaster-recovery-on-aws/" target="_blank" rel="noopener noreferrer">JenkinsのHA構成を実現するブログ</a>が書かれていたり、<a href="https://plugins.jenkins.io/ui/search?query=aws" target="_blank" rel="noopener noreferrer">AWS関連のプラグインも多数公開</a>されていたりします。</p><p>今日はその中でも特に、JenkinsのエージェントノードとしてEC2インスタンスを利用するためのプラグインを紹介します。実はほぼ同じ用途のものが2つあるので、比べてみましょう。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-amazon-ec2-プラグイン">1. <a href="https://plugins.jenkins.io/ec2/" target="_blank" rel="noopener noreferrer">Amazon EC2 プラグイン</a><a href="#1-amazon-ec2-プラグイン" class="hash-link" aria-label="1-amazon-ec2-プラグイン への直接リンク" title="1-amazon-ec2-プラグイン への直接リンク">​</a></h2><p><a href="https://plugins.jenkins.io/ec2/" target="_blank" rel="noopener noreferrer">Documentation</a> / <a href="https://github.com/jenkinsci/ec2-plugin" target="_blank" rel="noopener noreferrer">GitHub</a></p><p>JenkinsのMasterノードからEC2 APIを叩き、必要に応じてエージェントノードのEC2インスタンスを起動･維持･終了するプラグインです。
Jenkinsエージェントのセットアップ自体はSSH経由で自動的に行われるので、事前のAMI構築が楽になって良いですね。</p><p>より昔からあるプラグインのためユーザー数は多く、また今もしっかりとメンテナンスされているようです。こちらしか知らなかったという方もいるんではないでしょうか。</p><p>内部実装としては、ec2:RunInstance APIを直接叩いてインスタンスを起動するなど、プラグインが自身でインスタンスの管理を行う形になります。
このため、EC2の起動に必要な情報をすべてJenkinsに登録する必要があります。このために、設定項目が多めでやや煩雑な印象も受けました。</p><p>とはいえ枯れていてユーザー数も多いという点で無難な選択肢ではないかと思います。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-ec2-fleet-プラグイン">2. <a href="https://plugins.jenkins.io/ec2-fleet/" target="_blank" rel="noopener noreferrer">EC2 Fleet プラグイン</a><a href="#2-ec2-fleet-プラグイン" class="hash-link" aria-label="2-ec2-fleet-プラグイン への直接リンク" title="2-ec2-fleet-プラグイン への直接リンク">​</a></h2><p><a href="https://plugins.jenkins.io/ec2-fleet/" target="_blank" rel="noopener noreferrer">Documentation</a> / <a href="https://github.com/jenkinsci/ec2-fleet-plugin" target="_blank" rel="noopener noreferrer">GitHub</a></p><p>機能的には1と大きな違いはありません。EC2インスタンスの起動･終了やSSHによる自動設定も同様に利用可能です。</p><p>大きな違いは、ノードを管理する仕組みとしてAWSマネージドのAuto Scaling Groupを利用していることです。
これにより、プラグイン自体の実装は単純になり、またASGに慣れている人にはより理解しやすい挙動を得られるでしょう。
Allocation strategyなどASGの豊富な機能をそのまま使えるのも魅力です。
<a href="https://plugins.jenkins.io/ec2-fleet/#plugin-content-comparison-to-ec2-plugin" target="_blank" rel="noopener noreferrer">EC2プラグインとのより詳細な比較はこちらにある</a>ので、ぜひご確認ください。</p><p>元々は <code>github.com/awslabs</code> 配下の <a href="https://github.com/awslabs/ec2-spot-jenkins-plugin" target="_blank" rel="noopener noreferrer">ec2-spot-jenkins-plugin</a> というプロジェクトだったようで、AWS公式に提供されていたようです。
コミットログを見る限り、今もAWSやAmazonの開発者が関わっている様子が窺えます。</p><p>また、個人的にはEC2の起動設定 (どのAMIやインスタンスタイプを使うかなど) を、ASGやLaunch templateの設定としてAWS側で持つことができるのも良いと思いました。
これにより、AWS CDKやTerraformなど慣れたIaCツールでそれらの設定を記述することができます。
一方すべてJenkins側で管理したい方もいると思うので、ここは好みの問題かもしれません。</p><p>注意点として、まだ枯れていないせいか、ドキュメントが一部そのまま動かない点がありました。例えばGroovyスクリプトはそのままではエラーになります。
この辺りをカバーするために後ほど動作するサンプルを公開する予定ですので、そちらもぜひ合わせてご確認ください。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="私見">私見<a href="#私見" class="hash-link" aria-label="私見 への直接リンク" title="私見 への直接リンク">​</a></h2><p>2つの大きな違いは、ノードの管理にAWSマネージドなAuto Scaling Groupを使うか、プラグイン自身が管理するかという点です。</p><p>個人的には、そのような低レベルな処理はできるだけAWSに寄せたほうがプラグイン自体の開発･メンテナンスは楽になるのではと思います。
楽なものは維持されやすいので、サステイナビリティの面ではEC2 Fleetの方が良いかもしれません。(とはいえユーザー数の差は大きいので今は判断が難しいですが)</p><p>一方で、ノードの起動時間などパフォーマンスの面ではEC2プラグインが優れているかもしれません。自前で実装している分、最適化の余地がより大きいためです。
ノード起動時間にシビアな要求がある場合は、こちらに軍配が上がるかもしれません。</p><p>この比較をしていて、似たような話を思い出しました。Amazon EKSのノードのスケーリングの仕組みとして、Cluster Autoscaler(CAS) と Karpenter の2つがあるという話です。
前者はASGを利用し、後者は自前実装でEC2インスタンスを管理します。Karpenterの方が性能が良いなどの理由で、最近は<a href="https://aws.github.io/aws-eks-best-practices/karpenter/" target="_blank" rel="noopener noreferrer">CASより推奨される</a>こともあるようです。
EKSのような汎用基盤ではパフォーマンスが最重要視されるため、ノードをいち早く起動できる後者の選択肢が生まれたのでしょう。</p><p>Jenkinsプラグインの場合はCI/CD用のノードを管理することに特化しているため、ノードの起動時間は最優先ではないとも考えられます。
コミュニティが主導するOSSである都合上、プラグイン自体のメンテナンス性や開発容易性にも優先度が置かれることもあるでしょう。
このため、EC2 Fleetプラグインが後発で登場したのではないでしょうか。</p><p>JenkinsとEKSのノード管理、似たような話でありながら逆の方向に進化しているのが面白いですね。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h2><p>JenkinsのEC2プラグインを2つ紹介しました。
特にまだEC2 Fleetプラグインの知名度はやや低いようなので、ぜひこの機会にお試しください！</p>]]></content:encoded>
            <category>jenkins</category>
            <category>ec2</category>
        </item>
        <item>
            <title><![CDATA[React 環境で 3Dmol.js を使う]]></title>
            <link>https://prototyping-blog.com/blog/react-3dmol</link>
            <guid>https://prototyping-blog.com/blog/react-3dmol</guid>
            <pubDate>Fri, 02 Dec 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[3dmol.js は分子を立体表示する JavaScript ライブラリです。React 環境で動作させる場合、少しコツが必要でしたので紹介します。]]></description>
            <content:encoded><![CDATA[<p>3dmol.js は分子を立体表示する JavaScript ライブラリです。React 環境で動作させる場合、少しコツが必要でしたので紹介します。
<a href="https://3dmol.csb.pitt.edu/doc/index.html" target="_blank" rel="noopener noreferrer">https://3dmol.csb.pitt.edu/doc/index.html</a></p><p><img loading="lazy" alt="3dmol.png" src="/assets/images/3dmol-e70bc053c47dc9eafd7bf2b164956572.png" width="1152" height="842" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="react-環境で-3dmoljs-を読み込み分子データを可視化する手順">React 環境で 3Dmol.js を読み込み分子データを可視化する手順<a href="#react-環境で-3dmoljs-を読み込み分子データを可視化する手順" class="hash-link" aria-label="React 環境で 3Dmol.js を読み込み分子データを可視化する手順 への直接リンク" title="React 環境で 3Dmol.js を読み込み分子データを可視化する手順 への直接リンク">​</a></h2><p>jQuery への依存を解決するために <code>3Dmol-min.js</code> を読み込みます。jQuery を読み込んだりバンドル時に解決する方法でも構いません。</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- index.html --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">https://cdnjs.cloudflare.com/ajax/libs/3Dmol/1.4.0/3Dmol-min.js</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">integrity</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">sha384-G/ktMxNGQtSajNFY+7He9WGWTfkmMrPlEbZbCjtjWLYXpsgvuAkS8Aj8IBjs13yc</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">crossorigin</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">anonymous</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f"></span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>構造データ (pdb) のリンクを state にして、リンク取得時にレンダリングする hook を作成します。3Dmol viewer は構造データをテキストで渡すこともできますが、URL からダウンロードして表示する機能も備わっていますので、そちらを利用しています。</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// npm install 3dmol@^1.8.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// @ts-ignore</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports operator" style="color:#393A34">*</span><span class="token imports"> </span><span class="token imports keyword module" style="color:#00009f">as</span><span class="token imports"> $3Dmol</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'3dmol/build/3Dmol-nojquery.js'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Page</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> pdbViewer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pdbUrl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> setPdbUrl</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">''</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">useEffect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">render</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> viewer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> $3Dmol</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">createViewer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pdbViewer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">current</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> $3Dmol</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">download</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">url:</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">pdbUrl</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> viewer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      viewer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setStyle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> cartoon</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> color</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'spectrum'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      viewer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">render</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pdbUrl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">render</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pdbUrl</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">ref</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f">pdbViewer</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">style</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f"> height</span><span class="token tag script language-javascript operator" style="color:#393A34">:</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript number" style="color:#36acaa">500</span><span class="token tag script language-javascript punctuation" style="color:#393A34">,</span><span class="token tag script language-javascript" style="color:#00009f"> width</span><span class="token tag script language-javascript operator" style="color:#393A34">:</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript number" style="color:#36acaa">500</span><span class="token tag script language-javascript punctuation" style="color:#393A34">,</span><span class="token tag script language-javascript" style="color:#00009f"> position</span><span class="token tag script language-javascript operator" style="color:#393A34">:</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript string" style="color:#e3116c">'relative'</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="vite-rollup-を利用している場合">Vite (Rollup) を利用している場合<a href="#vite-rollup-を利用している場合" class="hash-link" aria-label="Vite (Rollup) を利用している場合 への直接リンク" title="Vite (Rollup) を利用している場合 への直接リンク">​</a></h2><p>3Dmol.js の内部で require を上書きしている箇所があり、その部分が <code>Illegal reassignment to import 'commonjsRequire'</code> と怒られてビルドに失敗します。利用していない箇所のため、下記のように rollup replace plugin でコードを書き換えてビルドすると回避できます。</p><div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> defineConfig </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'vite'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> react </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'@vitejs/plugin-react'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// npm install @rollup/plugin-replace@^5.0.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> replace </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'@rollup/plugin-replace'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">defineConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  plugins</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      preventAssignment</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      include</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'node_modules/3dmol/build/3Dmol-nojquery.js'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      values</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string-property property" style="color:#36acaa">'require = _3dmol_saved_require'</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">''</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">react</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>react</category>
        </item>
        <item>
            <title><![CDATA[CDK の NOTICES についてざっと調べてみた]]></title>
            <link>https://prototyping-blog.com/blog/cdk-notices</link>
            <guid>https://prototyping-blog.com/blog/cdk-notices</guid>
            <pubDate>Thu, 20 Oct 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[CDK NOTICES とは?]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cdk-notices-とは">CDK NOTICES とは?<a href="#cdk-notices-とは" class="hash-link" aria-label="CDK NOTICES とは? への直接リンク" title="CDK NOTICES とは? への直接リンク">​</a></h2><p><a href="https://github.com/aws/aws-cdk/tree/main/packages/aws-cdk#notices" target="_blank" rel="noopener noreferrer">ここ</a> に説明がありました。</p><blockquote><p>CDK Notices are important messages regarding security vulnerabilities, regressions, and usage of unsupported versions. Relevant notices appear on every command by default.</p></blockquote><p><code>cdk deploy</code> などのコマンドを実行すると、このようなメッセージがでます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">NOTICES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">21902   apigateway: Unable to serialize value as aws-cdk-lib.aws_apigateway.IModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Overview: Users of CDK in any language other than TS/JS cannot use</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  values that return an instance of a deprecated class.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Affected versions: framework: &gt;=2.41.0 &lt;=2.43.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        More information at: https://github.com/aws/aws-cdk/issues/21902</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">If you don’t want to see a notice anymore, use "cdk acknowledge &lt;id&gt;". For example, "cdk acknowledge 21902".</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cdk-の-notices-はいつから出るようになった">CDK の NOTICES はいつから出るようになった？<a href="#cdk-の-notices-はいつから出るようになった" class="hash-link" aria-label="CDK の NOTICES はいつから出るようになった？ への直接リンク" title="CDK の NOTICES はいつから出るようになった？ への直接リンク">​</a></h2><p><a href="https://github.com/aws/aws-cdk/releases/tag/v2.14.0" target="_blank" rel="noopener noreferrer">v2.14.0</a> に入っている<a href="https://github.com/aws/aws-cdk/pull/18936" target="_blank" rel="noopener noreferrer">こちらの対応</a> で導入されたようです。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cdk-の-notices-を消すには">CDK の NOTICES を消すには？<a href="#cdk-の-notices-を消すには" class="hash-link" aria-label="CDK の NOTICES を消すには？ への直接リンク" title="CDK の NOTICES を消すには？ への直接リンク">​</a></h2><ul><li>Affected versions に書かれている通り、CDK のバージョンをアップデートするのが正攻法です。</li><li>CDK のバージョンを都合によってアップデートできない場合、<code>cdk acknowledge &lt;id&gt;</code> で消すこともできます。</li><li>CI で実行していて不要な場合などは <code>--no-notices</code> で非表示にすることも可能です。</li><li>プロジェクト単位で NOTICES 対応が不要な場合は、cdk.json に <code>notices: false</code> を追加することで消すこともできます。</li></ul><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>ヒント</div><div class="admonitionContent_S0QG"><p>ちなみに NOTICES を明示的に表示する <code>cdk notices</code> というコマンドがあるのですが、<code>cdk notices --no-notices</code> を実行したところ、NOTICES は表示されませんでした。</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一度消した-notices-をもう一度出すためには">一度消した NOTICES をもう一度出すためには？<a href="#一度消した-notices-をもう一度出すためには" class="hash-link" aria-label="一度消した NOTICES をもう一度出すためには？ への直接リンク" title="一度消した NOTICES をもう一度出すためには？ への直接リンク">​</a></h2><p>CDK の NOTICES は <code>$HOME/.cdk/cache/notices.json</code> に状態が保存されているようです。
よって、これまで acknowledge した NOTICES は全てこちらで管理されています。
該当する項目を消すことで、筆者の手元で NOTICES がもう一度表示されることが確認できました。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="複数のプロジェクトを運用している場合は注意が必要">複数のプロジェクトを運用している場合は注意が必要<a href="#複数のプロジェクトを運用している場合は注意が必要" class="hash-link" aria-label="複数のプロジェクトを運用している場合は注意が必要 への直接リンク" title="複数のプロジェクトを運用している場合は注意が必要 への直接リンク">​</a></h2><p>CDK の NOTICES がユーザー単位で注目されていることに注意が必要です。</p><p>例えば、とあるプロジェクトには不要で、とあるプロジェクトには必要な NOTICES があった場合、不用意に <code>cdk acknowledge</code> をしてしまうと、必要なプロジェクトでも見えなくなります。
そのようなケースでは、根本原因である CDK のバージョンアップ、<code>--no-notices</code> フラグ、cdk.json の <code>notices: false</code> で対応するのが良いでしょう。</p><p>また、CDK のバージョンアップを行うと NOTICES が見えなくなりますが、実態としては自動的に <code>cdk acknowledge</code> されているようです。
つまり複数のプロジェクトに NOTICES がでていても、1 つのプロジェクトで対応すると見えなくなり、対応していないプロジェクトが放置される原因になります。
よって、CDK をアップデートする際は、同時に行うのが良いでしょう。</p>]]></content:encoded>
            <category>cdk</category>
        </item>
        <item>
            <title><![CDATA[閉域網でサーバレスなアプリケーションを開発する]]></title>
            <link>https://prototyping-blog.com/blog/closed-serverless-app</link>
            <guid>https://prototyping-blog.com/blog/closed-serverless-app</guid>
            <pubDate>Mon, 03 Oct 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[はじめに]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="はじめに">はじめに<a href="#はじめに" class="hash-link" aria-label="はじめに への直接リンク" title="はじめに への直接リンク">​</a></h2><p>昨今、DX (Digital Transformation)に代表されるように、あらゆる業界・企業において IT 技術を駆使した業務変革のニーズが高まっています。その中で社内の変化を促すにあたり、既存の社内システムと連携が必要になるケースがあるかと思います。しかしこのような変革を担う部署では、PoC を実施し素早い成果創出を求められることが多い一方で、予算確保や保守・運用に関する社内調整が煩雑になり、スピード感を持って進めることが難しいと感じたご経験を持つ方もいらっしゃると思います。本記事は上記のような悩みを持っている方の助けになることを目指して執筆致しました。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景 への直接リンク" title="背景 への直接リンク">​</a></h2><p>ゼロトラストによるセキュリティ対策が登場し久しいですが、多くのエンタープライズ企業ではまだ境界型セキュリティが主流であり、社内ネットワークと外部ネットワーク（例えばインターネットなど）の境界に、ファイアウォール等を設置しネットワークレイヤーでアクセス制限をかけているケースが多いと思います。特にプロキシを経由した社内ネットワークからインターネットへ出る outbound の通信は許可されている一方で、インターネットから社内イントラへの inboud は厳禁など、クライアントからインターネット経由でのサーバへのアクセスは許可されていないこともあるかと思います。このような制約があるため、既存の社内システム（ERP、Active Directory などの何らかの管理システム）と連携が必要なシステムを AWS 上に構築する場合、<a href="https://aws.amazon.com/jp/directconnect/" target="_blank" rel="noopener noreferrer">AWS Direct Connect</a>による閉域環境を構成した上で、EC2 や RDS などを使い開発していくケースが多いかと思います。</p><p><img loading="lazy" alt="background" src="/assets/images/background-63acea9a7e5f60fa74068f5e3dcd56dd.png" width="471" height="671" class="img_ev3q"></p><p>一方 EC2 や RDS を使った PoC では、下記のような課題が発生することがあります。</p><ul><li>料金：基本的に使用時間に基づいた課金のため、社内システムのようにアクセス量の比較的少ないシステムの場合、リクエスト数と実行時間で課金される<a href="https://aws.amazon.com/jp/lambda/" target="_blank" rel="noopener noreferrer">AWS Lambda</a>などと比較し高くつくことがあります。PoC 予算は限られている傾向にあるため、これは PJ を進める上で障害となる可能性があります。</li><li>運用・保守：EC2 は各社社内ルールの規定上、従来の物理サーバやプライベートクラウドと同様の保守・運用プロセスが求められることがあります（参考：<a href="https://aws.amazon.com/jp/compliance/shared-responsibility-model/" target="_blank" rel="noopener noreferrer">責任共有モデル</a>）。これは運用・保守人材確保のための社内調整や、人件費予算が必要となることを意味します。</li></ul><p>上記のような課題は、サーバレス構成を採用することで解決が見込める一方、閉域網でのサーバレス構成に関する情報は散逸的であり、いざ開発に取り掛かると時間がかかったり、苦労することもあるかと思います。このため、参考となるようなサンプル：<a href="https://github.com/aws-samples/serverless-application-on-closed-network" target="_blank" rel="noopener noreferrer">serverless-application-on-closed-network</a>を公開しました。下記にそのアーキテクチャを示します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="アーキテクチャ">アーキテクチャ<a href="#アーキテクチャ" class="hash-link" aria-label="アーキテクチャ への直接リンク" title="アーキテクチャ への直接リンク">​</a></h2><p><img loading="lazy" alt="arch" src="/assets/images/arch-427a357caa9bd41f4f4d97ae281690e1.png" width="968" height="491" class="img_ev3q"></p><p>フロントエンド・バックエンド・RDB からなる典型的な３層構成を想定したアーキテクチャであり、フロントエンド (html/css/js)は S3 から配信、バックエンドは API Gateway + AWS Lambda の組み合わせを想定しています。フロントエンドは静的ファイルであり、SPA (e.g. React、Vue)を想定しています。 S3 および API Gateway は VPC Endpoint によりインターネットを経由せずにアクセスが可能です。なおバックエンドを Fargate 上で稼働するサンプルも併せて公開しているため、既存のアプリケーションがコンテナで稼働している場合はそのままお使いいただけます（※Fargate は稼働時間による課金である点はご留意ください）。なお簡便のため RDB は今回のサンプルの中に含めていません。</p><p>図中左側の VPC は Transit Gateway や VPC Peering によって接続された他 VPC のほか、Direct Connect によって接続された社内のイントラネットを想定した検証用環境です。アプリケーション稼働確認用の Windows Server を立ち上げるためだけに存在していますので、他環境にて確認できる場合は不要となります。デプロイおよび確認の詳細な手順については <a href="https://github.com/aws-samples/serverless-application-on-closed-network" target="_blank" rel="noopener noreferrer">Github のリポジトリ</a>をご参照ください。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="おわりに">おわりに<a href="#おわりに" class="hash-link" aria-label="おわりに への直接リンク" title="おわりに への直接リンク">​</a></h2><p>サーバレスコンピューティングは、従来かかっていた運用負荷を下げるための良い解法の一つです。人的資源の限られる中で変革を遂げるにあたり、ぜひ閉域ネットワーク内においても AWS のサーバレスな仕組みを積極的にご活用いただければ幸いです。</p>]]></content:encoded>
            <category>dx</category>
            <category>closed</category>
            <category>serverless</category>
        </item>
        <item>
            <title><![CDATA[Amazon CloudWatch RUM で月次アクセス数を集計してみた]]></title>
            <link>https://prototyping-blog.com/blog/cloudwatch-rum-stats</link>
            <guid>https://prototyping-blog.com/blog/cloudwatch-rum-stats</guid>
            <pubDate>Fri, 16 Sep 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[概要]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a href="#概要" class="hash-link" aria-label="概要 への直接リンク" title="概要 への直接リンク">​</a></h2><p>本記事では、<a href="https://console.aws.amazon.com/cloudwatch/home#rum:dashboard?tab=overview" target="_blank" rel="noopener noreferrer">Amazon CloudWatch RUM</a> を利用した月次アクセス数の集計方法を実際のコードと合わせて紹介します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="amazon-cloudwatch-rum-とは">Amazon CloudWatch RUM とは<a href="#amazon-cloudwatch-rum-とは" class="hash-link" aria-label="Amazon CloudWatch RUM とは への直接リンク" title="Amazon CloudWatch RUM とは への直接リンク">​</a></h2><p><img loading="lazy" alt="overview" src="/assets/images/overview-df77b9364aace37c8d598cedeb14f07e.png" width="1532" height="498" class="img_ev3q"></p><p>Amazon CloudWatch RUM は、Web アプリケーションのモニタリングサービスです。簡単な JavaScript のスニペットをサイトに追加するだけで、ユーザーが使っているブラウザ、アクセス元の地域、パフォーマンスなどを取得し、可視化してくれます。利用方法は極めて簡単で、<a href="https://console.aws.amazon.com/cloudwatch/home#rum:dashboard?tab=overview" target="_blank" rel="noopener noreferrer">Amazon CloudWatch RUM</a> のページを開き、右上の「Add app monitor」をクリックしてサイト名とドメイン名を入力すれば基本的な設定は完了です。<strong>後述する集計を行う場合は「Data storage」を有効にしてログを出力するようにしてください。</strong>テスト用のローカル環境であれば、ドメインは localhost で構いません。</p><p>作成するとスニペットが出力されるので、それをサイトに追加しましょう。追加された状態でサイトにアクセスし、Amazon CloudWatch RUM の Overview をご覧ください。「Page loads」などでアクセスが確認できれば正常に設定できています。</p><p>Jekyll で構成されたサイトの場合、次のように設定すれば本番環境と開発環境でスニペットを分けることができます。</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    {% if jekyll.environment == "development" %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript comment" style="color:#999988;font-style:italic">// 開発環境のスニペット</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript keyword" style="color:#00009f">function</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript parameter">n</span><span class="token script language-javascript parameter punctuation" style="color:#393A34">,</span><span class="token script language-javascript parameter">i</span><span class="token script language-javascript parameter punctuation" style="color:#393A34">,</span><span class="token script language-javascript parameter">v</span><span class="token script language-javascript parameter punctuation" style="color:#393A34">,</span><span class="token script language-javascript parameter">r</span><span class="token script language-javascript parameter punctuation" style="color:#393A34">,</span><span class="token script language-javascript parameter">s</span><span class="token script language-javascript parameter punctuation" style="color:#393A34">,</span><span class="token script language-javascript parameter">c</span><span class="token script language-javascript parameter punctuation" style="color:#393A34">,</span><span class="token script language-javascript parameter">x</span><span class="token script language-javascript parameter punctuation" style="color:#393A34">,</span><span class="token script language-javascript parameter">z</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript comment" style="color:#999988;font-style:italic">// ...省略...</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">          </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {% else %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript comment" style="color:#999988;font-style:italic">// 本番環境のスニペット</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript keyword" style="color:#00009f">function</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript parameter">n</span><span class="token script language-javascript parameter punctuation" style="color:#393A34">,</span><span class="token script language-javascript parameter">i</span><span class="token script language-javascript parameter punctuation" style="color:#393A34">,</span><span class="token script language-javascript parameter">v</span><span class="token script language-javascript parameter punctuation" style="color:#393A34">,</span><span class="token script language-javascript parameter">r</span><span class="token script language-javascript parameter punctuation" style="color:#393A34">,</span><span class="token script language-javascript parameter">s</span><span class="token script language-javascript parameter punctuation" style="color:#393A34">,</span><span class="token script language-javascript parameter">c</span><span class="token script language-javascript parameter punctuation" style="color:#393A34">,</span><span class="token script language-javascript parameter">x</span><span class="token script language-javascript parameter punctuation" style="color:#393A34">,</span><span class="token script language-javascript parameter">z</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript comment" style="color:#999988;font-style:italic">// ...省略...</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">          </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {% endif %}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="マネージメントコンソールでの集計テスト">マネージメントコンソールでの集計テスト<a href="#マネージメントコンソールでの集計テスト" class="hash-link" aria-label="マネージメントコンソールでの集計テスト への直接リンク" title="マネージメントコンソールでの集計テスト への直接リンク">​</a></h2><p>Amazon CloudWatch RUM にはさまざまな機能があるのですが、ここではログの集計にフォーカスします。月次にそれぞれのページにどれくらいアクセスがあったか投稿する Bot を作成しましょう。まずは <a href="https://console.aws.amazon.com/cloudwatch/home#logsV2:log-groups" target="_blank" rel="noopener noreferrer">Amazon CloudWatch Logs</a> を開いて、該当の Log group を探します。Log group は <code>/aws/vendedlogs/RUMService_&lt;サイト名&gt;&lt;ランダム文字列&gt;</code> の形式になっていますので、検索ボックスから探してみてください。さまざまな Event が記録されていると思います。以下に一例を示します。(一部の項目は無効な値に置き換えています。)</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"event_timestamp"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1663290527000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"event_type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"com.amazon.rum.page_view_event"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"event_id"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"event_version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1.0.0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"log_stream"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"2022-09-15T18"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"application_id"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"application_version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1.0.0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"metadata"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1.0.0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"browserLanguage"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"en"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"browserName"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Chrome"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"browserVersion"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0.0.0.0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"osName"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Mac OS"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"osVersion"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0.0.0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"deviceType"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"desktop"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"platformType"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"web"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"domain"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"aws-samples.github.io"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"title"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Home | AWS Prototyping ブログ"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"pageId"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/jp-prototyping-blog/"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"countryCode"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"JP"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"subdivisionCode"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"13"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"user_details"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"sessionId"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"00000000-0000-0000-0000-000000000000"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"userId"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"00000000-0000-0000-0000-000000000000"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"event_details"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1.0.0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"pageId"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/jp-prototyping-blog/"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>大事な項目をピックアップします。まず、event_timestamp にはイベントを受信した Unixtime が記録されています。次に、event_type が com.amazon.rum.page_view_event なので、ページを開いたというイベントであることがわかります。集計する際には event_type が com.amazon.rum.page_view_event のものをページごとに集計すれば良いことがわかります。metadata 以下にはユーザーのさまざまな情報が記録されています。</p><p>では、<a href="https://console.aws.amazon.com/cloudwatch/home#logsV2:logs-insights" target="_blank" rel="noopener noreferrer">Amazon CloudWatch の Logs Insights</a> で集計してみようと思います。Log group に該当のものを選択し、Query を以下のように入力します。右上の集計期間内にログが存在しないと結果が正しく表示されない可能性があるため、注意してください。(不明な場合は、とりあえず最大の 4 weeks を選択してみてください。)</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">filter event_type = "com.amazon.rum.page_view_event"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| stats count(*) as pageCount by metadata.title as pageTitle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sort pageCount desc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以下のような結果が出力されましたでしょうか。Home や About、404 などの結果も入ってしまっていますが、ここでは一旦アプリケーションレベルでフィルタリングすることにします。</p><p><img loading="lazy" alt="insights" src="/assets/images/insights-3ad177989e76e2f63e3401c1db78a352.png" width="1508" height="374" class="img_ev3q"></p><p>では、この実行の流れをコードに落とし込みたいと思います。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="python-による集計">Python による集計<a href="#python-による集計" class="hash-link" aria-label="Python による集計 への直接リンク" title="Python による集計 への直接リンク">​</a></h2><p>boto3 を利用して Query を実行します。まず、クエリ探索範囲の指定に Unixtime が必要です。ここでは約 1 ヶ月ということにします。</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> datetime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">today </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">date</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">today</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">month </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> today </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">timedelta</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>これで今日と 1 ヶ月前の datetime が取得できました。あとは <code>strftime("%s")</code> によって Unixtime に変換できます。では boto3 の logs クライアントを初期化して、<code>start_query</code> を実行してみます。<code>&lt;Log group名&gt;</code> となっているところは置き換えが必要です。</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> boto3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> boto3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'logs'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">query </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">start_query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logGroupName</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">'&lt;Log group名: 例 /aws/vendedlogs/RUMService_...&gt;'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    startTime</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">month</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">strftime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%s"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    endTime</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">today</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">strftime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%s"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    queryString</span><span class="token operator" style="color:#393A34">=</span><span class="token triple-quoted-string string" style="color:#e3116c">"""filter event_type = "com.amazon.rum.page_view_event"</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    | stats count(*) as pageCount by metadata.title as pageTitle</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    | sort pageCount desc"""</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>正常に実行完了すると以下のように出力されます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{'queryId': 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', 'ResponseMetadata': ... 省略 ...}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>クエリの実行は非同期ですので、この queryId をポーリングすることにより実行結果を得ます。</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    res </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_query_results</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queryId</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'queryId'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'status'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Running'</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'status'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Scheduled'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'status'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Complete'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'status for the query was not Complete'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">res</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>結果は以下のようになっていると思います。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{'results': [[{'field': 'pageTitle', 'value': 'ページタイトル'}, {'field': 'pageCount', 'value': '104'}],... 省略 ...]], 'statistics': {'recordsMatched': 193.0, 'recordsScanned': 2034.0, 'bytesScanned': 2139385.0}, 'status': 'Complete', 'ResponseMetadata': ... 省略 ...}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>一つ一つの項目が <code>[{'field': 'field名', 'value': '値'}]</code> となっているのが少し扱いづらいので、これを <code>{ 'field名': '値' }</code> となるように変換します。</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">formatFields</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fields</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pageTitle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">lambda</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'field'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'pageTitle'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fields</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pageCount </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">lambda</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'field'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'pageCount'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fields</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">'title'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pageTitle</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'value'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">'count'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pageCount</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'value'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">formatFields</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'results'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>これで出力が <code>[{ 'title': 'ページタイトル', 'count': '閲覧数' }...]</code> のようになりました。また、Home や About などのページを対象外にします。ここでは Python レベルでフィルタリングしていますが、Amazon CloudWatch RUM の設定でページを排除することも可能ですし、Amazon CloudWatch Logs Insigts のクエリで排除することもできます。</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ページタイトルが Home, About, Archive, 404 で始まる物を対象外とする</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">filterPosts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">post</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> post</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'title'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">startswith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Home | '</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> post</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'title'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">startswith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'About | '</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> post</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'title'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">startswith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Archive | '</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> post</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'title'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">startswith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'404: '</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">filterPosts</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">formatFields</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'results'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上で各ページの 1 ヶ月の閲覧数が取得できました！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="おわりに">おわりに<a href="#おわりに" class="hash-link" aria-label="おわりに への直接リンク" title="おわりに への直接リンク">​</a></h2><p>あとはこれを Lambda 関数にして Slack に定期的に投稿するなどすれば、立派な集計 Bot の完成です！Lambda 化する場合は、十分な実行時間を確保できるタイムアウトに設定するのと、権限に注意してください。Lambda 関数から対象の CloudWatch Log Group に <code>logs:StartQuery</code> と <code>logs:GetQueryResults</code> が許可されている必要があります。</p>]]></content:encoded>
            <category>cloudwatch</category>
            <category>rum</category>
            <category>stats</category>
        </item>
        <item>
            <title><![CDATA[AWS Samples の Simple NFT Marketplace を触ってみた]]></title>
            <link>https://prototyping-blog.com/blog/simple-nft-marketplace</link>
            <guid>https://prototyping-blog.com/blog/simple-nft-marketplace</guid>
            <pubDate>Wed, 10 Aug 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[概要]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a href="#概要" class="hash-link" aria-label="概要 への直接リンク" title="概要 への直接リンク">​</a></h2><p>本記事では、<a href="https://github.com/aws-samples/simple-nft-marketplace" target="_blank" rel="noopener noreferrer">github.com/aws-samples/simple-nft-marketplace</a> というサンプルプロジェクトの動作をざっと確認してみたいと思います。Simple NFT Marketplace はその名の通り、シンプルな NFT のマーケットプレイスです。ただし、<a href="https://opensea.io/" target="_blank" rel="noopener noreferrer">OpenSea</a> のように <a href="https://metamask.io/" target="_blank" rel="noopener noreferrer">MataMask</a> と連携させた完全な非中央集権的なマーケットプレイスではなく、アカウント登録が必要で、かつ、ウォレットをシステム側で管理するマーケットプレイスです。ただ、ERC-721 の規格に則っていますので、Simple NFT Marketplace で作成した NFT を OpenSea に陳列するといったことも可能です。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="simple-nft-marketplace-の環境構築について">Simple NFT Marketplace の環境構築について<a href="#simple-nft-marketplace-の環境構築について" class="hash-link" aria-label="Simple NFT Marketplace の環境構築について への直接リンク" title="Simple NFT Marketplace の環境構築について への直接リンク">​</a></h2><p>構築方法については <a href="https://github.com/aws-samples/simple-nft-marketplace/tree/main/docs/ja" target="_blank" rel="noopener noreferrer">ドキュメント</a> をご参照ください。方法は 2 通り存在していて、1 つは deploy.js というスクリプトを利用した簡単な手順、もう一つは Step-by-Step で構築する手順です。<strong>いずれの場合も Ethereum Ropsten の Ethereum が必要です。インターネット上のサービスを活用して、事前にトークンを取得しておいてください。「Ropsten Ethereum Faucet」などで検索すると見つかります。</strong> (Ethereum Ropsten は Ethereum のテストネットです。Simple NFT Marketplace の Contract はデフォルトで Ropsten にデプロイされます。)</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="動作確認">動作確認<a href="#動作確認" class="hash-link" aria-label="動作確認 への直接リンク" title="動作確認 への直接リンク">​</a></h2><p>では構築が完了した Simple NFT Marketplace にアクセスしてみます。まず、最初にサインイン/アカウント登録画面が表示されます。</p><p><img loading="lazy" alt="web01" src="/assets/images/web01-7c681820c1597c0a5fa0e5856cd8cb5f.png" width="481" height="497" class="img_ev3q"></p><p>初回なので、アカウントを作成しましょう。</p><p><img loading="lazy" alt="web02" src="/assets/images/web02-60477f2421653ef445307dd0dd867cca.png" width="1917" height="944" class="img_ev3q"></p><p>アカウント登録が完了 or サインインが完了すると、トップページに遷移します。とてもシンプルな UI ですが、大きく 2 つの機能があることがわかります。1 つは NFT を作成する機能、もう 1 つは NFT を表示する機能です。後者の画面で NFT の売買も可能です。また、右上の Account ページでアカウント情報を確認できます。</p><p><img loading="lazy" alt="web03" src="/assets/images/web03-9cb7da35acadc14aa17aace518b99d2a.png" width="732" height="312" class="img_ev3q"></p><p>こちらがアカウントページで表示されている情報です。ユーザー名 (taichirs)、ウォレットの Public Address、Balance (残高) が表示されています。Private Key は下部の Retrieve ボタンを押下すると表示されます。この Private Key は MetaMask などの外部ウォレットに Export することも可能です。また、サインアウトもここから行います。Private Key をユーザーに渡さない用に実装を変更すれば、サービス側で完全にウォレットを管理するということになります。</p><p><img loading="lazy" alt="web04" src="/assets/images/web04-723b2beb271fdd6a31f60fe2a322b1db.png" width="1294" height="572" class="img_ev3q"></p><p>では Create NFT から最初の NFT を作成してみようと思います。Simple NFT Marketplace では、画像を NFT として登録する機能を提供しています。適当な画像をアップロードし、タイトルと説明を記入します。Royalty Percentage は、NFT の発行者に支払われるロイヤリティの設定です。例えばデフォルトの 5 %を設定した場合、NFT が売買されるたびに売買代金の 5 %が発行者に支払われます。ここで言う発行者は、売買する度に変わるオーナーとは別で、最初に NFT を作成したアカウントになります。発行者は NFT 作成後に変更できない仕様です。(変更できるように実装することも可能です。) 一通り入力したら CREATE ボタンを押下してください。暫く待つと、NFT の詳細ページに遷移します。</p><p><img loading="lazy" alt="web05" src="/assets/images/web05-4a055918880d98e89465c6fe75ca20d4.png" width="1221" height="760" class="img_ev3q"></p><p>こちらが NFT の詳細ページです。Metadata として Token ID が払い出されています。Token ID は 1 から始まり、NFT が発行されるたびにインクリメントされる仕様です。Owner は今ログイン中のアカウントの Public Address になります。続いて Marketplace の情報です。Listing が false なので、現在この NFT は陳列されてません。(= 売買することができません。) Publisher (発行者) は Owner と同じアカウントで、Royalty は 5 %で設定されています。</p><p><img loading="lazy" alt="web06" src="/assets/images/web06-787725a6e63022db7119fdb0f8e5072c.png" width="1287" height="540" class="img_ev3q"></p><p>下部にスクロールすると、Marketplace と Transfer の機能が使えます。前者は、値段を設定した上で Marketplace に NFT を陳列する機能です。後者は、売買とは別に、NFT を転送する (= Owner を変更する) 機能です。では、Marketplace の機能で、発行した NFT を陳列してみます。適当な Price を入力し、Set price ボタンを押下してください。</p><p><img loading="lazy" alt="web07" src="/assets/images/web07-cc45b1d56463325b14cdd6b8983f3d78.png" width="408" height="233" class="img_ev3q"></p><p>陳列が完了すると、Listing が true になり、Price が設定されていることが確認できます。この状態であれば、売買が可能です。</p><p><img loading="lazy" alt="web08" src="/assets/images/web08-611200421a78f5d72ca73f6fda1d906a.png" width="357" height="136" class="img_ev3q"></p><p>この状態で下部にスクロールすると、先程は値段を設定する UI だったところが、今度は陳列を取り下げる機能に変わっています。Remove を押下すると陳列を取り下げます。</p><p><img loading="lazy" alt="web09" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKUAAACTCAYAAADvCNlqAAABPmlDQ1BJQ0MgUHJvZmlsZQAAKJFjYGDiSSwoyGFhYGDIzSspCnJ3UoiIjFJgf8bAwcDFwM+gycCQmFxc4BgQ4ANUwgCjUcG3awyMIPqyLsis9ftnVfI+dOOdqrTiaFoyoxqmehTAlZJanAyk/wBxQnJBUQkDA2MMkK1cXlIAYjcA2SJFQEcB2VNA7HQIewWInQRh7wGrCQlyBrIvANkCyRmJKUD2AyBbJwlJPB2JDbUXBNjC3I1MTAk4lFRQklpRAqKd8wsqizLTM0oUHIGhk6rgmZesp6NgZGBkxMAACmuI6s83wGHIKMaBEMt2Z2Aw28bAwLQEIZYCjJHtfEDnZyLE1NMYGISsGRgOKBQkFiXCHcD4jaU4zdgIwubezsDAOu3//8/hDAzsQDP+Xv////f2////LmNgYL4F1PsNAFBnW0yA4n5UAAAAVmVYSWZNTQAqAAAACAABh2kABAAAAAEAAAAaAAAAAAADkoYABwAAABIAAABEoAIABAAAAAEAAACloAMABAAAAAEAAACTAAAAAEFTQ0lJAAAAU2NyZWVuc2hvdM8z+5AAAAHWaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA2LjAuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOmV4aWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vZXhpZi8xLjAvIj4KICAgICAgICAgPGV4aWY6UGl4ZWxZRGltZW5zaW9uPjE0NzwvZXhpZjpQaXhlbFlEaW1lbnNpb24+CiAgICAgICAgIDxleGlmOlBpeGVsWERpbWVuc2lvbj4xNjU8L2V4aWY6UGl4ZWxYRGltZW5zaW9uPgogICAgICAgICA8ZXhpZjpVc2VyQ29tbWVudD5TY3JlZW5zaG90PC9leGlmOlVzZXJDb21tZW50PgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KktaYBwAAGvVJREFUeAHtnQd0FUUXxy+EHnrvLfQiRUBF0AgKKgJ2sWBB7L1hwV4RFewdvmPBroAUFRUrooKIoFRRDBHpEHoJ8M1vYJZ5m/eSl7wkbxPmnvOys7Mzs7N3/nPn3jslRfYqEkeOAwHiQNEA1cVVxXFAc8CB0gEhcBxwoAxck7gKOVA6DASOAw6UgWsSVyEHSoeBwHHAgTJwTeIq5EDpMBA4DjhQBq5JXIUcKB0GAscBB8rANYmrkAOlw0DgOOBAGbgmcRVyoHQYCBwHHCgD1ySuQg6UDgOB44ADZeCaxFWoWG6w4O+//5Z33nlHUlNTZdq0aVKiRAk55ZRTQoouVqyYVKtWTerXqydHdusmJUuWDHleGG6++OILmTFjhvcp/fr1k9atW3v3LhAdB3IFlIDx3Xff9d64c+fOkHvvwf5A2bJlZcBZA+Tqa672PyrQ9wDS5gOAdKDMfpPGZfjevHmzvDrqVXnwwQezX2OXo9BzIFckZTgudezY0YtGcq5YsULWrl0r9j61Dz74QNLT0+Wee+6RIkWKeOld4ODmQJ6AkiFr9OjRGTi7bNkyGT58uHz33Xfes3HjxskRRxwhvXv39uJc4ODmQL4O3/WUkfP000/LIYccEsL1jz76KOTe3RzcHMgTSZkZSxmmL7/8crnyyiu9ZPPnzffCBB5++GHZvXu3jitXrpxcf/31Ic/NzYYNG+SZZ54xt1K3bl256KKLvPsPP/xQ5s2b593zrHLlyvL888/L9OnTZdOmTXLXXXdJ9+7dvTQEtm7dKkjw77//XlatXCkbVbqKFStK/fr1tUTvcUwPSSiWEJIns5ulS5fKm2++KXPnzpX169dLpUqVpE2bNnLeeedJo0aNMsuqn/3www8676JFi+TPP//UnotmzZpJixYt5LDDDpOmTZtmWsaePXvkyy+/lN9//10WL14s1Kdq1ao6f8uWLfX3c58V/fLLL4IAIf+a1WukbLmyUqNGDTnqqKOkf//+Urp06ayKiOp5voOSWsFQmzZu2ijbtm3zPgpdE0ZCVapUiQhKQAXwDKE22KAEVF999ZV5LH369JEnn3xScN0YAiQ2TZo0SR566CENTDt+1apVAijIi778jJL4icqLkBUtWLBA14nvM0RZCxcuFN710ksvSbt27cyjkCt57r77bvn8889D4rmhLhMnThRcbTfeeKOcc845GdIQwffdcsstMnPmzJDny5cvlzlz5ug4ePz4449Lhw4dQtKYGzo/75g1a5aJ0teVq1bKkiVLhE7z3HPPyQMPPCDJyckhaXJyk6/Dt6lgvIwamGoD0tTHXEeNGiVDhw7NAEjz3FwpZ+D558tKJUUzIwy7a6+9Vne4cOm2b9+un//zzz8ZHpP37LPPDgtIOzGGIno6gPATOvyZZ56ZAZB+/vOuyy67LOy71qxZo+vhB6T/XQgIgMsIEyvFRVLSy20qX668JyXt+NwOAzoI3Zbhs2jRotqhT9zcOXPlhRdeIOhR7dq1dc9Hgvz777/aB/nff//p53/99ZfcfPPN8sYbb3jp/QHKw/PQvHlzOfzww6VUqVLauW43cFpamnaNvfLKKyHZx44dq4dJE0ldevTooYdrpNPUqVM9SUcaRowTTzxRDj30UJNFf8/q1au9+06dOuk6ozKg1nz22Wd60oME1PPVV1+V4447zktPALCbb+a+Tp06ctJJJ0mXLl00T7799luvozO60UE6d+6s05E+J5TvoMQlxJBlU6vWrezbPAszHN5+++1y1llnZXjHEyOe0O4p86BJUpKMeeutkJknpE7fvn21a4t06Gg0WK1atUy2kCsNjbS79dZbvfgrrrhCnn3mWe2nNZHz58/XrjJbgjG0G0pMTBQ6lHkPOvCFF14oF1xwgfz2228mmQaHDcpff/3Ve8Yw/8QTT0iFChV0HB2NH9KUWTgIlYKJEHRzaMbPM+Sbb77RYf6gd+JVQY+EeBezVtgA7733no5DH6eD3Xvvvfo+J3/yFZT4Kh999FGZPXt2SF1PO+20kPu8uunVq1dYQDIMG/2KdyPRHlcN6J8KLVOmjDbS0DkhOtjkyZPl4osv1vf+PxggQ4YM8UcLwJw0eZIngZhMwHgwRs+OHTvk5JNP9vIhaQ0gvUgVgG82KG2JRjqjl5s8NuhNHJ0U3duQMTC5p4423XnnnR4g7fjbbrtNu/nM+9Hj0YUZiXJCeQLKP/74Q+sopkK7du3SDYCCb380z0899dQMQ4bJl9vX9u3bhy2SRrEbEKu2YcOGYdMChOpqDt8cVVe9evWw6YjEIAoHBCz3tm3beqAkLZa5ASWdASmYFSUpaW4TktkmDKgpU6boKHRPOs+VqkN0U5K2ePHiOh6pOGDAADubF/7pp5+8MN9hS2HvgQoAPnhmQIlKgpVPZ8oJ5QkoqYj9QZEqxnB4xx13RHqc6/FNmzQNWyadxSZ/Y9vPaICjo7QwM2uUmjVr2sVGNK42btyopSFDMcMrlvCWLVsE6YoRkhmxKObrr7/W+iLpAMoNyhgB9HhA6Bi4c3Arhes8GECGGBX6nNjH3Ga44kGxCZ5m9v12Wn84z0Dpf5F9j+8RXcv2VdrP8yocybfob1wjsWKtB3pcJMpqaENyP/XUU9qQsqV4pPLCxTNT9pgyPIYonRaVwBBhJDO/t5TezOotZtTwFLDCC0La+SWvH3imvHDXdevWhYuOKi4y16LKHjmR35gwS9caKAd01yOPzKCvRS4p759gSNgUC0PtcnIaBjR0WJzVNgEYhltWWfFDR8cLkBkh1fFz4tPkh9/UD3IsdJz7eEWYjECShnOE+ycZ7PfCM/ydhvwjgYmP5ponoMSJjQKdG4QuFInSNqRFepSteP9sBi6XeBJuFhuQGDlIsaOPPlowtgyhu5977rnmNuK1fPny2rmOg32LGvZ/VYYmy+w++eQTsVWXn3/+WbuWSEcHwFVnpCPGH5I7KwkfsRLZeJAz8ygbL8hJUoZ3Qwwj9myIiee6cNFC+zbH4ZYtWobkRWL4pYlJwILmE044wfsxl5/bZC9YoexLL71Uv88GJPG4krJLzEJ1U4usb7jhBvn000+1S8cuw7bmGzZq6D3C0Z9fnTWQoPQryDiS/bQ7fbe8/vrr/ugc3Xfq3En74ExmrEh7Tt3Ec2U6jufmhxM5twnfoU3hhkIMD5zfkQjDCIe9+V133XUZkiL1+p7UNyQeQ8rQsccea4L6+vLLL4fc2zdIcvOuo7ofJRhoOaVAgpJFAjY9++yzwnw4U1m4l5h9ueDCCyTc9JydL9owlucZZ5wRkvy1117TjmIzlch7cQobRzOJMRCwXHObDu14YFaGspkZsmdmGD1YpGJvvfDXAcc49UPC8cMJjk/VJjr22HGhHd5e3MFEAUO/IXRTHOW2Vc4oxqwPKod5V5fDuoTkM/mjveaJThntyyOlS05O1oq38WkyS8AqdX4YTEbPxJe4VDmdc4MuueQS+Vq5T8yQyPDN0IzEZAYDRd62RpEyDKvhXCmx1ufIbkeGzPjg2Mfxn9S4saSr1VMpKSlavcjq+1m5Q4c2hPttxIgReiYHScu3Mn1qCL1x4MCB5lavZsIxbrvtmLl5//33hXcnKB6kKKlu84XVVEjNWCiQkpJezsKIcA1uAMkStFimsvxMA2Q0oH/FDo2HlWsznsZjZsovXf1l5vSe76dh7e+nHn8qA4xOSIcBFEPvGJrpKwYNGiSDLx4cYpzg/kLisTDFBiTL8hgdzBSiKZj5dGaljLOdeOqCbk19bL4whckUKmXFQoEEJR/ETA+9lOEkISHB+0YaqmfPnnohge2C8BLEEKC80aNG69Uu4XyVAJdZmldefiXPZ6EA1H333ae/3/Z3YhVjcY9RLpwyiQcs8XCfTX3ZnMeyMhZW2wYk6XmOi4lZKja8+XV5UybW+P9G/0/QMY0f0zzjipXOksHJar6+Tds29qMchYso1JsZsxwVkB+ZGL6ZL8efCEj9Vmhe1QEJiTRhTSKARTqxQDe/Cb8lq3rQ7+gsgCmnhI6Md4GyACFSPztEW6A+wJvEMonSqHGjECMxO2VFSlsgQBmp8i6+cHIg512ucPLDfVUAOOBAGYBGcFUI5YADZSg/3F0AOOBAGYBGcFUI5YADZSg/3F0AOOBAGYBGcFUI5YADZSg/3F0AOOBAGYBGcFUI5YADZSg/3F0AOOBAGYBGcFUI5YADZSg/3F0AOBB3ULI41N4MHw+esLjA3u0XTR2iycNaF1aRZ7XmxeyLj+a9B0OamBf5sjD2/vvvD+EVG/RZl3jtNddkeTIZx5GwHIp9I/lNbNR/++239Qp26sCytJtuuilkV56/TtHm4WiaL9S6xbVqcTDrDJOTkzOskWQlPdsrWEHOqm3O6Tn99NP1sXr2ewHtyJEj9Z4ajlFkv3w4CtcWJh3bbTnZg12S7GiMRNSV7SemLBb1+jfWkZfDrODZsGHDIhWV4/iYQWnezNpHlnchcfggJCDn0nD0nr1A1KQ3VxbWFlVrJPOb2JgPINg2+sgjj+itqjQ8q9u5hqNo83DYFOsTBw8erA+d4hgT1jSyXMw+qvCxxx7Tx8WwiJYdoOw5YrU7i2RZ6AshkTkChT0v9qLfcPUzcawU96+dZFE0dPXVV+ttJYRZTU8dOJfIrKUMt16StPlJuQZKpIzpUV27dpWJEybICNW4HAJlGBzuw/zMC5cmL+LY88NaQk5OY48zm7NYa8j2B9Yb+s/QpA7R5gGUHBFjzozkpArWg3788cdy/sDz9YGrgI39Pmw/QIpCrDb/8ccf9XYDwzMkGwtxAU+0Zy7xbtMWumDrT6tWrbw7hAbEGtW82GvkvSibgTzTKdkEz4ppQAnRUGx24vBO9sOwshzi6Dj2ExtiqHrxxRf1uTec6MUwYZ/GSzp2EprtCEge0pPPEHubOak3M12OIYyj9exN9xyqykZ89lOHo2jysKkLwNkHVFEWwORZ6r/7gDBv/ztsoDGisP2A41kMHakObhg5YqRWAZCU0UpLk78gXvMMlOzdABRmOKBBOBoZScQ5ieakMnbp2bvj0FHYdYe0ZfhjPwrANHuO2T3H8MRQyraAY445RutabIgy9JoaBtnjg9QJR9QL4Pj3klBX9GH/FlfKiDZPyj8p+pX+slm1Dpmylykphf7mHyk4O5OV7qzwhtBxzXEz1IFfYadcG779jOJ8RXYj2ofuw2iGIf8WWpOXw0TRv9iyiYSA2PjPnmXO7ObgKf6zGfoV5yTSqBD6ECdyYCSQhpMkAHuk93AqBJLVv0mKstiWytHLfoo2j5GE/r3a7PID9GbIZJtFuCHWHPkHeI2e569LVvdsgzXCwKRFUudkiMY48pdFmRwXw0lreUG5BkpOgUWZ3qUk5E/q+A+Yf/zxx4cAAxBFAgofx5ZPJIcBJHEMaRycb4ihlQZHYpqTM9C5IIY9QInRwC8SmR149oYsk5Y4WxUw8dHmIR1DrL3ZzZRB2aYc3hHOADR12rXzgDpi8kd7ZQ+TH0jh3hVNeeHKIl+474umvGjS5BooOfoPaQAxdNEz/XpVVoxhQ5KRFJEqb45mNkaEnS7awwlq16qt9V1z0IBdBhLWNgbMs2jz0EEYYpGsuHgMMUrwq7e/A/HM6NsmDVdTp3r169nR2Qqju4eTwtkqZH9ijncJVxYqVV5RroGS0yPCVT47FUcCzvKdNObPjwRk2OU/HvipWEJ0n4OORl3RK20CTIASvc5P0eYxuuTyf5eHgNIM23X3lw14OSLFLzFRHThRzagm/nocDPd5ZujkhHm4YXA2G6PGlIGDHRcT1KRJE23kIHWxlM1v0cJFsiHtwDk4Jm+kK2oEm/LtoZoN+hxIGmnojyYPOimA/3jCxyGvHj9+vFZNDGiNNCbeEJ2Ck9Byqkuacgr6NVCg5L8K0PBswkcdYDhHAo8ZM0aq7T/GGZUA6xQFHB2SNFje+BsBFMTBT5yPyWkSkYhzx9FJyYt05H0YT/x3BANKnuG+4swdKJo8pGP45H/L4NfEKMPoowOQn04EAc6T1bEqzCgxzYoHAs8E0jvWY0/wifI99g9vRUGh6Ma7fPoalHMsR9xCTF0CGjb/4xYxlmODBg00aJnGY3YCCx/97P4H7vdcPEzf8WPqLhIhzQAyQATAxYsVl46HdpSrrrrKy8LwiisrfXe6dstEk4fMuLPQeelMGGkMx/369tOGn1e4CgxWgF+pdE9mkTCAUF8AdDj1wc6XVRge+slMM/rjg3gf2MMIkE4c2JnZiRQYDpwtZJ8MZpiMfzPakySQqNUUSMP9B7FI5WSWx9SB4RgJldQ4yfM1mmf2lc7HhEBjdYCVI5HAgtI1zsHLgUDplAdvM7gvtzngQGlzw4UDwQEHykA0g6uEzQEHSpsbLhwIDjhQBqIZXCVsDjhQ2txw4UBwwIEyEM3gKmFzwIHS5oYLB4IDDpSBaAZXCZsDDpQ2N1w4EBxwoAxEM7hK2BxwoLS54cKB4IADZSCawVXC5oADpc0NFw4EBxwoA9EMrhI2BxwobW64cCA44EAZiGZwlbA54EBpc8OFA8EBB8pANIOrhM0BB0qbGy4cCA44UAaiGVwlbA44UNrccOFAcMCBMhDN4Cphc8CB0uaGCweCAw6UgWgGVwmbAw6UNjdcOBAcyJUDrr7fuk6G/DdfpqetFNmz74SyQHzdwVKJoglyRIUaMrxWS+lWZt+/JinInx7zWUIAsvuCrx0Yg4ACBc7vWiQXeGDGPHwjIZ10DAIiVR3UKKXbIyDVyWk1YgalHrJz+naXL9c5UBjaI2ZQOimZ67iKrcBCoNPHDsrYWOhyOw5k4IADZQaWuIh4c8CBMt4t4N6fgQMOlBlY4iLizQEHyni3gHt/Bg44UGZgiYuINwccKOPdAu79GTjgQJmBJS4i3hxwoDQtkFBcTqvWSKRYCRPjrnHiQK6sEoq17l0r1pZpTfb903lT1oIdW2TSxpVyc+pvov45oonOu2vxUvJBg05SY8sGWZW+M+/e40rOkgOBAKWpZc+/pkvqzu2SmJAgAyvWlUurNJC2pcpJ70XfiuzdY5K5ayHnQKBAOXXjapH0HZrlv6q1mVM3r5EJjbpIUmIlWbJ5bSFvCvd5hgOB1iknblguO5SEPDqxiq7vZTVbyOikw03d912LFJXZbXpL23LV9f3pSi8c3+woaVGumnzbqqcsa9fXS9+vakP9bG37/vJFyx5yfJX63jMTqKDWJD6vOsLydv1kRutecna1JPNo37V0eXm/aTdZ0aGfLD6kjzzdsLNIUatvFykit9RpLXPaHC9r1HsmqLpULFMxpIymZavq76CMic2OFurl6AAHAg1KUYArKkUUMPetZq9VvKQ0LVn2QO0JKRC0K1VeKqh/jQxVTyipFrlWkjH1O8jYtBVyWeocHd9XqQLjFIDmbt8kA1JmyW9b02Ryo8MyAOKtBh0lZddWGZQ6W5bu3Crcd6pYU5chyhha17yHlFD1uiBltjy2+k/pW76GvGt1lDvrtJXrqzaWW/6bJ73+/lHW70mXlBY9hLyaFKhnNOumg+f/86tMV4ukxzbsJMdWrrfvufsrVhcPHjcGV2koxRXoPsvm0F1ZWdDNF30ja7Zu2PdRCkTvqoa/Y8V8GZb6u477fN0y2ayWeV2kwPDxmqXex3+Qtlwe3Z/m07XLZHX7ftKvXE2ZuWGFtswB6ziV1yzZ26yMsFH12qvOofq3kupnKqPtubVL5bO1KbrM8zetkf4Ajk6ze5eMq9dOPldxg5b8qJ9PUWVtU/neqNdBalGuo2CBcrga9v7dtV1KFy0qZ1aoLR1KV5Bhq5YcAFeUDbZcleEBUuWprKRTaQWaYfuBYoq5Z9lsE/Suk9JWeWGFMvl082ppWWq/dFYegXHqpwnJp8BfXJVbCkAWKymya5v8riTxFaozzVQdYoqS1ABxvAX6PuVqyBDVOaR4ae89s7alSU01Cug4VcbBToGSlOdWrCOp6dt1m8zevlEeWLlIxloNGm1jbVX/gN6mTsqC17R9sx0dNrxKgcimtPRdUrZEKS/qmtot5aoqjaR5yUQvzg6cs3SmjG7QQRtoxZSU/0QZb3evXCCz2FSngEjciFqt9M/OR/iQMuVkTpoDZaBAWeePKZ717W8w7veqXwnVqCGElMqCFindUFOJMiI7sgZmpOLOrZ6kwNRazvrnF/kIKag8BS3LVpF5zZMPZFFxDM2DlCTtqoyt26o3kRlNu0vSgq9k6Zb1kr53r/RfOkMmhxuq1TNHym4sSExYtnObtFdGjSgL2VBjNTRnRUvVULpHQXpA+X0Wuknfo3JdubVuG3Ob5bWnAhluqo/W/K2HanTIw5VR5ZHqIJWxtBnalcT9QXkP+i3+XjYpY+fYxKpa5/xp2wbpjjdB5fV+Kl8DylFqi6MCBsppylLF8n2o7iEiakium1hZnlfWbpakDJq7ViyUl5VB0gujQw29WLvjG3aRndmQTr8o3S9ZScYuWONKh+ypyri7RrMDr1dlTU/qKhOSjtD1o/P0VWkqFC0uU5RuCg39b4EMqd5YBpFPeRKqKhBPaNJVJjZSriWA6ihYhk5W7bFQWa3XLv9dHqjZXO5Qw2KKkpynpcyU3kqCZUUPp86VBAXol+q2k4YlSst6pSsOX71ERi6fl1VW7/lzKxZLZ2V8TUvqpnXDqVvWyqVqGnRKY+M73Sudl0yTScr1tEf5KVE0lqo6nvj3T5KyZZ0u55v1qXr4H6pAOUpZ4gzY4zeukLaLv1OgdMM3TIr5MIIiM9/XzM7fP6q51Vy1KCtbtWT2X42lvH/mKPuZVQ7UB36ZzZFHk4bFH+w+zOUdiHs7nZGjzwpKpkAZOtEzRQExFtdJLICkktEAKZo0mYE6emYUupROsy50TVrwP8iBsuC3YaH7AgfKQtekBf+DHCgLfhsWui9woCx0TVrwP8iBsuC3YaH7AgfKQtekBf+DHCgLfhsWui+IHZTMXDgKDgcKQXvEDEoOgHcUHA4UhvaIGZT8RwJ7KVlwmucgrImSkro9CvinxwxK/kUG/5HgiEq1HTjjBQYFRvhfGP4zBCyMeZVQvNrBvbfwciBmSVl4WeO+LF4ccKCMF+fdeyNywIEyImvcg3hxwIEyXpx3743IAQfKiKxxD+LFAQfKeHHevTciBxwoI7LGPYgXBxwo48V5996IHHCgjMga9yBeHHCgjBfn3XsjcsCBMiJr3IN4ceD/pJ7EwkHjJqQAAAAASUVORK5CYII=" width="165" height="147" class="img_ev3q"></p><p>では、NFT を購入してみます。別のアカウントでログインし、先程発行した NFT の詳細ページを開きます。下部にスクロールすると、Purchase という機能が表示されていると思います。Price を確認して、Purchase ボタンを押下してください。購入が完了すると、自動でページがリロードされます。なお、購入するアカウントの Balance が NFT の値段よりも多いことを事前に確認してください。</p><p><img loading="lazy" alt="web10" src="/assets/images/web10-03e9eb81aabb839ce23cd25881a02e59.png" width="412" height="494" class="img_ev3q"></p><p>こちらが購入後の NFT の詳細ページの情報です。ご覧の通り、Owner のアドレスが変更されました。購入直後は陳列から外されるため、Marketplace の Listing は false になります。また前述したとおり、Publisher は変わっていないことを確認してください。</p><p>以上で売買を含む Simple NFT Marketplace の機能の紹介は終了です！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="おわりに">おわりに<a href="#おわりに" class="hash-link" aria-label="おわりに への直接リンク" title="おわりに への直接リンク">​</a></h2><p>Simple NFT Marketplace では秘密鍵を DynamoDB で管理しています。AWS KMS を利用すると、システムの運用者ですら秘密鍵を取り出すことができなくなり、よりセキュアです。方法は以下をご参照ください。</p><ul><li><a href="https://aws.amazon.com/jp/blogs/database/how-to-sign-ethereum-eip-1559-transactions-using-aws-kms/" target="_blank" rel="noopener noreferrer">How to sign Ethereum EIP-1559 transactions using AWS KMS</a></li></ul>]]></content:encoded>
            <category>nft</category>
            <category>blockchain</category>
            <category>ethereum</category>
        </item>
        <item>
            <title><![CDATA[AWS CDK で静的サイトをデプロイする (CloudFront + S3 + CF2)]]></title>
            <link>https://prototyping-blog.com/blog/cdk-static-website</link>
            <guid>https://prototyping-blog.com/blog/cdk-static-website</guid>
            <pubDate>Thu, 04 Aug 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[はじめに]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="はじめに">はじめに<a href="#はじめに" class="hash-link" aria-label="はじめに への直接リンク" title="はじめに への直接リンク">​</a></h2><p>静的 Web サイトを AWS CDK を使い、CloudFront + S3 の構成でデプロイ方法について説明します。この組み合わせは定番なのでいろいろな所で紹介されていますが、
情報が古くなってしまっているものもあるため2022年8月の時点で良さそうだと思った作り方を紹介します。</p><p>CDK アプリのソースコード全体は <a href="https://github.com/kudtomoy/aws-cdk-samples/tree/main/static-website" target="_blank" rel="noopener noreferrer">GitHub</a> で公開しています。この記事では、今回の CDK アプリの書き方のポイントや理由について説明していきます。</p><p>使用した Node.js と CDK のバージョンは以下になります:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> --version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">v16.14.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cdk --version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2.28</span><span class="token plain">.1 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">build d035432</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ホストゾーンと証明書の情報を-parameter-store-から取得する">ホストゾーンと証明書の情報を Parameter Store から取得する<a href="#ホストゾーンと証明書の情報を-parameter-store-から取得する" class="hash-link" aria-label="ホストゾーンと証明書の情報を Parameter Store から取得する への直接リンク" title="ホストゾーンと証明書の情報を Parameter Store から取得する への直接リンク">​</a></h2><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> recordName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ssm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringParameter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">valueFromLookup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">'/static-website/record-name'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> domainName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ssm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringParameter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">valueFromLookup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">'/static-website/domain-name'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> certificateArn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ssm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringParameter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">valueFromLookup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">'/static-website/certificate-arn'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>AWS マネジメントコンソール上で Amazon Route53 のホストゾーンと AWS Certificate Manager (ACM) の証明書をあらかじめ作成しておき、それらの情報を AWS Systems Manager の Parameter Store に保存して、テンプレート生成時に読み込んでいます。</p><p>今回 CDK でホストゾーンや証明書を管理しなかった理由は以下です:</p><ul><li>ドメインの取得や移管には手作業が発生するし、何度も繰り返す作業ではない</li><li>Amazon CloudFront で ACM の証明書を使用するには証明書が <code>us-east-1</code> リージョンで発行されている必要があり、クロススタック参照になって手間が増える</li></ul><p>ACM も CDK で管理したい場合は <a href="https://dev.classmethod.jp/articles/cdk-remote-stack-for-acm-and-cloudfront/" target="_blank" rel="noopener noreferrer">AWS CDK（cdk-remote-stack）でACMとCloudFrontのクロスリージョン参照を実装する</a> の記事が参考になると思います。</p><p>また ARN 等をソースコードに書きたくなかったので Parameter Store を利用しましたが、ここはお好みでベタ書きしたり、CDK の Context を利用するなどしても良いと思います。Parameter Store を利用する場合は AWS CLI で以下のように値を保存します。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aws ssm put-parameter --type </span><span class="token string" style="color:#e3116c">'String'</span><span class="token plain"> --name </span><span class="token string" style="color:#e3116c">'/static-website/record-name'</span><span class="token plain"> --value </span><span class="token string" style="color:#e3116c">'sample.com'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws ssm put-parameter --type </span><span class="token string" style="color:#e3116c">'String'</span><span class="token plain"> --name </span><span class="token string" style="color:#e3116c">'/static-website/domain-name'</span><span class="token plain"> --value </span><span class="token string" style="color:#e3116c">'sample.com'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws ssm put-parameter --type </span><span class="token string" style="color:#e3116c">'String'</span><span class="token plain"> --name </span><span class="token string" style="color:#e3116c">'/static-website/certificate-arn'</span><span class="token plain"> --value </span><span class="token string" style="color:#e3116c">'arn:aws:acm:us-east-1:xxxx:certificate/xxxx'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="s3-origin--origin-access-identity-を使用する">S3 Origin + Origin Access Identity を使用する<a href="#s3-origin--origin-access-identity-を使用する" class="hash-link" aria-label="S3 Origin + Origin Access Identity を使用する への直接リンク" title="S3 Origin + Origin Access Identity を使用する への直接リンク">​</a></h2><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> bucket </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">s3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Bucket</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Bucket'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      autoDeleteObjects</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      removalPolicy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RemovalPolicy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">DESTROY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> originAccessIdentity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">cloudfront</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">OriginAccessIdentity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">'OriginAccessIdentity'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> bucketPolicyStatement </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">iam</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">PolicyStatement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      actions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'s3:GetObject'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      effect</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> iam</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Effect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">ALLOW</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      principals</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">iam</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CanonicalUserPrincipal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          originAccessIdentity</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloudFrontOriginAccessIdentityS3CanonicalUserId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      resources</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">bucket</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">bucketArn</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">/*</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bucket</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addToResourcePolicy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bucketPolicyStatement</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>CloudFront 経由 で Amazon S3 のデータを配信する方法は2種類あります:</p><ol><li>CloudFront のオリジンに S3 バケットそのものを指定する</li><li>CloudFront のオリジンに S3 バケットの Static website hosting のエンドポイントを指定する</li></ol><p>今回は S3 に直接アクセスされたくなかったので Static website hosting を有効にせず、Origin Access Identity(OAI) を作成して CloudFront からのみアクセスできる1の構成にしました。</p><p>この場合、デフォルトルートオブジェクトのファイル名 (<code>index.html</code>) をディストリビューションで指定しているオリジンのルートにしか設定できません。たとえば <code>https://sample.com/posts/</code> にアクセスすると <code>https://sample.com/posts/index.html</code> は表示されずに403エラーになります。この問題は次の CloudFront Functions で解決します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cloudfront-functions-でファイル名を含まない-url-に対応する">CloudFront Functions でファイル名を含まない URL に対応する<a href="#cloudfront-functions-でファイル名を含まない-url-に対応する" class="hash-link" aria-label="CloudFront Functions でファイル名を含まない URL に対応する への直接リンク" title="CloudFront Functions でファイル名を含まない URL に対応する への直接リンク">​</a></h2><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> rewriteUrlFunction </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">cloudfront</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">'RewriteUrlFunction'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        functionName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'rewrite-url'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        code</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cloudfront</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FunctionCode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fromFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          filePath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'functions/rewrite-url/index.js'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>functions/rewrite-url/index.js</code> は <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/example-function-add-index.html" target="_blank" rel="noopener noreferrer">公式ドキュメント</a> のコードをそのまま使用しています:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> request </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">request</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> uri </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">uri</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Check whether the URI is missing a file name.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uri</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">endsWith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'/'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">uri</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'index.html'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Check whether the URI is missing a file extension.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">uri</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">includes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'.'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">uri</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/index.html'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ファイル名を含まない URL でアクセスされた時に <code>index.html</code> を返せるように CloudFront Functions (CF2) を設定します。CF2 は GA が比較的最近 (2021年5月) だったこともあり、同じことを Lambda@Edge でやっている例がよく紹介されています。 1回あたりの呼び出しは CF2 の方が安くレイテンシも小さいですが、Lambda@Edge は CloudFront のキャッシュにヒットしなかった場合のみ実行できるという利点があり、このあたりの選択はお好みだと思います。</p><p>Lambda@Edge を利用する場合は Lambda を <code>us-east-1</code> にデプロイする必要があり、CDK でやろうとするとクロススタック参照をする必要があります。この場合は Experimental ではありますが <a href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_cloudfront.experimental.EdgeFunction.html" target="_blank" rel="noopener noreferrer">EdgeFunction</a> を使うとかんたんに書くことができます。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cloudfrontwebdistribution-ではなく-distribution-api-を使用する">CloudFrontWebDistribution ではなく Distribution API を使用する<a href="#cloudfrontwebdistribution-ではなく-distribution-api-を使用する" class="hash-link" aria-label="CloudFrontWebDistribution ではなく Distribution API を使用する への直接リンク" title="CloudFrontWebDistribution ではなく Distribution API を使用する への直接リンク">​</a></h2><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> distribution </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">cloudfront</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Distribution</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Distribution'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      defaultRootObject</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'index.html'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      defaultBehavior</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        allowedMethods</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cloudfront</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AllowedMethods</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">ALLOW_GET_HEAD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cachedMethods</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cloudfront</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CachedMethods</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">CACHE_GET_HEAD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cachePolicy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cloudfront</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CachePolicy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">CACHING_OPTIMIZED</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        viewerProtocolPolicy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cloudfront</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ViewerProtocolPolicy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">REDIRECT_TO_HTTPS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        origin</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">cloudfrontOrigins</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">S3Origin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bucket</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          originAccessIdentity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        functionAssociations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventType</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cloudfront</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FunctionEventType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">VIEWER_REQUEST</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">function</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> rewriteUrlFunction</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      priceClass</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cloudfront</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PriceClass</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">PRICE_CLASS_200</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      certificate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> acm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Certificate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fromCertificateArn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">'Certificate'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Lazy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">produce</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> certificateArn </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      domainNames</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">recordName</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      minimumProtocolVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cloudfront</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SecurityPolicyProtocol</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">TLS_V1_2_2021</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>CDK で CloudFront の Distribution を作成する高レベル Constructs は <code>CloudFrontWebDistribution</code> と <code>Distribution</code> の2つが用意されていますが、<code>Distribution</code> の方が新しく、<a href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_cloudfront-readme.html" target="_blank" rel="noopener noreferrer">ドキュメント</a>でもこちらの使用が推奨されています。</p><blockquote><p>The CloudFrontWebDistribution construct is the original construct written for working with CloudFront distributions. Users are encouraged to use the newer Distribution instead, as it has a simpler interface and receives new features faster.</p></blockquote><p>他に、<code>priceClass</code> は日本のエッジロケーションを使用したいので <code>PRICE_CLASS_200</code> としています。また <code>certificateArn</code> を渡すのに <code>Lazy</code> を使用しているのは <a href="https://github.com/aws/aws-cdk/issues/8699" target="_blank" rel="noopener noreferrer">Issue#8699</a> に対応するためです。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="bucketdeployment-を使ってファイルを-s3-にアップロードする">BucketDeployment を使ってファイルを S3 にアップロードする<a href="#bucketdeployment-を使ってファイルを-s3-にアップロードする" class="hash-link" aria-label="BucketDeployment を使ってファイルを S3 にアップロードする への直接リンク" title="BucketDeployment を使ってファイルを S3 にアップロードする への直接リンク">​</a></h2><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">s3Deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">BucketDeployment</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'BucketDeployment'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sources</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s3Deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">asset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">resolve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__dirname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'../web/public'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      destinationBucket</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> bucket</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      distribution</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> distribution</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      distributionPaths</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'/*'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_s3_deployment.BucketDeployment.html" target="_blank" rel="noopener noreferrer">BucketDeployment</a> はローカルのファイルをS3バケットにデプロイします。また、先ほど作成した <code>Distribution</code> がこのバケットを Origin とするように設定しています。<code>../web/public</code> はデプロイしたいファイルがある場所に合わせて修正して下さい。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ipv4-と-ipv6-両方に対応する">IPv4 と IPv6 両方に対応する<a href="#ipv4-と-ipv6-両方に対応する" class="hash-link" aria-label="IPv4 と IPv6 両方に対応する への直接リンク" title="IPv4 と IPv6 両方に対応する への直接リンク">​</a></h2><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> hostedZone </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> route53</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HostedZone</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fromLookup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'HostedZone'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      domainName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> propsForRoute53Records </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      zone</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> hostedZone</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      recordName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      target</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> route53</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RecordTarget</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fromAlias</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">route53Targets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CloudFrontTarget</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">destribution</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">route53</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ARecord</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'ARecord'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> propsForRoute53Records</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">route53</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AaaaRecord</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'AaaaRecord'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> propsForRoute53Records</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A と AAAA の2つのレコードを追加することで、IPv4 と IPv6 両方に対応しています。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="おわりに">おわりに<a href="#おわりに" class="hash-link" aria-label="おわりに への直接リンク" title="おわりに への直接リンク">​</a></h2><p>本記事では CDK で 静的ウェブサイトをデプロイする方法についてご紹介しました。CloudFront + S3 の組み合わせでファイル名を含まない URL に対応するためには少し工夫が必要になりますが、CDK であれば管理も簡単なのでおすすめです。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="あわせて読みたい">あわせて読みたい<a href="#あわせて読みたい" class="hash-link" aria-label="あわせて読みたい への直接リンク" title="あわせて読みたい への直接リンク">​</a></h2><ul><li><a href="https://aws.amazon.com/jp/premiumsupport/knowledge-center/cloudfront-serve-static-website/" target="_blank" rel="noopener noreferrer">CloudFront を使用して、Amazon S3 でホストされた静的ウェブサイトを公開するにはどうすればよいですか?</a></li><li><a href="https://dev.classmethod.jp/articles/sometimes-cf2-price-is-higher-than-lae/" target="_blank" rel="noopener noreferrer">CloudFront FunctionsはLambda@Edgeより安い。それ本当？！</a></li></ul>]]></content:encoded>
            <category>cdk</category>
            <category>cloudfront</category>
            <category>s3</category>
        </item>
        <item>
            <title><![CDATA[Amazon CloudWatch RUM で Jekyll の静的サイトのアクセス解析を行う]]></title>
            <link>https://prototyping-blog.com/blog/jekyll-cloudwatch-rum</link>
            <guid>https://prototyping-blog.com/blog/jekyll-cloudwatch-rum</guid>
            <pubDate>Wed, 03 Aug 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[本記事では、GitHub Pages で広く利用されている静的サイト作成ツール Jekyll と AWS の Web アプリケーションモニタリングツールである Amazon CloudWatch RUM を組み合わせたアクセス解析可能な静的サイトの構築方法をご紹介いたします。なお、ホスティング方法については触れません。]]></description>
            <content:encoded><![CDATA[<p>本記事では、GitHub Pages で広く利用されている静的サイト作成ツール Jekyll と AWS の Web アプリケーションモニタリングツールである Amazon CloudWatch RUM を組み合わせたアクセス解析可能な静的サイトの構築方法をご紹介いたします。なお、ホスティング方法については触れません。</p><h1>Jekyll の準備</h1><p>基本的には <a href="http://jekyllrb-ja.github.io/" target="_blank" rel="noopener noreferrer">Jekyll</a> の公式サイトの手順をなぞる形になります。Jekyll のコマンドラインツールは gem (Ruby のライブラリ形式) で公開されていますので、手元の環境に Ruby が必要だということに注意してください。以下のコマンドを実行して、<code>jekyll</code> コマンドをインストールし、<code>hello-rum</code> というサイトを作成します。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gem </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> bundler jekyll</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jekyll new hello-rum</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> hello-rum</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>公式の手順では次に <code>bundle exec jekyll serve</code> を実行していますが、筆者の手元の環境では <code>webrick</code> という gem が必要だというエラーが出ました。同様のエラーに遭遇した場合、Gemfile に以下の一文を追加してください。</p><div class="language-ruby codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ruby codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source "https://rubygems.org"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...省略...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 末尾にこれを追加</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gem "webrick"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最後に、以下のコマンドを実行して serve を開始します。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bundle </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bundle </span><span class="token builtin class-name">exec</span><span class="token plain"> jekyll serve</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="http://localhost:4000" target="_blank" rel="noopener noreferrer">http://localhost:4000</a> にアクセスし、正常に表示されていることを確認してください。</p><h1>Amazon CloudWatch RUM による App monitor の作成</h1><p><a href="https://console.aws.amazon.com/cloudwatch/home#rum:dashboard?tab=overview" target="_blank" rel="noopener noreferrer">Amazon CloudWatch RUM</a> にアクセスし、右上の「Add app monitor」をクリックして App monitor の作成を開始します。</p><p>App monitor 名は「hello-rum」にします。Application domain は検証目的のため「localhost」にします。</p><p><img loading="lazy" alt="App monitor 01" src="/assets/images/app-monitor-01-82f54281235ed3c3c3d244a64ac07510.png" width="875" height="361" class="img_ev3q"></p><p>集めるデータには全てチェックを入れます。不必要なものがある場合はチェックを外しても問題ありません。</p><p><img loading="lazy" alt="App monitor 02" src="/assets/images/app-monitor-02-cbc46e29bf198b949f50ab60221fbdbf.png" width="876" height="387" class="img_ev3q"></p><p>「Allow cookies」のチェックは外しました。チェックを入れた場合は、cookie を設定してユーザーの動向を追跡できます。「Session samples」は 100% にします。「Data Storage」は有効にしました。これにより、CloudWatch Logs でデータを集計できるようになります。</p><p><img loading="lazy" alt="App monitor 03" src="/assets/images/app-monitor-03-908ad9a3e639ac9c2066b8996516cf32.png" width="873" height="567" class="img_ev3q"></p><p>作成が完了すると、組み込み用の Snippet が表示されます。TypeScript、JavaScript、HTML が選択できますが、Jekyll 用に「HTML」を選択します。右上から Snippet をコピーしてください。</p><p><img loading="lazy" alt="App monitor 04" src="/assets/images/app-monitor-04-1ff096fdb5edaae90d38e482ed40006f.png" width="874" height="681" class="img_ev3q"></p><h1>Jekyll に App monitor を組み込む</h1><p>jekyll (バージョン 4.2.2) ではデフォルトで <a href="https://github.com/jekyll/minima" target="_blank" rel="noopener noreferrer">minima</a> というテーマが適応されています。Snippet を組み込む <code>&lt;head&gt;</code> タグを上書きするため、<code>hello-rum</code> ディレクトリに <code>_includes</code> ディレクトリを作成し、その中に <code>head.html</code> を作成します。<code>head.html</code> の内容は以下にします。<code>&lt;!-- ここに App monitor のスニペットを貼り付ける --&gt;</code> は Snippet に置き換えてください。</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">head</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">meta</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">charset</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">utf-8</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">meta</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">http-equiv</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">X-UA-Compatible</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">content</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">IE=edge</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">meta</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">viewport</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">content</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">width=device-width, initial-scale=1</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {%- seo -%}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;link rel="stylesheet" href="{{ "/assets/main.css" | relative_url }}"&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {%- feed_meta -%}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- ここに App monitor のスニペットを貼り付ける --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">head</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上のコードはほとんど <a href="https://github.com/jekyll/minima/blob/master/_includes/head.html" target="_blank" rel="noopener noreferrer">minima の <code>_includes/head.html</code></a> の内容ですが、下部に App monitor のスニペットを組み込みます。また、minima のバージョンによっては <a href="https://github.com/jekyll/minima/blob/master/_includes/custom-head.html" target="_blank" rel="noopener noreferrer"><code>_includes/custom-head.html</code></a> も利用可能なようなので、そちらにスニペットを貼り付けても良いかもしれません。</p><p><a href="http://localhost:4000" target="_blank" rel="noopener noreferrer">http://localhost:4000</a> を何度かリロードしたり記事を閲覧したりして App monitor のダッシュボードにデータが表示されることを確認してください。成功していると以下のようにデータが表示されます。</p><p><img loading="lazy" alt="App monitor 05" src="/assets/images/app-monitor-05-db4ef50bfc68c45136f55f5f37b4251a.png" width="1509" height="850" class="img_ev3q"></p><h1>Production 環境への組み込み</h1><p>前述した App monitor は localhost に設定した開発用のものでした。本番用の App monitor も組み込んでみます。前述した手順と同様に App monitor を作成してください。App monitor 名は「hello-rum-prod」にして、Application domain は本番環境で使うドメインに設定します。GitHub Pages の場合「<code>&lt;org名&gt;.github.io</code>」になります。他の設定は同じで問題ありません。Snippet はコピーしておいてください。</p><p>続いて、<code>head.html</code> を以下のように編集します。本番環境か否かを <code>{% if jekyll.environment == "development" %}</code> で判断しています。</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">head</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">meta</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">charset</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">utf-8</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">meta</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">http-equiv</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">X-UA-Compatible</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">content</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">IE=edge</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">meta</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">viewport</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">content</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">width=device-width, initial-scale=1</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {%- seo -%}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;link rel="stylesheet" href="{{ "/assets/main.css" | relative_url }}"&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {%- feed_meta -%}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {% if jekyll.environment == "development" %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- ここに開発用 (localhost) の App monitor のスニペットを貼り付ける --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {% else %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- ここに本番用の App monitor のスニペットを貼り付ける --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {% endif %}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">head</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>本番環境にデプロイしたあと、正常にデータが受信できることを確認してください。以上で全ての設定が完了です！</p><h1>おわりに</h1><p>本記事では Jekyll で作成した静的サイトに Amazon CloudWatch RUM を組み込む手順を紹介しました。Amazon CloudWatch RUM ではページごとのアクセス状況やデバイス種別などのデータが解析可能ですし、CloudWatch Logs と連携させることにより、柔軟な集計を行うことも可能です。また、今回は Jekyll への組み込みを行いましたが、React や Vue.js などの SPA にも組み込むことは可能ですので、ぜひ一度お試しください。</p>]]></content:encoded>
            <category>cloudwatch</category>
            <category>rum</category>
            <category>jekyll</category>
        </item>
    </channel>
</rss>